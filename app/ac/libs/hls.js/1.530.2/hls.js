/**
 * @license
 * Copyright (c) 2017 Dailymotion (http://www.dailymotion.com)
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * src/remux/mp4-generator.js and src/demux/exp-golomb.js implementation in this project
 * are derived from the HLS library for video.js (https://github.com/videojs/videojs-contrib-hls)
 *
 * That work is also covered by the Apache 2 License, following copyright:
 * Copyright (c) 2013-2015 Brightcove
 *
 * src/utils/url-toolkit.js implementation in this project
 * is derived from the url-toolkit library (https://github.com/tjenkinson/url-toolkit)
 *
 * That work is also covered by the Apache 2 License, following copyright:
 * Copyright (c) 2016 Tom Jenkinson
 */
/*! Modules included in this bundle:
* name: rxjs
*  license: Apache-2.0
*  version: 7.0.0-beta.0
* 
* name: timers-browserify
*  license: MIT
*  version: 2.0.11
* 
* name: typescript
*  license: Apache-2.0
*  version: 3.9.3
* 
* name: events
*  license: MIT
*  version: 3.0.0
*  text:
*  MIT
*  
*  Copyright Joyent, Inc. and other Node contributors.
*  
*  Permission is hereby granted, free of charge, to any person obtaining a
*  copy of this software and associated documentation files (the
*  "Software"), to deal in the Software without restriction, including
*  without limitation the rights to use, copy, modify, merge, publish,
*  distribute, sublicense, and/or sell copies of the Software, and to permit
*  persons to whom the Software is furnished to do so, subject to the
*  following conditions:
*  
*  The above copyright notice and this permission notice shall be included
*  in all copies or substantial portions of the Software.
*  
*  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
*  OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
*  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
*  NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
*  DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
*  OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
*  USE OR OTHER DEALINGS IN THE SOFTWARE.
*  
* name: tslib
*  license: 0BSD
*  version: 1.13.0
* 
* name: setimmediate
*  license: MIT
*  version: 1.0.5
* 
* name: webworkify-webpack
*  license: MIT
*  version: 2.1.3
* 
*/
!(function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("Hls",[],t):"object"==typeof exports?exports.Hls=t():e.Hls=t()})(window,(function(){return (function(e){function t(t){for(var i,r,a=t[0],n=t[1],o=0,d=[];o<a.length;o++)r=a[o],Object.prototype.hasOwnProperty.call(s,r)&&s[r]&&d.push(s[r][0]),s[r]=0;for(i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i]);for(l&&l(t);d.length;)d.shift()()}var i={},s={0:0};function r(t){if(i[t])return i[t].exports;var s=i[t]={i:t,l:!1,exports:{}};return e[t].call(s.exports,s,s.exports,r),s.l=!0,s.exports}r.m=e,r.c=i,r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)r.d(i,s,function(t){return e[t]}.bind(null,s));return i},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r.oe=function(e){throw console.error(e),e};var a=window.webpackJsonpHls=window.webpackJsonpHls||[],n=a.push.bind(a);a.push=t,a=a.slice();for(var o=0;o<a.length;o++)t(a[o]);var l=n;return r(r.s=27)})([(function(e,t,i){"use strict";var s;i.d(t,"e",(function(){return s})),i.d(t,"n",(function(){return a})),i.d(t,"p",(function(){return n})),i.d(t,"l",(function(){return o})),i.d(t,"q",(function(){return l})),i.d(t,"k",(function(){return d})),i.d(t,"j",(function(){return h})),i.d(t,"i",(function(){return c})),i.d(t,"r",(function(){return u})),i.d(t,"b",(function(){return f})),i.d(t,"c",(function(){return g})),i.d(t,"o",(function(){return p})),i.d(t,"h",(function(){return m})),i.d(t,"a",(function(){return y})),i.d(t,"g",(function(){return v})),i.d(t,"d",(function(){return b})),i.d(t,"f",(function(){return T})),i.d(t,"m",(function(){return S})),(function(e){e.Upgraded="Upgraded",e.Downgraded="Downgraded"})(s||(s={}));class r extends Error{constructor(e,t,i,s){super(s),this.type=e,this.details=t,this.fatal=i,this.reason=s}}class a extends r{constructor(e,t,i,s,r,a,n,o,l){super(e,t,i,s),this.response=r,this.decryptdata=a,this.stats=n,this.levelIds=o,this.keyErrorReason=l}}class n extends r{constructor(e,t,i,s,r,a,n,o){super(e,t,i,s),this.response=r,this.url=a,this.loader=n,this.context=o}}class o extends r{constructor(e,t,i,s,r,a,n){super(e,t,i,s),this.response=r,this.loader=a,this.frag=n}}class l extends r{constructor(e,t,i,s,r){super(e,t,i,s),this.response=r}}class d extends r{constructor(e,t,i,s,r){super(e,t,i,s),this.frag=r}}class h extends r{constructor(e,t,i,s,r,a){super(e,t,i,s),this.response=r,this.frag=a}}class c extends r{constructor(e,t,i,s){super(e,t,i,s)}}class u extends r{constructor(e,t,i,s,r){super(e,t,i,s),this.response=r}}class f extends u{constructor(e,t,i,s,r,a,n,o){super(e,t,i,s,r),this.parent=a,this.trackType=n,this.maxTotalBytes=o}}class g extends r{constructor(e,t,i,s,r){super(e,t,i,s),this.response=r}}class p extends r{constructor(e,t,i,s,r,a,n){super(e,t,i,s),this.response=r,this.bytes=a,this.frag=n}}class m extends r{constructor(e,t,i,s){super(e,t,i,s)}}class y extends Error{constructor(e){super(e)}}const v={NETWORK_ERROR:"networkError",MEDIA_ERROR:"mediaError",MUX_ERROR:"muxError",KEY_SYSTEM_ERROR:"keySystemError",OTHER_ERROR:"otherError"},b={MANIFEST_LOAD_ERROR:"manifestLoadError",MANIFEST_LOAD_TIMEOUT:"manifestLoadTimeOut",MANIFEST_PARSING_ERROR:"manifestParsingError",MANIFEST_INCOMPATIBLE_CODECS_ERROR:"manifestIncompatibleCodecsError",MANIFEST_INCOMPATIBLE_VIDEO_RANGE_ERROR:"manifestIncompatibleVideoRangeError",LEVEL_LOAD_ERROR:"levelLoadError",LEVEL_LOAD_TIMEOUT:"levelLoadTimeOut",LEVEL_SWITCH_ERROR:"levelSwitchError",AUDIO_TRACK_LOAD_ERROR:"audioTrackLoadError",AUDIO_TRACK_LOAD_TIMEOUT:"audioTrackLoadTimeOut",SUBTITLE_TRACK_LOAD_ERROR:"subtitleTrackLoadError",SUBTITLE_TRACK_LOAD_TIMEOUT:"subtitleTrackLoadTimeout",FRAG_LOAD_ERROR:"fragLoadError",FRAG_LOOP_LOADING_ERROR:"fragLoopLoadingError",FRAG_LOAD_TIMEOUT:"fragLoadTimeOut",FRAG_DECRYPT_ERROR:"fragDecryptError",FRAG_PARSING_ERROR:"fragParsingError",REMUX_ALLOC_ERROR:"remuxAllocError",BUFFER_ADD_CODEC_ERROR:"bufferAddCodecError",BUFFER_APPEND_ERROR:"bufferAppendError",BUFFER_APPENDING_ERROR:"bufferAppendingError",BUFFER_STALLED_ERROR:"bufferStalledError",BUFFER_FULL_ERROR:"bufferFullError",BUFFER_SEEK_OVER_HOLE:"bufferSeekOverHole",BUFFER_NUDGE_ON_STALL:"bufferNudgeOnStall",INTERNAL_EXCEPTION:"internalException",WEBVTT_EXCEPTION:"webVTTException",KEY_LOAD_ERROR:"keyLoadError",KEY_LOAD_TIMEOUT:"keyLoadTimeOut",KEY_SYSTEM_GENERIC_ERROR:"keySystemGenericError",CERT_LOAD_ERROR:"certificateLoadError",CERT_LOAD_TIMEOUT:"certificateLoadTimeOut",SESSION_DATA_LOAD_ERROR:"sessionDataLoadError",SESSION_DATA_LOAD_TIMEOUT:"sessionDataLoadTimeOut"},T={PlaylistNotReceived:{code:-12884,text:"Playlist not received"},CryptResponseReceivedSlowly:{code:-16833,text:"Crypt key received slowly"},LivePlaylistUpdateError:{code:-12888,text:"Live playlist not updated"},NoResponseFromMediaRequest:{code:-12889,text:"No response for fragment"},IncompatibleAsset:{code:-12927,text:"IncompatibleAsset"},CorruptStream:{code:-16041,text:"Corrupt fragment"},InternalError:{code:-12645,text:"InternalException"},CantSwitchInTime:{code:-12644,text:"CantSwitchInTime"},VideoDecoderBadDataErr:{code:-12909,text:"Buffer error"},InsufficientDataAvailable:{code:-12928,text:"Incomplete data"},AllocationFailed:{code:-12862,text:"AllocationFailed"},PlaylistErrorMissingEXTM3U:{code:-12269,text:"Response doesnt have #EXTM3U tag"},PlaylistErrorInvalidEntry:{code:-12264,text:"Invalid entry"},PlaylistErrorBadTargetDuration:{code:-12271,text:"Invalid targetduration"},NoValidAlternates:{code:-12925,text:"No valid alternates"},FormatError:{code:-12642,text:"Incorrect playlist format"}},S={SeekToUnbufferedTimeRanges:"SeekToUnbufferedTimeRanges",InvalidFormat:"InvalidFormat",FatalErrorWhileLoading:"FatalErrorWhileLoading",ApplicationInitiated:"ApplicationInitiated"}}),(function(e,t,i){"use strict";var s;i.d(t,"a",(function(){return s})),(function(e){e.MEDIA_ATTACHING="hlsMediaAttaching",e.MEDIA_ATTACHED="hlsMediaAttached",e.MEDIA_DETACHING="hlsMediaDetaching",e.MEDIA_DETACHED="hlsMediaDetached",e.BUFFER_CREATED="hlsBufferCreated",e.BUFFER_APPENDING="hlsBufferAppending",e.BUFFER_APPENDED="hlsBufferAppended",e.BUFFER_FLUSHED="hlsBufferFlushed",e.BUFFER_SOURCE_RESETTING="hlsBufferSourceResetting",e.BUFFER_SOURCE_RESET="hlsBufferSourceReset",e.MANIFEST_LOADING="hlsManifestLoading",e.MANIFEST_LOADED="hlsManifestLoaded",e.MANIFEST_PARSED="hlsManifestParsed",e.LEVEL_SWITCH="hlsLevelSwitch",e.LEVEL_SWITCHING="hlsLevelSwitching",e.LEVEL_SWITCHED="hlsLevelSwitched",e.LEVEL_LOADING="hlsLevelLoading",e.LEVEL_LOADED="hlsLevelLoaded",e.LEVEL_UPDATED="hlsLevelUpdated",e.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",e.LEVELS_CHANGED="hlsLevelsChanged",e.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",e.AUDIO_TRACK_SWITCH="hlsAudioTrackSwitch",e.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",e.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",e.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",e.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",e.SUBTITLE_TRACKS_CREATED="hlsSubtitleTracksCreated",e.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",e.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",e.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",e.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",e.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",e.INLINE_STYLES_PARSED="hlsInlineStylesParsed",e.SESSION_DATA_PARSED="hlsSessionDataParsed",e.SESSION_DATA_LOADING="hlsSessionDataLoading",e.SESSION_DATA_LOADED="hlsSessionDataLoaded",e.SESSION_DATA_COMPLETE="hlsSessionDataComplete",e.INIT_PTS_FOUND="hlsInitPtsFound",e.FRAG_LOADING="hlsFragLoading",e.FRAG_LOAD_PROGRESS="hlsFragLoadProgress",e.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",e.FRAG_LOADED="hlsFragLoaded",e.FRAG_DECRYPTED="hlsFragDecrypted",e.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",e.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",e.FRAG_PARSING_CAPTIONDATA="hlsFragParsingCaptiondata",e.FRAG_PARSING_METADATA="hlsFragParsingMetadata",e.FRAG_PARSING_DATA="hlsFragParsingData",e.FRAG_PARSED="hlsFragParsed",e.FRAG_BUFFERED="hlsFragBuffered",e.FRAG_CHANGED="hlsFragChanged",e.FPS_DROP="hlsFpsDrop",e.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",e.INTERNAL_ERROR="hlsInternalError",e.ERROR="hlsError",e.DESTROYING="hlsDestroying",e.KEY_REQUEST_STARTED="hlsKeyRequestStarted",e.LICENSE_CHALLENGE_CREATED="hlsLicenseChallengeCreated",e.KEY_LOADED="hlsKeyLoaded",e.STREAM_STATE_TRANSITION="hlsStreamStateTransition",e.LICENSE_RELEASED="hlsLicenseReleased",e.UNRESOLVED_URI_LOADING="hlsUnresolvedUriLoading",e.UNRESOLVED_URI_LOADED="hlsUnresolvedUriLoaded",e.DESIRED_RATE_CHANGED="hlsDesiredRateChanged",e.PLAYER_STATE_CHANGE="hlsPlayerStateChange",e.SEEKING="hlsSeeking",e.SEEKED="hlsSeeked",e.BANDWIDTH_CHANGED="hlsBandwidthChanged",e.BUFFER_CHANGED="hlsBufferChanged",e.STALLED="hlsStalled",e.PREFERRED_HOST_CHANGED="hlsPreferredHostChanged",e.READY_FOR_NEXT_ITEM="hlsReadyForNextItem",e.ITEM_TRANSITIONED="hlsItemTransitioned",e.ITEM_EVICTED="hlsItemEvicted"})(s||(s={})),t.b=s}),(function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));const s=()=>s;function r(e){return e<10?"0"+e:e.toString()}const a=["debug","log","info","warn","error"];class n{constructor(){this._enabled={},this.streamAndSessionIDStr=""}_fn(e,...t){return"function"!=typeof this._enabled[e]?s:(t=[`${(function(){const e=new Date,t=e.getTimezoneOffset(),i=r(Math.floor(Math.abs(t)/60)),s=r(Math.abs(t)%60);let a=t<=0?"UTC+"+i:"UTC-"+i;return a=s?a+":"+s:a,e.getFullYear()+"-"+r(e.getMonth()+1)+"-"+r(e.getDate())+" "+r(e.getHours())+":"+r(e.getMinutes())+":"+r(e.getSeconds())+"."+(e.getMilliseconds()/1e3).toFixed(3).slice(2,5)+" "+a})()}${this.streamAndSessionIDStr} | [${e}] >`,...t],this._enabled[e].bind(this,t.map(e=>"string"==typeof e?e:e&&"function"==typeof e.toString?e.toString():Object.prototype.toString.call(e)).join(" ")))}trace(...e){return this._fn("trace",...e)}debug(...e){return this._fn("debug",...e)}log(...e){return this._fn("log",...e)}info(...e){return this._fn("info",...e)}warn(...e){return this._fn("warn",...e)}error(...e){return this._fn("error",...e)}_set(e,t){this._enabled[e]=t||console[e]}enable(e,t){e&&(this._enabled={},(null!=t&&a.indexOf(t)>=0?a.slice(a.indexOf(t)):a).forEach(t=>this._set(t,"boolean"!=typeof e&&e[t]||console[t])))}setStreamAndSessionIDs(e,t){this.sessionID=e,this.streamID=t,this.streamAndSessionIDStr=this.getStreamAndSessionIDString()}getStreamAndSessionIDString(){return(this.sessionID?"| [SessionID: "+this.sessionID.slice(0,8):"")+(this.streamID?", StreamID: "+this.streamID+"]":"]")}}const o=new n;o.enable("undefined"==typeof globalHlsLogConfig||globalHlsLogConfig),t.b=o}),(function(e,t,i){"use strict";i.d(t,"c",(function(){return a})),i.d(t,"a",(function(){return n}));const s=new Set(["ac-3","mp4a.a5","mp4a.A5"]),r=new Set(["ec-3","mp4a.a6","mp4a.A6"]);function a(e){return"number"==typeof e&&isFinite(e)}const n={aac:1024,mp3:1024,ac3:1536,ec3:1536},o={isAC3:function(e){return Boolean(e&&s.has(e))},isEC3:function(e){return Boolean(e&&r.has(e))},isDolbyAtmos:function(e,t){let i=t.split("/");return Boolean(o.isEC3(e)&&i.length>1&&"JOC"===i[1])},isAAC:function(e){let t;return Boolean(e&&("aac"===e||null!==(t=e.match(/^mp4a\.40\.(.*)/))&&"34"!==t[1]))},isMP3:function(e){let t;return Boolean(e&&("mp3"===e||null!==(t=e.match(/^mp4a\.40\.(.*)/))&&"34"===t[1]))},isAVC:function(e){return Boolean(e&&e.match(/^avc[13]\.(.*)/))},isHEVC:function(e){return Boolean(e&&e.match(/^(hev|hvc)1\..*/))},isDolby:function(e){return Boolean(e&&e.match(/^dv(h1|he|a1|av)\..*/))},isVP09:function(e){return Boolean(e&&e.match(/^vp09\..*/))},isCompatibleCodecString:function(e,t){let i=e.split(","),s=t.split(","),r=i.filter(e=>o.isVideoCodec(e)),a=s.filter(e=>o.isVideoCodec(e)),n=i.filter(e=>o.isAudioCodec(e)),l=s.filter(e=>o.isAudioCodec(e)),d=0===r.length&&0===a.length||r.length===a.length&&o.isCompatibleVideoCodec(r[0],a[0]),h=0===n.length&&0===l.length||n.length===l.length&&o.isCompatibleAudioCodec(n[0],l[0]);return d&&h},isVideoCodec:function(e){return o.isAVC(e)||o.isDolby(e)||o.isHEVC(e)},isAudioCodec:function(e){return o.isAC3(e)||o.isEC3(e)||o.isAAC(e)||o.isMP3(e)},isCompatibleVideoCodec:function(e,t){return Boolean(e&&t&&(e===t||o.isDolby(e)&&o.isDolby(t)||o.isHEVC(e)&&o.isHEVC(t)||o.isAVC(e)&&o.isAVC(t)))},isCompatibleAudioCodec:function(e,t){return Boolean(e&&t&&(e===t||o.isAAC(e)&&o.isAAC(t)||o.isAC3(e)&&o.isAC3(t)||o.isEC3(e)&&o.isEC3(t)||o.isMP3(e)&&o.isMP3(t)))},getSegmentCodec:function(e){let t;if(o.isAAC(e))t="aac";else if(o.isAC3(e))t="ac3";else if(o.isEC3(e))t="ec3";else{if("mp3"!==e)throw`invalid audio config, codec ${e}`;t="mp3"}return t},getChannelCount:function(e){if(!e)return 0;let t=e.split("/"),i=parseInt(t[0]);return isNaN(i)?0:i}};t.b=o}),(function(e,t,i){"use strict";const s=Math.pow(2,32)-1;class r{static init(){var e;for(e in r.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],free:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],dec3:[],"ec-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[],uuid:[],encv:[],enca:[],frma:[],schm:[],schi:[],senc:[],saio:[],saiz:[],sinf:[],tenc:[],sbgp:[],seig:[],sgpd:[],pssh:[]},r.types)r.types.hasOwnProperty(e)&&(r.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);var t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),i=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);r.HDLR_TYPES={video:t,audio:i};var s=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),a=new Uint8Array([0,0,0,0,0,0,0,0]);r.STTS=r.STSC=r.STCO=a,r.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),r.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),r.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),r.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);var n=new Uint8Array([105,115,111,109]),o=new Uint8Array([97,118,99,49]),l=new Uint8Array([0,0,0,1]);r.FTYP=r.box(r.types.ftyp,n,l,n,o),r.DINF=r.box(r.types.dinf,r.box(r.types.dref,s))}static set16(e,t,i){return t[i]=e>>8&255,t[i+1]=255&e,i+2}static set32(e,t,i){return t[i]=e>>24&255,t[i+1]=e>>16&255,t[i+2]=e>>8&255,t[i+3]=255&e,i+4}static box(e,...t){for(var i,s=Array.prototype.slice.call(arguments,1),r=8,a=s.length,n=a;a--;)r+=s[a].byteLength;for((i=new Uint8Array(r))[0]=r>>24&255,i[1]=r>>16&255,i[2]=r>>8&255,i[3]=255&r,i.set(e,4),a=0,r=8;a<n;a++)i.set(s[a],r),r+=s[a].byteLength;return i}static hdlr(e){return r.box(r.types.hdlr,r.HDLR_TYPES[e])}static mdat(e){return r.box(r.types.mdat,e)}static mdhd(e,t){t*=e;const i=Math.floor(t/(s+1)),a=Math.floor(t%(s+1));return r.box(r.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,i>>24,i>>16&255,i>>8&255,255&i,a>>24,a>>16&255,a>>8&255,255&a,85,196,0,0]))}static mdia(e){let t=r.mdhd(e.info.timescale,e.info.duration),i=r.hdlr(e.type),s=r.minf(e);return r.box(r.types.mdia,t,i,s)}static mfhd(e){return r.box(r.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e]))}static minf(e){return"audio"===e.type?r.box(r.types.minf,r.box(r.types.smhd,r.SMHD),r.DINF,r.stbl(e)):r.box(r.types.minf,r.box(r.types.vmhd,r.VMHD),r.DINF,r.stbl(e))}static moof(e,t){r.types||r.init();let i=r.traf(t,e);return r.box(r.types.moof,r.mfhd(t.sequenceNumber),i)}static moov(e){for(var t=e.length,i=[];t--;)i[t]=r.trak(e[t]);return r.box.apply(null,[r.types.moov,r.mvhd(e[0].info.timescale,e[0].info.duration)].concat(i).concat(r.mvex(e)))}static mvex(e){for(var t=e.length,i=[];t--;)i[t]=r.trex(e[t]);return r.box(r.types.mvex,...i)}static mvhd(e,t){t*=e;const i=Math.floor(t/(s+1)),a=Math.floor(t%(s+1));var n=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,i>>24,i>>16&255,i>>8&255,255&i,a>>24,a>>16&255,a>>8&255,255&a,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return r.box(r.types.mvhd,n)}static sdtp(e){var t,i,s=e.samples||[],a=new Uint8Array(4+s.length);for(i=0;i<s.length;i++)t=s[i].flags,a[i+4]=t.dependsOn<<4|t.isDependedOn<<2|t.hasRedundancy;return r.box(r.types.sdtp,a)}static stbl(e){let t=r.stsd(e),i=r.box(r.types.stts,r.STTS),s=r.box(r.types.stsc,r.STSC),a=r.box(r.types.stsz,r.STSZ),n=r.box(r.types.stco,r.STCO);return r.box(r.types.stbl,t,i,s,a,n)}static avc1(e){var t,i,s,a=[],n=[];let o=e.info.encrypted?r.types.encv:r.types.avc1;for(t=0;t<e.config.sps.length;t++)s=(i=e.config.sps[t]).byteLength,a.push(s>>>8&255),a.push(255&s),a=a.concat(Array.prototype.slice.call(i));for(t=0;t<e.config.pps.length;t++)s=(i=e.config.pps[t]).byteLength,n.push(s>>>8&255),n.push(255&s),n=n.concat(Array.prototype.slice.call(i));var l=r.box(r.types.avcC,new Uint8Array([1,a[3],a[4],a[5],255,224|e.config.sps.length].concat(a).concat([e.config.pps.length]).concat(n))),d=e.config.width,h=e.config.height,c=e.config.pixelRatio[0],u=e.config.pixelRatio[1],f=e.info.encrypted&&e.info.decryptdata?r.sinf(e.info.decryptdata,e.type,r.types.avc1):new Uint8Array;return r.box(o,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,d>>8&255,255&d,h>>8&255,255&h,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),l,f,r.box(r.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),r.box(r.types.pasp,new Uint8Array([c>>24,c>>16&255,c>>8&255,255&c,u>>24,u>>16&255,u>>8&255,255&u])))}static esds(e){var t=e.esdsConfig.length;return new Uint8Array([0,0,0,0,3,23+t,0,1,0,4,15+t,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([t]).concat(e.esdsConfig).concat([6,1,2]))}static audioStsd(e){var t=e.samplerate;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount,0,16,0,0,0,0,t>>8&255,255&t,0,0])}static dac3(e){let t=e.extraData;return new Uint8Array([t>>16&255,t>>8&255,255&t])}static dec3(e){return e.extraDataBytes}static mp4a(e,t){let i=r.types.mp4a,s=null;e.encrypted&&e.decryptdata?(i=r.types.enca,s=r.sinf(e.decryptdata,"audio",r.types.mp4a)):s=new Uint8Array;let a=r.audioStsd(t),n=r.box(r.types.esds,r.esds(t));return r.box(i,a,n,s)}static mp3(e){return r.box(r.types[".mp3"],r.audioStsd(e))}static ac3(e,t){let i=r.types["ac-3"],s=null;return e.encrypted&&e.decryptdata?(i=r.types.enca,s=r.sinf(e.decryptdata,"audio",r.types["ac-3"])):s=new Uint8Array,r.box(i,r.audioStsd(t),r.box(r.types.dac3,r.dac3(t)),s)}static ec3(e,t){let i=r.types["ec-3"],s=null;return e.encrypted&&e.decryptdata?(i=r.types.enca,s=r.sinf(e.decryptdata,"audio",r.types["ec-3"])):s=new Uint8Array,r.box(i,r.audioStsd(t),r.box(r.types.dec3,r.dec3(t)),s)}static stsd(e){if("audio"===e.type){if("mp3"===e.config.segmentCodec&&"mp3"===e.config.codec)return r.box(r.types.stsd,r.STSD,r.mp3(e.config));if("ac3"===e.config.segmentCodec)return r.box(r.types.stsd,r.STSD,r.ac3(e.info,e.config));if("ec3"===e.config.segmentCodec)return r.box(r.types.stsd,r.STSD,r.ec3(e.info,e.config));if("aac"===e.config.segmentCodec)return r.box(r.types.stsd,r.STSD,r.mp4a(e.info,e.config));throw`unknown segmentCodec ${e.config.segmentCodec}`}return r.box(r.types.stsd,r.STSD,r.avc1(e))}static tkhd(e){let t=e.info.id,i=e.info.duration*e.info.timescale,a=Math.floor(i/(s+1)),n=Math.floor(i%(s+1)),o=0,l=0;return"video"===e.type&&(o=e.config.width,l=e.config.height),r.box(r.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,0,0,0,0,a>>24,a>>16&255,a>>8&255,255&a,n>>24,n>>16&255,n>>8&255,255&n,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,o>>8&255,255&o,0,0,l>>8&255,255&l,0,0]))}static traf(e,t){const i=r.senc(e);var a=r.sdtp(e),n=i.boxData,o=n.length?r.saio(76):new Uint8Array,l=n.length?r.saiz(i.defaultSampleInfoSize,i.sampleInfoSizes):new Uint8Array,d=r.sbgp(e),h=r.sgpd(e),c=e.id,u=Math.floor(t/(s+1)),f=Math.floor(t%(s+1));return r.box(r.types.traf,r.box(r.types.tfhd,new Uint8Array([0,2,0,0,c>>24,c>>16&255,c>>8&255,255&c])),r.box(r.types.tfdt,new Uint8Array([1,0,0,0,u>>24,u>>16&255,u>>8&255,255&u,f>>24,f>>16&255,f>>8&255,255&f])),n,o,l,d,h,r.trun(e,a.length+n.length+d.length+h.length+o.length+l.length+16+20+8+16+8+8),a)}static trak(e){if("trakData"in e)return e.trakData;e.info.duration=e.info.duration||4294967295;let t=r.types.trak,i=r.tkhd(e),s=r.mdia(e);return r.box(t,i,s)}static trex(e){var t=e.info.id;return r.box(r.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,t){var i,s,a,n,o,l,d=e.samples||[],h=d.length,c=12+16*h,u=new Uint8Array(c);for(t+=8+c,u.set([0,0,15,1,h>>>24&255,h>>>16&255,h>>>8&255,255&h,t>>>24&255,t>>>16&255,t>>>8&255,255&t],0),i=0;i<h;i++)a=(s=d[i]).duration,n=s.size,o=s.flags,l=s.cts,u.set([a>>>24&255,a>>>16&255,a>>>8&255,255&a,n>>>24&255,n>>>16&255,n>>>8&255,255&n,o.isLeading<<2|o.dependsOn,o.isDependedOn<<6|o.hasRedundancy<<4|o.paddingValue<<1|o.isNonSync,61440&o.degradPrio,15&o.degradPrio,l>>>24&255,l>>>16&255,l>>>8&255,255&l],12+16*i);return r.box(r.types.trun,u)}static initSegment(e){r.types||r.init();var t,i=r.moov(e);return(t=new Uint8Array(r.FTYP.byteLength+i.byteLength)).set(r.FTYP),t.set(i,r.FTYP.byteLength),t}static saio(e){const t=e+4+4;return r.box(r.types.saio,new Uint8Array([0,0,0,0,0,0,0,1,t>>24&255,t>>16&255,t>>8&255,255&t]))}static saiz(e,t){isNaN(e)&&(e=0);const i=t.length;let s=0===e?new Uint8Array(t):new Uint8Array;return r.box(r.types.saiz,new Uint8Array([0,0,0,0,e,i>>24&255,i>>16&255,i>>8&255,255&i]),s)}static senc(e){const t=e.samples||[],i=t.length;let s=0,a=NaN,n=!0,o=[];if(!e.encrypted||i<=0)return{boxData:new Uint8Array,sampleInfoSizes:o,defaultSampleInfoSize:0};const l=e.defaultPerSampleIVSize?e.defaultPerSampleIVSize:0;for(const e of t)e.subsamples&&(s+=e.subsamples.length);if(s<=0)return{boxData:new Uint8Array,sampleInfoSizes:o,defaultSampleInfoSize:0};let d=new Uint8Array(2*i+i*l+6*s+4),h=this.set32(i,d,0);for(const e of t){let t=e.subsamples?e.subsamples:[],i=2;e.iv&&(d.set(e.iv,h),h+=e.iv.byteLength,i+=e.iv.byteLength),h=this.set16(t.length,d,h);for(const e of t)h=this.set16(e[0],d,h),h=this.set32(e[1],d,h),i+=6;o.push(i),isNaN(a)&&(a=i),n=n&&a===i,a=i}return{boxData:r.box(r.types.senc,new Uint8Array([0,0,0,2]),d),defaultSampleInfoSize:n?a:0,sampleInfoSizes:o}}static sinf(e,t,i){return r.box(r.types.sinf,r.frma(i),r.schm(),r.schi(e,t))}static frma(e){return r.box(r.types.frma,new Uint8Array(e))}static schm(){return r.box(r.types.schm,new Uint8Array([0,0,0,0,99,98,99,115,0,1,0,0]))}static schi(e,t){return r.box(r.types.schi,r.tenc(e,t))}static tenc(e,t){let i=0;"video"===t&&(i=25);let s=new Uint8Array(17);if(s[0]=16,e.iv&&16===e.iv.byteLength&&s.set(e.iv,1),!e.keyId)throw"tenc: no key id found in decryptdata";return r.box(r.types.tenc,new Uint8Array([1,0,0,0,0,i,1,0]),e.keyId,s)}static sbgp(e){if(!e.encrypted||0===e.samples.length||!e.samples[0].decryptdata)return new Uint8Array;let t=e.samples.length;return r.box(r.types.sbgp,new Uint8Array([0,0,0,0]),new Uint8Array(r.types.seig),new Uint8Array([0,0,0,1,t>>24&255,t>>16&255,t>>8&255,255&t,0,1,0,1]))}static sgpd(e){if(!e.encrypted||0===e.samples.length||!e.samples[0].decryptdata)return new Uint8Array;let t=e.samples[0].decryptdata,i=0;"video"===e.type&&(i=25);let s=new Uint8Array(17);if(s[0]=16,t.iv&&s.set(t.iv,1),!t.keyId)throw"sgpd: no keyid in decryptdata";return r.box(r.types.sgpd,new Uint8Array([1,0,0,0]),new Uint8Array(r.types.seig),new Uint8Array([0,0,0,37,0,0,0,1]),new Uint8Array([0,i,1,0]),t.keyId,s)}static pssh(e,t,i){if(r.types||r.init(),!e)throw new TypeError("Bad system id");if(16!==e.byteLength)throw new RangeError("Invalid system id");let s,a,n;if(t){s=1,a=new Uint8Array(16*t.length);for(let e=0;e<t.length;e++){let i=t[e];if(16!==i.byteLength)throw new RangeError("Invalid key");a.set(i,16*e)}}else s=0,a=new Uint8Array;s>0?(n=new Uint8Array(4),t.length>0&&new DataView(n.buffer).setUint32(0,t.length,!1)):n=new Uint8Array;let o=new Uint8Array(4);return i&&i.byteLength>0&&new DataView(o.buffer).setUint32(0,i.byteLength,!1),r.box(r.types.pssh,new Uint8Array([s,0,0,0]),e,n,a,o,i||new Uint8Array)}}t.a=r}),(function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var s=i(10);let r,a;const n="undefined"!=typeof TextEncoder&&"undefined"!=typeof TextDecoder?{strToUtf8array:function(e){return r||(r=new TextEncoder),r.encode(e)},utf8arrayToStr:function(e){return a||(a=new TextDecoder("utf-8")),a.decode(e)}}:{strToUtf8array:function(e){const t=s.a.Buffer.from(e,"utf-8");return new Uint8Array(t.buffer,t.byteOffset,t.byteLength)},utf8arrayToStr:function(e){return s.a.Buffer.from(e).toString("utf-8")}};class o{constructor(){this.transfer=[]}add(e){this.transfer.indexOf(e)<0&&this.transfer.push(e)}}t.b=n}),(function(e,t,i){"use strict";var s=i(10);function r(e){return e.replace(/\+/g,"-").replace(/\//g,"_").replace(/\=+$/,"")}class a{static strToBase64Encode(e){return btoa(e)}static base64DecodeToStr(e){return atob(e)}static base64Encode(e){return btoa(String.fromCharCode(...e))}static base64UrlEncode(e){return r(a.base64Encode(e))}static base64Decode(e){return Uint8Array.from(atob(e),e=>e.charCodeAt(0))}}class n{static strToBase64Encode(e){return s.a.Buffer.from(e).toString("base64")}static base64DecodeToStr(e){return s.a.Buffer.from(e,"base64").toString()}static base64Encode(e){return s.a.Buffer.from(e).toString("base64")}static base64UrlEncode(e){return r(n.base64Encode(e))}static base64Decode(e){const t=s.a.Buffer.from(e,"base64");return new Uint8Array(t.buffer,t.byteOffset,t.byteLength)}}const o=void 0!==s.a.Buffer?n:a;t.a=o}),(function(e,t,i){"use strict";i.d(t,"c",(function(){return n})),i.d(t,"b",(function(){return s})),i.d(t,"a",(function(){return r})),i(1);var s,r,a=i(17);function n(e){var t,i;const{cc:s,level:r}=e;return`cc:${s}/level:${r}/keyId:${(null===(t=e.decryptdata)||void 0===t?void 0:t.keyId)?a.a.hexDump(null===(i=e.decryptdata)||void 0===i?void 0:i.keyId):"clear"}`}!(function(e){e.LowBuffer="LowBuffer",e.HighBuffer="HighBuffer",e.Seek="Seek"})(s||(s={})),(r||(r={})).INIT="init"}),(function(e,t,i){"use strict";var s="undefined"!=typeof global&&global||"undefined"!=typeof self&&self||window,r=Function.prototype.apply;function a(e,t){this._id=e,this._clearFn=t}t.setTimeout=function(){return new a(r.call(setTimeout,s,arguments),clearTimeout)},t.setInterval=function(){return new a(r.call(setInterval,s,arguments),clearInterval)},t.clearTimeout=t.clearInterval=function(e){e&&e.close()},a.prototype.unref=a.prototype.ref=function(){},a.prototype.close=function(){this._clearFn.call(s,this._id)},t.enroll=function(e,t){clearTimeout(e._idleTimeoutId),e._idleTimeout=t},t.unenroll=function(e){clearTimeout(e._idleTimeoutId),e._idleTimeout=-1},t._unrefActive=t.active=function(e){clearTimeout(e._idleTimeoutId);var t=e._idleTimeout;t>=0&&(e._idleTimeoutId=setTimeout((function(){e._onTimeout&&e._onTimeout()}),t))},i(20),t.setImmediate="undefined"!=typeof self&&self.setImmediate||"undefined"!=typeof global&&global.setImmediate||this&&this.setImmediate,t.clearImmediate="undefined"!=typeof self&&self.clearImmediate||"undefined"!=typeof global&&global.clearImmediate||this&&this.clearImmediate}),,(function(e,t,i){"use strict";const s=e=>e&&e.Math===Math&&e;t.a=s("object"==typeof globalThis&&globalThis)||s("object"==typeof window&&window)||s("object"==typeof self&&self)||s("object"==typeof global&&global)||Function("return this")()}),,(function(e,t,i){"use strict";var s,r="object"==typeof Reflect?Reflect:null,a=r&&"function"==typeof r.apply?r.apply:function(e,t,i){return Function.prototype.apply.call(e,t,i)};s=r&&"function"==typeof r.ownKeys?r.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var n=Number.isNaN||function(e){return e!=e};function o(){o.init.call(this)}e.exports=o,o.EventEmitter=o,o.prototype._events=void 0,o.prototype._eventsCount=0,o.prototype._maxListeners=void 0;var l=10;function d(e){return void 0===e._maxListeners?o.defaultMaxListeners:e._maxListeners}function h(e,t,i,s){var r,a,n,o;if("function"!=typeof i)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof i);if(void 0===(a=e._events)?(a=e._events=Object.create(null),e._eventsCount=0):(void 0!==a.newListener&&(e.emit("newListener",t,i.listener?i.listener:i),a=e._events),n=a[t]),void 0===n)n=a[t]=i,++e._eventsCount;else if("function"==typeof n?n=a[t]=s?[i,n]:[n,i]:s?n.unshift(i):n.push(i),(r=d(e))>0&&n.length>r&&!n.warned){n.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+n.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=e,l.type=t,l.count=n.length,o=l,console&&console.warn&&console.warn(o)}return e}function c(e,t,i){var s={fired:!1,wrapFn:void 0,target:e,type:t,listener:i},r=function(){for(var e=[],t=0;t<arguments.length;t++)e.push(arguments[t]);this.fired||(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,a(this.listener,this.target,e))}.bind(s);return r.listener=i,s.wrapFn=r,r}function u(e,t,i){var s=e._events;if(void 0===s)return[];var r=s[t];return void 0===r?[]:"function"==typeof r?i?[r.listener||r]:[r]:i?(function(e){for(var t=new Array(e.length),i=0;i<t.length;++i)t[i]=e[i].listener||e[i];return t})(r):g(r,r.length)}function f(e){var t=this._events;if(void 0!==t){var i=t[e];if("function"==typeof i)return 1;if(void 0!==i)return i.length}return 0}function g(e,t){for(var i=new Array(t),s=0;s<t;++s)i[s]=e[s];return i}Object.defineProperty(o,"defaultMaxListeners",{enumerable:!0,get:function(){return l},set:function(e){if("number"!=typeof e||e<0||n(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");l=e}}),o.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||n(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},o.prototype.getMaxListeners=function(){return d(this)},o.prototype.emit=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var s="error"===e,r=this._events;if(void 0!==r)s=s&&void 0===r.error;else if(!s)return!1;if(s){var n;if(t.length>0&&(n=t[0]),n instanceof Error)throw n;var o=new Error("Unhandled error."+(n?" ("+n.message+")":""));throw o.context=n,o}var l=r[e];if(void 0===l)return!1;if("function"==typeof l)a(l,this,t);else{var d=l.length,h=g(l,d);for(i=0;i<d;++i)a(h[i],this,t)}return!0},o.prototype.addListener=function(e,t){return h(this,e,t,!1)},o.prototype.on=o.prototype.addListener,o.prototype.prependListener=function(e,t){return h(this,e,t,!0)},o.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);return this.on(e,c(this,e,t)),this},o.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);return this.prependListener(e,c(this,e,t)),this},o.prototype.removeListener=function(e,t){var i,s,r,a,n;if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);if(void 0===(s=this._events))return this;if(void 0===(i=s[e]))return this;if(i===t||i.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete s[e],s.removeListener&&this.emit("removeListener",e,i.listener||t));else if("function"!=typeof i){for(r=-1,a=i.length-1;a>=0;a--)if(i[a]===t||i[a].listener===t){n=i[a].listener,r=a;break}if(r<0)return this;0===r?i.shift():(function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()})(i,r),1===i.length&&(s[e]=i[0]),void 0!==s.removeListener&&this.emit("removeListener",e,n||t)}return this},o.prototype.off=o.prototype.removeListener,o.prototype.removeAllListeners=function(e){var t,i,s;if(void 0===(i=this._events))return this;if(void 0===i.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==i[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete i[e]),this;if(0===arguments.length){var r,a=Object.keys(i);for(s=0;s<a.length;++s)"removeListener"!==(r=a[s])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=i[e]))this.removeListener(e,t);else if(void 0!==t)for(s=t.length-1;s>=0;s--)this.removeListener(e,t[s]);return this},o.prototype.listeners=function(e){return u(this,e,!0)},o.prototype.rawListeners=function(e){return u(this,e,!1)},o.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):f.call(e,t)},o.prototype.listenerCount=f,o.prototype.eventNames=function(){return this._eventsCount>0?s(this._events):[]}}),(function(e,t,i){"use strict";function s(e){for(var i in e)t.hasOwnProperty(i)||(t[i]=e[i])}Object.defineProperty(t,"__esModule",{value:!0}),s(i(21)),s(i(23))}),(function(e,t,i){"use strict";var s=i(1),r=i(0),a=i(2),n=i(5);class o{constructor(e,t){this._hasTimeStamp=!1,this._audioType=null,this._length=0,this._frames=[],this.logger=null==t?a.b:t;for(var i,s,r,n,l=0;;)if(r=o.readUTF(e,l,3),l+=3,"ID3"===r){this._minor=e[l++],this._revision=e[l++];let t=e[l++];if(128&t&&(this._unsynchronized=!0,this.logger.error("id3 tag is unsynchronized")()),64&t&&(this._hasExtendedHeader=!0,this.logger.warn("id3 tag has extended header")()),i=o.readSynchSafeUint32(e.subarray(l,l+4)),s=(l+=4)+i,this._hasExtendedHeader){let t=o.readSynchSafeUint32(e.subarray(l,l+4));this.logger.warn(`id3 tag has ${t}-byte extended header. usually 6 or 10 bytes`)(),l+=t}this.minor>2?this._parseID3Frames(e,l,s):this.logger.error("[id3] doesn't support older than v2.3 tags")(),l=s}else{if("3DI"!==r)return void((n=l-=3)&&(this.hasTimeStamp||this.logger.warn("ID3 tag found, but no timestamp")(),this._length=n,this._payload=e.slice(0,n)));l+=7}}static isHeader(e,t){return 73===e[t]&&68===e[t+1]&&51===e[t+2]}static readSynchSafeUint32(e){return 2097152*(127&e[0])+16384*(127&e[1])+128*(127&e[2])+(127&e[3])}static readUTF(e,t,i){var s="",r=t,a=t+i;do{s+=String.fromCharCode(e[r++])}while(r<a);return s}isID3Frame(e,t){return e[t+4]<128&&e[t+5]<128&&e[t+6]<128&&e[t+7]<128}decodeID3Frame(e){return"TXXX"===e.type?this.decodeTxxxFrame(e):"WXXX"===e.type?this.decodeWxxxFrame(e):"PRIV"===e.type?this.decodePrivFrame(e):"T"===e.type[0]?this.decodeTextFrame(e):{key:e.type,data:e.data}}decodeTxxxFrame(e){if(e.size<2)return;if(3!==e.data[0])return;let t=1,i=this.utf8ArrayToStr(e.data.subarray(t));return t+=i.length+1,{key:"TXXX",description:i,data:this.utf8ArrayToStr(e.data.subarray(t))}}decodeWxxxFrame(e){if(e.size<2)return;if(3!==e.data[0])return;let t=1,i=this.utf8ArrayToStr(e.data.subarray(t));return t+=i.length+1,{key:"WXXX",description:i,data:n.b.utf8arrayToStr(e.data.subarray(t))}}decodeTextFrame(e){if(e.size<2)return;if(3!==e.data[0])return;let t=e.data.subarray(1);return{key:e.type,data:this.utf8ArrayToStr(t)}}decodePrivFrame(e){if(e.size<2)return;let t=this.utf8ArrayToStr(e.data);return{key:"PRIV",info:t,data:e.data.slice(t.length+1)}}_extractID3Frame(e,t,i,s,r){let a,n=s+i;return n<=r?(this.logger.info(`[QE Critical] [id3] parsed frame id ${t} size ${i}`)(),a={type:t,data:e.slice(s,n)}):this.logger.error(`id3 frame ${t} size ${i} exceeded ${r}`)(),a}_parseID3Frames(e,t,i){for(var s,r,a,n;t+8<=i;){if(!this.isID3Frame(e,t))return void this.logger.error(`[id3] illegal id3 frame @ offset ${t}. skip this id3 tag`)();if(s=o.readUTF(e,t,4),t+=4,""===s)return void this.logger.info("[id3] empty tagId. padding.")();if(0===(r=o.readSynchSafeUint32(e.subarray(t,t+4))))return void this.logger.info("[id3] zero tag length. padding.")();t+=4,e[t++],e[t++],a=t;let d=this._extractID3Frame(e,s,r,a,i);if(d){let e=this.decodeID3Frame(d);this._frames.push(e)}switch(s){case"PRIV":if(53===r&&"com.apple.streaming.transportStreamTimestamp"===o.readUTF(e,t,44)){t+=44,t+=4;var l=1&e[t++];this._hasTimeStamp=!0,n=((e[t++]<<23)+(e[t++]<<15)+(e[t++]<<7)+e[t++])/45,l&&(n+=47721858.84),n=Math.round(n),this._timeStamp=n}else r>=45&&"com.apple.streaming.audioDescription"===o.readUTF(e,t,36)?(t+=37,this._audioType=o.readUTF(e,t,4),t+=4,t+=r-41):t+=r;break;default:t+=r}}}utf8ArrayToStr(e){let t,i,s="",r=0,a=e.length;for(;r<a;){let a=e[r++];switch(a>>4){case 0:return s;case 1:case 2:case 3:case 4:case 5:case 6:case 7:s+=String.fromCharCode(a);break;case 12:case 13:t=e[r++],s+=String.fromCharCode((31&a)<<6|63&t);break;case 14:t=e[r++],i=e[r++],s+=String.fromCharCode((15&a)<<12|(63&t)<<6|(63&i)<<0)}}}get hasTimeStamp(){return this._hasTimeStamp}get timeStamp(){return this._timeStamp}get audioType(){return this._audioType}get length(){return this._length}get payload(){return this._payload}get frames(){return this._frames}get minor(){return this._minor}get revision(){return this._revision}}var l=o;class d{bsReadAndUpdate(e,t,i){let s=this.readBits(e,t,i);return this.updateOffset(t,i),s}bsWriteAndUpdate(e,t,i,s){let r=this.writeBits(e,t,i,s);return this.updateOffset(t,i),r}bsSkip(e,t){this.updateOffset(e,t)}readBits(e,t,i){if(!e||!t)return;let s,r=t.byteOffset,a=t.usedBits;if(a>=8||a+i>32)return;let n=new Uint32Array(1),o=new Uint32Array(1),l=new Uint8Array(1);if(!(a>=8||i>32)){if(a){let t=8-a,n=i<t?t-i:0;o[0]=4278190080>>>32-t,s=(e[r]&o[0])>>>n,r+=1,i-=t}for(;i>0;){l[0]=e[r];let t=Math.min(i,8),a=8-t;o[0]=4278190080>>>24+a<<a,n[0]=(l[0]&o[0])>>a,s=s?s<<t|n[0]:n[0],r+=1,i-=t}return s}}writeBits(e,t,i,s){if(!e||!t)return;let r=t.byteOffset,a=t.usedBits;if(a>=8||a+i>32)return;let n=new Uint32Array(1),o=new Uint32Array(1),l=new Uint32Array(1),d=new Uint8Array(1);for(n[0]=s,a&&(o[0]=n[0]<<32-i,l[0]=4278190080,d[0]=(o[0]&l[0])>>>24+a,e[r]&=~(l[0]>>>24+a),e[r]|=d[0],r+=1,i-=8-a);i>0;){o[0]=n[0]<<32-i,l[0]=4278190080,d[0]=(o[0]&l[0])>>>24;let t=i<0?8-i:0;e[r]&=~(l[0]>>>24>>>t<<t),e[r]|=d[0],i-=8,r+=1}return 0}updateOffset(e,t){if(!e||!t||e.usedBits+t>32)return;let i=e.usedBits%8,s=Math.floor((i+t)/8),r=(i+t)%8;e.byteOffset+=s,e.usedBits=r}}var h=function(e,t,i){let a,n=new d,o=!1,h=0;for(;i<t.length;){if(i+8>t.length)return a={type:r.g.MEDIA_ERROR,details:r.d.FRAG_PARSING_ERROR,fatal:!0,reason:"error parsing ec-3, not enough data"},void e.trigger(s.b.INTERNAL_ERROR,a);let d=0;if(l.isHeader(t,i)&&(i+=d=new l(t.subarray(i)).length||0),11!==t[i]||119!==t[i+1])return a={type:r.g.MEDIA_ERROR,details:r.d.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid ec-3 magic"},void e.trigger(s.b.INTERNAL_ERROR,a);let c={byteOffset:i+2,usedBits:0},u=n.bsReadAndUpdate(t,c,2),f=n.bsReadAndUpdate(t,c,3);if(0===u||2===u)if(!0===o){if(0===f)break}else o=!0;else if(1!==u)return a={type:r.g.MEDIA_ERROR,details:r.d.FRAG_PARSING_ERROR,fatal:!0,reason:"reserved stream type"},void e.trigger(s.b.INTERNAL_ERROR,a);let g=2*(n.bsReadAndUpdate(t,c,11)+1);i+=g,h+=g+(d||0)}return h},c=function(e,t,i){let a,n={frmsiz:0,fscod:0,numblkscod:0,acmod:0,lfeon:0,bsid:0,strmtyp:0,substreamid:0,chanmape:0,chanmap:0,mixdef:0,mixdeflen:0,bsmod:0},o={fscod:0,acmod:0,lfeon:0,bsid:0,bsmod:0,chan_loc:0,data_rate:0,num_ind_sub:0,num_dep_sub:[],complexity_index_type_a:0},h=new d,c=!1,u=0;for(;i<t.length;){if(i+8>t.length)return a={type:r.g.MEDIA_ERROR,details:r.d.FRAG_PARSING_ERROR,fatal:!0,reason:"error parsing ec-3, not enough data"},void e.trigger(s.b.INTERNAL_ERROR,a);let d=0;if(l.isHeader(t,i)&&(i+=d=new l(t.subarray(i)).length||0),11!==t[i]||119!==t[i+1])return a={type:r.g.MEDIA_ERROR,details:r.d.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid ec-3 magic"},void e.trigger(s.b.INTERNAL_ERROR,a);let f={byteOffset:i+2,usedBits:0};if(n.strmtyp=h.bsReadAndUpdate(t,f,2),n.substreamid=h.bsReadAndUpdate(t,f,3),0===n.strmtyp||2===n.strmtyp){if(!0===c){if(0===n.substreamid)break}else c=!0;o.num_ind_sub++,o.num_dep_sub.push(0)}else{if(1!==n.strmtyp)return a={type:r.g.MEDIA_ERROR,details:r.d.FRAG_PARSING_ERROR,fatal:!0,reason:"reserved stream type"},void e.trigger(s.b.INTERNAL_ERROR,a);o.num_dep_sub[o.num_ind_sub-1]++}if(n.frmsiz=h.bsReadAndUpdate(t,f,11),n.fscod=h.bsReadAndUpdate(t,f,2),3===n.fscod?(h.bsSkip(f,2),n.numblkscod=3):n.numblkscod=h.bsReadAndUpdate(t,f,2),n.acmod=h.bsReadAndUpdate(t,f,3),n.lfeon=h.bsReadAndUpdate(t,f,1),n.bsid=h.bsReadAndUpdate(t,f,5),h.bsSkip(f,5),h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,8),0===n.acmod&&(h.bsSkip(f,5),h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,8)),1===n.strmtyp&&(n.chanmape=h.bsReadAndUpdate(t,f,1),n.chanmape&&(n.chanmap=h.bsReadAndUpdate(t,f,16))),h.bsReadAndUpdate(t,f,1)&&(n.acmod>2&&h.bsSkip(f,2),1&n.acmod&&n.acmod>2&&h.bsSkip(f,6),4&n.acmod&&h.bsSkip(f,6),n.lfeon&&h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,5),0===n.strmtyp)){if(h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,6),0===n.acmod&&h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,6),h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,6),n.mixdef=h.bsReadAndUpdate(t,f,2),1===n.mixdef)h.bsSkip(f,5);else if(2===n.mixdef)h.bsSkip(f,12);else if(3===n.mixdef){n.mixdeflen=h.bsReadAndUpdate(t,f,5),h.bsReadAndUpdate(t,f,1)&&(h.bsSkip(f,5),h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,4),h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,4),h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,4),h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,4),h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,4),h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,4),h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,4),h.bsReadAndUpdate(t,f,1)&&(h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,4),h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,4))),h.bsReadAndUpdate(t,f,1)&&(h.bsSkip(f,5),h.bsReadAndUpdate(t,f,1)&&(h.bsSkip(f,7),h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,8)));let e=n.mixdeflen+2+(f.usedBits?1:0);f.byteOffset+=e}if(n.acmod<2&&(h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,14),0===n.acmod&&h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,14)),h.bsReadAndUpdate(t,f,1))if(0===n.numblkscod)h.bsSkip(f,5);else for(let e=0;e<n.numblkscod;e++)h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,5)}if(n.bsmod=0,h.bsReadAndUpdate(t,f,1)&&(n.bsmod=h.bsReadAndUpdate(t,f,3),h.bsSkip(f,2),2===n.acmod&&h.bsSkip(f,4),n.acmod>=6&&h.bsSkip(f,2),h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,8),0===n.acmod&&h.bsReadAndUpdate(t,f,1)&&h.bsSkip(f,8),n.fscod<3&&h.bsSkip(f,1)),0===n.strmtyp&&3!==n.numblkscod&&h.bsSkip(f,1),2===n.strmtyp){let e;(e=3===n.numblkscod?1:h.bsReadAndUpdate(t,f,1))&&h.bsReadAndUpdate(t,f,6)}if(h.bsReadAndUpdate(t,f,1)){let e=h.bsReadAndUpdate(t,f,6);if(0===n.strmtyp&&0===n.substreamid&&1===e){let e=h.bsReadAndUpdate(t,f,7),i=h.bsReadAndUpdate(t,f,1),s=h.bsReadAndUpdate(t,f,8);0===e&&1===i&&s>=1&&s<=16&&(o.complexity_index_type_a=s)}}if(n.chanmape)o.chan_loc|=n.chanmap;else{let e=[40960,16384,40960,57344,41472,57856,47104,63488];o.chan_loc|=e[n.acmod]}0===n.strmtyp&&(o.fscod=n.fscod,o.bsid=n.bsid,o.bsmod=n.bsmod,o.acmod=n.acmod,o.lfeon=n.lfeon),o.chan_loc|=n.lfeon?1:0;let g=2*(n.frmsiz+1);i+=g,u+=g+(d||0)}let f=0;for(let e=0;e<16;e++)o.chan_loc&1<<e&&f++;o.lfeon&&f++;let g=10+3*o.num_ind_sub,p=[48e3,44100,32e3][o.fscod];o.data_rate=p/1536*u*8,g=10+3*o.num_ind_sub;for(let e=0;e<o.num_ind_sub;e++)o.num_dep_sub[e]>0&&g++;o.complexity_index_type_a>0&&(g+=2);let m=new Uint8Array(g),y={byteOffset:0,usedBits:0};h.bsWriteAndUpdate(m,y,32,g),h.bsWriteAndUpdate(m,y,32,1684366131),h.bsWriteAndUpdate(m,y,13,o.data_rate),h.bsWriteAndUpdate(m,y,3,o.num_ind_sub);for(let e=0;e<o.num_ind_sub;e++)h.bsWriteAndUpdate(m,y,2,o.fscod),h.bsWriteAndUpdate(m,y,5,o.bsid),h.bsWriteAndUpdate(m,y,1,0),h.bsWriteAndUpdate(m,y,1,0===e?0:1),h.bsWriteAndUpdate(m,y,3,o.bsmod),h.bsWriteAndUpdate(m,y,3,o.acmod),h.bsWriteAndUpdate(m,y,1,o.lfeon),h.bsWriteAndUpdate(m,y,3,0),h.bsWriteAndUpdate(m,y,4,o.num_dep_sub[e]),o.num_dep_sub[e]>0?h.bsWriteAndUpdate(m,y,9,o.chan_loc):h.bsWriteAndUpdate(m,y,1,0);return o.complexity_index_type_a>0&&(h.bsWriteAndUpdate(m,y,7,0),h.bsWriteAndUpdate(m,y,1,1),h.bsWriteAndUpdate(m,y,8,o.complexity_index_type_a)),{samplerate:p,channelCount:f,segmentCodec:"ec3",codec:"ec-3",extraDataBytes:m}};class u{constructor(e,t,i,s,r){this.observer=e,this.remuxer=t,this.config=i,this.typeSupported=s,this.logger=r}static probe(e){throw new Error("Method not implemented.")}resetTimeStamp(e){}resetInitSegment(e,t,i,s){}destroy(){}}class f extends u{constructor(e,t,i,s,r){super(e,t,i,s,r),this.observer=e,this.remuxer=t,this.config=i,this.typeSupported=s,this.logger=r,this.esRemuxer=t}}class g{constructor(e,t){this.observer=e,this.config=t}resetInitSegment(){}resetTimeStamp(e){}destroy(){}}let p=[48e3,44100,32e3],m=[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920];var y={getFrameDuration:function(e,t){return 1536/e.samplerate*t},getAudioConfig:function(e,t,i){let a;if(i+8>t.length)return a={type:r.g.MEDIA_ERROR,details:r.d.FRAG_PARSING_ERROR,fatal:!0,reason:"error parsing ac-3, not enough data"},void e.trigger(s.b.INTERNAL_ERROR,a);if(11!==t[i]||119!==t[i+1])return a={type:r.g.MEDIA_ERROR,details:r.d.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid ac-3 magic"},void e.trigger(s.b.INTERNAL_ERROR,a);let n=t[i+4]>>6;if(n>=3)return a={type:r.g.MEDIA_ERROR,details:r.d.FRAG_PARSING_ERROR,fatal:!0,reason:`invalid ac-3 samplingRateCode:${n}`},void e.trigger(s.b.INTERNAL_ERROR,a);let o=63&t[i+4],l=t[i+6]>>5,d=0;2===l?d+=2:(1&l&&1!==l&&(d+=2),4&l&&(d+=2));let h=(t[i+6]<<8|t[i+7])>>12-d&1,c=[2,1,2,3,3,4,4,5][l]+h,u=t[i+5]>>3,f=7&t[i+5];return{samplerate:p[n],channelCount:c,segmentCodec:"ac3",codec:"ac-3",extraData:n<<22|u<<17|f<<14|l<<11|h<<10|o>>1<<5}},getFrameLength:function(e,t,i){let a;if(i+8>t.length)return a={type:r.g.MEDIA_ERROR,details:r.d.FRAG_PARSING_ERROR,fatal:!0,reason:"error parsing ac-3, not enough data"},void e.trigger(s.b.INTERNAL_ERROR,a);if(11!==t[i]||119!==t[i+1])return a={type:r.g.MEDIA_ERROR,details:r.d.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid ac-3 magic"},void e.trigger(s.b.INTERNAL_ERROR,a);let n=t[i+4]>>6;if(n>=3)return a={type:r.g.MEDIA_ERROR,details:r.d.FRAG_PARSING_ERROR,fatal:!0,reason:`invalid ac-3 samplingRateCode:${n}`},void e.trigger(s.b.INTERNAL_ERROR,a);let o=63&t[i+4];return 2*m[3*o+n]}},v={getAudioConfig:function(e,t,i,a){let n,o,l,d,h,c=navigator.userAgent.toLowerCase(),u=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];if(n=1+((192&t[i+2])>>>6),!((o=(60&t[i+2])>>>2)>u.length-1))return d=(1&t[i+2])<<2,d|=(192&t[i+3])>>>6,/firefox/i.test(c)?o>=6?(n=5,h=new Array(4),l=o-3):(n=2,h=new Array(2)):-1!==c.indexOf("android")?(n=2,h=new Array(2)):(n=5,h=new Array(4),a&&(-1!==a.indexOf("mp4a.40.29")||-1!==a.indexOf("mp4a.40.5"))||!a&&o>=6?l=o-3:((a&&-1!==a.indexOf("mp4a.40.2")||!a&&1===d)&&(n=2,h=new Array(2)),l=o)),h[0]=n<<3,h[0]|=(14&o)>>1,h[1]|=(1&o)<<7,h[1]|=d<<3,5===n&&(h[1]|=(14&l)>>1,h[2]=(1&l)<<7,h[2]|=8,h[3]=0),{esdsConfig:h,samplerate:u[o],channelCount:d,segmentCodec:"aac",codec:"mp4a.40."+n};e.trigger(s.b.INTERNAL_ERROR,{type:r.g.MEDIA_ERROR,details:r.d.FRAG_PARSING_ERROR,fatal:!0,reason:`invalid ADTS sampling index:${o}`})}};const b={BitratesMap:[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],SamplingRateMap:[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],SamplesCoefficients:[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],BytesInSlot:[0,1,1,4],onFrame:function(e,t,i,s,r,a,n){var o=n+a*(10368e4/s);e.esSamples.push({unit:t,pts:o,dts:o}),e.len+=t.length},onNoise:function(e){a.b.warn("mpeg audio has noise: "+e.length+" bytes")()},parseFrames:function(e,t,i,s,r,a){if(i+2>s)return-1;if(255===t[i]||224==(224&t[i+1])){if(i+24>s)return-1;var n=t[i+1]>>3&3,o=t[i+1]>>1&3,l=t[i+2]>>4&15,d=t[i+2]>>2&3,h=!!(2&t[i+2]);if(1!==n&&0!==l&&15!==l&&3!==d){var c=1e3*[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160][14*(3===n?3-o:3===o?3:4)+l-1],u=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3][3*(3===n?0:2===n?1:2)+d],f=h?1:0,g=t[i+3]>>6==3?1:2,p=3===o?(3===n?12:6)*c/u+f<<2:(3===n?144:72)*c/u+f|0;return i+p>s?-1:(b.onFrame(e,t.subarray(i,i+p),c,u,g,r,a),p)}}for(var m=i+2;m<s;){if(255===t[m-1]&&224==(224&t[m]))return b.onNoise(t.subarray(i,m-1)),m-i-1;m++}return-1},parse:function(e,t,i,s){for(var r,a=t.length,n=0;i<a&&(r=b.parseFrames(e,t,i,a,n++,s))>0;)i+=r},getAudioConfig:function(e,t){let i=e[t+1]>>3&3,s=e[t+1]>>1&3,r=e[t+2]>>4&15,a=e[t+2]>>2&3,n=e[t+2]>>1&1;if(1!==i&&0!==r&&15!==r&&3!==a){let o=3===i?3-s:3===s?3:4,l=1e3*b.BitratesMap[14*o+r-1],d=3===i?0:2===i?1:2,h=b.SamplingRateMap[3*d+a],c=e[t+3]>>6==3?1:2,u=b.SamplesCoefficients[i][s],f=b.BytesInSlot[s];return{segmentCodec:"mp3",codec:"mp3",samplerate:h,channelCount:c,frameLength:parseInt(u*l/h+n,10)*f}}},isHeaderPattern:function(e,t){return 255===e[t]&&224==(224&e[t+1])&&0!=(6&e[t+1])},probe:function(e,t){if(t+1<e.length&&b.isHeaderPattern(e,t)){let i=4,s=b.getAudioConfig(e,t),r=i;s&&s.frameLength&&(r=s.frameLength);let a=t+r;if(a===e.length||a+1<e.length&&b.isHeaderPattern(e,a))return!0}return!1}};var T=b,S=i(4),I=i(3);class E{static getTrack(e,t,i,s){let r;switch(I.b.getSegmentCodec(i)){case"aac":{let a;(a=1===s?v.getAudioConfig(e,new Uint8Array([255,241,92,64,1,127,252]),0,i):v.getAudioConfig(e,new Uint8Array([255,241,92,128,1,191,252]),0,i))&&(r={type:"audio",info:{id:t,timescale:a.samplerate,duration:0,encrypted:!1,decryptdata:void 0},config:a})}break;case"ac3":case"ec3":{let i;(i=y.getAudioConfig(e,new Uint8Array([11,119,69,17,128,64,47,132]),0))&&(r={type:"audio",info:{id:t,timescale:i.samplerate,duration:0,encrypted:!1,decryptdata:void 0},config:i})}}return r}static getSample(e,t){let i;switch(e){case"mp4a.40.2":case"mp4a.40.5":i=1===t?new Uint8Array([0,208,0,7]):new Uint8Array([33,0,3,64,104,28]);break;case"ac-3":case"ec-3":i=new Uint8Array([11,119,69,17,128,64,47,132,41,3,253,214,124,253,243,215,233,95,185,123,78,20,40,106,97,190,74,253,43,218,208,140,191,176,144,120,214,181,44,124,129,251,91,109,187,109,198,225,43,172,116,140,176,123,38,144,211,247,225,64,29,53,175,96,16,57,121,87,78,203,81,37,7,72,228,132,37,169,38,231,97,229,247,194,208,8,12,83,74,139,137,17,22,26,221,203,107,113,94,93,75,33,208,247,146,105,39,143,6,36,1,227,108,70,11,180,152,218,182,218,209,59,85,104,201,70,37,82,219,68,55,225,144,99,149,0,119,26,14,69,164,241,204,222,81,177,142,80,20,100,97,143,101,221,140,113,31,208,124,25,64,29,49,77,140,30,155,74,214,204,138,229,109,172,95,130,70,230,134,88,59,179,212,155,232,0,0,0,0,0,173,234])}return i}static getSegment(e,t,i,s){let r=E.getSample(e.config.codec,e.config.channelCount);if(!r)return;let a=[],n={id:e.info.id,sequenceNumber:t,type:"audio",encrypted:!1,samples:a,defaultPerSampleIVSize:0},o=I.a[e.config.segmentCodec],l=Math.ceil(s*e.info.timescale/o),d=0,h=l*r.byteLength+8,c=new Uint8Array(h);c[0]=h>>24&255,c[1]=h>>16&255,c[2]=h>>8&255,c[3]=255&h,S.a.types||S.a.init(),c.set(S.a.types.mdat,4),d+=8;for(var u=0;u<l;u++)a.push({duration:o,size:r.byteLength,cts:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1,isNonSync:0,paddingValue:0}}),c.set(r,d),d+=r.byteLength;let f=S.a.moof(i,n),g=new Uint8Array(f.byteLength+c.byteLength);return g.set(f),g.set(c,f.byteLength),g}}var _=E;i(17),i(6);const R={bin2str:e=>String.fromCharCode.apply(null,e),readUint16(e,t){const i=e[t]<<8|e[t+1];return i<0?65536+i:i},readSint32:(e,t)=>e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3],readUint32(e,t){const i=R.readSint32(e,t);return i<0?4294967296+i:i},writeUint32(e,t,i){e[t]=i>>24,e[t+1]=i>>16&255,e[t+2]=i>>8&255,e[t+3]=255&i},findBox(e,t){let i,s,r,a,n,o=[];if(!t.length)return[];for(i=0;i<e.byteLength;)s=R.readUint32(e,i),r=R.bin2str(e.subarray(i+4,i+8)),a=s>1?i+s:e.byteLength,r===t[0]&&(1===t.length?o.push(e.subarray(i+8,a)):(n=R.findBox(e.subarray(i+8,a),t.slice(1))).length&&(o=o.concat(n))),i=a;return o},findBoxWithOffset(e,t,i,s){let r,a,n,o,l,d=[];if(!i.length)return[];for(r=0;r<e.byteLength;)a=R.readUint32(e,r),n=R.bin2str(e.subarray(r+4,r+8)),o=a>1?r+a:e.byteLength,n===i[0]&&(s&&s.push({offset:r+t,type:n,size:a}),1===i.length?d.push({offset:r+t,type:n,data:e.subarray(r+8,o),boxSize:a,walkedPath:s?s.slice(0):void 0}):(l=R.findBoxWithOffset(e.subarray(r+8,o),r+t+8,i.slice(1),s?s.slice(0):void 0)).length&&(d=d.concat(l),s=s?s.slice(0,-1):void 0)),r=o;return d}};class D extends g{constructor(e,t){super(e,t)}static _isCommonEncryptionInternal(e){return Boolean(e&&!("NONE"===e||"AES-128"===e))}static remuxInitSegment(e,t,i){if(!t)return e;let s=e;if(D._isCommonEncryptionInternal(t.method)){let r=t.keyId,n=!1,o=[];R.findBoxWithOffset(e,0,["moov","trak"]).forEach(s=>{let l,d,h=s.data,c=0,u=R.findBoxWithOffset(h,0,["mdia","minf","stbl","stsd"],[])[0],f=u.data.subarray(8),g=null,p=R.findBoxWithOffset(f,u.offset+16,["enca"])[0];p?(g=p.data.subarray(28),d="audio",c=u.offset+16+8+28):(p=R.findBoxWithOffset(f,u.offset+16,["encv"])[0])&&(g=p.data.subarray(78),d="video",c=u.offset+16+8+78),g&&R.findBoxWithOffset(g,c,["sinf"]).forEach(e=>{let s=e.data,o=R.findBox(s,["frma"])[0],c=R.findBox(s,["schm"])[0];if(!o)return void a.b.error("missing frma box")();if(!c)return void a.b.error("missing schm box")();let f=R.bin2str(c.subarray(4,8));if("aac "===R.bin2str(o.subarray(0,4))&&(S.a.types||S.a.init(),a.b.info("found frma with type 'aac ', patching to 'mp4a'")(),o.set(S.a.types.mp4a,0)),"cbcs"===f||"cenc"===f){i&&i.push(s);let e=R.findBox(s,["schi","tenc"])[0];if(e){const i=8;e.subarray(i,i+16).find((function(e){return 0!==e})),e.set(r,i);let s=e[6],a=e[7];if(1===s&&0===a){let i=e[24];i>0&&t.iv&&i===t.iv.length&&e.set(t.iv,25)}}}else if("cbc2"===f){n=!0,S.a.types||S.a.init();let i=R.findBoxWithOffset(s,0,["frma"])[0],r=S.a.box(S.a.types.schi,S.a.tenc(t,d)),a=S.a.box(S.a.types.sinf,s.subarray(i.offset,i.boxSize),S.a.schm(),r),o=(l=S.a.box(S.a.types.trak,h.subarray(0,e.offset),a,h.subarray(e.offset+e.boxSize))).subarray(8),c=a.byteLength-e.boxSize;u.walkedPath&&(u.walkedPath.push({type:"stsd",offset:p.offset,size:p.boxSize}),u.walkedPath.forEach(e=>{R.writeUint32(o,e.offset,e.size+c)}))}});let m=R.findBoxWithOffset(h,0,["edts"])[0];m&&(S.a.types||S.a.init(),h.set(S.a.types.free,m.offset+4)),l||(l=e.subarray(s.offset,s.offset+s.boxSize)),o.push(l)}),n&&(s=D.remuxCbc2InitSegment(e,o)||e)}return s}static remuxCbc2InitSegment(e,t){let i=R.findBoxWithOffset(e,0,["ftyp"])[0];if(!i)return void a.b.error("no ftyp found")();let s=R.findBoxWithOffset(e,i.boxSize,["moov"])[0],r=[],n=0;for(;n<s.data.byteLength;){let e=R.readUint32(s.data,n),i=R.bin2str(s.data.subarray(n+4,n+8)),a=e>1?n+e:s.data.byteLength;switch(i){case"trak":t&&(r=r.concat(t),t=void 0);break;default:r.push(s.data.subarray(n,a))}n=a}let o=S.a.box(S.a.types.moov,...r),l=new Uint8Array(i.boxSize+o.byteLength);return l.set(e.subarray(0,i.boxSize)),l.set(o,i.boxSize),l}static remuxOverflowSegment(e){S.a.types||S.a.init();let t,i=R.findBoxWithOffset(e,0,["moof","traf","tfdt"],[]),s=e.byteLength;if(i.forEach(e=>{0===e.data[0]&&(s+=4)}),s>e.byteLength){t=new Uint8Array(s);let i=0,r=0;for(;r<e.byteLength;){let s=R.readUint32(e,r),a=R.bin2str(e.subarray(r+4,r+8)),n=s>1?r+s:e.byteLength;if("moof"===a){let s=D.remuxOverflowMoof(e.subarray(r+8,n));t.set(s,i),i+=s.byteLength}else t.set(e.subarray(r,n),i),i+=s;r=n}}else a.b.warn("no increase in size")();return t||e}static remuxOverflowMoof(e){let t=0,i=[];for(;t<e.byteLength;){let s=R.readUint32(e,t);if("traf"===R.bin2str(e.subarray(t+4,t+8))){let r=D.remuxOverflowTraf(e.subarray(t+8,t+s));i.push(r)}else i.push(e.subarray(t,t+s));t=s>1?t+s:e.byteLength}let s=S.a.box(S.a.types.moof,...i),r=s.byteLength-e.byteLength-8;return R.findBoxWithOffset(s,0,["moof","traf","trun"],[]).forEach(e=>{if(0!=(1&e.data[3])){let t=R.readUint32(e.data,8);R.writeUint32(e.data,8,t+r)}}),s}static remuxOverflowTraf(e){let t=0,i=[];for(;t<e.byteLength;){let s=R.readUint32(e,t);if("tfdt"===R.bin2str(e.subarray(t+4,t+8))&&0===e[t+8]){let s=R.readUint32(e,t+12),r=S.a.box(S.a.types.tfdt,new Uint8Array([1,0,0,0,0,0,0,0,s>>24,s>>16&255,s>>8&255,255&s]));i.push(r)}else i.push(e.subarray(t,t+s));t=s>1?t+s:e.byteLength}return S.a.box(S.a.types.traf,...i)}remuxText(e){e.captionSamples.sort((function(e,t){return e.pts-t.pts})),e.captionSamples.length&&this.observer.trigger(s.b.FRAG_PARSING_CAPTIONDATA,{samples:e.captionSamples}),e.captionSamples=[]}remuxIFrame(e,t,i,r,a){if(!t.samples||!t.samples.length||!t.samples[0].data)return;var n=this.observer;let o,l,d=S.a.moof(e*t.timescale,t),h=new Uint8Array(d.byteLength+t.samples[0].data.byteLength+8);h.set(d),R.writeUint32(h,d.byteLength,t.samples[0].data.byteLength+8),h.set(S.a.types.mdat,d.byteLength+4),h.set(t.samples[0].data,d.byteLength+8),t.sequenceNumber++,i?(l="audiovideo",i.sequenceNumber=t.sequenceNumber,t.sequenceNumber++,o=_.getSegment(i,i.sequenceNumber,e*i.info.timescale,r)):l="video";let c={data1:h,data2:o,startPTS:e,startDTS:e,type:l,dropped:0,track:a};n.trigger(s.b.FRAG_PARSING_DATA,c),n.trigger(s.b.FRAG_PARSED)}remuxRawData(e,t,i,r,a,n){const o=this.observer;let l;e>0&&t>0?l="audiovideo":e>0?l="audio":t>0&&(l="video");let d=Math.max(t,e),h={data1:a,track:n,startPTS:r,startDTS:r,endPTS:r+d,endDTS:r+d,type:l,dropped:0};o.trigger(s.b.FRAG_PARSING_DATA,h),i&&i.captionSamples.length&&this.remuxText(i),o.trigger(s.b.FRAG_PARSED)}remuxEmsg(e,t,i,r,a){let n=this.observer,o="";e&&(o+="audio"),t&&(o+="video"),n.trigger(s.b.FRAG_PARSING_DATA,{data1:a,startPTS:r,startDTS:r,type:o,nb:1,dropped:0}),i&&i.id3Samples.length>0&&(this.remuxID3(i),this.emitId3Samples(i)),n.trigger(s.b.FRAG_PARSED)}emitId3Samples(e){e.id3Samples.length&&this.observer.trigger(s.b.FRAG_PARSING_METADATA,{samples:e.id3Samples})}remuxID3(e){let t;const i=e.id3Samples.length;if(i)for(let s=0;s<i;s++)(t=e.id3Samples[s]).pts=t.pts-10,t.dts=t.dts-10}}var A=D;const L=Math.pow(2,32)-1,w=Math.pow(2,20)-1,k=1e6;class C extends u{constructor(e,t,i,s,r){super(e,t,i,{},r),this.mp4Remuxer=t,this.audioPrimingDelay=i.audioPrimingDelay,this.audioPrimingDelay}resetTimeStamp(e){isNaN(e)?this.initPtsTs=void 0:this.initData.audio&&!this.initData.video?(this.initPtsTs={baseTime:Math.round(e*this.initData.audio.timescale/9e4),timescale:this.initData.audio.timescale},this.logger.info(`resetting audio track initPTS: ${this.initPtsTs.baseTime}/${this.initPtsTs.timescale}, seconds: ${this.initPtsTs.baseTime/this.initPtsTs.timescale}`)()):this.initPtsTs={baseTime:e,timescale:9e4}}static isHEVCFlavor(e){if(!e)return!1;let t=e.indexOf("."),i=t<0?e:e.substring(0,t);return"hvc1"===i||"hev1"===i||"chvc"===i||"qhvc"===i||"qhev"===i||"muxa"===i||"dvh1"===i||"dvhe"===i||"cdh1"===i||"qdh1"===i||"qdhe"===i}resetInitSegment(e,t,i){if(this._silentAudioTrack=void 0,e&&e.byteLength){let r=A.remuxInitSegment(e,i);const a=this.initData=C.parseInitSegment(r);let n;a.foundLargeTimescale&&this.logger.warn("large timescale found, will check for 32 bit tfdts")();const o=a.audioCodec,l=a.videoCodec;if(a.audio&&a.video?n={type:"audiovideo",container:"video/mp4",codec:o+","+l,initSegment:r}:(a.audio&&o&&(n={type:"audio",container:"audio/mp4",codec:o,initSegment:r}),a.video&&l&&(n={type:"video",container:"video/mp4",codec:l,initSegment:r})),a.video){const i=a.video,s=e.subarray(i.trakOffset,i.trakOffset+i.trakSize);this._videoTrack=Object.assign(Object.assign({},i),{info:{id:i.id,timescale:i.timescale,duration:t},trakData:s,sequenceNumber:0,samples:[]}),this.trySEICaptions=!0,this._captionTrack=Object.assign(Object.assign({},a.caption),{sequenceNumber:0,captionSamples:[]})}a.audio&&o&&(this._audioTrack=Object.assign({},a.audio)),a.caption&&(this.trySEICaptions=!1,this._captionTrack=Object.assign(Object.assign({},a.caption),{sequenceNumber:0,captionSamples:[]})),this.remuxedInitDataTrack=n;let d={track:n};this.observer.trigger(s.b.FRAG_PARSING_INIT_SEGMENT,d)}}static probe(e){return R.findBox(e.subarray(0,Math.min(e.length,512e3)),["moof"]).length>0}static parseHvcC(e){let t;if(e){let i=e[0];if(1===i){let i=e[1];t={profileSpace:i>>6,tierFlag:(32&i)>>5?"H":"L",profileIDC:31&i,profileCompat:R.readUint32(e,2),constraintIndicator:e.subarray(6,12),levelIDC:e[12]}}else a.b.warn(`Unhandled version ${i} in hvcC box`)()}else a.b.warn("No hvcC box")();return t}static hvcCToCodecString(e,t){let i=e+"."+(t.profileSpace?String.fromCharCode(t.profileSpace+"A"-1):"")+t.profileIDC+"."+t.profileCompat.toString(16).toUpperCase()+"."+t.tierFlag+t.levelIDC,s="";for(let e=t.constraintIndicator.length-1;e>=0;--e){let i=t.constraintIndicator[e];if(0!==i||""!==s){let e=i.toString(16).toUpperCase();s="."+(""===s?e:e+s)}}return i+s}static parseDvcC(e){let t;return e?t={versionMajor:e[0],versionMinor:e[1],profile:e[2]>>1&127,level:e[2]<<5&32|e[3]>>3&31}:a.b.warn("No dvcC box")(),t}static dvcCToCodecString(e,t){return e+"."+(t.profile<10?"0"+t.profile:t.profile)+"."+(t.level<10?"0"+t.level:t.level)}static parseVpcC(e){let t;return e?t={profile:e[4],level:e[5],bitDepth:e[6]>>4&15}:a.b.warn("No vpcC box")(),t}static vpcCToCodecString(e,t){return e+"."+(t.profile<10?"0"+t.profile:t.profile)+"."+(t.level<10?"0"+t.level:t.level)+"."+t.bitDepth}static parseInitSegment(e){let t={foundLargeTimescale:!1,tracksById:{}};return R.findBoxWithOffset(e,0,["moov","trak"]).forEach(e=>{let i=e.data;const s=R.findBox(i,["tkhd"])[0];if(s){let r=s[0],a=0===r?12:20,n=R.readUint32(s,a);const o=R.findBox(i,["mdia","mdhd"])[0];if(o){let s=0===(r=o[0])?12:20;const a=R.readUint32(o,s);s+=4,a>=k&&(t.foundLargeTimescale=!0);let l=0===r?R.readUint32(o,s):0;const d=R.findBox(i,["mdia","hdlr"])[0];if(d){const s=R.bin2str(d.subarray(8,12));let r={soun:"audio",vide:"video",clcp:"caption"}[s]||s;if(r){let s,o=R.findBox(i,["mdia","minf","stbl","stsd"]);if(o.length){let i=o[0];s=R.bin2str(i.subarray(12,16));const d=C.parseStsd(i);let h;if("caption"===r){let e=Object.assign({id:n,type:r,timescale:a,duration:l,isTimingTrack:!1,sequenceNumber:0,captionSamples:[]},d);t.caption=e,h=e}else{let i=Object.assign({id:n,type:r,timescale:a,duration:l,isTimingTrack:!0,trakOffset:e.offset,trakSize:e.boxSize,sequenceNumber:0,samples:[],fragmentDuration:0},d);"video"===r?(t.video=i,t.videoCodec=i.codec):(t.audio=i,t.audioCodec=i.codec),h=i}t.tracksById[n]=h}}}}}}),t}static parseStsd(e){let t,i,s;const r=e.subarray(8);let a,n=R.bin2str(r.subarray(4,8)),o=null,l=null;"enca"===n?l=(o=R.findBox(r,["enca"])[0]).subarray(28):"encv"===n&&(l=(o=R.findBox(r,["encv"])[0]).subarray(78)),t=!!l,i=0,l&&R.findBox(l,["sinf"]).forEach(e=>{let t=R.findBox(e,["schm"])[0];if(t){let s=R.bin2str(t.subarray(4,8));if("cbcs"===s||"cenc"===s){let t=R.findBox(e,["frma"])[0];t&&(n=R.bin2str(t));let s=R.findBox(e,["schi","tenc"])[0];s&&(i=s[7])}}});let d=r.subarray(86);switch(n){case"mp4a":s="mp4a.40.5";break;case"ac-3":case"ec-3":s=n;break;case"avc1":case"avc3":s=n+".640028";break;case"hvc1":case"hev1":let e=R.findBox(d,["hvcC"])[0];s=(a=C.parseHvcC(e))?C.hvcCToCodecString(n,a):n+".2.4.H150.B0";break;case"dvh1":case"dvhe":let t=R.findBox(d,["dvcC"])[0];s=(a=C.parseDvcC(t))?C.dvcCToCodecString(n,a):n+".05.01";break;case"c608":s=n;break;case"vp09":let i=R.findBox(d,["vpcC"])[0];a=C.parseVpcC(i),s=C.vpcCToCodecString(n,a);break;default:s=n}return{codec:s,encrypted:t,defaultPerSampleIVSize:i}}static has32BitTfdts(e){let t=!1;return R.findBox(e,["moof","traf","tfdt"]).forEach(e=>{0===e[0]&&(t=!0)}),t}static getStartDtsTs(e,t){let i,s=R.findBox(t,["moof","traf"]),r=Number.MAX_SAFE_INTEGER;return s.map((function(t){return R.findBox(t,["tfhd"]).forEach(s=>{const n=R.readUint32(s,4),o=e.tracksById[n];let l,d;if(!o)return;if(!o.isTimingTrack)return 1/0;l=o.timescale||9e4;let h=R.findBox(t,["tfdt"]).map((function(e){var t,i;return t=e[0],i=R.readUint32(e,4),1===t&&(i>w&&a.b.warn(`Value larger than can be represented by float for upper 32 bits ${i}`)(),i*=Math.pow(2,32),i+=R.readUint32(e,8)),i}));d=h.length>0?h[0]:1/0,isFinite(d)&&d/l<r&&(r=d/l,i={baseTime:d,timescale:l})})})),i}static offsetStartDTS(e,t,i,s){R.findBox(t,["moof","traf"]).map((function(t){return R.findBox(t,["tfhd"]).map((function(r){const n=R.readUint32(r,4),o=e.tracksById[n];if(!o)return;var l=o.timescale||9e4;let d="caption"===o.type?0:s;R.findBox(t,["tfdt"]).map((function(e){var t=e[0];const s=o.type;if(0===t){let t=R.readUint32(e,4)-Math.round(i.baseTime*l/i.timescale);"video"===s&&t<0&&(a.b.warn(`video tdft would have gone negative by ${t/l} seconds`)(),t=0),t+=Math.round(d*l),t=Math.max(t,0),R.writeUint32(e,4,t)}else{let t=R.readUint32(e,4);t>w&&a.b.error(`baseMediaDecodeTime larger than can be represented by float for upper 32 bits ${t}`)();let r=t;r*=Math.pow(2,32),r+=R.readUint32(e,8),r-=Math.round(i.baseTime*l/i.timescale),"video"===s&&r<0&&(a.b.warn(`video tdft would have gone negative by ${r/l} seconds`)(),r=0),r+=Math.round(d*l),r=Math.max(r,0);const n=Math.floor(r/(L+1)),o=Math.floor(r%(L+1));R.writeUint32(e,4,n),R.writeUint32(e,8,o)}}))}))}))}static writeStartDTS(e,t,i){R.findBox(t,["moof","traf"]).map((function(t){return R.findBox(t,["tfhd"]).map((function(s){let r=R.readUint32(s,4),n=e.tracksById[r];if(!n)return;let o=n.timescale||9e4,l=Math.round(i*o)/o;Math.abs(l-i)>.01&&a.b.warn(`[iframes] large rounding error when adjusting timestamps, startDTS: ${i}, roundedStartDTS: ${l}`)(),R.findBox(t,["tfdt"]).map((function(e){if(0===e[0])R.writeUint32(e,4,l*o);else{let t=l*o;t=Math.max(t,0);const i=Math.floor(t/(L+1)),s=Math.floor(t%(L+1));R.writeUint32(e,4,i),R.writeUint32(e,8,s)}}))}))}))}static parseSAIO(e){let t=0,i=0,s=e[0];i+=4,0!=(1&R.readUint32(e,0))&&(i+=8);let r=16777215&R.readUint32(e,i);return 1===r?(i+=4,t=R.readUint32(e,i),1===s&&(i+=4,t*=Math.pow(2,32),t+=R.readUint32(e,i))):a.b.error(`saio entry count error, count is: ${r}`)(),t}static parseSAIZ(e){let t=0,i=0;return i+=4,0!=(1&R.readUint32(e,0))&&(i+=8),t=e[i],i++,i+=4,0===t&&(t=e[i]),t}static parseSubsample(e,t){let i={subsamples:[]},s=0;for(e&&(i.iv=t.subarray(0,e),s+=e),s+=2;s+6<=t.byteLength;){let e=R.readUint16(t,s);s+=2;let r=R.readUint32(t,s);s+=4,i.subsamples.push([e,r])}return i}static isSEIMessage(e,t){return e?39===t||40===t:6===t}static parseCLCPSample(e,t,i){let s=0,r=[],a=0;for(;s<i;){let i=t+s,o=R.readUint32(e,i);i+=4;let l=R.bin2str(e.subarray(i,i+4));if(i+=4,"cdat"!==l)break;{let t=o-8;var n=e.subarray(i,i+t);a+=t,r.push(n),s+=o}}return{cdatList:r,cdatTotalSize:a}}static parseSamples(e,t,i,s,r,n){let o,l=i.timescale,d=i.id,h=e,c=0,u=!1;R.findBoxWithOffset(t,0,["moof"]).map((function(e){var f=e.data,g=e.offset;R.findBox(f,["traf"]).map((function(e){let f=R.findBox(e,["tfdt"]).map((function(e){var t,i;return t=e[0],i=R.readUint32(e,4),1===t&&(i*=Math.pow(2,32),i+=R.readUint32(e,8)),i/l}))[0];return void 0!==f&&(h=f),R.findBox(e,["tfhd"]).map((function(f){let p=R.readUint32(f,4),m=16777215&R.readUint32(f,0),y=0,v=0!=(2&m),b=0,T=0!=(8&m),S=0,I=0!=(16&m),E=0,_=0!=(32&m),D=0,A=8;if(p===d){if(0!=(1&m)){y=R.readUint32(f,A),A+=4;let e=R.readUint32(f,A);A+=4,0!==e&&a.b.info("tfhd baseDataOffset has 64-bit value. Caption should be turned off")()}if(v&&(b=R.readUint32(f,A),A+=4),T&&(S=R.readUint32(f,A),A+=4),I&&(E=R.readUint32(f,A),A+=4),_&&(D=R.readUint32(f,A),A+=4),"video"===i.type){let s=0,r=0;R.findBox(e,["saio"]).map((function(e){s=C.parseSAIO(e)})),R.findBox(e,["saiz"]).map((function(e){r=C.parseSAIZ(e)})),s&&r&&(o=C.parseSubsample(i.defaultPerSampleIVSize,t.subarray(s,s+r))),u=C.isHEVCFlavor(i.codec)}R.findBox(e,["trun"]).map((function(e){let a=e[0],d=16777215&R.readUint32(e,0),f=0!=(1&d),p=0,m=0!=(4&d),y=0!=(256&d),v=0,b=0!=(512&d),T=0,I=0!=(1024&d),_=0!=(2048&d),D=0,A=R.readUint32(e,4),L=8;f&&(p=R.readUint32(e,L),L+=4),m&&(L+=4);let w=p+g;for(let d=0;d<A&&(n<0||c<n);d++){if(y?(v=R.readUint32(e,L),L+=4):v=S,b?(T=R.readUint32(e,L),L+=4):T=E,I&&(L+=4),_&&(D=0===a?R.readUint32(e,L):R.readSint32(e,L),L+=4),"video"===i.type)if(isNaN(s)){if(i.fragmentDuration+=v,r){let e=0;for(;e<T;){let s=R.readUint32(t,w),r=31&t[w+=4];if(i.seiSamples||(i.seiSamples=[]),C.isSEIMessage(u,r)){var k=t.subarray(w,w+s);i.seiSamples.push({pts:h+D/l,type:r,data:k,sampleOffset:w,naluSize:s})}w+=s,e+=s+4}}}else i.samples.push({data:t.subarray(w,w+T),size:T,duration:s*l,cts:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:2,isNonSync:0,paddingValue:0},subsamples:o?o.subsamples:[],iv:o?o.iv:void 0});else if("audio"===i.type)i.fragmentDuration+=v;else if("caption"===i.type){let{cdatList:e,cdatTotalSize:s}=C.parseCLCPSample(t,w,T);if(w+=T,e.length){let t;if(1===e.length)t=new Uint8Array(e[0]);else if(e.length>1){let i=0;t=new Uint8Array(s);for(const s of e)t.set(s,i),i+=s.length}i.captionSamples.push({type:3,pts:h,bytes:t})}}c++,h+=v/l}}))}}))}))}))}static parseEmsg(e){let t,i,s,r,n,o,l="",d="",h=0;if(0===e[0]){for(;"\0"!==R.bin2str(e.subarray(h,h+1));)l+=R.bin2str(e.subarray(h,h+1)),h+=1;for(l+=R.bin2str(e.subarray(h,h+1)),h+=1;"\0"!==R.bin2str(e.subarray(h,h+1));)d+=R.bin2str(e.subarray(h,h+1)),h+=1;d+=R.bin2str(e.subarray(h,h+1)),h+=1,t=R.readUint32(e,12),i=R.readUint32(e,16),r=R.readUint32(e,20),n=R.readUint32(e,24),h=28}else{h+=4,t=R.readUint32(e,h),h+=4;let i=R.readUint32(e,h);h+=4;let o=R.readUint32(e,h);for(h+=4,s=Math.pow(2,32)*i+o,Number.isSafeInteger(s)||(s=Number.MAX_SAFE_INTEGER,a.b.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")()),r=R.readUint32(e,h),h+=4,n=R.readUint32(e,h),h+=4;"\0"!==R.bin2str(e.subarray(h,h+1));)l+=R.bin2str(e.subarray(h,h+1)),h+=1;for(l+=R.bin2str(e.subarray(h,h+1)),h+=1;"\0"!==R.bin2str(e.subarray(h,h+1));)d+=R.bin2str(e.subarray(h,h+1)),h+=1;d+=R.bin2str(e.subarray(h,h+1)),h+=1}return{schemeIdUri:l,value:d,timeScale:t,presentationTime:s,presentationTimeDelta:i,eventDuration:r,id:n,payload:o=e.subarray(h,e.byteLength)}}static extractID3PayloadCreateID3Track(e,t,i){const s=new l(e.payload);let r,n=new Uint8Array(e.payload),o=n.byteLength,d=0,h=0;if(r=isNaN(e.presentationTime)?t+e.presentationTimeDelta/e.timeScale:e.presentationTime/e.timeScale,isNaN(r))return void a.b.error("No pts found in emsg info when extracting ID3 payload")();let c=e.eventDuration,u=n.subarray(0,10),f=R.bin2str(u.subarray(h,h+3));h+=3,"ID3"!==f&&a.b.error("No ID3 tag found when extracting ID3 payload")(),h+=2;let g=n.subarray(h,h+1),p=(g[0],64&g[0]),m=16&g[0];if(h+=1,l.readSynchSafeUint32(n.subarray(h,h+4)),h+=4,p){let e=l.readSynchSafeUint32(n.subarray(h,h+4));h+=4,h+=e}for(;h+2<o;){let e="";e+=R.bin2str(n.subarray(h,h+4)),h+=4;let t=l.readSynchSafeUint32(n.subarray(h,h+4));h+=4;let o=r+d*c,u={data:n,pts:o,dts:o,decryptdata:void 0,frames:s.frames};i.id3Samples.push(u),h+=t,d++,m&&("DI3"!==R.bin2str(n.subarray(h,h+3))&&a.b.error("End should be DI3 if footer present in extracting ID3 payload")(),h+=3,h+=7)}h+2===o&&0!==R.readUint16(n,h)&&a.b.warn("Padding should be 0 when extracting ID3 payload")()}append(e,t,i,a,n,o,l){let d=this.initData,h=0,c=0;void 0===d&&(this.resetInitSegment(e,0),d=this.initData);let u,f=this.initPtsTs;if(f||(u=C.getStartDtsTs(d,e),this.initPtsTs=f={baseTime:u.baseTime-Math.round(t*u.timescale),timescale:u.timescale},this.logger.info(`initPtsTs: ${f.baseTime}/${f.timescale}, sec: ${f.baseTime/f.timescale}, startDtsTs: ${u.baseTime}/${u.timescale} timeOffset: ${t}`)(),this.observer.trigger(s.b.INIT_PTS_FOUND,{initPTS90k:9e4*f.baseTime/f.timescale})),d.foundLargeTimescale&&C.has32BitTfdts(e)&&!l&&(e=A.remuxOverflowSegment(e)),l){let t=this._videoTrack.timescale;l=Math.ceil(l*t)/t,C.writeStartDTS(d,e,o)}else C.offsetStartDTS(d,e,f,this.audioPrimingDelay);u=C.getStartDtsTs(d,e);let g=R.findBox(e,["emsg"]);if(d.video&&d.video.encrypted&&!R.findBox(e,["moof","traf"]).find((function(e){return Boolean(R.findBox(e,["senc"])[0]||R.findBox(e,["saiz"])[0]&&R.findBox(e,["saio"])[0])}))&&(this.logger.warn(`Missing subsample information for encrypted content codec=${d.videoCodec}`)(),d.videoCodec&&!I.b.isAVC(d.videoCodec))){let e={type:r.g.MEDIA_ERROR,details:r.d.FRAG_PARSING_ERROR,fatal:!0,reason:"Missing subsample information for encrypted content"};this.observer.trigger(s.b.INTERNAL_ERROR,e)}else if(l){let t=(u.baseTime+this.audioPrimingDelay*u.timescale)/u.timescale;if(this._videoTrack&&this._audioTrack&&!this._silentAudioTrack){let e=_.getTrack(this.observer,this._audioTrack.id,this._audioTrack.codec,2);if(!e)throw`unable to create silent audio track for codec ${this._audioTrack.codec}`;this._silentAudioTrack=Object.assign(Object.assign({},e),{sequenceNumber:0});let t=S.a.initSegment([this._videoTrack,this._silentAudioTrack]);this.remuxedInitDataTrack={type:"audiovideo",container:"video/mp4",codec:this._silentAudioTrack.config.codec+","+this._videoTrack.codec,initSegment:t};const i={track:this.remuxedInitDataTrack};this.observer.trigger(s.b.FRAG_PARSING_INIT_SEGMENT,i)}C.parseSamples(t,e,this._videoTrack,l,!1,1),this.mp4Remuxer.remuxIFrame(t,this._videoTrack,this._silentAudioTrack,l,this.remuxedInitDataTrack),this._videoTrack.samples=[]}else if(g&&g.length>0){let i=(u.baseTime-this.audioPrimingDelay*u.timescale)/u.timescale;i=Math.max(0,i);let s=g.map(e=>{let t=C.parseEmsg(e);return"https://aomedia.org/emsg/ID3\0"!==t.schemeIdUri||this._id3Track||(this._id3Track={id3Samples:[],inputTimescale:9e4}),t});this._id3Track&&s.map(e=>{C.extractID3PayloadCreateID3Track(e,t,this._id3Track)}),this.mp4Remuxer.remuxEmsg(!!d.audio,!!d.video,this._id3Track,i,e),this._id3Track&&(this._id3Track.id3Samples=[])}else{let t=(u.baseTime-this.audioPrimingDelay*u.timescale)/u.timescale;t=Math.max(0,t),this._videoTrack&&(C.parseSamples(t,e,this._videoTrack,void 0,this.trySEICaptions,-1),h=this._videoTrack.fragmentDuration/this._videoTrack.timescale,this._videoTrack.fragmentDuration=0,this.trySEICaptions?(C.extractSEICaptionsFromNALu(this._videoTrack.seiSamples,this._captionTrack),this._videoTrack.seiSamples=[]):this._captionTrack&&C.parseSamples(t,e,this._captionTrack,void 0,!1,Number.MAX_SAFE_INTEGER)),this._audioTrack&&(C.parseSamples(t,e,this._audioTrack,void 0,!1,-1),c=this._audioTrack.fragmentDuration/this._audioTrack.timescale,this._audioTrack.fragmentDuration=0),this.mp4Remuxer.remuxRawData(c,h,this._captionTrack,t,e,this.remuxedInitDataTrack)}}static extractSEICaptionsFromNALu(e,t){if(e){for(let c=0;c<e.length;++c){let u=e[c],f=u.pts,g=0;g++;for(var i=0,s=0,r=!1,a=0;!r&&g<u.data.length;){i=0;do{if(g>=u.data.length)break;i+=a=u.data[g++]}while(255===a);s=0;do{if(g>=u.data.length)break;s+=a=u.data[g++]}while(255===a);let e=u.data.length-g;if(4===i&&g<u.data.length){if(r=!0,181===u.data[g++]){var n=R.readUint16(u.data,g);if(g+=2,49===n){var o=R.readUint32(u.data,g);if(g+=4,1195456820===o&&3===u.data[g++]){var l=u.data[g++];g++;var d=31&l,h=[];if(64&l)for(let e=0;e<d;e++){let e=u.data[g++];if(e===(252&e)){let t=3&e;if(0===t||1===t){let e=u.data[g++],t=u.data[g++];h.push(e),h.push(t)}}else g+=2}h.length>0&&t.captionSamples.push({type:3,pts:f,bytes:h})}}}}else if(s<e)g+=s;else if(s>e)break}}return t}}}var P=C,M=class{constructor(e){this.data=e,this._bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}get bytesAvailable(){return this._bytesAvailable}loadWord(){var e=this.data,t=this._bytesAvailable,i=e.byteLength-t,s=new Uint8Array(4),r=Math.min(4,t);if(0===r)throw new Error("no bytes available");s.set(e.subarray(i,i+r)),this.word=new DataView(s.buffer).getUint32(0),this.bitsAvailable=8*r,this._bytesAvailable-=r}skipBits(e){var t;this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(e-=this.bitsAvailable,e-=(t=e>>3)>>3,this._bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}readBits(e){var t=Math.min(this.bitsAvailable,e),i=this.word>>>32-t;return e>32&&a.b.error("Cannot read more than 32 bits at a time")(),this.bitsAvailable-=t,this.bitsAvailable>0?this.word<<=t:this._bytesAvailable>0&&this.loadWord(),(t=e-t)>0&&this.bitsAvailable?i<<t|this.readBits(t):i}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if(0!=(this.word&2147483648>>>e))return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){var e=this.skipLZ();return this.readBits(e+1)-1}readEG(){var e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return 1===this.readBits(1)}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}skipScalingList(e){var t,i=8,s=8;for(t=0;t<e;t++)0!==s&&(s=(i+this.readEG()+256)%256),i=0===s?i:s}readSPS(){var e,t,i,s,r,a,n,o=0,l=0,d=0,h=0,c=this.readUByte.bind(this),u=this.readBits.bind(this),f=this.readUEG.bind(this),g=this.readBoolean.bind(this),p=this.skipBits.bind(this),m=this.skipEG.bind(this),y=this.skipUEG.bind(this),v=this.skipScalingList.bind(this);if(c(),e=c(),u(5),p(3),c(),y(),100===e||110===e||122===e||244===e||44===e||83===e||86===e||118===e||128===e){var b=f();if(3===b&&p(1),y(),y(),p(1),g())for(a=3!==b?8:12,n=0;n<a;n++)g()&&v(n<6?16:64)}y();var T=f();if(0===T)f();else if(1===T)for(p(1),m(),m(),t=f(),n=0;n<t;n++)m();y(),p(1),i=f(),s=f(),0===(r=u(1))&&p(1),p(1),g()&&(o=f(),l=f(),d=f(),h=f());let S=[1,1];if(g()&&g())switch(c()){case 1:S=[1,1];break;case 2:S=[12,11];break;case 3:S=[10,11];break;case 4:S=[16,11];break;case 5:S=[40,33];break;case 6:S=[24,11];break;case 7:S=[20,11];break;case 8:S=[32,11];break;case 9:S=[80,33];break;case 10:S=[18,11];break;case 11:S=[15,11];break;case 12:S=[64,33];break;case 13:S=[160,99];break;case 14:S=[4,3];break;case 15:S=[3,2];break;case 16:S=[2,1];break;case 255:S=[c()<<8|c(),c()<<8|c()]}return{width:Math.ceil(16*(i+1)-2*o-2*l),height:(2-r)*(s+1)*16-(r?2:4)*(d+h),pixelRatio:S}}readSliceType(){return this.readUByte(),this.readUEG(),this.readUEG()}},O=class{static getSilentFrame(e,t){switch(e){case"mp4a.40.2":if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}return null}},N=class extends g{constructor(e,t,i,s){super(e,t),this.typeSupported=i;const r=navigator.userAgent;this.isSafari=s&&s.indexOf("Apple")>-1&&r&&!r.match("CriOS"),this.currentInitTrack=void 0}resetTimeStamp(e){this._initPTS=this._initDTS=e}resetInitSegment(){this.currentInitTrack=void 0,this._silentAudioTrack=void 0}remuxEsTracks(e,t,i,r,n,o,l,d,h,c){var u;let f,g=void 0===h?n:h;if(!this.currentInitTrack){if(e&&e.config.codec&&(this._audioTrackInfo={id:e.info.id,codec:e.config.codec,channelCount:e.config.channelCount}),t&&c&&this._audioTrackInfo){let e=_.getTrack(this.observer,this._audioTrackInfo.id,this._audioTrackInfo.codec,this._audioTrackInfo.channelCount);e&&(this._silentAudioTrack=Object.assign(Object.assign({},e),{info:Object.assign(Object.assign({},e.info),{inputTimescale:9e4}),parsingData:{len:0,sequenceNumber:0,esSamples:[]}}),f=_.getSegment(this._silentAudioTrack,t.parsingData.sequenceNumber,g*this._silentAudioTrack.info.timescale,c),t.parsingData.sequenceNumber++)}else this._silentAudioTrack=void 0;this.updateInitPTSDTS(t,e,n),this.generateIS(this._silentAudioTrack?this._silentAudioTrack:e,t)}if(this.currentInitTrack){let i,r,h;if(t&&c&&this._silentAudioTrack&&!f&&(f=_.getSegment(this._silentAudioTrack,t.parsingData.sequenceNumber,Math.round((g+this.config.audioPrimingDelay)*this._silentAudioTrack.info.timescale),c)),e&&e.parsingData.esSamples.length){if(isNaN(e.info.timescale)&&(a.b.warn("regenerate InitSegment as audio detected")(),this.updateInitPTSDTS(t,e,n),this.generateIS(e,t)),i=this.remuxAudio(e,g,o,l,d),t&&t.parsingData.esSamples.length){let s;i&&(s=i.endPTS-i.startPTS),isNaN(t.info.timescale)&&(a.b.warn("regenerate InitSegment as video detected")(),this.updateInitPTSDTS(t,e,n),this.generateIS(e,t)),r=this.remuxVideo(t,g,o,s,c)}}else t&&t.parsingData.esSamples.length&&(r=this.remuxVideo(t,g,o,void 0,c)),r&&e&&e.config.codec&&(i=this.remuxEmptyAudio(e,g,o,l,r,d));f?h={data1:r.data1,data2:f,startDTS:r.startDTS,startPTS:r.startPTS,type:"audiovideo",track:this.currentInitTrack}:r&&i?h={data1:r.data1,data2:i.data1,startDTS:Math.min(r.startDTS,i.startDTS),startPTS:Math.min(r.startPTS,i.startPTS),endDTS:Math.max(r.endDTS,i.endDTS),endPTS:Math.max(r.endPTS,i.endPTS),type:"audiovideo",track:this.currentInitTrack}:r?h={data1:r.data1,startDTS:r.startDTS,startPTS:r.startPTS,endDTS:r.endDTS,endPTS:r.endPTS,type:"video",track:this.currentInitTrack}:i&&(h={data1:i.data1,startDTS:i.startDTS,startPTS:i.startPTS,endDTS:i.endDTS,endPTS:i.endPTS,type:"audio",track:this.currentInitTrack}),this.observer.trigger(s.b.FRAG_PARSING_DATA,h)}else a.b.error("failed to generate IS")();(null===(u=null==i?void 0:i.id3Samples)||void 0===u?void 0:u.length)&&this.remuxID3(i,g),r&&r.captionSamples.length&&this.remuxText(r,g),this.observer.trigger(s.b.FRAG_PARSED)}updateInitPTSDTS(e,t,i){let a=1/0,n=1/0,o=e?e.parsingData.esSamples:[],l=t?t.parsingData.esSamples:[];if(isNaN(this._initPTS)){if(t&&l.length&&(a=n=l[0].pts-t.info.inputTimescale*i),e&&o.length){const t=e.info.inputTimescale;e.info.timescale=t,a=Math.min(a,o[0].pts-t*i),n=Math.min(n,o[0].dts-t*i),this.observer.trigger(s.b.INIT_PTS_FOUND,{initPTS90k:a})}if(isNaN(a)||isNaN(n)){let e={type:r.g.MEDIA_ERROR,details:r.d.FRAG_PARSING_ERROR,fatal:!1,reason:"invalid initPTS or initDTS"};this.observer.trigger(s.b.INTERNAL_ERROR,e)}else this._initPTS=a,this._initDTS=n}}generateIS(e,t){const i=this.observer,a=t?t.parsingData.esSamples:[],n=this.typeSupported;let o,l="audio/mp4";if(e&&t&&a.length){const i=t.info.inputTimescale;t.info.timescale=i,e.info.timescale=e.config.samplerate;const s=S.a.initSegment([t,e]);o={type:"audiovideo",container:"video/mp4",codec:`${t.config.codec},${e.config.codec}`,initSegment:s}}else if(e){switch(e.info.timescale=e.config.samplerate,e.config.segmentCodec){case"mp3":n.mpeg?(l="audio/mpeg",e.config.codec=""):n.mp3&&(e.config.codec="mp3")}const t="mp3"===e.config.segmentCodec&&n.mpeg?new Uint8Array:S.a.initSegment([e]);o={type:"audio",container:l,codec:e.config.codec,initSegment:t}}else if(t&&a.length){const e=t.info.inputTimescale;t.info.timescale=e;const i=S.a.initSegment([t]);o={type:"video",container:"video/mp4",codec:t.config.codec,initSegment:i}}if(o){this.currentInitTrack=o;let e={track:o};i.trigger(s.b.FRAG_PARSING_INIT_SEGMENT,e)}else{let e={type:r.g.MEDIA_ERROR,details:r.d.FRAG_PARSING_ERROR,fatal:!1,reason:"no audio/video samples found"};i.trigger(s.b.INTERNAL_ERROR,e)}}remuxVideo(e,t,i,n,o){var l,d,h,c,u,f,g,p=8,m=e.info.inputTimescale,y=e.parsingData.esSamples,v=[],b=y.length,T=this._PTSNormalize,I=this._initDTS,E=e.info.encrypted;let _;_=i?this.nextAvcDts:t*m,y.forEach((function(e){e.pts=T(e.pts-I,_),e.dts=T(e.dts-I,_)})),y.sort((function(e,t){const i=e.dts-t.dts,s=e.pts-t.pts;return i||s||e.id-t.id}));let R=y.reduce((e,t)=>Math.max(Math.min(e,t.pts-t.dts),-18e3),0);if(R<0){a.b.warn(`PTS < DTS detected in video samples, shifting DTS by ${Math.round(R/90)} ms to overcome this issue`)();for(let e=0;e<y.length;e++)y[e].dts+=R}let D=y[0];u=Math.max(D.dts,0),c=Math.max(D.pts,0),isNaN(o)||(u=t*m,c=t*m);let A=Math.round((u-_)/90);i&&A&&(u=_,y[0].dts=u,c=Math.max(c-A,_),y[0].pts=c,a.b.info(`Video/PTS/DTS adjusted: ${Math.round(c/90)}/${Math.round(u/90)},delta:${A} ms`)()),D=y[y.length-1],g=Math.max(D.dts,0),f=Math.max(D.pts,0,g),isNaN(o)||(g=t*m,f=t*m);const L=this.isSafari;L&&(l=Math.round((g-u)/(y.length-1)));let w=0,k=0;for(let e=0;e<b;e++){let t=y[e],i=t.units,s=i.length,r=0;for(let e=0;e<s;e++)r+=i[e].data.length;k+=r,w+=s,t.length=r,t.dts=L?u+e*l:Math.max(t.dts,u),t.pts=Math.max(t.pts,t.dts)}let C=k+4*w+8;try{d=new Uint8Array(C)}catch(e){let t,i={type:r.g.MUX_ERROR,details:r.d.REMUX_ALLOC_ERROR,fatal:!1,bytes:C,reason:`fail allocating video mdat ${C}`,response:r.f.InternalError};return i.level=t,void this.observer.trigger(s.b.INTERNAL_ERROR,i)}let P=new DataView(d.buffer);P.setUint32(0,C),d.set(S.a.types.mdat,4);for(let e=0;e<b;e++){let t,i=y[e],s=i.units,r=0,a=[],h=0;for(let e=0,t=s.length;e<t;e++){let t=s[e],i=t.data,n=t.data.byteLength;if(P.setUint32(p,n),p+=4,d.set(i,p),p+=n,r+=4+n,E)if(n<=48||1!==t.type&&5!==t.type)h+=4+n;else{let e=n-32;e%16==0&&(e-=16),a.push([h+36,e]),h=n-32-e}}if(h>0&&a.push([h,0]),L)t=Math.max(0,l*Math.round((i.pts-i.dts)/l));else{if(e<b-1)l=y[e+1].dts-i.dts;else{let t=this.config,s=i.dts-y[e>0?e-1:e].dts;if(t.stretchShortVideoTrack){let e=t.maxBufferHole,r=t.maxSeekHole,a=Math.floor(Math.min(e,r)*m),o=(n?c+n*m:this.nextAudioPts)-i.pts;o>a?(l=o-s)<0&&(l=s):l=s}else l=s}t=Math.round(i.pts-i.dts)}isNaN(o)||(t=0,l=o*m),v.push({size:r,duration:l,cts:t,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:i.key?2:1,isNonSync:i.key?0:1,paddingValue:0},decryptdata:i.decryptdata,subsamples:a})}this.nextAvcDts=g+l;let M=e.parsingData.dropped;if(e.parsingData.dropped=0,v.length&&navigator.userAgent.toLowerCase().indexOf("chrome")>-1){let e=v[0].flags;e.dependsOn=2,e.isNonSync=0}let O={sequenceNumber:e.parsingData.sequenceNumber++,id:e.info.id,type:e.type,encrypted:e.info.encrypted,samples:v,defaultPerSampleIVSize:0};h=S.a.moof(u+this.config.audioPrimingDelay*m,O),e.parsingData.esSamples=[];let N=new Uint8Array(h.byteLength+d.byteLength);return N.set(h),N.set(d,h.byteLength),{data1:N,startPTS:c/m,endPTS:(f+l)/m,startDTS:u/m,endDTS:this.nextAvcDts/m,type:"video",dropped:M}}remuxAudio(e,t,i,n,o){const l=e.info.inputTimescale,h=l/e.info.timescale,c=("aac"===e.config.segmentCodec?1024:"mp3"===e.config.segmentCodec?1152:1536)*h,u=this._PTSNormalize,f=this._initDTS,g="mp3"===e.config.segmentCodec&&this.typeSupported.mpeg,p=e.info.encrypted;var m,y,v,b,T,I,E,_,R,D,A,L,w,k=g?0:8,C=[],P=[];let M=new d;if(P=e.parsingData.esSamples,w=this.nextAudioPts,(i=i||P.length&&w&&(n&&Math.abs(t-w/l)<.1||Math.abs(P[0].pts-w-f)<20*c))||(w=t*l),P.forEach((function(e){e.pts=e.dts=u(e.pts-f,w)})),P.sort((function(e,t){return e.pts-t.pts})),n&&"aac"===e.config.segmentCodec)for(let t=0,i=w;t<P.length;){var N,x=P[t];N=(R=x.pts)-i;const s=Math.abs(1e3*N/l);if(N<=-c)a.b.warn(`Dropping 1 audio frame @ ${(i/l).toFixed(3)}s due to ${s} ms overlap.`)(),P.splice(t,1),e.parsingData.len-=x.unit.length;else if(N>=c&&s<1e4&&i){var F=Math.round(N/c);a.b.warn(`Injecting ${F} audio frame @ ${(i/l).toFixed(3)}s due to ${Math.round(1e3*N/l)} ms gap.`)();for(var B=0;B<F;B++)L=Math.max(i,0),(A=O.getSilentFrame(e.config.codec,e.config.channelCount))||(a.b.warn("Unable to get silent frame for given audio codec; duplicating last frame instead.")(),A=x.unit.subarray(0)),P.splice(t,0,{unit:A,pts:L,dts:L,decryptdata:o}),e.parsingData.len+=A.length,i+=c,t+=1;x.pts=x.dts=i,i+=c,t+=1}else Math.abs(N),i+=c,x.pts=x.dts=0===t?w:P[t-1].pts+c,t+=1}for(let t=0,n=P.length;t<n;t++){if(v=(m=P[t]).unit,R=m.pts,D=m.dts,void 0!==_)y.duration=Math.round((D-_)/h);else{let t=Math.round(1e3*(R-w)/l),n=0;if(i&&"aac"===e.config.segmentCodec&&t){if(t>0&&t<1e4)(n=Math.round((R-w)/c))>0&&((A=O.getSilentFrame(e.config.codec,e.config.channelCount))||(A=v.subarray(0)),e.parsingData.len+=n*A.length);else if(t<-12){e.parsingData.len-=v.byteLength;continue}R=D=w}if(I=Math.max(0,R),E=Math.max(0,D),!(e.parsingData.len>0))return;{let t=g?e.parsingData.len:e.parsingData.len+8;try{b=new Uint8Array(t)}catch(e){let i,a={type:r.g.MUX_ERROR,details:r.d.REMUX_ALLOC_ERROR,fatal:!1,bytes:t,reason:`fail allocating audio mdat ${t}`,response:r.f.InternalError};return a.level=i,void this.observer.trigger(s.b.INTERNAL_ERROR,a)}g||(new DataView(b.buffer).setUint32(0,t),b.set(S.a.types.mdat,4))}for(let t=0;t<n;t++)L=R-(n-t)*c,(A=O.getSilentFrame(e.config.codec,e.config.channelCount))||(a.b.warn("Unable to get silent frame for given audio codec; duplicating this frame instead.")(),A=v.subarray(0)),b.set(A,k),k+=A.byteLength,y={size:A.byteLength,cts:0,duration:1024,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1,paddingValue:0,isNonSync:0},decryptdata:m.decryptdata,subsamples:p?[[A.byteLength,0]]:[]},C.push(y)}b.set(v,k);let n=v.byteLength;k+=n;let o=[];if(p)if("ec3"===e.config.segmentCodec){let e=0;for(;e<v.byteLength;){let t=2*(M.bsReadAndUpdate(v,{byteOffset:e+2,usedBits:5},11)+1);e+=t;let i=Math.min(t,16);o.push([i,t-i])}}else{let e=Math.min(n,16);o.push([e,n-e])}y={size:n,cts:0,duration:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1,paddingValue:0,isNonSync:0},decryptdata:m.decryptdata,subsamples:o},C.push(y),_=D}var U=0,$=C.length;if($>=2&&(U=C[$-2].duration,y.duration=U),$){if(this.nextAudioPts=R+h*U,e.parsingData.len=0,g)T=new Uint8Array;else{let t={sequenceNumber:e.parsingData.sequenceNumber++,id:e.info.id,type:e.type,encrypted:e.info.encrypted,samples:C,defaultPerSampleIVSize:0};T=S.a.moof((E+this.config.audioPrimingDelay*l)/h,t)}let t=new Uint8Array(T.byteLength+b.byteLength);return t.set(T),t.set(b,T.byteLength),e.parsingData.esSamples=[],{data1:t,startPTS:I/l,endPTS:this.nextAudioPts/l,startDTS:E/l,endDTS:(D+h*U)/l,type:"audio"}}return null}remuxEmptyAudio(e,t,i,s,r,n){let o=e.info.inputTimescale,l=o/(e.config.samplerate?e.config.samplerate:o),d=this.nextAudioPts,h=(void 0!==d?d:r.startDTS*o)+this._initDTS,c=r.endDTS*o+this._initDTS,u=1024*l,f=Math.ceil((c-h)/u),g=O.getSilentFrame(e.config.codec,e.config.channelCount);if(a.b.warn("remux empty Audio")(),!g)return void a.b.error("Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec!")();let p=[];for(var m=0;m<f;m++){var y=h+m*u;p.push({unit:g,pts:y,dts:y,decryptdata:n}),e.parsingData.len+=g.length}e.parsingData.esSamples=p,this.remuxAudio(e,t,i,s,n)}remuxID3(e,t){var i,r=e.id3Samples.length;const a=e.inputTimescale,n=this._initPTS,o=this._initDTS;if(r){for(var l=0;l<r;l++)(i=e.id3Samples[l]).pts=(i.pts-n)/a,i.dts=(i.dts-o)/a;this.observer.trigger(s.b.FRAG_PARSING_METADATA,{samples:e.id3Samples})}e.id3Samples=[]}remuxText(e,t){e.captionSamples.sort((function(e,t){return e.pts-t.pts}));var i,r=e.captionSamples.length;const a=e.inputTimescale,n=this._initPTS;if(r){for(var o=0;o<r;o++)(i=e.captionSamples[o]).pts=(i.pts-n)/a;this.observer.trigger(s.b.FRAG_PARSING_USERDATA,{samples:e.captionSamples})}e.captionSamples=[]}_PTSNormalize(e,t){var i;if(void 0===t)return e;for(i=t<e?-8589934592:8589934592;Math.abs(e-t)>4294967296;)e+=i;return e}};t.a=class{constructor(e,t,i,s){this.observer=e,this.typeSupported=t,this.config=i,this.vendor=s,this.logger=new a.a,this.logger.enable(i.debug,i.debugLevel)}destroy(){var e=this.demuxer;e&&e.destroy()}push(e,t,i,n,o,u,g,p,m,b,S,I){var E=this.demuxer;i=new Uint8Array(i);const _=new Uint8Array(e);if(!E||(o||u)&&!this.probeFn(_)){const{observer:e,typeSupported:t,config:i}=this,n=[{demux:class extends f{constructor(e,t,i,s,r){super(e,t,i,s,r)}static probe(e){return e.length>=564&&71===e[0]&&71===e[188]&&71===e[376]}resetInitSegment(e,t,i){this.pmtParsed=!1,this._pmtId=-1;const s={id:-1,inputTimescale:9e4,timescale:NaN,duration:0,encrypted:i&&i.isEncrypted,decryptdata:i},r={len:0,sequenceNumber:0};this._avcContext={info:Object.assign({},s),parsingData:Object.assign(Object.assign({},r),{esSamples:new Array,dropped:0}),config:{},container:"video/mp2t",type:"video"},this._audioContext={info:Object.assign({},s),parsingData:Object.assign(Object.assign({},r),{esSamples:new Array}),container:"video/mp2t",type:"audio"},this._id3Track={id:-1,inputTimescale:9e4,id3Samples:[]},this._txtTrack={inputTimescale:9e4,captionSamples:[]},this._duration=t,this._initSegment=e}append(e,t,i,a,n,o,l){var d,h,c,u,f,g=!1;this.contiguous=i;var p=this.pmtParsed,m=this._avcContext,y=this._audioContext,v=this._id3Track,b=m.info.id,T=y.info.id,S=v.id,I=this._pmtId,E=m.pesData,_=y.pesData,R=v.pesData;if(this.iframeMode=void 0!==l,this._initSegment&&this._initSegment.byteLength>0){let t=new Uint8Array(this._initSegment.byteLength+e.byteLength);t.set(this._initSegment),t.set(e,this._initSegment.byteLength),this._initSegment=void 0,e=t}let D,A,L=e.length;for(L-=L%188,d=0;d<L;d+=188){if(71!==e[d]){let e={type:r.g.MEDIA_ERROR,details:r.d.FRAG_PARSING_ERROR,fatal:!1,reason:"TS packet did not start with 0x47"};return void this.observer.trigger(s.b.INTERNAL_ERROR,e)}if(h=!!(64&e[d+1]),c=((31&e[d+1])<<8)+e[d+2],(48&e[d+3])>>4>1){if((u=d+5+e[d+4])===d+188)continue}else u=d+4;switch(c){case b:h&&(E&&(f=this._parsePES(E))&&this._parseAVCPES(f,!1),E={data:[],size:0,decryptdata:n}),E&&(E.data.push(e.subarray(u,d+188)),E.size+=d+188-u);break;case T:if(h&&!this.iframeMode){if(_&&(f=this._parsePES(_)))switch(y.segmentCodec){case"aac":this._parseAACPES(f);break;case"mp3":this._parseMPEGPES(f);break;case"ac3":case"ec3":this._parseDolbyPES(f)}_={data:[],size:0,decryptdata:n}}_&&(_.data.push(e.subarray(u,d+188)),_.size+=d+188-u);break;case S:h&&(R&&(f=this._parsePES(R))&&v.id3Samples.push(f),R={data:[],size:0}),R&&(R.data.push(e.subarray(u,d+188)),R.size+=d+188-u);break;case 0:h&&(u+=e[u]+1),I=this._pmtId=this._parsePAT(e,u);break;case I:h&&(u+=e[u]+1);let t=this._parsePMT(e,u,this.typeSupported);(b=t.avcId)>0&&(m.info.id=b,m.info.encrypted=t.videoEncrypted),(T=t.audioId)>0&&(y.info.id=T,y.segmentCodec=t.audioSegmentCodec,y.info.encrypted=t.audioEncrypted),(S=t.id3Id)>0&&(v.id=S),g&&!p&&(g=!1,d=-188),p=this.pmtParsed=!0;break;case 17:case 8191:break;default:g=!0}}if(E&&(f=this._parsePES(E))?(this._parseAVCPES(f,!0),m.pesData=void 0):m.pesData=E,_&&(f=this._parsePES(_))){switch(y.segmentCodec){case"aac":this._parseAACPES(f);break;case"mp3":this._parseMPEGPES(f);break;case"ac3":case"ec3":this._parseDolbyPES(f)}y.pesData=void 0}else _&&_.size&&this.logger.warn("last AAC PES packet truncated,might overlap between fragments")(),y.pesData=_;R&&(f=this._parsePES(R))?(v.id3Samples.push(f),v.pesData=void 0):v.pesData=R,y.config&&y.segmentCodec&&(D={type:"audio",info:y.info,config:y.config,parsingData:y.parsingData});let w=m.config;var k;"string"==typeof(k=w).codec&&Array.isArray(k.sps)&&Array.isArray(k.pps)&&"number"==typeof k.width&&"number"==typeof k.height&&Array.isArray(k.pixelRatio)&&(A={type:"video",info:m.info,config:w,parsingData:m.parsingData}),this.esRemuxer.remuxEsTracks(D,A,v,this._txtTrack,t,i,a,n,o,l)}destroy(){this._duration=0}_parsePAT(e,t){return(31&e[t+10])<<8|e[t+11]}_parsePMT(e,t,i){var s,r;let a={audioId:-1,avcId:-1,id3Id:-1,audioEncrypted:!1,videoEncrypted:!1};for(s=t+3+((15&e[t+1])<<8|e[t+2])-4,t+=12+((15&e[t+10])<<8|e[t+11]);t<s;){switch(r=(31&e[t+1])<<8|e[t+2],e[t]){case 207:a.audioEncrypted=!0;case 15:-1===a.audioId&&(a.audioId=r,a.audioSegmentCodec="aac");break;case 21:-1===a.id3Id&&(a.id3Id=r);break;case 219:a.videoEncrypted=!0;case 27:-1===a.avcId&&(a.avcId=r);break;case 3:case 4:!0!==i.mpeg&&!0!==i.mp3?this.logger.warn("MPEG audio found, not supported in this browser for now")():-1===a.audioId&&(a.audioId=r,a.audioSegmentCodec="mp3");break;case 193:a.audioEncrypted=!0;case 129:!0!==i.ac3?this.logger.warn("AC-3 audio found, not supported in this browser for now")():-1===a.audioId&&(a.audioId=r,a.audioSegmentCodec="ac3");break;case 194:a.audioEncrypted=!0;case 135:!0!==i.ec3?this.logger.warn("EC-3 audio found, not supported in this browser for now")():-1===a.audioId&&(a.audioId=r,a.audioSegmentCodec="ec3");break;case 36:this.logger.warn("HEVC stream type found, not supported for now")();break;default:this.logger.warn("unkown stream type:"+e[t])()}t+=5+((15&e[t+3])<<8|e[t+4])}return a}_parsePES(e){var t,i,s,r,a,n,o=0,l=e.data,d=e.decryptdata;let h=NaN,c=NaN;if(e&&0!==e.size){for(;l[0].length<19&&l.length>1;){let e=new Uint8Array(l[0].length+l[1].length);e.set(l[0]),e.set(l[1],l[0].length),l[0]=e,l.splice(1,1)}if(1===((t=l[0])[0]<<16)+(t[1]<<8)+t[2]){if((s=(t[4]<<8)+t[5])&&s>e.size-6)return;192&(i=t[7])&&((h=536870912*(14&t[9])+4194304*(255&t[10])+16384*(254&t[11])+128*(255&t[12])+(254&t[13])/2)>4294967295&&(h-=8589934592),64&i?((c=536870912*(14&t[14])+4194304*(255&t[15])+16384*(254&t[16])+128*(255&t[17])+(254&t[18])/2)>4294967295&&(c-=8589934592),h-c>54e5&&(this.logger.warn(`${Math.round((h-c)/9e4)}s delta between PTS and DTS, align them`)(),h=c)):c=h),n=(r=t[8])+9,e.size-=n,a=new Uint8Array(e.size);for(let e=0,i=l.length;e<i;e++){let i=(t=l[e]).byteLength;if(n){if(n>i){n-=i;continue}t=t.subarray(n),i-=n,n=0}a.set(t,o),o+=i}return s&&(s-=r+3),{data:a,pts:h,dts:c,len:s,decryptdata:d}}}}pushAccesUnit(e,t){let i=e.avcSample;if(i&&i.units.length&&i.frame){const s=e.parsingData.esSamples,r=s.length;!this.config.forceKeyFrameOnDiscontinuity||!0===i.key||e.config.sps&&(r||this.contiguous)?(i.id=r,i.decryptdata=t,e.info.encrypted&&i.units.forEach(e=>{if(e.data.byteLength>48)switch(e.type){case 1:case 5:e.data=this.discardEPB(e.data)}}),s.push(i)):e.parsingData.dropped++}i&&i.debug.length}_parseAVCPES(e,t){if(!e.data)throw"invalid pes data";var i,s,r,a=this._avcContext,n=this._parseAVCNALu(e.data),o=a.avcSample,l=e.decryptdata;e.data=void 0,n.forEach(t=>{switch(t.type){case 1:if(o&&!this.iframeMode){s=!0,o.frame=!0;let e=t.data;if(e.length>4){let t=new M(e).readSliceType();2!==t&&4!==t&&7!==t&&9!==t||(o.key=!0)}}break;case 5:s=!0,o&&(o||(o=a.avcSample=this._createAVCSample(!0,e.pts,e.dts,"")),o.key=!0,o.frame=!0);break;case 6:s=!0,(i=new M(this.discardEPB(t.data))).readUByte();for(var n=0,d=0,h=!1,c=0;!h&&i.bytesAvailable>1;){n=0;do{n+=c=i.readUByte()}while(255===c);d=0;do{d+=c=i.readUByte()}while(255===c);if(4===n&&0!==i.bytesAvailable){if(h=!0,181===i.readUByte()&&49===i.readUShort()&&1195456820===i.readUInt()&&3===i.readUByte()){var u=i.readUByte(),f=31&u,g=[u,i.readUByte()];for(r=0;r<f;r++)g.push(i.readUByte()),g.push(i.readUByte()),g.push(i.readUByte());this._insertSampleInOrder(this._txtTrack.captionSamples,{type:3,pts:e.pts,bytes:g})}}else if(d<i.bytesAvailable)for(r=0;r<d;r++)i.readUByte()}break;case 7:if(s=!0,!a.config.sps){var p=(i=new M(t.data)).readSPS();a.config.width=p.width,a.config.height=p.height,a.config.pixelRatio=p.pixelRatio,a.config.sps=[t.data],a.info.duration=this._duration;var m=t.data.subarray(1,4),y="avc1.";for(r=0;r<3;r++){var v=m[r].toString(16);v.length<2&&(v="0"+v),y+=v}a.config.codec=y}break;case 8:s=!0,a.config.pps||(a.config.pps=[t.data]);break;case 9:s=!1,o&&this.pushAccesUnit(a,l),o=a.avcSample=this._createAVCSample(!1,e.pts,e.dts,"");break;case 12:s=!1;break;default:s=!1,o&&(o.debug+="unknown NAL "+t.type+" ")}o&&s&&o.units.push(t)}),t&&o&&(this.pushAccesUnit(a,l),a.avcSample=void 0)}_createAVCSample(e,t,i,s){return{id:NaN,key:e,pts:t,dts:i,units:new Array,debug:s}}_insertSampleInOrder(e,t){var i=e.length;if(i>0){if(t.pts>=e[i-1].pts)e.push(t);else for(var s=i-1;s>=0;s--)if(t.pts<e[s].pts){e.splice(s,0,t);break}}else e.push(t)}_getLastNalUnit(){let e,t=this._avcContext,i=t.avcSample;if(!i||0===i.units.length){let e=t.parsingData.esSamples;i=e[e.length-1]}if(i){let t=i.units;e=t[t.length-1]}return e}_parseAVCNALu(e){var t,i,s,r,a=0,n=e.byteLength,o=this._avcContext,l=o.naluState||0,d=l,h=[],c=-1;for(-1===l&&(c=0,r=31&e[0],l=0,a=1);a<n;)if(t=e[a++],l)if(1!==l)if(t)if(1===t){if(c>=0)s={data:e.subarray(c,a-l-1),type:r},h.push(s);else{let t=this._getLastNalUnit();if(t&&(d&&a<=4-d&&t.state&&(t.data=t.data.subarray(0,t.data.byteLength-d)),(i=a-l-1)>0)){let s=new Uint8Array(t.data.byteLength+i);s.set(t.data,0),s.set(e.subarray(0,i),t.data.byteLength),t.data=s}}a<n?(c=a,r=31&e[a],l=0):l=-1}else l=0;else l=3;else l=t?0:2;else l=t?0:1;if(c>=0&&l>=0&&(s={data:e.subarray(c,n),type:r,state:l},h.push(s)),0===h.length){let t=this._getLastNalUnit();if(t){let i=new Uint8Array(t.data.byteLength+e.byteLength);i.set(t.data,0),i.set(e,t.data.byteLength),t.data=i}}return o.naluState=l,h}discardEPB(e){for(var t,i,s=e.byteLength,r=[],a=1;a<s-2;)0===e[a]&&0===e[a+1]&&3===e[a+2]?(r.push(a+2),a+=2):a++;if(0===r.length)return e;t=s-r.length,i=new Uint8Array(t);var n=0;for(a=0;a<t;n++,a++)n===r[0]&&(n++,r.shift()),i[a]=e[n];return i}_parseAACPES(e){var t,i,a,n,o,l,d,h,c=this._audioContext,u=e.data,f=e.pts,g=c.audioOverFlow,p=c.audioLastPTS,m=e.decryptdata;if(g){var y=new Uint8Array(g.byteLength+u.byteLength);y.set(g,0),y.set(u,g.byteLength),u=y}for(n=0,d=u.length;n<d-1&&(255!==u[n]||240!=(240&u[n+1]));n++);if(n){var b,T;n<d-1?(b=`AAC PES did not start with ADTS header,offset:${n}`,T=!1):(b="no ADTS header found in AAC PES",T=!0),this.logger.warn(`parsing error:${b}`)();let e={type:r.g.MEDIA_ERROR,details:r.d.FRAG_PARSING_ERROR,fatal:T,reason:b};if(this.observer.trigger(s.b.INTERNAL_ERROR,e),T)return}if(!c.config){let e=v.getAudioConfig(this.observer,u,n);if(!e)throw"unable to parse adts header";c.config=e}if(a=0,i=9216e4/c.config.samplerate,g&&p){var S=p+i;Math.abs(S-f)>1&&(f=S)}for(;n+5<d&&(o=1&u[n+1]?7:9,t=(3&u[n+3])<<11|u[n+4]<<3|(224&u[n+5])>>>5,(t-=o)>0&&n+o+t<=d);)for(l=f+a*i,h={unit:u.subarray(n+o,n+o+t),pts:l,dts:l,decryptdata:m},c.parsingData.esSamples.push(h),c.parsingData.len+=t,n+=t+o,a++;n<d-1&&(255!==u[n]||240!=(240&u[n+1]));n++);g=n<d?u.subarray(n,d):void 0,c.audioOverFlow=g,c.audioLastPTS=l}_parseMPEGPES(e){"mp3"===this._audioContext.segmentCodec&&T.parse(this._audioContext.parsingData,e.data,0,e.pts)}_parseDolbyPES(e){let t=this._audioContext,i=e.data,a=e.pts,n=e.decryptdata,o=0,l=0,d=t.audioOverFlow,u=t.audioLastPTS;if(!t.config){let e;if("ac3"===t.segmentCodec?e=y.getAudioConfig(this.observer,i,l):"ec3"===t.segmentCodec&&(e=c(this.observer,i,l)),!e)throw"unable to parse dolby header";t.config=e}if("ac3"!==t.config.segmentCodec&&"ec3"!==t.config.segmentCodec)throw"unexpected config type";const f=1536/t.config.samplerate*t.info.inputTimescale;if(d){var g=new Uint8Array(d.byteLength+i.byteLength);g.set(d,0),g.set(i,d.byteLength),i=g}let p=i.length;if(d&&u){var m=u+f;Math.abs(m-a)>1&&(a=m)}let v=0;for(;l+v<=p;){if(11!==i[l]||119!==i[l+1]){let e={type:r.g.MEDIA_ERROR,details:r.d.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid dolby audio magic"};return void this.observer.trigger(s.b.INTERNAL_ERROR,e)}"ac3"===t.segmentCodec?v=y.getFrameLength(this.observer,i,l):"ec3"===t.segmentCodec&&(v=h(this.observer,i,l));let e=a+o*f;t.audioLastPTS=e;let d={unit:i.subarray(l,l+v),pts:e,dts:e,decryptdata:n};t.parsingData.esSamples.push(d),t.info.duration=this._duration,t.parsingData.len+=v,l+=v,o++}d=l<p?i.subarray(l,p):void 0,t.audioOverFlow=d}},remux:N},{demux:class extends f{resetInitSegment(e,t){this.audioConfig=void 0,this.audioTrack=void 0,this.duration=t}static probe(e){let t=new l(e),i=t.length;return!(!t.hasTimeStamp||11!==e[i]||119!==e[i+1]||16!==(new d).bsReadAndUpdate(e,{byteOffset:i+5,usedBits:0},5))}append(e,t,i,s,r){const a=new l(e),n=90*a.timeStamp,o=e.length;let d=0,u=a.length;if(this.audioConfig||(this.audioConfig=c(this.observer,e,u)),!this.audioConfig)throw"failed to parse ec-3 config";if(!this.audioTrack){let e={id:258,inputTimescale:9e4,timescale:NaN,duration:this.duration,encrypted:!1,decryptdata:r},t={len:0,sequenceNumber:0,esSamples:[]};this.audioTrack={info:e,parsingData:t,type:"audio",config:this.audioConfig}}const f=y.getFrameDuration(this.audioConfig,this.audioTrack.info.inputTimescale);for("zec3"===a.audioType&&(this.audioTrack.info.encrypted=!0);u<o;){let t=h(this.observer,e,u),i=n+d*f,s={unit:e.subarray(u,u+t),pts:i,dts:i,decryptdata:r};this.audioTrack.parsingData.esSamples.push(s),this.audioTrack.parsingData.len+=t,u+=t,d++}this.esRemuxer.remuxEsTracks(this.audioTrack,void 0,{id3Samples:[{pts:n,dts:n,data:a.payload,frames:a.frames}],inputTimescale:this.audioTrack.info.inputTimescale},void 0,t,i,s,r)}},remux:N},{demux:class extends f{resetInitSegment(e,t){this.audioConfig=void 0,this.audioTrack=void 0,this.duration=t}static probe(e){const t=new l(e),i=t.length;return!!(t.hasTimeStamp&&11===e[i]&&119===e[i+1]&&(new d).bsReadAndUpdate(e,{byteOffset:i+5,usedBits:0},5)<16)}append(e,t,i,a,n){let o=new l(e),d=90*o.timeStamp,h=e.byteLength,c=0,u=o.length;if(this.audioConfig||(this.audioConfig=y.getAudioConfig(this.observer,e,u)),!this.audioConfig)throw"failed to parse ac3 config";if(!this.audioTrack){let e={id:258,inputTimescale:9e4,timescale:NaN,duration:this.duration,encrypted:!1,decryptdata:n},t={len:0,sequenceNumber:0,esSamples:[]};this.audioTrack={info:e,parsingData:t,type:"audio",config:this.audioConfig}}const f=y.getFrameDuration(this.audioConfig,this.audioTrack.info.inputTimescale);for("zac3"===o.audioType&&(this.audioTrack.info.encrypted=!0);u<h;){if(l.isHeader(e,u)&&(u+=new l(e.subarray(u)).length),11!==e[u]||119!==e[u+1]){let e={type:r.g.MEDIA_ERROR,details:r.d.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid ac-3 magic"};return void this.observer.trigger(s.b.INTERNAL_ERROR,e)}let t=y.getFrameLength(this.observer,e,u),i=d+c*f,a={unit:e.subarray(u,u+t),pts:i,dts:i,decryptdata:n};this.audioTrack.parsingData.esSamples.push(a),this.audioTrack.parsingData.len+=t,u+=t,c++}this.esRemuxer.remuxEsTracks(this.audioTrack,void 0,{id3Samples:[{pts:d,dts:d,data:o.payload,frames:o.frames}],inputTimescale:this.audioTrack.info.inputTimescale},void 0,t,i,a,n)}},remux:N},{demux:class extends f{resetInitSegment(e,t){this.audioConfig=void 0,this.audioTrack=void 0,this.duration=t}static probe(e){let t,i;for(t=new l(e).length,i=Math.min(e.length-1,t+100);t<i;t++)if(255===e[t]&&240==(246&e[t+1]))return!0;return!1}append(e,t,i,s,r){const a=new l(e,this.logger),n=a.hasTimeStamp?90*a.timeStamp:9e4*t;let o,d,h,c,u,f,g,p;for(a.hasTimeStamp||this.logger.info(`missing id3 timestamp at timeOffset ${t.toFixed(3)}`)(),c=a.length,g=e.length;c<g-1&&(255!==e[c]||240!=(246&e[c+1]));c++);if(!this.audioConfig&&(this.audioConfig=v.getAudioConfig(this.observer,e,c),!this.audioConfig))throw"failed to parse adts config";if(!this.audioTrack){let e={id:258,inputTimescale:9e4,timescale:NaN,duration:this.duration,encrypted:!1,decryptdata:r},t={len:0,sequenceNumber:0,esSamples:[]};this.audioTrack={info:e,parsingData:t,type:"audio",config:this.audioConfig}}for("zaac"!==a.audioType&&"zach"!==a.audioType&&"zacp"!==a.audioType||(this.audioTrack.info.encrypted=!0),h=0,d=9216e4/this.audioConfig.samplerate;c+5<g&&(u=1&e[c+1]?7:9,o=(3&e[c+3])<<11|e[c+4]<<3|(224&e[c+5])>>>5,(o-=u)>0&&c+u+o<=g);)for(f=n+h*d,p={unit:e.subarray(c+u,c+u+o),pts:f,dts:f,decryptdata:r},this.audioTrack.parsingData.esSamples.push(p),this.audioTrack.parsingData.len+=o,c+=o+u,h++;c<g-1&&(255!==e[c]||240!=(246&e[c+1]));c++);let m=void 0,y=void 0,b=void 0;a.length&&(b=a.payload,a.frames.length&&(y=a.frames),m={id3Samples:[{pts:n,dts:n,data:b,frames:y}],inputTimescale:9e4}),this.esRemuxer.remuxEsTracks(this.audioTrack,void 0,m,void 0,t,i,s,r)}},remux:N},{demux:P,remux:A},{demux:class extends f{resetInitSegment(e,t){this.audioConfig=void 0,this.audioTrack=void 0,this.duration=t}static probe(e){let t,i,s=new l(e);if(s.hasTimeStamp)for(t=s.length,i=Math.min(e.length-1,t+100);t<i;t++)if(T.probe(e,t))return a.b.warn("MPEG Audio sync word found !")(),!0;return!1}append(e,t,i,s,r){const a=new l(e),n=90*a.timeStamp;let o,d;for(o=a.length,d=e.length;o<d-1&&(255!==e[o]||224!=(224&e[o+1])||0==(6&e[o+1]));o++);if(this.audioConfig||(this.audioConfig=T.getAudioConfig(e,a.length)),!this.audioConfig)throw"unable to parse mp3 header";if(!this.audioTrack){let e={id:258,inputTimescale:9e4,timescale:NaN,duration:this.duration,encrypted:!1,decryptdata:r},t={len:0,sequenceNumber:0,esSamples:[]};this.audioTrack={info:e,parsingData:t,type:"audio",config:this.audioConfig}}T.parse(this.audioTrack.parsingData,e,a.length,n),this.esRemuxer.remuxEsTracks(this.audioTrack,void 0,{id3Samples:[{pts:n,dts:n,data:a.payload,frames:a.frames}],inputTimescale:9e4},void 0,t,i,s)}},remux:N}];for(let s of n){const{probe:r}=s.demux;if(r(_)){this.remuxer=new s.remux(e,i,t,this.vendor),E=new s.demux(e,this.remuxer,i,t,this.logger),this.probeFn=r;break}}if(!E){let t={type:r.g.MEDIA_ERROR,details:r.d.FRAG_PARSING_ERROR,fatal:!0,reason:"no demux matching with content found"};return void e.trigger(s.b.INTERNAL_ERROR,t)}this.demuxer=E}const R=this.remuxer;let D=!this.lastDecryptData||t&&"NONE"!==t.method&&this.lastDecryptData.uri!==t.uri;this.lastDecryptData=t,(o||u||D)&&(E.resetInitSegment(i,p,t,o),R.resetInitSegment()),o&&(E.resetTimeStamp(b),R.resetTimeStamp(b)),E.append(_,n,g,m,t,S,I)}}}),(function(e,t,i){"use strict";class s{constructor(e,t){this.subtle=e,this.iv=t}decrypt(e,t){const{iv:i,subtle:s}=this;return s.decrypt({name:"AES-CBC",iv:i},t,e)}}class r{constructor(e,t){this.subtle=e,this.key=t}expandKey(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC",length:null},!1,["encrypt","decrypt"])}}class a{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.initTable()}uint8ArrayToUint32Array_(e){const t=new DataView(e),i=Math.floor(t.byteLength/4),s=new Uint32Array(i);for(let e=0;e<i;e++)s[e]=t.getUint32(4*e);return s}initTable(){const e=this.sBox,t=this.invSBox,i=this.subMix,s=i[0],r=i[1],a=i[2],n=i[3],o=this.invSubMix,l=o[0],d=o[1],h=o[2],c=o[3],u=new Uint32Array(256);let f=0,g=0,p=0;for(p=0;p<256;p++)u[p]=p<128?p<<1:p<<1^283;for(p=0;p<256;p++){let i=g^g<<1^g<<2^g<<3^g<<4;i=i>>>8^255&i^99,e[f]=i,t[i]=f;const o=u[f],p=u[o],m=u[p];let y=257*u[i]^16843008*i;s[f]=y<<24|y>>>8,r[f]=y<<16|y>>>16,a[f]=y<<8|y>>>24,n[f]=y,y=16843009*m^65537*p^257*o^16843008*f,l[i]=y<<24|y>>>8,d[i]=y<<16|y>>>16,h[i]=y<<8|y>>>24,c[i]=y,f?(f=o^u[u[u[m^o]]],g^=u[u[g]]):f=g=1}}expandKey(e){const t=this.uint8ArrayToUint32Array_(e);let i=!0,s=0;for(;s<t.length&&i;)i=t[s]===this.key[s],s++;if(i)return;this.key=t;let r=this.keySize=t.length;if(4!==r&&6!==r&&8!==r)throw new Error("Invalid aes key size="+r);const a=this.ksRows=4*(r+6+1);let n,o;const l=this.keySchedule=new Uint32Array(a),d=this.invKeySchedule=new Uint32Array(a),h=this.sBox,c=this.rcon,u=this.invSubMix,f=u[0],g=u[1],p=u[2],m=u[3];let y,v;for(n=0;n<a;n++)n<r?y=l[n]=t[n]:(v=y,n%r==0?(v=h[(v=v<<8|v>>>24)>>>24]<<24|h[v>>>16&255]<<16|h[v>>>8&255]<<8|h[255&v],v^=c[n/r|0]<<24):r>6&&n%r==4&&(v=h[v>>>24]<<24|h[v>>>16&255]<<16|h[v>>>8&255]<<8|h[255&v]),l[n]=y=(l[n-r]^v)>>>0);for(o=0;o<a;o++)n=a-o,v=3&o?l[n]:l[n-4],d[o]=o<4||n<=4?v:f[h[v>>>24]]^g[h[v>>>16&255]]^p[h[v>>>8&255]]^m[h[255&v]],d[o]=d[o]>>>0}networkToHostOrderSwap(e){return e<<24|(65280&e)<<8|(16711680&e)>>8|e>>>24}decrypt(e,t,i){const s=this.keySize+6,r=this.invKeySchedule,a=this.invSBox,n=this.invSubMix,o=n[0],l=n[1],d=n[2],h=n[3],c=this.uint8ArrayToUint32Array_(i);let u=c[0],f=c[1],g=c[2],p=c[3];const m=new Int32Array(e),y=new Int32Array(m.length);let v,b,T,S,I,E,_,R,D,A,L,w;var k,C;const P=this.networkToHostOrderSwap;for(;t<m.length;){for(D=P(m[t]),A=P(m[t+1]),L=P(m[t+2]),w=P(m[t+3]),I=D^r[0],E=w^r[1],_=L^r[2],R=A^r[3],k=4,C=1;C<s;C++)v=o[I>>>24]^l[E>>16&255]^d[_>>8&255]^h[255&R]^r[k],b=o[E>>>24]^l[_>>16&255]^d[R>>8&255]^h[255&I]^r[k+1],T=o[_>>>24]^l[R>>16&255]^d[I>>8&255]^h[255&E]^r[k+2],S=o[R>>>24]^l[I>>16&255]^d[E>>8&255]^h[255&_]^r[k+3],I=v,E=b,_=T,R=S,k+=4;v=a[I>>>24]<<24^a[E>>16&255]<<16^a[_>>8&255]<<8^a[255&R]^r[k],b=a[E>>>24]<<24^a[_>>16&255]<<16^a[R>>8&255]<<8^a[255&I]^r[k+1],T=a[_>>>24]<<24^a[R>>16&255]<<16^a[I>>8&255]<<8^a[255&E]^r[k+2],S=a[R>>>24]<<24^a[I>>16&255]<<16^a[E>>8&255]<<8^a[255&_]^r[k+3],k+=3,y[t]=P(v^u),y[t+1]=P(S^f),y[t+2]=P(T^g),y[t+3]=P(b^p),u=D,f=A,g=L,p=w,t+=4}return y.buffer}destroy(){this.key=void 0,this.keySize=void 0,this.ksRows=void 0,this.sBox=void 0,this.invSBox=void 0,this.subMix=void 0,this.invSubMix=void 0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.rcon=void 0}}var n=i(0),o=i(1),l=i(2);class d{constructor(e,t){this.observer=e,this.config=t,this.logEnabled=!0;try{const t=crypto||self.crypto;this.subtle=t.subtle||t.webkitSubtle}catch(e){l.b.error(e)()}this.disableWebCrypto=!this.subtle}isSync(){return this.disableWebCrypto&&this.config.enableSoftwareAES}decrypt(e,t,i,n){if(!this.disableWebCrypto||!this.config.enableSoftwareAES){this.logEnabled&&(this.logEnabled=!1);const a=this.subtle;return this.key!==t&&(this.key=t,this.fastAesKey=new r(a,t)),this.fastAesKey.expandKey().then(r=>{new s(a,i).decrypt(e,r).then(e=>{try{n(e)}catch(e){l.b.error(e)()}}).catch(s=>{this.onWebCryptoError(s,e,t,i,n)})}).catch(s=>{this.onWebCryptoError(s,e,t,i,n)})}{this.logEnabled&&(this.logEnabled=!1),this.decryptor||(this.decryptor=new a);const{decryptor:s}=this;s.expandKey(t),n(s.decrypt(e,0,i))}}onWebCryptoError(e,t,i,s,r){if(this.config.enableSoftwareAES)this.disableWebCrypto=!0,this.logEnabled=!0,this.decrypt(t,i,s,r);else{l.b.error(`decrypting error : ${e.message}`)();let t={type:n.g.MEDIA_ERROR,details:n.d.FRAG_DECRYPT_ERROR,fatal:!0,reason:e.message};this.observer.trigger(o.b.INTERNAL_ERROR,t)}}destroy(){this.decryptor&&(this.decryptor.destroy(),this.decryptor=void 0)}}i.d(t,"a",(function(){return h}));class h{constructor(e,t){this.observer=e,this.config=t}destroy(){this.decryptor&&this.decryptor.destroy()}decrypt(e,t,i){if(e.byteLength>0&&t&&t.key&&t.iv&&"AES-128"===t.method){null==this.decryptor&&(this.decryptor=new d(this.observer,this.config));try{performance.now()}catch(e){Date.now()}return this.decryptor.decrypt(e,t.key.buffer,t.iv.buffer,e=>{try{performance.now()}catch(e){Date.now()}i&&i(e)})}}}}),(function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s={"&amp;":"&","&lt;":"<","&gt;":">","&lrm;":"‎","&rlm;":"‏","&nbsp;":" "},r={c:"span",i:"i",b:"b",u:"u",ruby:"ruby",rt:"rt",v:"span",lang:"span"},a={v:"title",lang:"lang"},n={rt:"ruby"},o={"text-combine-upright":"-webkit-text-combine:horizontal; text-orientation: mixed;"};class l{static parseTimeStamp(e){function t(e){const[t,i,s,r]=e.map(e=>e?parseInt(""+e):0);return 3600*t+60*i+s+r/1e3}const i=/^(\d+):(\d{2})(:\d{2})?\.(\d{3})/.exec(e);return i?i[3]?t([i[1],i[2],i[3].substring(1),i[4]]):parseInt(i[1])>59?t([i[1],i[2],null,i[4]]):t([null,i[1],i[2],i[4]]):null}static parseContent(e,t,i){let d=t.text;function h(){if(!d)return null;const e=/^([^<]*)(<[^>]+>?)?/.exec(d);return t=e[1]?e[1]:e[2],d=d.substr(t.length),t;var t}function c(e){return s[e]}function u(e,t){return!n[t.dataset.localName]||n[t.dataset.localName]===e.dataset.localName}function f(t,s,n){const l=r[t];if(!l)return null;const d=e.document.createElement(l);d.dataset.localName=l;const h=a[t];if(h&&n&&(d[h]=n.trim()),s)if(i[s]){const e=(function(e){let t="";for(const i in e)o[i]?t+=o[i]:t+=i+":"+e[i]+";";return t})(i[s]);d.setAttribute("style",e)}else console.info(`WebVTT: parseContent: Style referenced, but no style defined for '${s}'!`);return d}const g=e.document.createElement("div"),p=[];let m,y,v=g;for(;null!==(m=h());)if("<"!==m[0])v.appendChild(e.document.createTextNode(m.replace(/&(amp|lt|gt|lrm|rlm|nbsp);/g,c)));else{if("/"===m[1]){p.length&&p[p.length-1]===m.substr(2).replace(">","")&&(p.pop(),v=v.parentNode);continue}const t=l.parseTimeStamp(m.substr(1,m.length-2));let i;if(t){i=e.document.createProcessingInstruction("timestamp",t.toString()),v.appendChild(i);continue}if(!(y=/^<([^.\s/0-9>]+)(\.[^\s\\>]+)?([^>\\]+)?(\\?)>?$/.exec(m)))continue;if(!(i=f(y[1],y[2],y[3])))continue;if(!u(v,i))continue;y[2],p.push(y[1]),v.appendChild(i),v=i}return g}}t.default=l}),(function(e,t,i){"use strict";t.a={hexDump:function(e){var t,i="";for(t=0;t<e.length;t++){var s=e[t].toString(16);s.length<2&&(s="0"+s),i+=s}return i}}}),(function(e,t,i){"use strict";var s=this&&this.__decorate||function(e,t,i,s){var r,a=arguments.length,n=a<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,s);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(n=(a<3?r(n):a>3?r(t,i,n):r(t,i))||n);return a>3&&n&&Object.defineProperty(t,i,n),n};Object.defineProperty(t,"__esModule",{value:!0});const r=i(19),a=i(16);let n=class{constructor(e,t,i){this._id="",this._pauseOnExit=!1,this._region=null,this._vertical="",this._snapToLines=!0,this._line="auto",this._lineAlign="start",this._position=50,this._positionAlign="center",this._size=50,this._align="center",this.hasBeenReset=!1,this._startTime=e,this._endTime=t,this._text=i}get id(){return this._id}set id(e){this._id=""+e}get pauseOnExit(){return this._pauseOnExit}set pauseOnExit(e){this._pauseOnExit=!!e}get startTime(){return this._startTime}set startTime(e){if("number"!=typeof e)throw new TypeError(`Start time must be set to a number: ${e}`);this._startTime=e,this.hasBeenReset=!0}get endTime(){return this._endTime}set endTime(e){if("number"!=typeof e)throw new TypeError(`End time must be set to a number: ${e}`);this._endTime=e,this.hasBeenReset=!0}get text(){return this._text}set text(e){this._text=""+e,this.hasBeenReset=!0}get region(){return this._region}set region(e){this._region=e,this.hasBeenReset=!0}get vertical(){return this._vertical}set vertical(e){if(!r.isValidDirectionSetting(e))throw new SyntaxError(`An invalid or illegal string was specified for vertical: ${e}`);this._vertical=e,this.hasBeenReset=!0}get snapToLines(){return this._snapToLines}set snapToLines(e){this._snapToLines=!!e,this.hasBeenReset=!0}get line(){return this._line}set line(e){if(!r.isValidLineAndPositionSetting(e))throw new SyntaxError(`An invalid number or illegal string was specified for line: ${e}`);this._line=e,this.hasBeenReset=!0}get lineAlign(){return this._lineAlign}set lineAlign(e){if(!r.isValidLineAlignSetting(e))throw new SyntaxError(`An invalid or illegal string was specified for lineAlign: ${e}`);this._lineAlign=e,this.hasBeenReset=!0}get position(){return this._position}set position(e){if(!r.isValidLineAndPositionSetting(e))throw new Error(`Position must be between 0 and 100 or auto: ${e}`);this._position=e,this.hasBeenReset=!0}get positionAlign(){return this._positionAlign}set positionAlign(e){if(!r.isValidPositionAlignSetting(e))throw new SyntaxError(`An invalid or illegal string was specified for positionAlign: ${e}`);this._positionAlign=e,this.hasBeenReset=!0}get size(){return this._size}set size(e){if(e<0||e>100)throw new Error(`Size must be between 0 and 100: ${e}`);this._size=e,this.hasBeenReset=!0}get align(){return this._align}set align(e){if(!r.isValidAlignSetting(e))throw new SyntaxError(`An invalid or illegal string was specified for align: ${e}`);this._align=e,this.hasBeenReset=!0}getCueAsHTML(){return a.default.parseContent(window,this,{})}static create(e){if(!e.hasOwnProperty("startTime")||!e.hasOwnProperty("endTime")||!e.hasOwnProperty("text"))throw new Error("You must at least have start time, end time, and text.");const t=new this(e.startTime,e.endTime,e.text);return Object.keys(e).forEach(i=>{t.hasOwnProperty(i)&&(t[i]=e[i])}),t}static fromJSON(e){return this.create(JSON.parse(e))}toJSON(){const e={};return Object.keys(this).forEach(t=>{this.hasOwnProperty(t)&&"getCueAsHTML"!==t&&"hasBeenReset"!==t&&"displayState"!==t&&(e[t]=this[t])}),e}};n=s([function(e){let t=e;return"undefined"!=typeof window&&null!=window.VTTCue&&((t=window.VTTCue).create=e.create,t.fromJSON=e.fromJSON,t.prototype.toJSON=e.prototype.toJSON),t}],n),t.VTTCue=n}),(function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isValidPercentValue=function(e){return"number"==typeof e&&e>=0&&e<=100},t.isValidAlignSetting=function(e){return"string"==typeof e&&["start","center","end","left","right","middle"].includes(e)},t.isValidDirectionSetting=function(e){return"string"==typeof e&&["","rl","lr"].includes(e)},t.isValidLineAndPositionSetting=function(e){return"number"==typeof e||"auto"===e},t.isValidLineAlignSetting=function(e){return"string"==typeof e&&["start","center","end"].includes(e)},t.isValidPositionAlignSetting=function(e){return"string"==typeof e&&["line-left","center","line-right","auto","left","start","middle","end","right"].includes(e)},t.isValidScrollSetting=function(e){return["","up"].includes(e)}}),(function(e,t,i){"use strict";!(function(e,t){if(!e.setImmediate){var i,s,r,a,n,o=1,l={},d=!1,h=e.document,c=Object.getPrototypeOf&&Object.getPrototypeOf(e);c=c&&c.setTimeout?c:e,"[object process]"==={}.toString.call(e.process)?i=function(e){process.nextTick((function(){f(e)}))}:(function(){if(e.postMessage&&!e.importScripts){var t=!0,i=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=i,t}})()?(a="setImmediate$"+Math.random()+"$",n=function(t){t.source===e&&"string"==typeof t.data&&0===t.data.indexOf(a)&&f(+t.data.slice(a.length))},e.addEventListener?e.addEventListener("message",n,!1):e.attachEvent("onmessage",n),i=function(t){e.postMessage(a+t,"*")}):e.MessageChannel?((r=new MessageChannel).port1.onmessage=function(e){f(e.data)},i=function(e){r.port2.postMessage(e)}):h&&"onreadystatechange"in h.createElement("script")?(s=h.documentElement,i=function(e){var t=h.createElement("script");t.onreadystatechange=function(){f(e),t.onreadystatechange=null,s.removeChild(t),t=null},s.appendChild(t)}):i=function(e){setTimeout(f,0,e)},c.setImmediate=function(e){"function"!=typeof e&&(e=new Function(""+e));for(var t=new Array(arguments.length-1),s=0;s<t.length;s++)t[s]=arguments[s+1];var r={callback:e,args:t};return l[o]=r,i(o),o++},c.clearImmediate=u}function u(e){delete l[e]}function f(e){if(d)setTimeout(f,0,e);else{var i=l[e];if(i){d=!0;try{!(function(e){var i=e.callback,s=e.args;switch(s.length){case 0:i();break;case 1:i(s[0]);break;case 2:i(s[0],s[1]);break;case 3:i(s[0],s[1],s[2]);break;default:i.apply(t,s)}})(i)}finally{u(e),d=!1}}}}})("undefined"==typeof self?"undefined"==typeof global?this:global:self)}),(function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=i(18);t.VTTCue=s.VTTCue;const r=i(22);t.VTTRegion=r.VTTRegion;const a=i(16);class n extends Error{constructor(e,t){super(),this.name="ParsingError",this.code="number"==typeof e?e:e.code,t?this.message=t:e instanceof n&&(this.message=e.message)}}t.ParsingError=n,n.Errors={BadSignature:new n(0,"Malformed WebVTT signature."),BadTimeStamp:new n(1,"Malformed time stamp.")};class o{constructor(){this.values={}}set(e,t){this.get(e)||""===t||(this.values[e]=t)}get(e,t,i){return"object"==typeof t&&"string"==typeof i?this.has(e)?this.values[e]:t[i]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,i){for(let s=0;s<i.length;++s)if(t===i[s]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(t.match(/^([\d]{1,3})(\.[\d]*)?%$/))try{const i=parseFloat(t);if(i>=0&&i<=100)return this.set(e,i),!0}catch(e){return!1}return!1}}class l{constructor(e,t,i){this.window=e,this.state="INITIAL",this.buffer="",this.decoder=t||new TextDecoder("utf8"),this.regionList=[],this.onStylesParsedCallback=i,this._styles={}}static StringDecoder(){return{decode:e=>{if(!e)return"";if("string"!=typeof e)throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}}reportOrThrowError(e){if(!(e instanceof n&&"function"==typeof this.onparsingerror))throw e;this.onparsingerror(e)}parseOptions(e,t,i,s){const r=s?e.split(s):[e];for(const e of r){if("string"!=typeof e)continue;const s=e.split(i);2===s.length&&t(s[0],s[1])}}parseCue(e,t,i){const s=e,r=()=>{const t=a.default.parseTimeStamp(e);if(null===t)throw new n(n.Errors.BadTimeStamp,"Malformed timestamp: "+s);return e=e.replace(/^[^\sa-zA-Z-]+/,""),t},l=()=>{e=e.replace(/^\s+/,"")};if(l(),t.startTime=r(),l(),"--\x3e"!==e.substr(0,3))throw new n(n.Errors.BadTimeStamp,`Malformed time stamp (time stamps must be separated by '--\x3e'): ${s}`);e=e.substr(3),l(),t.endTime=r(),l(),((e,t)=>{const s=new o;this.parseOptions(e,(e,t)=>{let r,a;switch(e){case"region":for(let r=i.length-1;r>=0;r--)if(i[r].id===t){s.set(e,i[r].region);break}break;case"vertical":s.alt(e,t,["rl","lr"]);break;case"line":a=(r=t.split(","))[0],s.integer(e,a),s.percent(e,a)&&s.set("snapToLines",!1),s.alt(e,a,["auto"]),2===r.length&&s.alt("lineAlign",r[1],["start","center","end"]);break;case"position":if(r=t.split(","),s.percent(e,r[0]),2===r.length){let e=["line-left","line-right","center","auto","left","start","middle","end","right"];s.alt("positionAlign",r[1],e)}break;case"size":s.percent(e,t);break;case"align":let n=["start","center","end","left","right","middle"];s.alt(e,t,n)}},/:/,/\s/),t.region=s.get("region",null),t.vertical=s.get("vertical",""),t.line=s.get("line",void 0===t.line?"auto":t.line),t.lineAlign=s.get("lineAlign","start"),t.snapToLines=s.get("snapToLines",!0),t.size=s.get("size",100);let r=s.get("align","center");t.align="middle"===r?"center":r,t.position=s.get("position","auto");let a=s.get("positionAlign",{start:"start",left:"start",center:"center",right:"end",end:"end"},t.align);t.positionAlign={start:"start","line-left":"start",left:"start",center:"center",middle:"center","line-right":"end",right:"end",end:"end"}[a]})(e,t)}parseRegion(e){const t=new o;if(this.parseOptions(e,(e,i)=>{switch(e){case"id":t.set(e,i);break;case"width":t.percent(e,i);break;case"lines":t.integer(e,i);break;case"regionanchor":case"viewportanchor":{const s=i.split(",");if(2!==s.length)break;const r=new o;if(r.percent("x",s[0]),r.percent("y",s[1]),!r.has("x")||!r.has("y"))break;t.set(e+"X",r.get("x")),t.set(e+"Y",r.get("y"));break}case"scroll":t.alt(e,i,["up"])}},/=/,/\s/),t.has("id")){const e=new r.VTTRegion;e.width=t.get("width",100),e.lines=t.get("lines",3),e.regionAnchorX=t.get("regionanchorX",0),e.regionAnchorY=t.get("regionanchorY",100),e.viewportAnchorX=t.get("viewportanchorX",0),e.viewportAnchorY=t.get("viewportanchorY",100),e.scroll=t.get("scroll",""),this.onregion&&this.onregion(e),this.regionList.push({id:t.get("id"),region:e})}}parseStyle(e){const t=e=>{const t={},i=e.split(";");for(let e=0;e<i.length;e++){const s=i[e].split(":",2),r=s[0].trim(),a=s[1].trim();""!==r&&""!==a&&(t[r]=a)}return t},i=e.replace(" ","").split("}");i.pop();for(const e of i){let i=null,s=null;const r=e.split("{");r[0]&&(i=r[0].trim()),r[1]&&(s=t(r[1])),i&&s&&(this._styles[i]=s)}this.onStylesParsedCallback&&this.onStylesParsedCallback(this._styles)}parseHeader(e){this.parseOptions(e,(function(e,t){switch(e){case"Region":this.parseRegion(t)}}),/:/)}parse(e){e&&(this.buffer+=this.decoder.decode(e,{stream:!0}));const t=()=>{const e=this.buffer;let t=0;const i=(e,t)=>{const i={start:-1,length:-1};if("\r"===e[t])i.start=t,i.length=1;else if("\n"===e[t])i.start=t,i.length=1;else if("<"===e[t]&&t+1<e.length&&"b"===e[t+1]&&t+2<e.length&&"r"===e[t+2]){let s=t+2;for(;s<e.length&&">"!==e[s++];);i.start=t,i.length=s-t}return i};let s={start:e.length,length:0};for(;t<e.length;){const r=i(e,t);if(r.length>0){s=r;break}++t}const r=e.substr(0,s.start);return this.buffer=e.substr(s.start+s.length),r};try{let i;if(this.styleCollector="","INITIAL"===this.state){if(!/\r\n|\n/.test(this.buffer))return this;i=t();const e=/^(ï»¿)?WEBVTT([ \t].*)?$/.exec(i);if(!e||!e[0])throw new n(n.Errors.BadSignature);this.state="HEADER"}let r=!1;for(;this.buffer;){if(!/\r\n|\n/.test(this.buffer))return this;switch(r?r=!1:i=t(),this.state){case"HEADER":i.includes(":")?this.parseHeader(i):i||(this.state="ID");continue;case"NOTE":i||(this.state="ID");continue;case"STYLE":i?this.styleCollector+=i:(this.parseStyle(this.styleCollector),this.state="ID",this.styleCollector="");continue;case"ID":if(/^NOTE($|[ \t])/.test(i)){this.state="NOTE";break}if(/^STYLE($|[ \t])/.test(i)){this.state="STYLE";break}if(!i)continue;if(this.cue=new s.VTTCue(0,0,""),this.state="CUE",!i.includes("--\x3e")){this.cue.id=i;continue}case"CUE":try{this.parseCue(i,this.cue,this.regionList)}catch(e){this.reportOrThrowError(e),this.cue=null,this.state="BADCUE";continue}this.state="CUETEXT";continue;case"CUETEXT":{const e=i.includes("--\x3e");if(!i||e){r=!0,this.oncue&&this.oncue(this.cue),this.cue=null,this.state="ID";continue}this.cue.text&&(this.cue.text+="\n"),this.cue.text+=i;continue}case"BADCUE":i||(this.state="ID");continue}}}catch(e){this.reportOrThrowError(e),"CUETEXT"===this.state&&this.cue&&this.oncue&&this.oncue(this.cue),this.cue=null,this.state="INITIAL"===this.state?"BADWEBVTT":"BADCUE"}return this}flush(){try{if(this.buffer+=this.decoder.decode(),(this.cue||"HEADER"===this.state)&&(this.buffer+="\n\n",this.parse()),"INITIAL"===this.state)throw new n(n.Errors.BadSignature)}catch(e){this.reportOrThrowError(e)}return this.onflush&&this.onflush(),this}styles(){return this._styles}}t.default=l,t.WebVTTParser=l}),(function(e,t,i){"use strict";var s=this&&this.__decorate||function(e,t,i,s){var r,a=arguments.length,n=a<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,s);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(n=(a<3?r(n):a>3?r(t,i,n):r(t,i))||n);return a>3&&n&&Object.defineProperty(t,i,n),n};Object.defineProperty(t,"__esModule",{value:!0});const r=i(19);let a=class{constructor(){this._id="",this._lines=3,this._regionAnchorX=0,this._regionAnchorY=100,this._scroll="",this._viewportAnchorX=0,this._viewportAnchorY=100,this._width=100}get id(){return this._id}set id(e){if("string"!=typeof e)throw new Error("ID must be a string.");this._id=e}get lines(){return this._lines}set lines(e){if("number"!=typeof e)throw new TypeError("Lines must be set to a number.");this._lines=e}get regionAnchorX(){return this._regionAnchorX}set regionAnchorX(e){if(!r.isValidPercentValue(e))throw new TypeError("RegionAnchorX must be between 0 and 100.");this._regionAnchorX=e}get regionAnchorY(){return this._regionAnchorY}set regionAnchorY(e){if(!r.isValidPercentValue(e))throw new TypeError("RegionAnchorY must be between 0 and 100.");this._regionAnchorY=e}get scroll(){return this._scroll}set scroll(e){if("string"==typeof e){const t=e.toLowerCase();if(r.isValidScrollSetting(t))return void(this._scroll=t)}throw new SyntaxError("An invalid or illegal string was specified.")}get viewportAnchorX(){return this._viewportAnchorX}set viewportAnchorX(e){if(!r.isValidPercentValue(e))throw new TypeError("ViewportAnchorX must be between 0 and 100.");this._viewportAnchorX=e}get viewportAnchorY(){return this._viewportAnchorY}set viewportAnchorY(e){if(!r.isValidPercentValue(e))throw new TypeError("ViewportAnchorY must be between 0 and 100.");this._viewportAnchorY=e}get width(){return this._width}set width(e){if(!r.isValidPercentValue(e))throw new TypeError("Width must be between 0 and 100.");this._lines=e}toJSON(){const e={};return Object.keys(this).forEach(t=>{this.hasOwnProperty(t)&&(e[t]=this[t])}),e}static create(e){const t=new this;return Object.keys(e).forEach(i=>{t.hasOwnProperty(i)&&(t[i]=e[i])}),t}static fromJSON(e){return this.create(JSON.parse(e))}};a=s([function(e){let t=e;return"undefined"!=typeof window&&null!=window.VTTRegion&&((t=window.VTTRegion).create=e.create,t.fromJSON=e.fromJSON,t.prototype.toJSON=e.prototype.toJSON),t}],a),t.VTTRegion=a}),(function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=i(18);t.VTTCue=s.VTTCue;const r=i(16),a="1.5%",n=0,o=.05,l=10,d=41,h="::cue",c="::-webkit-media-text-track-display",u=[/^(::cue\()(\..*)(\))/,/^(::cue\()(#.*)(\))/,/^(::cue\()(c|i|b|u|ruby|rt|v|lang)(\))/],f=[[1470,1470],[1472,1472],[1475,1475],[1478,1478],[1488,1514],[1520,1524],[1544,1544],[1547,1547],[1549,1549],[1563,1563],[1566,1610],[1645,1647],[1649,1749],[1765,1766],[1774,1775],[1786,1805],[1807,1808],[1810,1839],[1869,1957],[1969,1969],[1984,2026],[2036,2037],[2042,2042],[2048,2069],[2074,2074],[2084,2084],[2088,2088],[2096,2110],[2112,2136],[2142,2142],[2208,2208],[2210,2220],[8207,8207],[64285,64285],[64287,64296],[64298,64310],[64312,64316],[64318,64318],[64320,64321],[64323,64324],[64326,64449],[64467,64829],[64848,64911],[64914,64967],[65008,65020],[65136,65140],[65142,65276],[67584,67589],[67592,67592],[67594,67637],[67639,67640],[67644,67644],[67647,67669],[67671,67679],[67840,67867],[67872,67897],[67903,67903],[67968,68023],[68030,68031],[68096,68096],[68112,68115],[68117,68119],[68121,68147],[68160,68167],[68176,68184],[68192,68223],[68352,68405],[68416,68437],[68440,68466],[68472,68479],[68608,68680],[126464,126467],[126469,126495],[126497,126498],[126500,126500],[126503,126503],[126505,126514],[126516,126519],[126521,126521],[126523,126523],[126530,126530],[126535,126535],[126537,126537],[126539,126539],[126541,126543],[126545,126546],[126548,126548],[126551,126551],[126553,126553],[126555,126555],[126557,126557],[126559,126559],[126561,126562],[126564,126564],[126567,126570],[126572,126578],[126580,126583],[126585,126588],[126590,126590],[126592,126601],[126603,126619],[126625,126627],[126629,126633],[126635,126651],[1114109,1114109]];class g{applyStyles(e,t){t=t||this.div;for(const i in e)e.hasOwnProperty(i)&&(t.style[i]=e[i])}formatStyle(e,t){return 0===e?"0":e+t}}t.StyleBox=g;class p extends g{constructor(e,t,i,s,a){super(),this.cue=t;let n={textAlign:{start:"left","line-left":"left",left:"left",center:"center",middle:"center","line-right":"right",right:"right",end:"right"}[t.positionAlign]||t.align,whiteSpace:"pre-line",position:"absolute"};n.direction=this.determineBidi(this.cueDiv),n.writingMode=this.directionSettingToWritingMode(t.vertical),n.unicodeBidi="plaintext",this.div=e.document.createElement("div"),this.applyStyles(n),n={backgroundColor:s.backgroundColor,display:"inline-block"},this.parseOpacity(n.backgroundColor)&&(n.padding="5px",n.borderRadius="5px"),this.backgroundDiv=e.document.createElement("div"),this.applyStyles(n,this.backgroundDiv),(n={color:i.color,backgroundColor:i.backgroundColor,textShadow:i.textShadow,fontSize:i.fontSize,fontFamily:i.fontFamily,position:"relative",left:"0",right:"0",top:"0",bottom:"0",display:"inline-block",textOrientation:"upright"}).writingMode=this.directionSettingToWritingMode(t.vertical),n.unicodeBidi="plaintext",this.cueDiv=r.default.parseContent(e,t,a),this.applyStyles(n,this.cueDiv),this.backgroundDiv.appendChild(this.cueDiv),this.div.appendChild(this.backgroundDiv);let o=0;if("number"==typeof t.position){let e=t.positionAlign||t.align;if(e)switch(e){case"start":case"left":o=t.position;break;case"center":case"middle":o=t.position-t.size/2;break;case"end":case"right":o=t.position-t.size}}""===t.vertical?this.applyStyles({left:this.formatStyle(o,"%"),width:this.formatStyle(t.size,"%")}):this.applyStyles({top:this.formatStyle(o,"%"),height:this.formatStyle(t.size,"%")})}determineBidi(e){let t,i=[],s="";if(!e||!e.childNodes)return"ltr";function r(e,t){for(let i=t.childNodes.length-1;i>=0;i--)e.push(t.childNodes[i])}function a(e){if(!e||!e.length)return null;let t=e.pop(),i=t.textContent||t.innerText;if(i){const t=/^.*(\n|\r)/.exec(i);return t?(e.length=0,t[0]):i}return"ruby"===t.tagName?a(e):t.childNodes?(r(e,t),a(e)):void 0}function n(e,t){for(const i of t)if(e>=i[0]&&e<=i[1])return!0;return!1}for(r(i,e);s=a(i);)for(let e=0;e<s.length;e++)if(n(t=s.charCodeAt(e),f))return"rtl";return"ltr"}parseOpacity(e){if(!e||"string"!=typeof e)return null;const t=(e=e.replace(/ /g,"").replace("rgba(","").replace(")","")).split(",");return t&&t.length>=4?t[3]:null}directionSettingToWritingMode(e){return""===e?"horizontal-tb":"lr"===e?"vertical-lr":"vertical-rl"}move(e){this.applyStyles({top:this.formatStyle(e.top,"px"),bottom:this.formatStyle(e.bottom,"px"),left:this.formatStyle(e.left,"px"),right:this.formatStyle(e.right,"px"),height:this.formatStyle(e.height,"px"),width:this.formatStyle(e.width,"px")})}}t.CueStyleBox=p;class m{constructor(e){var t;let i,s,r,a,n,o;if(e instanceof p&&e.cue?(t=e.cue)&&""!==t.vertical?this.property="width":this.property="height":e instanceof m&&(this.property=e.property||"height"),e instanceof p&&e.div){r=e.div.offsetHeight,a=e.div.offsetWidth,n=e.div.offsetTop;const t=e.div.firstChild;if(i=(o=t?t.getBoundingClientRect():e.div.getBoundingClientRect())&&o[this.property]||null,t&&t.firstChild){const e=t.firstChild;e&&"string"==typeof e.textContent&&(s=i/this.calculateNewLines(e.textContent))}}else e instanceof m&&(o=e);this.left=o.left,this.right=o.right,this.top=o.top||n,this.height=o.height||r,this.bottom=o.bottom||n+(o.height||r),this.width=o.width||a,this.lineHeight=null!==i?i:o.lineHeight,this.singleLineHeight=null!==s?s:o.singleLineHeight,this.singleLineHeight||(this.singleLineHeight=d)}calculateNewLines(e){let t=1;for(let i=0;i<e.length;i++)"\n"===e[i]&&t++;return t}move(e,t){switch(t=void 0!==t?t:this.singleLineHeight,e){case"+x":this.left+=t,this.right+=t;break;case"-x":this.left-=t,this.right-=t;break;case"+y":this.top+=t,this.bottom+=t;break;case"-y":this.top-=t,this.bottom-=t}}overlaps(e){return this.left<e.right&&this.right>e.left&&this.top<e.bottom&&this.bottom>e.top}overlapsAny(e){for(const t of e)if(this.overlaps(t))return!0;return!1}within(e){return this.top>=e.top&&this.bottom<=e.bottom&&this.left>=e.left&&this.right<=e.right}moveIfOutOfBounds(e,t){switch(t){case"+x":this.left<e.left&&(this.left=e.left,this.right=this.left+this.width);break;case"-x":this.right>e.right&&(this.right=e.right,this.left=this.right-this.width);break;case"+y":this.top<e.top&&(this.top=e.top,this.bottom=this.top+this.height);break;case"-y":this.bottom>e.bottom&&(this.bottom=e.bottom,this.top=this.bottom-this.height)}}toCSSCompatValues(e){return{top:this.top-e.top,bottom:e.bottom-this.bottom,left:this.left-e.left,right:e.right-this.right,height:this.height,width:this.width}}static getSimpleBoxPosition(e){let t=null;e instanceof g&&e.div?t=e.div:e instanceof HTMLElement&&(t=e);let i=t.offsetHeight||0,s=t.offsetWidth||0,r=t.offsetTop||0,a=r+i,n=t.getBoundingClientRect();const{left:o,right:l}=n;return n.top&&(r=n.top),n.height&&(i=n.height),n.width&&(s=n.width),n.bottom&&(a=n.bottom),{left:o,right:l,top:r,height:i,bottom:a,width:s}}static getBoxPosition(e,t){if(e&&e.length>0){let i=0,s=e[0][t];for(let r=0;r<e.length;r++)t in["top","right"]?e[r][t]>s&&(i=r,s=e[r][t]):t in["bottom","left"]&&e[r][t]<s&&(i=r,s=e[r][t]);return e[i]}return null}static moveToMinimumDistancePlacement(e,t,i){"height"===e.property?"+y"===t?(e.top=i.topMostBoxPosition.bottom+n,e.bottom=e.top+e.height):"-y"===t&&(e.bottom=i.bottomMostBoxPosition.top-n,e.top=e.bottom-e.height):"width"===e.property&&("+x"===t?(e.left=i.rightMostBoxPosition.right+n,e.right=e.left+e.width):"-x"===t&&(e.right=i.leftMostBoxPosition.left-n,e.left=e.right-e.width))}static moveBoxToLinePosition(e,t,i){const s=e.cue;let r,a=new m(e),n=(function(e){if("number"==typeof e.line&&(e.snapToLines||e.line>=0&&e.line<=100))return e.line;if(!e.track||!e.track.textTrackList||!e.track.textTrackList.mediaElement)return-1;let t=0;const i=e.track,s=i.textTrackList;for(let e=0;e<s.length&&s[e]!==i;e++)"showing"===s[e].mode&&t++;return-1*++t})(s),d=[];if(s.snapToLines){let e=0;switch(s.vertical){case"":d=["+y","-y"],r="height";break;case"rl":d=["+x","-x"],r="width";break;case"lr":d=["-x","+x"],r="width"}const i=a.lineHeight,l=t[r]+i,h=d[0];if(n<0){let r=0;switch(s.vertical){case"":r=t.height-i-t.height*o;break;case"rl":case"lr":r=-t.width+i+t.width*o}e=r,d=d.reverse()}else{switch(s.vertical){case"":e=i*Math.round(n);break;case"rl":e=t.width-i*Math.round(n);break;case"lr":e=i*Math.round(n)}Math.abs(e)>l&&(e=e<0?-1:1,e*=Math.ceil(l/i)*i)}a.move(h,e)}else{const i=""===s.vertical?t.height:t.width,r=a.lineHeight/i*100;switch(s.lineAlign){case"center":n-=r/2;break;case"end":n-=r}switch(s.vertical){case"":e.applyStyles({top:e.formatStyle(n,"%")});break;case"rl":e.applyStyles({right:e.formatStyle(n,"%")});break;case"lr":e.applyStyles({left:e.formatStyle(n,"%")})}d=["+y","-y","+x","-x"],"+y"===s.axis?d=["+y","-y","+x","-x"]:"-y"===s.axis&&(d=["-y","+y","+x","-x"]),a=new m(e)}const h=(function(e,s){let r;for(let a=0;a<s.length;a++){e.moveIfOutOfBounds(t,s[a]);let n=0,o=!1;for(;e.overlapsAny(i)&&!(n>l-1);)o?e.move(s[a]):(i&&i.length>0&&(r||(r={topMostBoxPosition:m.getBoxPosition(i,"top"),bottomMostBoxPosition:m.getBoxPosition(i,"bottom"),leftMostBoxPosition:m.getBoxPosition(i,"left"),rightMostBoxPosition:m.getBoxPosition(i,"right")}),m.moveToMinimumDistancePlacement(e,s[a],r)),o=!0),n++}return e})(a,d);e.move(h.toCSSCompatValues(t))}}t.BoxPosition=m;class y{constructor(e,t){if(!e)return null;this.window=e,this.overlay=t,this.foregroundStyleOptions={fontFamily:"Helvetica",fontSize:"36px",color:"rgba(255, 255, 255, 1)",textShadow:"",backgroundColor:"rgba(0, 0, 0, 0)"},this.backgroundStyleOptions={backgroundColor:"rgba(0, 0, 0, 0.5)"},this.globalStyleCollection={};const i=e.document.createElement("div");i.style.position="absolute",i.style.left="0",i.style.right="0",i.style.top="0",i.style.bottom="0",i.style.margin=a,this.paddedOverlay=i,t.appendChild(this.paddedOverlay),this.initSubtitleCSS()}initSubtitleCSS(){const e=[new s.VTTCue(0,0,"String to init CSS - Won't be visible to user")];this.paddedOverlay.style.opacity="0",this.processCues(e),this.processCues([]),this.paddedOverlay.style.opacity="1"}convertCueToDOMTree(e){return e?r.default.parseContent(this.window,e,this.globalStyleCollection):null}setStyles(e){function t(e,t,i){for(const s in t)t.hasOwnProperty(s)&&(!0===i&&void 0!==e[s]?e[s]=t[s]:!1===i&&(e[s]=t[s]))}for(const i in e){let s=!1,r=null;i===h?(r=this.foregroundStyleOptions,s=!0):i===c&&(r=this.backgroundStyleOptions,s=!0);const a=e[i];if(!0===s)t(r,a,s);else for(let e=0;e<u.length;e++){const r=u[e].exec(i);if(r&&4===r.length){const e=r[2],i={};t(i,a,s),this.globalStyleCollection[e]=i}}}this.initSubtitleCSS(),console.log("WebVTTRenderer setStyles foregroundStyleOptions: "+JSON.stringify(this.foregroundStyleOptions)),console.log("WebVTTRenderer setStyles backgroundStyleOptions: "+JSON.stringify(this.backgroundStyleOptions)),console.log("WebVTTRenderer setStyles globalStyleCollection: "+JSON.stringify(this.globalStyleCollection))}processCues(e){if(!e)return;for(;this.paddedOverlay.firstChild;)this.paddedOverlay.removeChild(this.paddedOverlay.firstChild);if(!(function(e){for(let t=0;t<e.length;t++)if(e[t].hasBeenReset||!e[t].displayState)return!0;return!1})(e)){for(let t=0;t<e.length;t++)this.paddedOverlay.appendChild(e[t].displayState);return}const t=[],i=m.getSimpleBoxPosition(this.paddedOverlay);e.length>1&&(e=(function(e){const t=[];let i=0;for(let s=0;s<e.length;s++){let r=e[s];if("number"!=typeof r.line)return e;i+=r.line,t.push(r)}return(i/=e.length)>50?(t.forEach((function(e){e.axis="-y"})),t.sort((e,t)=>t.line-e.line)):(t.forEach((function(e){e.axis="+y"})),t.sort((e,t)=>e.line-t.line)),t})(e));for(let s=0;s<e.length;s++){let r=e[s],a=new p(this.window,r,this.foregroundStyleOptions,this.backgroundStyleOptions,this.globalStyleCollection);this.paddedOverlay.appendChild(a.div),m.moveBoxToLinePosition(a,i,t),r.displayState=a.div,t.push(m.getSimpleBoxPosition(a))}}setSize(e,t){e&&(this.overlay.style.width=e+"px"),t&&(this.overlay.style.height=t+"px")}getOverlay(){return this.overlay}}t.default=y,t.WebVTTRenderer=y}),(function(e,t,i){"use strict";function s(e){var t={};function i(s){if(t[s])return t[s].exports;var r=t[s]={i:s,l:!1,exports:{}};return e[s].call(r.exports,r,r.exports,i),r.l=!0,r.exports}i.m=e,i.c=t,i.i=function(e){return e},i.d=function(e,t,s){i.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:s})},i.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="/",i.oe=function(e){throw console.error(e),e};var s=i(i.s=ENTRY_MODULE);return s.default||s}var r="[\\.|\\-|\\+|\\w|/|@]+",a="\\((/\\*.*?\\*/)?s?.*?("+r+").*?\\)";function n(e){return(e+"").replace(/[.?*+^$[\]\\(){}|-]/g,"\\$&")}function o(e,t,s){var o={};o[s]=[];var l=t.toString(),d=l.match(/^function\s?\(\w+,\s*\w+,\s*(\w+)\)/);if(!d)return o;for(var h,c=d[1],u=new RegExp("(\\\\n|\\W)"+n(c)+a,"g");h=u.exec(l);)"dll-reference"!==h[3]&&o[s].push(h[3]);for(u=new RegExp("\\("+n(c)+'\\("(dll-reference\\s('+r+'))"\\)\\)'+a,"g");h=u.exec(l);)e[h[2]]||(o[s].push(h[1]),e[h[2]]=i(h[1]).m),o[h[2]]=o[h[2]]||[],o[h[2]].push(h[4]);for(var f,g=Object.keys(o),p=0;p<g.length;p++)for(var m=0;m<o[g[p]].length;m++)f=o[g[p]][m],isNaN(1*f)||(o[g[p]][m]=1*o[g[p]][m]);return o}function l(e){return Object.keys(e).reduce((function(t,i){return t||e[i].length>0}),!1)}e.exports=function(e,t){t=t||{};var r={main:i.m},a=t.all?{main:Object.keys(r.main)}:(function(e,t){for(var i={main:[t]},s={main:[]},r={main:{}};l(i);)for(var a=Object.keys(i),n=0;n<a.length;n++){var d=a[n],h=i[d].pop();if(r[d]=r[d]||{},!r[d][h]&&e[d][h]){r[d][h]=!0,s[d]=s[d]||[],s[d].push(h);for(var c=o(e,e[d][h],d),u=Object.keys(c),f=0;f<u.length;f++)i[u[f]]=i[u[f]]||[],i[u[f]]=i[u[f]].concat(c[u[f]])}}return s})(r,e),n="";Object.keys(a).filter((function(e){return"main"!==e})).forEach((function(e){for(var t=0;a[e][t];)t++;a[e].push(t),r[e][t]="(function(module, exports, __webpack_require__) { module.exports = __webpack_require__; })",n=n+"var "+e+" = ("+s.toString().replace("ENTRY_MODULE",JSON.stringify(t))+")({"+a[e].map((function(t){return JSON.stringify(t)+": "+r[e][t].toString()})).join(",")+"});\n"})),n=n+"new (("+s.toString().replace("ENTRY_MODULE",JSON.stringify(e))+")({"+a.main.map((function(e){return JSON.stringify(e)+": "+r.main[e].toString()})).join(",")+"}))(self);";var d=new window.Blob([n],{type:"text/javascript"});if(t.bare)return d;var h=(window.URL||window.webkitURL||window.mozURL||window.msURL).createObjectURL(d),c=new window.Worker(h);return c.objectURL=h,c}}),(function(e,t,i){"use strict";i.r(t);var s=i(14),r=i(1),a=i(12),n=i(7),o=i(2),l=i(5);t.default=function(e){var t=new a.EventEmitter;t.trigger=function(e,i){t.emit(e,e,i)},t.off=(e,i)=>t.removeListener(e,i);const i=(t,i,s)=>e.postMessage({event:t,data:i},s);e.addEventListener("message",(function({data:r}){switch(r.cmd){case"init":let a=JSON.parse(r.config);e.demuxer=new s.a(t,r.typeSupported,a,r.vendor);try{o.b.enable(!0===a.debug,a.debugLevel),o.b.setStreamAndSessionIDs(r.options.sessionID,r.options.streamID)}catch(e){console.warn("demuxerWorker: unable to enable logs")}i(n.a.INIT,null);break;case"demux":e.demuxer.push(r.data,r.decryptdata,r.initSegment,r.timeOffset,r.discontinuity,r.trackSwitch,r.contiguous,r.duration,r.accurateTimeOffset,r.defaultInitPTS,r.iframeMediaStart,r.iframeDuration)}})),t.on(r.b.FRAG_DECRYPTED,i),t.on(r.b.FRAG_PARSING_INIT_SEGMENT,i),t.on(r.b.FRAG_PARSED,i),t.on(r.b.FRAG_PARSING_USERDATA,i),t.on(r.b.FRAG_PARSING_CAPTIONDATA,i),t.on(r.b.INIT_PTS_FOUND,i),t.on(r.b.FRAG_PARSING_DATA,(e,t)=>{const s=new l.a;t.data1&&s.add(t.data1.buffer),t.data2&&s.add(t.data2.buffer),i(e,t,s.transfer)}),t.on(r.b.FRAG_PARSING_METADATA,(t,i)=>{const s=new l.a;if(i.samples)for(const e of i.samples)if(e.data&&s.add(e.data.buffer),e.frames)for(const t of e.frames)t.data&&"string"!=typeof t.data&&s.add(t.data.buffer);e.postMessage({event:t,data:i},s.transfer)}),t.on(r.b.INTERNAL_ERROR,(t,i)=>{e.postMessage({event:t,data:i})})}}),(function(e,t,i){"use strict";i.r(t);var s=i(15),r=i(1),a=i(12),n=i(2);t.default=function(e){const t=new a.EventEmitter;t.trigger=(e,i)=>{t.emit(e,e,i)},t.off=(e,i)=>t.removeListener(e,i);const i=(t,i,s)=>{s?e.postMessage({event:t,fragObjId:i,data:s},[s]):e.postMessage({event:t,data:s})};e.addEventListener("message",({data:r})=>{switch(r.cmd){case"init":const a=JSON.parse(r.config);e.decryptor=new s.a(t,a);try{n.b.enable(!0===a.debug,a.debugLevel)}catch(e){console.warn("SegmentDecryptorWorker: unable to enable logs")}i("init",null);break;case"segment-decrypt":r=r,e.decryptor.decrypt(r.fragPayload,r.decryptdata,e=>{i("segment-decrypted",r.fragObjId,e)})}}),t.on(r.b.ERROR,(t,i)=>{e.postMessage({event:t,data:i})})}}),(function(e,t,i){"use strict";i.r(t);var s=i(1),r=i(0),a=/^((?:[^\/;?#]+:)?)(\/\/[^\/\;?#]*)?(.*?)??(;.*?)?(\?.*?)?(#.*?)?$/,n=/^([^\/;?#]*)(.*)$/,o=/(?:\/|^)\.(?=\/)/g,l=/(?:\/|^)\.\.\/(?!\.\.\/).*?(?=\/)/g;const d={buildAbsoluteURL:function(e,t,i){if(i=i||{},e=e.trim(),!(t=t.trim())){if(!i.alwaysNormalize)return e;var s=d.parseURL(e);if(!s)throw new Error("Error trying to parse base URL.");return s.path=d.normalizePath(s.path),d.buildURLFromParts(s)}var r=d.parseURL(t);if(!r)throw new Error("Error trying to parse relative URL.");if(r.scheme)return i.alwaysNormalize?(r.path=d.normalizePath(r.path),d.buildURLFromParts(r)):t;var a=d.parseURL(e);if(!a)throw new Error("Error trying to parse base URL.");if(!a.netLoc&&a.path&&"/"!==a.path[0]){var o=n.exec(a.path);a.netLoc=o[1],a.path=o[2]}a.netLoc&&!a.path&&(a.path="/");var l={scheme:a.scheme,netLoc:r.netLoc,path:null,params:r.params,query:r.query,fragment:r.fragment};if(!r.netLoc&&(l.netLoc=a.netLoc,"/"!==r.path[0]))if(r.path){i.inheritQuery&&(r.query||(l.query=a.query));var h=a.path,c=h.substring(0,h.lastIndexOf("/")+1)+r.path;l.path=d.normalizePath(c)}else l.path=a.path,r.params||(l.params=a.params,r.query||(l.query=a.query));return null===l.path&&(l.path=i.alwaysNormalize?d.normalizePath(r.path):r.path),d.buildURLFromParts(l)},parseURL:function(e){var t=a.exec(e);return t?{scheme:t[1]||"",netLoc:t[2]||"",path:t[3]||"",params:t[4]||"",query:t[5]||"",fragment:t[6]||""}:null},normalizePath:function(e){for(e=e.split("").reverse().join("").replace(o,"");e.length!==(e=e.replace(l,"")).length;);return e.split("").reverse().join("")},buildURLFromParts:function(e){return e.scheme+e.netLoc+e.path+e.params+e.query+e.fragment},getHostName:function(e){var t;return e?t=(t=(t=e.indexOf("://")>-1?e.split("/")[2]:e.split("/")[0]).split(":")[0]).split("?")[0]:t}};var h=d,c=i(2);class u{constructor(e){this.logger=e,null!=e||(this.logger=c.b)}destroy(){this.abort()}abort(){clearTimeout(this.firstByteLoadTimeout),this.firstByteLoadTimeout=null,clearTimeout(this.fullLoadTimeout),this.fullLoadTimeout=null,clearTimeout(this.retryTimeout),this.retryTimeout=null}_relateServerInstanceInfoToRequest(e){this.context.collectServerInstanceInfo&&(this.context.serverInstanceInfo={},this.context.collectServerInstanceInfo.forEach(t=>{let i=e.getResponseHeader(t);i&&(this.context.serverInstanceInfo[t]=i)}))}load(e,t,i){this.context=e,this.config=t,this.callbacks=i,this.stats={aborted:!1,trequest:performance.now(),tfirst:0,loaded:0,retry:0},this.loadInternal()}loadsuccess(e,t){let i,s,r=this.context,a=this.stats;a.tload=Math.max(a.tfirst,performance.now()),s="arraybuffer"===r.responseType?(i=e.response).byteLength:(i=e.responseText).length,a.tdataack=performance.now(),a.loaded=a.total=s,a.contentType=e.getResponseHeader("Content-Type");let n={url:e.responseURL,data:i,len:s,contentLen:t};this._relateServerInstanceInfoToRequest(e),this.callbacks.onSuccess(n,a,r),a.retry=0}loaderror(e,t){if(this.abort(),this.retryConfig=this.config.errorRetry,!this.config.autoRetry||e>=400&&e<499||!this.scheduleRetry()){this.logger.error(`[QE Critical] ${e} while loading url type: ${this.type}`)();let i={code:e,text:t};this.callbacks.onError(i,this.context)}}scheduleRetry(){let e=this.stats,t=!1,i=this.retryConfig;if(clearTimeout(this.retryTimeout),e.retry<i.maxNumRetry){let s=Math.min(Math.pow(2,e.retry)*i.retryDelayMs,i.maxRetryDelayMs);e.retry++,e.aborted=!1,this.logger.warn(`[QE Critical] current retryCount ${e.retry} schedule retry in ${s} ms`)(),this.retryTimeout=setTimeout(this.loadInternal.bind(this),s),t=!0}return t}resetStats(){let e=this.stats;e.aborted=!1,e.tfirst=0,e.loaded=0,e.trequest=performance.now()}setupTimeouts(){isFinite(this.config.maxLoadTimeMs)&&this.config.maxLoadTimeMs>0&&(this.fullLoadTimeout=setTimeout(this.loadtimeout.bind(this,!1),this.config.maxLoadTimeMs)),isFinite(this.config.maxTimeToFirstByteMs)&&this.config.maxTimeToFirstByteMs>0&&(this.firstByteLoadTimeout=setTimeout(this.loadtimeout.bind(this,!0),this.config.maxTimeToFirstByteMs))}loadtimeout(e){this.abort();let t=e?"maxTimeToFirstByteMs":"maxLoadTimeMs";this.logger.warn(`[QE Critical] timeout while loading url type: ${this.type}, this.config.${t}: ${this.config[t]}`)(),this.retryConfig=this.config.timeoutRetry,this.callbacks.onTimeout(this.stats,this.context)}}var f=class extends u{constructor(e,t){super(t),e&&e.xhrSetup&&(this.xhrSetup=e.xhrSetup)}abort(){var e=this.request;e&&4!==e.readyState&&(this.stats.aborted=!0,e.abort()),this.request=null,super.abort()}get loader(){return this.request}overrideMimeType(e){this.request&&typeof this.request.overrideMimeType==typeof Function?this.request.overrideMimeType(e):this.mimeType=e}responseXML(){let e=null;return this.request&&this.request.responseXML&&(e=this.request.responseXML),e}loadInternal(){var e,t=this.context;"undefined"!=typeof XDomainRequest?e=this.request=new XDomainRequest:(e=this.request=new XMLHttpRequest,this.mimeType&&typeof this.request.overrideMimeType==typeof Function&&this.request.overrideMimeType(this.mimeType)),this.resetStats();const i=this.xhrSetup;let s=t.method?t.method:"GET";try{if(i)try{i(e,t.url)}catch(r){e.open(s,t.url,!0),i(e,t.url)}e.readyState||e.open(s,t.url,!0)}catch(i){return void this.callbacks.onError({code:e.status,text:i.message},t)}t.sessionID&&e.setRequestHeader("X-Playback-Session-Id",t.sessionID),t.rangeEnd&&e.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),e.onreadystatechange=this.readystatechange.bind(this),e.onprogress=this.loadprogress.bind(this),e.responseType=t.responseType,this.setupTimeouts(),"POST"===s&&t.payload?e.send(t.payload):e.send()}getByteRangeLength(e){let t=/([0-9]+)\-([0-9]+)\/([0-9]+)/.exec(e);return t?parseInt(t[2])-parseInt(t[1])+1:void 0}getContentLength(e){let t,i=e.getResponseHeader("Content-Encoding"),s=e.getResponseHeader("Transfer-Encoding"),r=!i||i&&"identity"===i.toLowerCase(),a=!s||s&&"identity"===s.toLowerCase();return r&&a&&(t=this.getByteRangeLength(e.getResponseHeader("Content-Range")),isNaN(t)&&(t=parseInt(e.getResponseHeader("Content-Length")))),t}readystatechange(e){var t=e.currentTarget,i=t.readyState,s=this.stats;if(this.context,this.config,!s.aborted&&i>=2&&(0===s.tfirst&&(s.tfirst=Math.max(performance.now(),s.trequest)),this.firstByteLoadTimeout&&(clearTimeout(this.firstByteLoadTimeout),this.firstByteLoadTimeout=null),s.cdnServer=t.getResponseHeader("CDN-Server"),4===i)){this.fullLoadTimeout&&(clearTimeout(this.fullLoadTimeout),this.fullLoadTimeout=null);let e=t.status;e>=200&&e<300?this.loadsuccess(t,this.config.forceContentLenCheckIfNoHeader?this.getContentLength(t):void 0):this.loaderror(e,t.statusText)}}loadprogress(e){var t=e.currentTarget,i=this.stats;let s=this.callbacks.onProgress;s&&3===t.readyState&&(i.loaded=e.loaded,e.lengthComputable&&(i.total=e.total),s(i,this.context,this.request.response))}get type(){let e=this.context;return e&&(e.frag&&e.frag.type||e.type)||""}},g=i(5),p=class extends u{constructor(e){super(e.logger),this.hls=e,this._loader=void 0}abort(){this.onuriloaded&&(this.hls.off(s.b.UNRESOLVED_URI_LOADED,this.onuriloaded),this.onuriloaded=void 0);var e=this._loader;e&&(e.abort(),this.stats.aborted=e.stats.aborted),this._loader=void 0,super.abort()}loadInternal(){var e=this.context;this.resetStats(),this.setupTimeouts(),this.onuriloaded=this.onUnresolvedUriLoaded.bind(this),this.hls.on(s.b.UNRESOLVED_URI_LOADED,this.onuriloaded);let t={uri:e.url,userAgent:navigator.userAgent};this.hls.trigger(s.b.UNRESOLVED_URI_LOADING,t)}onUnresolvedUriLoaded(e,t){let i=t.uri,s=t.response;this.context.url===i&&this.handleExternalResponse(s)}handleExternalResponse(e){if(this.hls.off(s.b.UNRESOLVED_URI_LOADED,this.onuriloaded),this.stats.aborted)return;let t=this.stats,i=this.context;0===t.tfirst&&(t.tfirst=Math.max(performance.now(),t.trequest)),this.fullLoadTimeout&&(clearTimeout(this.fullLoadTimeout),this.fullLoadTimeout=null),this.firstByteLoadTimeout&&(clearTimeout(this.firstByteLoadTimeout),this.firstByteLoadTimeout=null);let r=e.status||200;if(r>=200&&r<300)this.loadsuccess({responseURL:i.url,response:e.data,get responseText(){return g.b.utf8arrayToStr(new Uint8Array(this.response))},getResponseHeader:()=>{}});else{let t;switch(r){case 300:case 302:case 303:case 305:t=e.uri}t?this.redirectRequest(t):this.loaderror(r,"Unable to load custom url")}}redirectRequest(e){let t=this.stats,i=this.config;this._loader=new f(this.hls.config);let s=function(e){let t=this.stats.trequest;this.stats=Object.assign({},e),this.stats.trequest=t}.bind(this),r=Object.assign({},this.context),a=Object.assign({},this.config),n={onSuccess:function(e,t){s(t),this.callbacks.onSuccess(e,this.stats,this.context)}.bind(this),onError:function(e){this.callbacks.onError(e,this.context)}.bind(this),onTimeout:function(e){s(e),this.loadtimeout(!1)}.bind(this),onProgress:function(e,t,i){this.stats.loaded=e.loaded,e.total&&(this.stats.total=e.total),this.callbacks.onProgress&&this.callbacks.onProgress(this.stats,this.context,i)}.bind(this)};r.url=e,a.maxLoadTimeMs=i.maxLoadTimeMs-(performance.now()-t.trequest),a.maxTimeToFirstByteMs=i.maxTimeToFirstByteMs-(performance.now()-t.trequest),!isFinite(i.maxLoadTimeMs)||i.maxLoadTimeMs<=0||a.maxLoadTimeMs>0&&a.maxTimeToFirstByteMs>0?this._loader.load(r,a,n):a.maxTimeToFirstByteMs<=0?this.loadtimeout(!0):a.maxLoadTimeMs<=0&&this.loadtimeout(!1)}get loader(){return this._loader?this._loader.loader:void 0}static isCustomUrl(e){let t=d.parseURL(e);return"http:"!==t.scheme&&"https:"!==t.scheme}overrideMimeType(e){}responseXML(){}get type(){return this.context?this.context.type:""}},m=i(6);const y={avc1:"video/mp4",avc3:"video/mp4",dvav:"video/mp4",dva1:"video/mp4",hev1:"video/mp4",hvc1:"video/mp4",dvh1:"video/mp4",dvhe:"video/mp4"};var v={mp4a:"audio/mp4","ac-3":"audio/mp4","ec-3":"audio/mp4"};function b(e){let t=g.b.strToUtf8array(e).subarray(0,16),i=new Uint8Array(16);return i.set(t,16-t.length),i}var T={getCapabilities:function(e,t){let i={videoCapabilities:new Array,audioCapabilities:new Array};return e&&e.forEach((function(e){let t=e.split(".")[0].trim();t in y&&i.videoCapabilities.push({contentType:y[t]+";codecs="+e,robustness:""})})),t&&t.forEach((function(e){let t=e.split(".")[0].trim();t in v&&i.audioCapabilities.push({contentType:v[t]+";codecs="+e,robustness:""})})),i},changeEndianness:function(e){let t=function(e,t,i){let s=e[t];e[t]=e[i],e[i]=s};t(e,0,3),t(e,1,2),t(e,4,5),t(e,6,7)},getKeyIdBytes:b,convertDataUriToArrayBytes:function(e){let t=e.split(":"),i=null;if("data"===t[0]&&2===t.length){let e=t[1].split(";"),s=e[e.length-1].split(",");if(2===s.length){let t="base64"===s[0],r=s[1];t?(e.splice(-1,1),i=m.a.base64Decode(r)):i=b(r)}}return i},makeKeyIdsInitData:function(e){let t={kids:e.map(m.a.base64UrlEncode)};return g.b.strToUtf8array(JSON.stringify(t))},parsePSSHList:function(e){let t=new DataView(e),i=0,s={};for(;i<t.buffer.byteLength;){let e,r=i,a=t.getUint32(i);if(i+=4,e=r+a,1886614376!==t.getUint32(i)){i=e;continue}switch(i+=4,t.getUint8(i)){case 0:case 1:i+=1;break;default:i=e}i+=3;let n="";for(let e=0;e<16;++e,++i)switch(n+=t.getUint8(i).toString(16),e){case 4:case 6:case 8:case 10:n+="-"}i+=4,s[n]=t.buffer.slice(r,e)}return s}},S={id:"playready",systemStringPrefix:"com.microsoft.playready",keyFormatString:"com.microsoft.playready"},I={id:"widevine",systemStringPrefix:"com.widevine.alpha",keyFormatString:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"};const E={NONE:"","AES-128":"","ISO-23001-7":"","SAMPLE-AES":"","SAMPLE-AES-CTR":""};let _={};class R{constructor(e,t,i,s,r){if(this.method=e,this.uri=t,this.iv=i,this.format=s,this.formatversions=r,this.isEncrypted=this.method&&"NONE"!==this.method,this.formatversions&&0!==this.formatversions.length||(this.formatversions=[1]),this.key=null,this.keyId=null,this.expiryPosition=1/0,!this.isEncrypted)return;let a=T.convertDataUriToArrayBytes(this.uri);if(a)switch(s){case S.keyFormatString:{this.pssh=a;let e=new Uint16Array(a.buffer);var n,o=String.fromCharCode.apply(null,e),l=o.substring(o.indexOf("<"),o.length),d=(new DOMParser).parseFromString(l,"text/xml").getElementsByTagName("KID")[0];if(d)if(n=d.childNodes[0]?d.childNodes[0].nodeValue:d.getAttribute("VALUE")){let e=m.a.base64Decode(n).subarray(0,16);T.changeEndianness(e),this.keyId=e}break}case I.keyFormatString:this.pssh=a,a.length>=22&&(this.keyId=a.subarray(a.length-22,a.length-6));break;default:{let e=a.subarray(0,16);if(16!==e.length){let t=new Uint8Array(16);t.set(e,16-e.length),e=t}this.keyId=e;break}}if(!this.keyId||16!==this.keyId.byteLength){let e=_[this.uri];if(!e){let t=Object.keys(_).length%Number.MAX_SAFE_INTEGER;e=new Uint8Array(16),new DataView(e.buffer,12,4).setUint32(0,t),_[this.uri]=e}this.keyId=e}}static clearKeyUriToKeyIdMap(){_={}}}var D=R;const A={afr:"af",aka:"ak",amh:"am",ara:"ar",arg:"an",asm:"as",ava:"av",ave:"ae",aym:"ay",aze:"az",bam:"bm",bel:"be",ben:"bn",bih:"bh",bod:"bo",bos:"bs",bre:"br",bul:"bg",cat:"ca",ces:"cs",cha:"ch",che:"ce",chu:"cu",chv:"cv",cor:"kw",cos:"co",cre:"cr",cym:"cy",dan:"da",deu:"de",div:"dv",dzo:"dz",ell:"el",eng:"en",epo:"eo",est:"et",eus:"eu",ewe:"ee",fao:"fo",fas:"fa",fin:"fi",fra:"fr",fry:"fy",ful:"ff",gla:"gd",gle:"ga",glg:"gl",glv:"gv",grn:"gn",guj:"gu",hat:"ht",heb:"he",her:"hz",hin:"hi",hmo:"ho",hrv:"hr",hun:"hu",hye:"hy",ibo:"ig",ido:"io",iii:"ii",iku:"iu",ile:"ie",ina:"ia",ind:"id",isl:"is",ita:"it",jav:"jv",jpn:"ja",kal:"kl",kan:"kn",kas:"ks",kat:"ka",kau:"kr",kaz:"kk",khm:"km",kik:"ki",kin:"rw",kir:"ky",kom:"kv",kon:"kg",kor:"ko",kua:"kj",kur:"ku",lao:"lo",lat:"la",lav:"lv",lim:"li",lit:"lt",ltz:"lb",lub:"lu",lug:"lg",mah:"mh",mal:"ml",mar:"mr",mkd:"mk",mlg:"mg",mlt:"mt",mol:"mo",mon:"mn",mri:"mi",msa:"ms",mya:"my",nav:"nv",nbl:"nr",nde:"nd",ndo:"ng",nep:"ne",nld:"nl",nno:"nn",nob:"nb",nya:"ny",oci:"oc",oji:"oj",ori:"or",orm:"om",oss:"os",pan:"pa",pli:"pi",pol:"pl",por:"pt",pus:"ps",que:"qu",roh:"rm",ron:"ro",run:"rn",rus:"ru",san:"sa",sin:"si",slk:"sk",slv:"sl",sme:"se",snd:"sd",som:"so",spa:"es",sqi:"sq",srd:"sc",srp:"sr",sun:"su",swa:"sw",swe:"sv",tah:"ty",tam:"ta",tat:"tt",tel:"te",tgk:"tg",tgl:"tl",tha:"th",tir:"ti",ton:"to",tuk:"tk",tur:"tr",uig:"ug",ukr:"uk",urd:"ur",uzb:"uz",ven:"ve",vie:"vi",wln:"wa",yid:"yi",zha:"za",zho:"zh"},L={isLanguageCode:function(e){return e in A},shortenLanguageCode:function(e){let t;if(e){let i=e.indexOf("-"),s=i>=0?e.slice(0,i):e;L.isLanguageCode(s)&&(t=A[s]),t||(t=s),i>0&&(t+="-"+e.slice(i+1))}return t}};var w=L;class k{constructor(e){this._url=null,this._byteRange=null,this.inheritQuery=e,this.tagList=new Array,this.loadCounter=0,this.iframe=!1}equals(e){return e.sn===this.sn&&e.level===this.level}get url(){return!this._url&&this.relurl&&(this._url=d.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0,inheritQuery:this.inheritQuery})),this._url}set url(e){this._url=e}get programDateTime(){return!this._programDateTime&&this.rawProgramDateTime&&(this._programDateTime=new Date(Date.parse(this.rawProgramDateTime))),this._programDateTime}get byteRange(){if(!this._byteRange){let e=new Array(2);if(this.rawByteRange){const t=this.rawByteRange.split("@",2);if(1===t.length){const t=this.lastByteRangeEndOffset;e[0]=t||0}else e[0]=parseInt(t[1]);e[1]=parseInt(t[0])+e[0]}this._byteRange=e}return this._byteRange}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get decryptdata(){return this._decryptdata||(this._decryptdata=this.fragmentDecryptdataFromLevelkey(this.levelkey,this.sn)),this._decryptdata}set decryptdata(e){this._decryptdata=e}static createInitializationVector(e){for(var t=new Uint8Array(16),i=12;i<16;i++)t[i]=e>>8*(15-i)&255;return t}fragmentDecryptdataFromLevelkey(e,t){var i=e;if(e&&e.method&&e.uri&&!e.iv&&(!e.format||"identity"===e.format)){let s=k.createInitializationVector(t);i=new D(e.method,e.uri,s,e.format,e.formatversions)}return i}get rangeString(){return this.start>=0&&this.duration>=0?`${this.start.toFixed(2)}-${(this.start+this.duration).toFixed(2)}`:"N/A"}get fragTag(){return`sn/cc/level: ${this.sn}/${this.cc}/${this.level}`}}var C=k,P=class{constructor(e,...t){this.hls=e,this.destroyed=!1,this.hls=e,this.logger=e.logger,this.onEvent=this.onEvent.bind(this),this.handledEvents=t,this.registerListeners()}destroy(){this.destroyed=!0,this.unregisterListeners()}registerListeners(){for(const e of this.handledEvents)this.hls.on(e,this.onEvent)}unregisterListeners(){for(const e of this.handledEvents)this.hls.off(e,this.onEvent)}onEvent(e,t){if(this.destroyed)this.logger.warn(`Event fired after event handler is destroyed! Event name: ${e}`)();else try{const i="on"+e.replace("hls",""),a=this[i];if("function"!=typeof a)throw new Error(`Event ${e} has no generic handler in this ${this.constructor.name} class (tried ${i})`);a.call(this,t)}catch(t){this.logger.error(`internal error happened while processing ${e}:${t.message} ${t.stack}`)();let i=new r.h(r.g.OTHER_ERROR,r.d.INTERNAL_EXCEPTION,!1,t.message);i.response=r.f.InternalError,i.event=e,i.err=t,this.hls.trigger(s.a.ERROR,i)}}};const M={"com.apple.hls.chapters":!0},O={JSON_PARSE_ERROR:-1};var N=function(e){if(!e.complete&&e.itemList){e.complete=!0;for(let t=0;t<e.itemList.length;++t){let i=e.itemList[t];if(M[i["DATA-ID"]]&&!i.VALUE&&!i._STATUS){e.complete=!1;break}}e.complete}return e.complete};class x extends P{constructor(e){super(e,s.b.SESSION_DATA_LOADING),this.loader=null,this.nextSessionDataItemId=0}destroy(){this.loader&&this.loader.destroy(),P.prototype.destroy.call(this)}onSessionDataLoading(e){this.loadSessionData(e.sessionData)}loadSessionData(e){let t,i,r,a=!1;for(;!1===a&&e.itemList&&this.nextSessionDataItemId<e.itemList.length;){let s=e.itemList[this.nextSessionDataItemId];i=s["DATA-ID"],s.URI&&M[i]&&(t=h.buildAbsoluteURL(this.hls.baseurl,s.URI,{alwaysNormalize:!0}),r="",s.VALUE=null,a=!0,this.loadSessionDataItemWithURL(t,i,"")),this.nextSessionDataItemId=this.nextSessionDataItemId+1}!1===a&&N(e)&&this.hls.trigger(s.b.SESSION_DATA_COMPLETE,{})}loadSessionDataItemWithURL(e,t,i){let s,r,a,n=this.loader,o=this.hls.config;n&&n.abort(),n=this.loader=p.isCustomUrl(e)?new p(this.hls):new o.loader(o),this.loader.overrideMimeType("application/xml"),s={type:"session",url:e,id:t,responseType:i,sessionID:o.useHTTPPlaybackSessionId?this.hls.sessionID:void 0},r=p.isCustomUrl(e)?o.fragLoadPolicy.customURL:o.fragLoadPolicy.default,a={onSuccess:this.onLoadSuccess.bind(this),onError:this.onLoadError.bind(this),onTimeout:this.onLoadTimeout.bind(this)},n.load(s,r,a)}stringIsXMLPlist(e){const t=/[\s]*<\?xml/i;let i,s;return t.lastIndex=0,(i=t.exec(e))||(s=/[\s]*<plist/i.exec(e)),i||s}stringIsJSONPlist(e){const t=/[\s]*[\{\[]/;return t.lastIndex=0,null!=t.exec(e)}onLoadSuccess(e,t,i){let s,r=this.hls,a=e.data,n=i.id,o=null;if(this.stringIsXMLPlist(a)&&(o=this.loader.responseXML()))s=this.convertPlisttoJSON(o),this.setSessionData(r.sessionData,n,"VALUE",s);else if(this.stringIsJSONPlist(a))try{s=JSON.parse(a),this.setSessionData(r.sessionData,n,"VALUE",s)}catch(e){this.setSessionData(r.sessionData,n,"VALUE",a),this.setSessionData(r.sessionData,n,"_STATUS",O.JSON_PARSE_ERROR)}else this.setSessionData(r.sessionData,n,"VALUE",a);this.loadSessionData(this.hls.sessionData),this.loader=void 0}onLoadError(e,t){let i=t.url,a=t.id;this.loader=void 0,this.setSessionData(this.hls.sessionData,a,"_STATUS",e.code),this.hls.trigger(s.b.INTERNAL_ERROR,{type:r.g.NETWORK_ERROR,details:r.d.SESSION_DATA_LOAD_ERROR,fatal:!1,id:a,url:i,response:e})}onLoadTimeout(e,t){let i=t.url,a=t.id;this.loader=void 0,this.hls.trigger(s.b.INTERNAL_ERROR,{type:r.g.NETWORK_ERROR,details:r.d.SESSION_DATA_LOAD_TIMEOUT,fatal:!1,id:a,url:i})}setSessionData(e,t,i,s){if(e.itemList){let r;for(r=0;r<e.itemList.length;++r){let a=e.itemList[r];if(a["DATA-ID"]===t){a[i]=s;break}}e.itemList.length}}convertPlisttoJSON(e){var t=null,i=e.childNodes;if(i)if(e.tagName){if("plist"===e.tagName.toLowerCase()){t=[];for(let e=0;e<i.length;++e){let s=i[e];s.tagName&&t.push(this.convertPlisttoJSON(s))}1===t.length&&(t=t[0])}if("array"===e.tagName.toLowerCase()){t=[];for(let e=0;e<i.length;++e){let s=i[e];s.tagName&&t.push(this.convertPlisttoJSON(s))}}if("dict"===e.tagName.toLowerCase()){var s,r,a=0;t={};for(let e=0;e<i.length;e++)i[e].tagName&&(a%2==0?"key"===i[e].tagName.toLowerCase()&&(s=this.convertPlisttoJSON(i[e]),a++):(r=this.convertPlisttoJSON(i[e]),t[s]=r,s=null,r=null,a++));s&&(t[s]=r,s=null,r=null)}else"key"===e.tagName.toLowerCase()?t=i[0]?i[0].nodeValue:null:"string"===e.tagName.toLowerCase()?t=i[0]?i[0].nodeValue:null:"integer"===e.tagName.toLowerCase()?t=i[0]?parseInt(i[0].nodeValue):0:"float"===e.tagName.toLowerCase()?t=i[0]?parseFloat(i[0].nodeValue):0:"date"===e.tagName.toLowerCase()?t=i[0]?new Date(i[0].nodeValue):null:"data"===e.tagName.toLowerCase()?t=i[0]?atob(i[0].nodeValue):null:"true"===e.tagName.toLowerCase()?t=!0:"false"===e.tagName.toLowerCase()&&(t=!1)}else if(0===i.length);else{t=[];for(let e=0;e<i.length;++e){let s=i[e];s.tagName&&t.push(this.convertPlisttoJSON(s))}1===t.length&&(t=t[0])}return t}}const F={canplay:"canplay",desiredratechange:"desiredratechange",pause:"pause",playing:"playing",ended:"ended",mediaerror:"mediaerror",playbackinfo:"playbackinfo",manifestparsed:"manifestparsed",manifestloaded:"manifestloaded",fragloading:"fragloading",fragloaded:"fragloaded",fragbuffered:"fragbuffered",variantend:"variantend",segmentkeyloaded:"segmentkeyloaded",levelloaded:"levelloaded",levelloaderror:"levelloaderror",levelswitched:"levelswitched",bufferstalled:"bufferstalled",mediaenginestalled:"mediaenginestalled",nwerror:"nwerror",spcrequested:"spcrequested",spcreceived:"spcreceived",spcsubmitted:"spcsubmitted",spccreated:"spccreated",ckcrequested:"ckcrequested",ckcreceived:"ckcreceived",ckcsubmitted:"ckcsubmitted",ckcprocessed:"ckcprocessed",keyaborted:"keyaborted",spcerror:"spcerror",ckcerror:"ckcerror"},B=6101,U=6110,$=6103,V=6106,G=6107,K=6108,H=6202,W=["PlayTimeWC","PlayTime","PlayType","StallCount","MediaEngineStallCount","InitTime","PauseTime","StallTime","LastPause","LastStall","LastMediaEngineStall","MediaEngineStallTime","ADT","SegmentProcessTime","SegmentParseTime","PlaylistADT","MaxPlaylistDT","MasterPlaylistADT","NwErrCount","PlayerErrCount","FatalNwErrCount","FatalPlayerErrCount","GroupViFrDr","GroupViFrDrEvtCount","SparseViFrDr","SparseViFrDrEvtCount","AvgVideoBitrate","AvgAudioBitrate","TWOBR","PerceivedTWOBR","NetTWOBR","PlayerTWIBR","PlayerTWIABR","TWBitRk","SwCnt","NetBytes","TargetDur","VariantList","PlaylistMimeType","SegmentMimeType","MediaRequestsSent","Rate","ReWd","ReHt","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt","IsGapless","IsAudioOnly","IsFirstItem","ItemID","ServerInfo"],j=["EventCounter","PInterval","PlayTimeWC","PlayTime","PlayType","StallCount","MediaEngineStallCount","InitTime","PauseTime","StallTime","MediaEngineStallTime","ADT","SegmentProcessTime","SegmentParseTime","PlaylistADT","MaxPlaylistDT","MasterPlaylistADT","NwErrCount","PlayerErrCount","FatalNwErrCount","FatalPlayerErrCount","GroupViFrDr","GroupViFrDrEvtCount","SparseViFrDr","SparseViFrDrEvtCount","AvgVideoBitrate","AvgAudioBitrate","TWOBR","PerceivedTWOBR","NetTWOBR","PlayerTWIBR","PlayerTWIABR","TWBitRk","SwCnt","NetBytes","TargetDur","VariantList","MediaRequestsSent","Rate","ReWd","ReHt","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt","IsGapless","IsAudioOnly","IsFirstItem","ItemID","ServerInfo"],q=["MediaDur","BitRnk","Codecs","PlayTime","PlayType","LastLikelyToKeepUp","LastSwitch","LastResume","NwErrTime","NwErrCode","LaSwDir","TargetDur","PlayerIABR","PlayerIBR","Rate","OBRLast","OBRMean","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt","IsGapless","IsAudioOnly","IsFirstItem","ItemID","ServerInfo"],Y=["KeyFormat","CDMVersion","SPCRequestTime","SPCCreationTime","CKCResponseTime","CKCProcessTime","KeyDeliveryTime","CurrentMediaTime","KeyInitTime","KeyErrorType","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt","IsGapless","IsAudioOnly","IsFirstItem","ItemID","ServerInfo"],z=["EventCounter","PlayType","PlayerIABR","PlayerIBR","MediaDur","BitRnk","Codecs","StartupTime","PlaylistADT","TargetDur","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt","IsGapless","IsAudioOnly","IsFirstItem","ItemID","ServerInfo"],Q=["Rate","PlayType","StNPT","StartupTime","PlayerIABR","PlayerIBR","BitRnk","MediaDur","Codecs","LastPause","LastStall","LastMediaEngineStall","RateChangePlayTime","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt","IsGapless","IsAudioOnly","IsFirstItem","ItemID","ServerInfo"],X=["ErrCode","ErrIsFatal","PlayerErrCount","ErrDomain","PlayType","BitRnk","MediaDur","PlayTime","PlayTimeWC","PlayerIABR","PlayerIBR","LastStall","LastMediaEngineStall","LastLikelyToKeepUp","LastSwitch","LastResume","VideoQltyIndex","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt","IsGapless","IsAudioOnly","IsFirstItem","ItemID","ServerInfo"],J=["MediaDur","BitRnk","Codecs","PlayTime","PlayType","LastLikelyToKeepUp","LastSwitch","LastResume","LaSwDir","TargetDur","PlayerIABR","PlayerIBR","Rate","OBRLast","OBRMean","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt","IsGapless","IsAudioOnly","IsFirstItem","ItemID","ServerInfo"],Z=["FrBitRnk","ToBitRnk","TimeToBitrate","MediaDur","Rate","PlayType","SwFail","PlayerIBR","PlayerIABR","LastPlayerIBR","LastPlayerIABR","PlayTime","PlayTimeLastSW","BadSw","ReWd","ReHt","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt","IsGapless","IsAudioOnly","IsFirstItem","ItemID","ServerInfo"],ee=["Rate","PlayType","VarAvgBitrate","VarPeakBitrate","VarBitRk","VarSTTime","VarEndTime","VarPlayTime","VarPlayTimeWC","IFR","ODR","ReWd","ReHt","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt","IsGapless","IsAudioOnly","IsFirstItem","ItemID","ServerInfo"],te=["ErrCode","ErrReason","ErrIsFatal","NwErrCount","ErrDomain","PlayTime","PlayTimeWC","LastResume","BitRnk","PlayType","LastMediaCDNServer","MaxVideoQltyIndex","MaxReWd","MaxReHt","IsGapless","IsAudioOnly","IsFirstItem","ItemID","ServerInfo"],ie="rtcStateInit",se="rtcStatePause",re="rtcStatePlay",ae="rtcStateStall",ne="rtcStateMediaEngineStall",oe="rtcStateStop",le=[V,$,K,H,G,B],de=["aapl","akam","llnw"],he={avc1:1,avc3:1,hvc1:{SDR:2,HLG:10,PQ:11},hev1:{SDR:2,HLG:10,PQ:11},vp09:{SDR:3,HLG:14,PQ:13},dvh1:{PQ:12}};var ce={id:"fairplaystreaming",systemStringPrefix:"com.apple.fps",keyFormatString:"com.apple.streamingkeydelivery"},ue=function(e,t){return(ue=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function fe(e,t){function i(){this.constructor=e}ue(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}function ge(e,t){var i,s,r,a,n={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return a={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(a){return function(o){return (function(a){if(i)throw new TypeError("Generator is already executing.");for(;n;)try{if(i=1,s&&(r=2&a[0]?s.return:a[0]?s.throw||((r=s.return)&&r.call(s),0):s.next)&&!(r=r.call(s,a[1])).done)return r;switch(s=0,r&&(a=[2&a[0],r.value]),a[0]){case 0:case 1:r=a;break;case 4:return n.label++,{value:a[1],done:!1};case 5:n.label++,s=a[1],a=[0];continue;case 7:a=n.ops.pop(),n.trys.pop();continue;default:if(!(r=(r=n.trys).length>0&&r[r.length-1])&&(6===a[0]||2===a[0])){n=0;continue}if(3===a[0]&&(!r||a[1]>r[0]&&a[1]<r[3])){n.label=a[1];break}if(6===a[0]&&n.label<r[1]){n.label=r[1],r=a;break}if(r&&n.label<r[2]){n.label=r[2],n.ops.push(a);break}r[2]&&n.ops.pop(),n.trys.pop();continue}a=t.call(e,n)}catch(e){a=[6,e],s=0}finally{i=r=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}})([a,o])}}}function pe(e){return this instanceof pe?(this.v=e,this):new pe(e)}function me(e){return"function"==typeof e}var ye=!1,ve={Promise:void 0,set useDeprecatedSynchronousErrorHandling(e){if(e){var t=new Error;console.warn("DEPRECATED! RxJS was set to use deprecated synchronous error handling behavior by code at: \n"+t.stack)}else ye&&console.log("RxJS: Back to a better error behavior. Thank you. <3");ye=e},get useDeprecatedSynchronousErrorHandling(){return ye}};function be(e){setTimeout((function(){throw e}),0)}var Te={closed:!0,next:function(e){},error:function(e){if(ve.useDeprecatedSynchronousErrorHandling)throw e;be(e)},complete:function(){}},Se=Array.isArray||function(e){return e&&"number"==typeof e.length};function Ie(e){return null!==e&&"object"==typeof e}var Ee=(function(){function e(e){return Error.call(this),this.message=e?e.length+" errors occurred during unsubscription:\n"+e.map((function(e,t){return t+1+") "+e.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=e,this}return e.prototype=Object.create(Error.prototype),e})(),_e=(function(){function e(e){this.closed=!1,this._parentOrParents=null,this._subscriptions=null,e&&(this._unsubscribe=e)}var t;return e.prototype.unsubscribe=function(){var t;if(!this.closed){var i=this._parentOrParents,s=this._unsubscribe,r=this._subscriptions;if(this.closed=!0,this._parentOrParents=null,this._subscriptions=null,i instanceof e)i.remove(this);else if(null!==i)for(var a=0;a<i.length;++a)i[a].remove(this);if(me(s))try{s.call(this)}catch(e){t=e instanceof Ee?Re(e.errors):[e]}if(Se(r)){a=-1;for(var n=r.length;++a<n;){var o=r[a];if(Ie(o))try{o.unsubscribe()}catch(e){t=t||[],e instanceof Ee?t=t.concat(Re(e.errors)):t.push(e)}}}if(t)throw new Ee(t)}},e.prototype.add=function(t){var i=t;if(!t)return e.EMPTY;switch(typeof t){case"function":i=new e(t);case"object":if(i===this||i.closed||"function"!=typeof i.unsubscribe)return i;if(this.closed)return i.unsubscribe(),i;if(!(i instanceof e)){var s=i;(i=new e)._subscriptions=[s]}break;default:throw new Error("unrecognized teardown "+t+" added to Subscription.")}var r=i._parentOrParents;if(null===r)i._parentOrParents=this;else if(r instanceof e){if(r===this)return i;i._parentOrParents=[r,this]}else{if(-1!==r.indexOf(this))return i;r.push(this)}var a=this._subscriptions;return null===a?this._subscriptions=[i]:a.push(i),i},e.prototype.remove=function(e){var t=this._subscriptions;if(t){var i=t.indexOf(e);-1!==i&&t.splice(i,1)}},e.EMPTY=((t=new e).closed=!0,t),e})();function Re(e){return e.reduce((function(e,t){return e.concat(t instanceof Ee?t.errors:t)}),[])}var De="function"==typeof Symbol?Symbol("rxSubscriber"):"@@rxSubscriber_"+Math.random(),Ae=(function(e){function t(i,s,r){var a=e.call(this)||this;switch(a.syncErrorValue=null,a.syncErrorThrown=!1,a.syncErrorThrowable=!1,a.isStopped=!1,arguments.length){case 0:a.destination=Te;break;case 1:if(!i){a.destination=Te;break}if("object"==typeof i){i instanceof t?(a.syncErrorThrowable=i.syncErrorThrowable,a.destination=i,i.add(a)):(a.syncErrorThrowable=!0,a.destination=new Le(a,i));break}default:a.syncErrorThrowable=!0,a.destination=new Le(a,i,s,r)}return a}return fe(t,e),t.prototype[De]=function(){return this},t.create=function(e,i,s){var r=new t(e,i,s);return r.syncErrorThrowable=!1,r},t.prototype.next=function(e){this.isStopped||this._next(e)},t.prototype.error=function(e){this.isStopped||(this.isStopped=!0,this._error(e))},t.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this))},t.prototype._next=function(e){this.destination.next(e)},t.prototype._error=function(e){this.destination.error(e),this.unsubscribe()},t.prototype._complete=function(){this.destination.complete(),this.unsubscribe()},t.prototype._unsubscribeAndRecycle=function(){var e=this._parentOrParents;return this._parentOrParents=null,this.unsubscribe(),this.closed=!1,this.isStopped=!1,this._parentOrParents=e,this},t})(_e),Le=(function(e){function t(t,i,s,r){var a,n=e.call(this)||this;n._parentSubscriber=t;var o=n;return me(i)?a=i:i&&(a=i.next,s=i.error,r=i.complete,i!==Te&&(me((o=Object.create(i)).unsubscribe)&&n.add(o.unsubscribe.bind(o)),o.unsubscribe=n.unsubscribe.bind(n))),n._context=o,n._next=a,n._error=s,n._complete=r,n}return fe(t,e),t.prototype.next=function(e){if(!this.isStopped&&this._next){var t=this._parentSubscriber;ve.useDeprecatedSynchronousErrorHandling&&t.syncErrorThrowable?this.__tryOrSetError(t,this._next,e)&&this.unsubscribe():this.__tryOrUnsub(this._next,e)}},t.prototype.error=function(e){if(!this.isStopped){var t=this._parentSubscriber,i=ve.useDeprecatedSynchronousErrorHandling;if(this._error)i&&t.syncErrorThrowable?(this.__tryOrSetError(t,this._error,e),this.unsubscribe()):(this.__tryOrUnsub(this._error,e),this.unsubscribe());else if(t.syncErrorThrowable)i?(t.syncErrorValue=e,t.syncErrorThrown=!0):be(e),this.unsubscribe();else{if(this.unsubscribe(),i)throw e;be(e)}}},t.prototype.complete=function(){var e=this;if(!this.isStopped){var t=this._parentSubscriber;if(this._complete){var i=function(){return e._complete.call(e._context)};ve.useDeprecatedSynchronousErrorHandling&&t.syncErrorThrowable?(this.__tryOrSetError(t,i),this.unsubscribe()):(this.__tryOrUnsub(i),this.unsubscribe())}else this.unsubscribe()}},t.prototype.__tryOrUnsub=function(e,t){try{e.call(this._context,t)}catch(e){if(this.unsubscribe(),ve.useDeprecatedSynchronousErrorHandling)throw e;be(e)}},t.prototype.__tryOrSetError=function(e,t,i){if(!ve.useDeprecatedSynchronousErrorHandling)throw new Error("bad call");try{t.call(this._context,i)}catch(t){return ve.useDeprecatedSynchronousErrorHandling?(e.syncErrorValue=t,e.syncErrorThrown=!0,!0):(be(t),!0)}return!1},t.prototype._unsubscribe=function(){var e=this._parentSubscriber;this._context=null,this._parentSubscriber=null,e.unsubscribe()},t})(Ae);function we(){}function ke(e,t,i){return function(s){return s.lift(new Ce(e,t,i))}}var Ce=(function(){function e(e,t,i){this.nextOrObserver=e,this.error=t,this.complete=i}return e.prototype.call=function(e,t){return t.subscribe(new Pe(e,this.nextOrObserver,this.error,this.complete))},e})(),Pe=(function(e){function t(t,i,s,r){var a=e.call(this,t)||this;return a._tapNext=we,a._tapError=we,a._tapComplete=we,a._tapError=s||we,a._tapComplete=r||we,me(i)?(a._context=a,a._tapNext=i):i&&(a._context=i,a._tapNext=i.next||we,a._tapError=i.error||we,a._tapComplete=i.complete||we),a}return fe(t,e),t.prototype._next=function(e){try{this._tapNext.call(this._context,e)}catch(e){return void this.destination.error(e)}this.destination.next(e)},t.prototype._error=function(e){try{this._tapError.call(this._context,e)}catch(e){return void this.destination.error(e)}this.destination.error(e)},t.prototype._complete=function(){try{this._tapComplete.call(this._context)}catch(e){return void this.destination.error(e)}return this.destination.complete()},t})(Ae),Me=(function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return fe(t,e),t.prototype.notifyNext=function(e,t,i,s,r){this.destination.next(t)},t.prototype.notifyError=function(e,t){this.destination.error(e)},t.prototype.notifyComplete=function(e){this.destination.complete()},t})(Ae),Oe=(function(e){function t(t,i,s){var r=e.call(this)||this;return r.parent=t,r.outerValue=i,r.outerIndex=s,r.index=0,r}return fe(t,e),t.prototype._next=function(e){this.parent.notifyNext(this.outerValue,e,this.outerIndex,this.index++,this)},t.prototype._error=function(e){this.parent.notifyError(e,this),this.unsubscribe()},t.prototype._complete=function(){this.parent.notifyComplete(this),this.unsubscribe()},t})(Ae),Ne=function(e){return function(t){for(var i=0,s=e.length;i<s&&!t.closed;i++)t.next(e[i]);t.complete()}},xe="function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator",Fe="function"==typeof Symbol&&Symbol.observable||"@@observable",Be=function(e){return e&&"number"==typeof e.length&&"function"!=typeof e};function Ue(e){return!!e&&"function"!=typeof e.subscribe&&"function"==typeof e.then}function $e(e){return function(t){(function(e,t){var i,s,r,a,n,o,l;return n=this,void 0,l=function(){var n,o;return ge(this,(function(l){switch(l.label){case 0:l.trys.push([0,5,6,11]),i=(function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,i=e[Symbol.asyncIterator];return i?i.call(e):(e=(function(e){var t="function"==typeof Symbol&&Symbol.iterator,i=t&&e[t],s=0;if(i)return i.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&s>=e.length&&(e=void 0),{value:e&&e[s++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")})(e),t={},s("next"),s("throw"),s("return"),t[Symbol.asyncIterator]=function(){return this},t);function s(i){t[i]=e[i]&&function(t){return new Promise(function(s,r){!(function(e,t,i,s){Promise.resolve(s).then((function(t){e({value:t,done:i})}),t)})(s,r,(t=e[i](t)).done,t.value)})}}})(e),l.label=1;case 1:return[4,i.next()];case 2:if((s=l.sent()).done)return[3,4];n=s.value,t.next(n),l.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return o=l.sent(),r={error:o},[3,11];case 6:return l.trys.push([6,,9,10]),s&&!s.done&&(a=i.return)?[4,a.call(i)]:[3,8];case 7:l.sent(),l.label=8;case 8:return[3,10];case 9:if(r)throw r.error;return[7];case 10:return[7];case 11:return t.complete(),[2]}}))},new((o=void 0)||(o=Promise))(function(e,t){function i(e){try{r(l.next(e))}catch(e){t(e)}}function s(e){try{r(l.throw(e))}catch(e){t(e)}}function r(t){var r;t.done?e(t.value):(r=t.value,r instanceof o?r:new o(function(e){e(r)})).then(i,s)}r((l=l.apply(n,[])).next())})})(e,t).catch((function(e){return t.error(e)}))}}var Ve=function(e){if(e&&"function"==typeof e[Fe])return s=e,function(e){var t=s[Fe]();if("function"!=typeof t.subscribe)throw new TypeError("Provided object does not correctly implement Symbol.observable");return t.subscribe(e)};if(Be(e))return Ne(e);if(Ue(e))return i=e,function(e){return i.then((function(t){e.closed||(e.next(t),e.complete())}),(function(t){return e.error(t)})).then(null,be),e};if(e&&"function"==typeof e[xe])return t=e,function(e){for(var i=t[xe]();;){var s=i.next();if(s.done){e.complete();break}if(e.next(s.value),e.closed)break}return"function"==typeof i.return&&e.add((function(){i.return&&i.return()})),e};if(Symbol&&Symbol.asyncIterator&&e&&"function"==typeof e[Symbol.asyncIterator])return $e(e);var t,i,s,r=Ie(e)?"an invalid object":"'"+e+"'";throw new TypeError("You provided "+r+" where a stream was expected. You can provide an Observable, Promise, Array, or Iterable.")};function Ge(e){return e}var Ke=function(){var e=this;this.resolve=null,this.reject=null,this.promise=new Promise(function(t,i){e.resolve=t,e.reject=i})};var He=(function(){function e(e){this._isScalar=!1,e&&(this._subscribe=e)}return e.prototype.lift=function(t){var i=new e;return i.source=this,i.operator=t,i},e.prototype.subscribe=function(e,t,i){var s=this.operator,r=(function(e,t,i){if(e){if(e instanceof Ae)return e;if(e[De])return e[De]()}return e||t||i?new Ae(e,t,i):new Ae(Te)})(e,t,i);if(s?r.add(s.call(r,this.source)):r.add(this.source||ve.useDeprecatedSynchronousErrorHandling&&!r.syncErrorThrowable?this._subscribe(r):this._trySubscribe(r)),ve.useDeprecatedSynchronousErrorHandling&&r.syncErrorThrowable&&(r.syncErrorThrowable=!1,r.syncErrorThrown))throw r.syncErrorValue;return r},e.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){ve.useDeprecatedSynchronousErrorHandling&&(e.syncErrorThrown=!0,e.syncErrorValue=t),(function(e){for(;e;){var t=e,i=t.closed,s=t.destination,r=t.isStopped;if(i||r)return!1;e=s&&s instanceof Ae?s:null}return!0})(e)?e.error(t):console.warn(t)}},e.prototype.forEach=function(e,t){var i=this;return new(t=We(t))(function(t,s){var r;r=i.subscribe((function(t){try{e(t)}catch(e){s(e),r&&r.unsubscribe()}}),s,t)})},e.prototype._subscribe=function(e){var t=this.source;return t&&t.subscribe(e)},e.prototype[Fe]=function(){return this},e.prototype.pipe=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return 0===e.length?this:(0===(i=e).length?Ge:1===i.length?i[0]:function(e){return i.reduce((function(e,t){return t(e)}),e)})(this);var i},e.prototype.toPromise=function(e){var t=this;return new(e=We(e))(function(e,i){var s;t.subscribe((function(e){return s=e}),(function(e){return i(e)}),(function(){return e(s)}))})},e.create=function(t){return new e(t)},e})();function We(e){if(e||(e=ve.Promise||Promise),!e)throw new Error("no Promise impl found");return e}function je(e,t,i,s,r){if(void 0===r&&(r=new Oe(e,i,s)),!r.closed)return t instanceof He?t.subscribe(r):Ve(t)(r)}function qe(e){return function(t){var i=new Ye(e),s=t.lift(i);return i.caught=s}}Symbol&&Symbol.asyncIterator&&(He.prototype[Symbol.asyncIterator]=function(){return (function(e){return (function(e){return (function(e,t,i){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s,r=i.apply(e,t||[]),a=[];return s={},n("next"),n("throw"),n("return"),s[Symbol.asyncIterator]=function(){return this},s;function n(e){r[e]&&(s[e]=function(t){return new Promise(function(i,s){a.push([e,t,i,s])>1||o(e,t)})})}function o(e,t){try{(i=r[e](t)).value instanceof pe?Promise.resolve(i.value.v).then(l,d):h(a[0][2],i)}catch(e){h(a[0][3],e)}var i}function l(e){o("next",e)}function d(e){o("throw",e)}function h(e,t){e(t),a.shift(),a.length&&o(a[0][0],a[0][1])}})(this,arguments,(function(){var t,i,s,r,a,n,o,l;return ge(this,(function(d){switch(d.label){case 0:t=[],i=[],s=!1,r=null,a=!1,n=e.subscribe({next:function(e){t.length>0?t.shift().resolve({value:e,done:!1}):i.push(e)},error:function(e){for(s=!0,r=e;t.length>0;)t.shift().reject(e)},complete:function(){for(a=!0;t.length>0;)t.shift().resolve({value:void 0,done:!0})}}),d.label=1;case 1:d.trys.push([1,16,17,18]),d.label=2;case 2:return i.length>0?[4,pe(i.shift())]:[3,5];case 3:return[4,d.sent()];case 4:return d.sent(),[3,14];case 5:return a?[4,pe(void 0)]:[3,7];case 6:return[2,d.sent()];case 7:if(!s)return[3,8];throw r;case 8:return o=new Ke,t.push(o),[4,pe(o.promise)];case 9:return(l=d.sent()).done?[4,pe(void 0)]:[3,11];case 10:return[2,d.sent()];case 11:return[4,pe(l.value)];case 12:return[4,d.sent()];case 13:d.sent(),d.label=14;case 14:return[3,2];case 15:return[3,18];case 16:throw d.sent();case 17:return n.unsubscribe(),[7];case 18:return[2]}}))}))})(e)})(this)});var Ye=(function(){function e(e){this.selector=e}return e.prototype.call=function(e,t){return t.subscribe(new ze(e,this.selector,this.caught))},e})(),ze=(function(e){function t(t,i,s){var r=e.call(this,t)||this;return r.selector=i,r.caught=s,r}return fe(t,e),t.prototype.error=function(t){if(!this.isStopped){var i=void 0;try{i=this.selector(t,this.caught)}catch(t){return void e.prototype.error.call(this,t)}this._unsubscribeAndRecycle();var s=new Oe(this,void 0,void 0);this.add(s);var r=je(this,i,void 0,void 0,s);r!==s&&this.add(r)}},t})(Me);function Qe(e){return function(t){return t.lift(new Xe(e))}}var Xe=(function(){function e(e){this.notifier=e}return e.prototype.call=function(e,t){var i=new Je(e),s=je(i,this.notifier);return s&&!i.seenValue?(i.add(s),t.subscribe(i)):i},e})(),Je=(function(e){function t(t){var i=e.call(this,t)||this;return i.seenValue=!1,i}return fe(t,e),t.prototype.notifyNext=function(e,t,i,s,r){this.seenValue=!0,this.complete()},t.prototype.notifyComplete=function(){},t})(Me),Ze=(function(){function e(){return Error.call(this),this.message="object unsubscribed",this.name="ObjectUnsubscribedError",this}return e.prototype=Object.create(Error.prototype),e})(),et=(function(e){function t(t,i){var s=e.call(this)||this;return s.subject=t,s.subscriber=i,s.closed=!1,s}return fe(t,e),t.prototype.unsubscribe=function(){if(!this.closed){this.closed=!0;var e=this.subject,t=e.observers;if(this.subject=null,t&&0!==t.length&&!e.isStopped&&!e.closed){var i=t.indexOf(this.subscriber);-1!==i&&t.splice(i,1)}}},t})(_e),tt=(function(e){function t(t){var i=e.call(this,t)||this;return i.destination=t,i}return fe(t,e),t})(Ae),it=(function(e){function t(){var t=e.call(this)||this;return t.observers=[],t.closed=!1,t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}return fe(t,e),t.prototype[De]=function(){return new tt(this)},t.prototype.lift=function(e){var t=new st(this,this);return t.operator=e,t},t.prototype.next=function(e){if(this.closed)throw new Ze;if(!this.isStopped)for(var t=this.observers,i=t.length,s=t.slice(),r=0;r<i;r++)s[r].next(e)},t.prototype.error=function(e){if(this.closed)throw new Ze;this.hasError=!0,this.thrownError=e,this.isStopped=!0;for(var t=this.observers,i=t.length,s=t.slice(),r=0;r<i;r++)s[r].error(e);this.observers.length=0},t.prototype.complete=function(){if(this.closed)throw new Ze;this.isStopped=!0;for(var e=this.observers,t=e.length,i=e.slice(),s=0;s<t;s++)i[s].complete();this.observers.length=0},t.prototype.unsubscribe=function(){this.isStopped=!0,this.closed=!0,this.observers=null},t.prototype._trySubscribe=function(t){if(this.closed)throw new Ze;return e.prototype._trySubscribe.call(this,t)},t.prototype._subscribe=function(e){if(this.closed)throw new Ze;return this.hasError?(e.error(this.thrownError),_e.EMPTY):this.isStopped?(e.complete(),_e.EMPTY):(this.observers.push(e),new et(this,e))},t.prototype.asObservable=function(){var e=new He;return e.source=this,e},t.create=function(e,t){return new st(e,t)},t})(He),st=(function(e){function t(t,i){var s=e.call(this)||this;return s.destination=t,s.source=i,s}return fe(t,e),t.prototype.next=function(e){var t=this.destination;t&&t.next&&t.next(e)},t.prototype.error=function(e){var t=this.destination;t&&t.error&&this.destination.error(e)},t.prototype.complete=function(){var e=this.destination;e&&e.complete&&this.destination.complete()},t.prototype._subscribe=function(e){return this.source?this.source.subscribe(e):_e.EMPTY},t})(it);function rt(e,t){return new He(t?function(i){return t.schedule(at,0,{error:e,subscriber:i})}:function(t){return t.error(e)})}function at(e){var t=e.error;e.subscriber.error(t)}const nt={video:["avc1.42E01E"],audio:["mp4a.40.2"]};class ot extends P{constructor(e,t){super(e,s.b.MANIFEST_LOADING,s.b.MEDIA_ATTACHING,s.b.MEDIA_DETACHING),this.keyLoader=t,this.reset$=new it,this.protectionData={},this.keySystem=void 0,this.keySystemId=void 0,this.createMediaKeysPromise=void 0,this.setMediaKeysPromise=void 0,!0===e.config.warmupCdms&&ot.warmupCDM()}static warmupCDM(){return yi.createMediaKeys(ce.id,nt.video,nt.audio,[])}destroy(){this.reset()}reset(){this.reset$.next(),this.keySystem&&(this.keySystem.shouldDestroyMediaKeys&&yi.destroyMediaKeys(),this.keySystem.destroy(),this.keySystem=void 0),this.keySystemId=void 0,this.createMediaKeysPromise=void 0,this.setMediaKeysPromise=void 0}cleanMediaKeys(e){e.setMediaKeys(null).catch(this.onMediaKeysError.bind(this))}onManifestLoading(){this.hls.isPreloadingItem?this.logger.info("[gapless] don't reset in onManifestLoading")():this.reset()}onMediaAttaching(e){if(this.media=e.media,this.keySystem)this.setMediaKeys(this.keySystem.mediaKeys);else if(this.hls.platformInfo&&this.hls.platformInfo.requiresCDMAttachOnStart&&!0===this.hls.platformInfo.requiresCDMAttachOnStart){let e=this.hls.config.keySystemPreference?yi.getKeySystemFormat(this.hls.config.keySystemPreference):ce.keyFormatString;this.createAndSetMediaKeys(new D("NONE",null,null,e,[1]))}}onMediaDetaching(){let e=this.media;this.hls.config.clearMediaKeysOnPromise&&this.setMediaKeysPromise?this.setMediaKeysPromise.then(this.cleanMediaKeys.bind(this,e)):this.cleanMediaKeys(e),this.setMediaKeysPromise=void 0,this.reset()}ensureKeySystem(e){if(!this.keySystem&&this.keySystemId){this.keySystem=yi.make(this.keySystemId,this.hls,e,this.keyLoader);let t=this.protectionData&&this.protectionData[this.keySystemId];t&&(this.keySystem.setLicenseServer(t.licenseServerUrl),this.keySystem.setServerCertificate(t.certificate))}return this.keySystem}createAndSetMediaKeys(e){return this.ensureMediaKeys(e).then(function(e){return this.ensureKeySystem(e),this.setMediaKeys(e).catch(this.onMediaKeysError.bind(this))}.bind(this))}requestKey(e){return this.createAndSetMediaKeys(e).then(()=>this.keySystem.startKeyRequest(e))}updateItemId(e){this.keySystem.updateItemId(e)}removeKey(e){this.keySystem.removeKey(e)}abortKey(e){this.keySystem&&this.keySystem.abortKeyRequest(e)}onServerCertificateLoaded(e){let t=e.keysystem,i=e.certificate;this.protectionData[t].certificate=i,this.keySystem&&this.keySystemId===t&&this.keySystem.setServerCertificate(i)}get availableKeySystems(){return yi.availableKeySystems}initialize(e){this.protectionData,this.protectionData={};for(let t in e){if(!yi.availableKeySystems.includes(t)){this.logger.warn(`Key system ${t} is not valid, ignoring`)();continue}let i=e[t],a=i.certificate,n=i.serverCertUrl;this.protectionData[t]={licenseServerUrl:i.licenseServerUrl,serverCertUrl:n,certificate:a},a?this.onServerCertificateLoaded({keysystem:t,certificate:a}):n&&this.keyLoader.loadCertificate(n,t).pipe(ke(e=>this.onServerCertificateLoaded(e)),qe((e,t)=>(this.logger.error(`Error loading cert: ${e instanceof Error?e.message:""}`)(),this.hls.trigger(s.b.INTERNAL_ERROR,{type:r.g.NETWORK_ERROR,details:r.d.CERT_LOAD_ERROR,fatal:!1,url:n}),rt(e))),Qe(this.reset$)).subscribe()}}generateRequest(e,t){this.keySystem&&this.keySystem.setKeyRequestInfo(e,t)}setLicenseResponse(e,t){this.keySystem&&this.keySystem.setParsedResponse(e,t)}setMediaKeys(e){if(!this.media)return void this.logger.warn("No media object attached")();let t=this.setMediaKeysPromise;return this.setMediaKeysPromise||(t=this.setMediaKeysPromise=this.media.setMediaKeys(e)).then(function(){}.bind(this)).catch(this.onMediaKeysError.bind(this)),t}onMediaKeysError(e){let t=new r.n(r.g.KEY_SYSTEM_ERROR,r.d.KEY_SYSTEM_GENERIC_ERROR,!0,e.message,void 0,void 0,void 0,void 0,void 0);this.hls.upgradeInternalErrorIfNecessary(t)}ensureMediaKeys(e){if(!this.createMediaKeysPromise){let t=this.keySystemId=yi.getKeySystemIdForDecryptData(e),i=yi.createMediaKeys(t,nt.video,nt.audio,this.hls.platformInfo.keySystemConfig);this.createMediaKeysPromise=i}return this.createMediaKeysPromise}}var lt=ot,dt=(function(){function e(){return Error.call(this),this.message="Timeout has occurred",this.name="TimeoutError",this}return e.prototype=Object.create(Error.prototype),e})();function ht(e){return e&&"function"==typeof e.schedule}function ct(e,t){return new He(function(i){var s=new _e,r=0;return s.add(t.schedule((function(){r!==e.length?(i.next(e[r++]),i.closed||s.add(this.schedule())):i.complete()}))),s})}function ut(e,t){return t?ct(e,t):new He(Ne(e))}function ft(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=e[e.length-1];return ht(i)?(e.pop(),ct(e,i)):ut(e)}function gt(e,t){return function(i){if("function"!=typeof e)throw new TypeError("argument is not a function. Are you looking for `mapTo()`?");return i.lift(new pt(e,t))}}var pt=(function(){function e(e,t){this.project=e,this.thisArg=t}return e.prototype.call=function(e,t){return t.subscribe(new mt(e,this.project,this.thisArg))},e})(),mt=(function(e){function t(t,i,s){var r=e.call(this,t)||this;return r.project=i,r.count=0,r.thisArg=s||r,r}return fe(t,e),t.prototype._next=function(e){var t;try{t=this.project.call(this.thisArg,e,this.count++)}catch(e){return void this.destination.error(e)}this.destination.next(t)},t})(Ae);function yt(e,t){return t?(function(e,t){if(null!=e){if(function(e){return e&&"function"==typeof e[Fe]}(e))return (function(e,t){return new He(function(i){var s=new _e;return s.add(t.schedule((function(){var r=e[Fe]();s.add(r.subscribe({next:function(e){s.add(t.schedule((function(){return i.next(e)})))},error:function(e){s.add(t.schedule((function(){return i.error(e)})))},complete:function(){s.add(t.schedule((function(){return i.complete()})))}}))}))),s})})(e,t);if(Ue(e))return (function(e,t){return new He(function(i){var s=new _e;return s.add(t.schedule((function(){return e.then((function(e){s.add(t.schedule((function(){i.next(e),s.add(t.schedule((function(){return i.complete()})))})))}),(function(e){s.add(t.schedule((function(){return i.error(e)})))}))}))),s})})(e,t);if(Be(e))return ct(e,t);if(function(e){return e&&"function"==typeof e[xe]}(e)||"string"==typeof e)return (function(e,t){if(!e)throw new Error("Iterable cannot be null");return new He(function(i){var s,r=new _e;return r.add((function(){s&&"function"==typeof s.return&&s.return()})),r.add(t.schedule((function(){s=e[xe](),r.add(t.schedule((function(){if(!i.closed){var e,t;try{var r=s.next();e=r.value,t=r.done}catch(e){return void i.error(e)}t?i.complete():(i.next(e),this.schedule())}})))}))),r})})(e,t);if(Symbol&&Symbol.asyncIterator&&"function"==typeof e[Symbol.asyncIterator])return (function(e,t){if(!e)throw new Error("Iterable cannot be null");return new He(function(i){var s=new _e;return s.add(t.schedule((function(){var r=e[Symbol.asyncIterator]();s.add(t.schedule((function(){var e=this;r.next().then((function(t){t.done?i.complete():(i.next(t.value),e.schedule())}))})))}))),s})})(e,t)}throw new TypeError((null!==e&&typeof e||e)+" is not observable")})(e,t):e instanceof He?e:new He(Ve(e))}function vt(e,t,i){return void 0===i&&(i=Number.POSITIVE_INFINITY),"function"==typeof t?function(s){return s.pipe(vt((function(i,s){return yt(e(i,s)).pipe(gt((function(e,r){return t(i,e,s,r)})))}),i))}:("number"==typeof t&&(i=t),function(t){return t.lift(new bt(e,i))})}var bt=(function(){function e(e,t){void 0===t&&(t=Number.POSITIVE_INFINITY),this.project=e,this.concurrent=t}return e.prototype.call=function(e,t){return t.subscribe(new Tt(e,this.project,this.concurrent))},e})(),Tt=(function(e){function t(t,i,s){void 0===s&&(s=Number.POSITIVE_INFINITY);var r=e.call(this,t)||this;return r.project=i,r.concurrent=s,r.hasCompleted=!1,r.buffer=[],r.active=0,r.index=0,r}return fe(t,e),t.prototype._next=function(e){this.active<this.concurrent?this._tryNext(e):this.buffer.push(e)},t.prototype._tryNext=function(e){var t,i=this.index++;try{t=this.project(e,i)}catch(e){return void this.destination.error(e)}this.active++,this._innerSub(t,e,i)},t.prototype._innerSub=function(e,t,i){var s=new Oe(this,t,i),r=this.destination;r.add(s);var a=je(this,e,void 0,void 0,s);a!==s&&r.add(a)},t.prototype._complete=function(){this.hasCompleted=!0,0===this.active&&0===this.buffer.length&&this.destination.complete(),this.unsubscribe()},t.prototype.notifyNext=function(e,t,i,s,r){this.destination.next(t)},t.prototype.notifyComplete=function(e){var t=this.buffer;this.remove(e),this.active--,t.length>0?this._next(t.shift()):0===this.active&&this.hasCompleted&&this.destination.complete()},t})(Me),St=(function(e){function t(t,i){var s=e.call(this,t,i)||this;return s.scheduler=t,s.work=i,s.pending=!1,s}return fe(t,e),t.prototype.schedule=function(e,t){if(void 0===t&&(t=0),this.closed)return this;this.state=e;var i=this.id,s=this.scheduler;return null!=i&&(this.id=this.recycleAsyncId(s,i,t)),this.pending=!0,this.delay=t,this.id=this.id||this.requestAsyncId(s,this.id,t),this},t.prototype.requestAsyncId=function(e,t,i){return void 0===i&&(i=0),setInterval(e.flush.bind(e,this),i)},t.prototype.recycleAsyncId=function(e,t,i){if(void 0===i&&(i=0),null!==i&&this.delay===i&&!1===this.pending)return t;clearInterval(t)},t.prototype.execute=function(e,t){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var i=this._execute(e,t);if(i)return i;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},t.prototype._execute=function(e,t){var i=!1,s=void 0;try{this.work(e)}catch(e){i=!0,s=!!e&&e||new Error(e)}if(i)return this.unsubscribe(),s},t.prototype._unsubscribe=function(){var e=this.id,t=this.scheduler,i=t.actions,s=i.indexOf(this);this.work=null,this.state=null,this.pending=!1,this.scheduler=null,-1!==s&&i.splice(s,1),null!=e&&(this.id=this.recycleAsyncId(t,e,null)),this.delay=null},t})(function(e){function t(t,i){return e.call(this)||this}return fe(t,e),t.prototype.schedule=function(e,t){return void 0===t&&(t=0),this},t}(_e)),It=(function(){function e(t,i){void 0===i&&(i=e.now),this.SchedulerAction=t,this.now=i}return e.prototype.schedule=function(e,t,i){return void 0===t&&(t=0),new this.SchedulerAction(this,e).schedule(i,t)},e.now=function(){return Date.now()},e})(),Et=new(function(e){function t(i,s){void 0===s&&(s=It.now);var r=e.call(this,i,(function(){return t.delegate&&t.delegate!==r?t.delegate.now():s()}))||this;return r.actions=[],r.active=!1,r.scheduled=void 0,r}return fe(t,e),t.prototype.schedule=function(i,s,r){return void 0===s&&(s=0),t.delegate&&t.delegate!==this?t.delegate.schedule(i,s,r):e.prototype.schedule.call(this,i,s,r)},t.prototype.flush=function(e){var t=this.actions;if(this.active)t.push(e);else{var i;this.active=!0;do{if(i=e.execute(e.state,e.delay))break}while(e=t.shift());if(this.active=!1,i){for(;e=t.shift();)e.unsubscribe();throw i}}},t}(It))(St),_t=(function(){function e(e,t,i,s){this.waitFor=e,this.absoluteTimeout=t,this.withObservable=i,this.scheduler=s}return e.prototype.call=function(e,t){return t.subscribe(new Rt(e,this.absoluteTimeout,this.waitFor,this.withObservable,this.scheduler))},e})(),Rt=(function(e){function t(t,i,s,r,a){var n=e.call(this,t)||this;return n.absoluteTimeout=i,n.waitFor=s,n.withObservable=r,n.scheduler=a,n.action=null,n.scheduleTimeout(),n}return fe(t,e),t.dispatchTimeout=function(e){var t=e.withObservable;e._unsubscribeAndRecycle(),e.add(je(e,t))},t.prototype.scheduleTimeout=function(){var e=this.action;e?this.action=e.schedule(this,this.waitFor):this.add(this.action=this.scheduler.schedule(t.dispatchTimeout,this.waitFor,this))},t.prototype._next=function(t){this.absoluteTimeout||this.scheduleTimeout(),e.prototype._next.call(this,t)},t.prototype._unsubscribe=function(){this.action=null,this.scheduler=null,this.withObservable=null},t})(Me);function Dt(e,t){return void 0===t&&(t=Et),(function(e,t,i){return void 0===i&&(i=Et),function(s){var r,a=(r=e)instanceof Date&&!isNaN(+r),n=a?+e-i.now():Math.abs(e);return s.lift(new _t(n,a,t,i))}})(e,rt(new dt),t)}function At(){return function(e){return e.lift(new Pt(e))}}var Lt,wt,kt,Ct,Pt=(function(){function e(e){this.connectable=e}return e.prototype.call=function(e,t){var i=this.connectable;i._refCount++;var s=new Mt(e,i),r=t.subscribe(s);return s.closed||(s.connection=i.connect()),r},e})(),Mt=(function(e){function t(t,i){var s=e.call(this,t)||this;return s.connectable=i,s.connection=null,s}return fe(t,e),t.prototype._unsubscribe=function(){var e=this.connectable;if(e){this.connectable=null;var t=e._refCount;if(t<=0)this.connection=null;else if(e._refCount=t-1,t>1)this.connection=null;else{var i=this.connection,s=e._connection;this.connection=null,!s||i&&s!==i||s.unsubscribe()}}else this.connection=null},t})(Ae),Ot={operator:{value:null},_refCount:{value:0,writable:!0},_subject:{value:null,writable:!0},_connection:{value:null,writable:!0},_subscribe:{value:(Lt=(function(e){function t(t,i){var s=e.call(this)||this;return s.source=t,s.subjectFactory=i,s._refCount=0,s._isComplete=!1,s}return fe(t,e),t.prototype._subscribe=function(e){return this.getSubject().subscribe(e)},t.prototype.getSubject=function(){var e=this._subject;return e&&!e.isStopped||(this._subject=this.subjectFactory()),this._subject},t.prototype.connect=function(){var e=this._connection;return e||(this._isComplete=!1,(e=this._connection=new _e).add(this.source.subscribe(new Nt(this.getSubject(),this))),e.closed&&(this._connection=null,e=_e.EMPTY)),e},t.prototype.refCount=function(){return At()(this)},t})(He).prototype)._subscribe},_isComplete:{value:Lt._isComplete,writable:!0},getSubject:{value:Lt.getSubject},connect:{value:Lt.connect},refCount:{value:Lt.refCount}},Nt=(function(e){function t(t,i){var s=e.call(this,t)||this;return s.connectable=i,s}return fe(t,e),t.prototype._error=function(t){this._unsubscribe(),e.prototype._error.call(this,t)},t.prototype._complete=function(){this.connectable._isComplete=!0,this._unsubscribe(),e.prototype._complete.call(this)},t.prototype._unsubscribe=function(){var e=this.connectable;if(e){this.connectable=null;var t=e._connection;e._refCount=0,e._subject=null,e._connection=null,t&&t.unsubscribe()}},t})(tt);function xt(){return new it}!(function(e){function t(t,i){var s=e.call(this,t)||this;return s.connectable=i,s}fe(t,e),t.prototype._unsubscribe=function(){var e=this.connectable;if(e){this.connectable=null;var t=e._refCount;if(t<=0)this.connection=null;else if(e._refCount=t-1,t>1)this.connection=null;else{var i=this.connection,s=e._connection;this.connection=null,!s||i&&s!==i||s.unsubscribe()}}else this.connection=null}})(Ae),(function(e){e.MustRequestResponse="MustRequestResponse",e.WaitingForKeyResponse="WaitingForKeyResponse",e.GotKeyResponse="GotKeyResponse"})(wt||(wt={}));class Ft extends Error{constructor(e,t){super(e),this.message=e,this.keyuri=t,this.name="KeyRequestTimeoutError",this.keyuri=t}}!(function(e){e[e.InvalidState=0]="InvalidState",e[e.Abort=1]="Abort",e[e.OutputRestricted=2]="OutputRestricted",e[e.AlreadyFailedKey=3]="AlreadyFailedKey",e[e.HttpError=4]="HttpError",e[e.InternalError=5]="InternalError",e[e.LicenseServerError=6]="LicenseServerError",e[e.InsufficientCPC=7]="InsufficientCPC"})(kt||(kt={}));class Bt extends Error{constructor(e,t,i,s,r){super(e),this.message=e,this.keyuri=t,this.statusCode=i,this.isOkToRetry=s,this.keyErrorReason=r,this.name="KeyRequestError"}}class Ut{constructor(e){this.hls=e,this.reset$=new it,this.hls=e,this.logger=e.logger,this.keyUriToKeyInfo={},this.numberOfConsecutiveKeyErrors=0,this.activeDecryptData=[],this.pendingDecryptData=[],this.resetFn=this.reset.bind(this),this.hls.on(s.b.MEDIA_DETACHING,this.resetFn),void 0!==this.hls.config.useMultipleKeySessions&&this.hls.config.useMultipleKeySessions&&(this.setupFn=this.setupListeners.bind(this),this.hls.on(s.b.MEDIA_ATTACHING,this.setupFn)),this.keySystemController=new lt(e,this)}destroy(){this.keySystemController.destroy(),this.reset(),this.hls&&(this.hls.off(s.b.MEDIA_DETACHING,this.resetFn),void 0!==this.hls.config.useMultipleKeySessions&&this.hls.config.useMultipleKeySessions&&this.hls.off(s.b.MEDIA_ATTACHING,this.setupFn),this.hls=void 0)}reset(){this.media&&(this.media.removeEventListener("timeupdate",this.ontimeupdate),this.media=null),this.reset$.next(),this.keyUriToKeyInfo={},this.activeDecryptData=[],this.numberOfConsecutiveKeyErrors=0}setupListeners(e,t){let i=this.media=t.media;i&&i.addEventListener("timeupdate",this.ontimeupdate.bind(this))}ontimeupdate(){if(!this.media)return;let e=this.media.currentTime;this.activeDecryptData.forEach(function(t,i,s){e>t.expiryPosition+this.hls.config.keyHoldTimeAfterExpiry/1e3&&(s.splice(i,1),this.keySystemController.removeKey(t),this.keyUriToKeyInfo[t.uri]=void 0)}.bind(this))}_handleKeyRequestResolve(e,t){let i=this.keyUriToKeyInfo[e];i?i.state=t:this.logger.warn(`Missing info keyuri=${this.hls.redactUrl(e)}`)()}_handleKeyError(e,t){let i,s=this.keyUriToKeyInfo[e];if(!s)return new Error("Key doesn't exist in system");if(this.logger.error(`[Keys] Key request error keyuri=${this.hls.redactUrl(e)} ${t.message}`)(),s.state=wt.MustRequestResponse,t)if(t instanceof $t)i=new r.n(r.g.KEY_SYSTEM_ERROR,r.d.KEY_SYSTEM_GENERIC_ERROR,!0,t.message,{code:t.code,text:t.message},s.decryptdata,s.stats,s.levelIds,void 0);else if(t instanceof Ft||t instanceof dt)i=new r.n(r.g.NETWORK_ERROR,r.d.KEY_LOAD_TIMEOUT,!1,t.message,r.f.CryptResponseReceivedSlowly,s.decryptdata,s.stats,s.levelIds,void 0);else if(t instanceof Bt){this.numberOfConsecutiveKeyErrors++;let e=!t.isOkToRetry&&this.numberOfConsecutiveKeyErrors>=this.hls.config.keyRetryCountOnError;s.stats.isOkToRetry=t.isOkToRetry,i=new r.n(r.g.NETWORK_ERROR,r.d.KEY_LOAD_ERROR,e,t.message,{code:t.statusCode,text:t.message},s.decryptdata,s.stats,s.levelIds,t.keyErrorReason)}else i=new r.h(r.g.OTHER_ERROR,r.d.INTERNAL_EXCEPTION,!0,t.message);return i}triggerKeyError(e,t){let i=this._handleKeyError(e,t);i&&this.hls.trigger(s.b.INTERNAL_ERROR,i)}getLevelIdsForKey(e){return this.keyUriToKeyInfo[e.uri]?this.keyUriToKeyInfo[e.uri].levelIds:new Set}getKeyFromDecryptData(e,t,i=!1){if(!e||!e.isEncrypted)return ft(e);let r=e.uri,a=this.keyUriToKeyInfo[r];if(a&&!isNaN(t)&&a.levelIds.add(t),a&&!a.stats.isOkToRetry)return rt(this._handleKeyError(r,new Bt("Key has already resulted in failure",r,0,!1,kt.AlreadyFailedKey)));if(!a||i||a.state===wt.MustRequestResponse){let i=!1;a?a.abort$.next():(i=!0,a=this.keyUriToKeyInfo[r]={state:wt.WaitingForKeyResponse,decryptdata:e,stats:void 0,request:void 0,levelIds:new Set,abort$:new it}),a.state=wt.WaitingForKeyResponse,a.decryptdata=e,isNaN(t)||a.levelIds.add(t);let n,o=performance.now();a.stats={trequest:o,tfirst:o,isOkToRetry:!0};let l=e.method;switch(l){case"SAMPLE-AES":case"ISO-23001-7":case"SAMPLE-AES-CTR":n=this._fetchKeyEME(a,e);break;case"AES-128":n=this.fetchKeyHTTP(e.uri,e,void 0);break;default:a.request=rt(new Error(`Unexpected METHOD attribute ${l}`))}const d=this.hls.config,h=this.hls.streamController.targetDuration;let c=Math.max(this.hls.config.keyLoadingMinTimeout,h>0?2e3*h:d.keyLoadingDefaultTimeout);return a.request=n.pipe(Dt(c),vt(t=>(this._handleKeyRequestResolve(r,e?wt.GotKeyResponse:wt.MustRequestResponse),this.numberOfConsecutiveKeyErrors=0,!this.hls.config.gapless&&i&&"fairplaystreaming"===this.hls.config.keySystemPreference&&"AES-128"!==e.method&&(this.hls.isLive?this.pendingDecryptData.push(e):this.activeDecryptData.push(e)),a.decryptdata.key=t.decryptdata.key,this.hls.trigger(s.b.KEY_LOADED,t),ft(t.decryptdata))),qe(e=>rt(this._handleKeyError(r,e))),(function(e){return At()((t=xt,function(e){var i;i="function"==typeof t?t:function(){return t};var s=Object.create(e,Ot);return s.source=e,s.subjectFactory=i,s})(e));var t}),Qe(function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=Number.POSITIVE_INFINITY,s=void 0,r=e[e.length-1];return ht(r)?(s=e.pop(),e.length>1&&"number"==typeof e[e.length-1]&&(i=e.pop())):"number"==typeof r&&(i=e.pop()),!s&&1===e.length&&e[0]instanceof He?e[0]:(function(e){return void 0===e&&(e=Number.POSITIVE_INFINITY),vt(Ge,e)})(i)(ut(e,s))}(a.abort$,this.reset$))),a.request}return a.state===wt.GotKeyResponse?ft(a.decryptdata):a.request}updateExpiryPosition(e,t,i=1/0){this.pendingDecryptData.forEach(function(s,r,a){s.uri===e.uri&&(a.splice(r,1),this.activeDecryptData.forEach(e=>{let s=this.keyUriToKeyInfo[e.uri];return e.expiryPosition===1/0&&s.levelIds.has(t)&&(e.expiryPosition=i),e}),this.activeDecryptData.push(s))}.bind(this))}stopRequest(e){let t=e.uri,i=this.keyUriToKeyInfo[t];i&&(i.abort$.next(),i.state=wt.MustRequestResponse)}_fetchKeyEME(e,t){return new He(i=>(this.keySystemController.requestKey(t).then(t=>{let s=performance.now();if(!t)return this.logger.warn("fetchKeyEME got undefined decryptdata")(),void i.error(new r.a("Key request was aborted"));let a={timestamp:s,keyuri:t.uri,decryptdata:t,stats:{trequest:e.stats.trequest,tfirst:e.stats.tfirst,tload:s}};i.next(a),i.complete()}).catch(e=>{i.error(e)}),()=>{this.keySystemController.abortKey(t)}))}fetchKeyHTTP(e,t,i){return new He(s=>{let r=this.hls.config,a=p.isCustomUrl(e)?new p(this.hls):new r.loader(r),n={type:"key",url:e,method:"GET",decryptdata:t,responseType:"arraybuffer"},o={maxLoadTimeMs:isNaN(i)?0:i,maxTimeToFirstByteMs:0,autoRetry:!1,timeoutRetry:null,errorRetry:null},l={onSuccess:(e,i,r)=>{t.key=new Uint8Array(e.data);let a={decryptdata:t,keyuri:r.url,stats:{trequest:i.trequest,tfirst:i.tfirst,tload:i.tload},timestamp:performance.now()};s.next(a),s.complete()},onError:(e,t)=>{s.error(new Bt("Unable to load key",t.url,e.code,!0,kt.HttpError))},onTimeout:(e,t)=>{s.error(new Ft("Key load timed out",t.url))}};return a.load(n,o,l),()=>{a.abort()}})}loadCertificate(e,t){return new He(i=>{let s,r=this.hls.config,a=p.isCustomUrl(e)?new p(this.hls):void 0!==r.fLoader?new r.fLoader(r):new r.loader(r),n={type:"cert",url:e,responseType:"arraybuffer"};s=p.isCustomUrl(e)?r.fragLoadPolicy.customURL:r.fragLoadPolicy.default;let o={onSuccess:(e,s,r)=>{i.next({keysystem:t,certificate:e.data}),i.complete()},onError:(e,t)=>{i.error(new Error(`Certificate error ${e.code}`))},onTimeout:(e,t)=>{i.error(new dt)}};return a.load(n,s,o),()=>{a.abort()}})}}!(function(e){e.GET_REQUEST_INFO="GET_REQUEST_INFO",e.GET_CHALLENGE="GET_CHALLENGE",e.GET_KEY_RESPONSE="GET_KEY_RESPONSE",e.PROCESS_LICENSE="PROCESS_LICENSE"})(Ct||(Ct={}));class $t extends Error{constructor(e,t,i,s){super(e),this.keyuri=t,this.code=i,this.keysystemstring=s,this.name="KeySystemError"}}class Vt{constructor(e,t,i,s){this.hls=e,this.mediaKeys=t,this.keyLoader=i,this.systemString=s,this.destroy$=new it,this.logger=e.logger,this.shouldDestroyMediaKeys=!1,this.itemId=e.loadingItem.itemId||"",this.sessions=[],this.keyIdToKeyInfo={},this.keyUriToKeyInfo={},this.sessionIdToKeyUri={},this.onkeystatuseschange=this.handleKeyStatusesChange.bind(this),this.onkeymessage=this.handleKeyMessage.bind(this)}removeAndCloseSessionInternal(e){return e.remove().catch(e=>{this.logger.error(`Could not remove session: ${e.message}`)()}).then(()=>e.close()).catch(e=>{this.logger.error(`Could not close session: ${e.message}`)()}).then(()=>{this.removeKeySessionListeners(e)})}destroy(){this.isDestroying=!0,this.destroy$.next();for(let e of Object.values(this.keyUriToKeyInfo))this.stopRenewal(e),this._abortKeyRequest(e);let e=[];this.sessions.forEach(t=>{let i=this.removeAndCloseSessionInternal(t);e.push(i)});let t=Promise.all(e).then(()=>{this.mediaKeys=void 0,this.keyIdToKeyInfo={},this.keyUriToKeyInfo={},this.sessionIdToKeyUri={}});return D.clearKeyUriToKeyIdMap(),t}setPromise(e,t,i){e.promise&&e.promise.reject(new Bt("Existing promise",e.decryptdata.uri,0,!0,kt.InvalidState)),e.promiseType=t,e.promise=i}resolvePromise(e,t,i,s){e&&e.promise&&(e.promiseType===t?e.promise.resolve(i):(this.logger.warn(`wrong type ${t} ${e.promiseType} ${s}`)(),e.promise.reject(s)),e.promise=void 0,e.promiseType=void 0)}setServerCertificate(e=null){return this.needsCert?(this.setCertPromise||(this.setCertPromise=new Promise(function(e){this.onCertSet=e}.bind(this)).then(function(e){return this.mediaKeys.setServerCertificate(e)}.bind(this)).catch(function(e){throw this.logger.error("Failed setServerCertificate")(),this.setCert=!1,e}.bind(this))),e&&!this.setCert&&(this.setCert=!0,this.onCertSet(e)),this.setCertPromise):Promise.resolve()}setLicenseServer(e){this.licenseServerUrl||(this.licenseServerUrl=e)}ensureKeySessionForKeyInfo(e){if(e.session)return;let t=this.mediaKeys.createSession();t?(this.sessions.push(t),this.addKeySessionListeners(t)):this.logger.error(`${this.systemString} FAIL: could not create MediaKeysSession`)(),e.session=t}_checkForAbort(e){if(e.aborted)throw this.logger.warn("Aborted in the middle of key request")(),new Bt("Aborted",e.decryptdata.uri,0,!0,kt.Abort)}startKeyRequest(e){let t=e.uri;this.keyUriToKeyInfo[t]||(this.keyUriToKeyInfo[t]={decryptdata:e,session:null,aborted:!1});let i=this.keyUriToKeyInfo[t];if(this.ensureKeySessionForKeyInfo(i),!i.session)return Promise.reject(new $t("Could not create key session",e.uri,0,this.systemString));let s=g.b.utf8arrayToStr(e.keyId);return this.keyIdToKeyInfo[s]=i,i.aborted=!1,this.logger.info(`[QE Critical] [Keys] ${this.systemString} startKeyRequest uri=${this.hls.redactUrl(t)}`)(),Promise.all([this.getKeyRequestInfo(i),this.setServerCertificate()]).then(e=>(this._checkForAbort(i),e[0])).then(function(e){return this._checkForAbort(i),this.hls.eventReporter.notifyKeySessionEvent(F.spcsubmitted,{keyuri:t,keyFormat:this.systemString}),this.generateLicenseChallenge(i,e).catch(function(e){throw this.logger.error(`[Keys] ${this.systemString} generateLicenseChallenge Failed ${e.message} uri=${this.hls.redactUrl(t)}`)(),this.hls.eventReporter.notifyKeySessionEvent(F.spcerror,{keyuri:t}),e}.bind(this))}.bind(this)).then(function(e){return this._checkForAbort(i),this.logger.info(`[QE Critical] [Keys] ${this.systemString} challenge created uri=${this.hls.redactUrl(t)}`)(),this.hls.eventReporter.notifyKeySessionEvent(F.spccreated,{keyuri:t,cdmVersion:this.cdmVersion}),this.getKeyRequestResponse(i,e)}.bind(this)).then(function(e){return this._checkForAbort(i),this.logger.info(`[QE Critical] [Keys] ${this.systemString} onKeyResponseParsed uri=${this.hls.redactUrl(t)}`)(),this.hls.eventReporter.notifyKeySessionEvent(F.ckcsubmitted,{keyuri:t}),this.handleParsedKeyResponse(i,e).catch(function(e){throw this.hls.eventReporter.notifyKeySessionEvent(F.ckcerror,{keyuri:t}),e}.bind(this))}.bind(this)).then(function(){return this.logger.info(`[QE Critical] [Keys] ${this.systemString} New usable key: keyuri=${this.hls.redactUrl(t)} CDMVersion=${this.cdmVersion}`)(),this.hls.eventReporter.notifyKeySessionEvent(F.ckcprocessed,{keyuri:t}),e}.bind(this)).catch(e=>{let t=!i.aborted;if(this.handleKeyExchangeError(i),t)throw e})}abortKeyRequest(e){let t=this.keyUriToKeyInfo[e.uri];this._abortKeyRequest(t)}_abortKeyRequest(e){if(e){let t=e.decryptdata.uri;e.aborted=!0,e.promise&&(this.logger.warn(`[Keys] Aborting key ${this.hls.redactUrl(t)}`)(),this.hls&&this.hls.eventReporter&&this.hls.eventReporter.notifyKeySessionEvent(F.keyaborted,{keyuri:t}),e.promise.reject(new Bt("Aborted",t,0,!0,kt.Abort)),e.promise=void 0,e.promiseType=void 0)}}handleKeyExchangeError(e){}stopRenewal(e){e&&e.renewalTimer&&(clearTimeout(e.renewalTimer),e.renewalTimer=void 0)}updateItemId(e){this.itemId=e}removeKey(e){this.logger.info(`[Keys] removing key ${this.hls.redactUrl(e.uri)}`)();let t=this.keyUriToKeyInfo[e.uri];if(t&&t.session){this._abortKeyRequest(t),this.stopRenewal(t),this.removeSession(t.session,e);let i=g.b.utf8arrayToStr(e.keyId);this.keyIdToKeyInfo[i]=void 0,this.keyUriToKeyInfo[e.uri]=void 0}}removeSession(e,t){var i=this.sessions.indexOf(e);i>-1&&this.sessions.splice(i,1),this.removeAndCloseSessionInternal(e),this.sessionIdToKeyUri[e.sessionId]=void 0}getKeyRequestInfo(e){return Promise.resolve({})}setKeyRequestInfo(e,t){}sanitizeRequest(e){return e}generateLicenseChallengeInternal(e,t,i){return new Promise((s,r)=>{let a,n=e.decryptdata,o=e.session,l=n.uri,d=n.keyId;if(this.setPromise(e,Ct.GET_CHALLENGE,{resolve:s,reject:r}),o.generateRequestPromise)a=o.generateRequestPromise.then(this.generateRequestInitialized.bind(this,e,"usable"===i));else{let i=this.generateInitData(d,n,t);o.generateRequestPromise=o.generateRequest(i.initDataType,i.initData),a=o.generateRequestPromise.then(function(){this.sessionIdToKeyUri[o.sessionId]=l}.bind(this)).catch(function(t){throw this.logger.error(`${this.systemString} FAIL: generateRequest fail keyuri=${this.hls.redactUrl(e.decryptdata.uri)} message=${t.message}`)(),new $t(t.message,e.decryptdata.uri,0,this.systemString)}.bind(this))}a.catch(r)})}generateRequestInitialized(e,t){}generateLicenseChallenge(e,t){let i,s,r=e.decryptdata,a=e.session,n=r.uri,o=r.keyId;if(this.logger.info(`[QE Critical] [Keys] ${this.systemString} generateLicenseChallenge uri=${this.hls.redactUrl(n)}`)(),e.licenseChallenge&&this.resolvePromise(e,Ct.GET_CHALLENGE,e.licenseChallenge,new Bt("Unexpected challenge",n,0,!0,kt.InvalidState)),t=this.sanitizeRequest(t),e.requestInfo=t,this.itemId=this.hls.inGaplessMode?this.hls.loadingItem.itemId:this.itemId,this.sessionId=this.sessionId||t&&t.sessionId||this.itemId,this.systemString===S.systemStringPrefix){let e=new Uint8Array(o);T.changeEndianness(e),i=a.keyStatuses.get(e)}else i=a.keyStatuses.get(o);switch(i){case"status-pending":case"usable":case"expired":case void 0:s=this.generateLicenseChallengeInternal(e,t,i);break;default:s=Promise.reject(new $t(`Bad internal state state=${i}`,n,0,this.systemString))}return s}setParsedResponse(e,t){let i=this.keyUriToKeyInfo[e];this.resolvePromise(i,Ct.GET_KEY_RESPONSE,t,new Bt("Unexpected response received",e,0,!0,kt.InvalidState))}addKeySessionListeners(e){e&&(e.addEventListener("keystatuseschange",this.onkeystatuseschange),e.addEventListener("message",this.onkeymessage))}removeKeySessionListeners(e){e&&(e.removeEventListener("keystatuseschange",this.onkeystatuseschange),e.removeEventListener("message",this.onkeymessage))}handleKeyStatusesChange(e){e.target.keyStatuses.forEach((e,t)=>{let i=new Uint8Array(t);this.systemString===S.systemStringPrefix&&T.changeEndianness(i);let s=g.b.utf8arrayToStr(i),r=this.keyIdToKeyInfo[s];this.handleKeyStatusForKey(e,r)})}handleKeyStatusForKey(e,t){if(!t)return;let i=t.decryptdata.uri;switch(e){case"internal-error":this.logger.error(`[Keys] ${this.systemString} internal-error for keyuri=${this.hls.redactUrl(i)} promiseType=${t.promiseType}`)(),t.promise&&(t.promise.reject(new Bt("Got internal error from key system",i,0,!1,kt.InternalError)),t.promise=void 0);break;case"usable":t.promiseType===Ct.PROCESS_LICENSE&&this.resolvePromise(t,Ct.PROCESS_LICENSE,{},new Bt("Wrong key status",i,0,!0,kt.InvalidState));break;case"output-restricted":if(this.logger.error(`[Keys] ${this.systemString} output-restricted for keyuri=${this.hls.redactUrl(i)}`)(),t.session){var s=this.sessions.indexOf(t.session);s>-1&&this.sessions.splice(s,1),this.removeAndCloseSessionInternal(t.session)}t.promise?(t.promise.reject(new Bt("output-restricted",i,0,!1,kt.OutputRestricted)),t.promise=void 0):this.keyLoader.triggerKeyError(i,new Bt("output-restricted",i,0,!1,kt.OutputRestricted));break;default:this.logger.info(`[Keys] key status uri=${this.hls.redactUrl(i)} ${e}`)()}}}const Gt={initDataTypes:["keyids","cenc"]},Kt={initDataTypes:["cenc"]},Ht=new Uint8Array([148,206,134,251,7,255,79,67,173,184,147,210,250,150,140,162]);var Wt;!(function(e){e[e.CENC=1667591779]="CENC",e[e.CBCS=1667392371]="CBCS"})(Wt||(Wt={}));class jt extends Vt{constructor(e,t,i,s,r){super(e,t,i,s),this.singleRenewalTimer=r,this.renewalTimer=void 0}destroy(){if(this.isDestroying=!0,this.singleRenewalTimer)this.stopRenewal(void 0);else for(let e in this.keyUriToKeyInfo){let t=this.keyUriToKeyInfo[e];this.stopRenewal(t)}return super.destroy()}static get systemId(){return Ht}static get requestAccessConfig(){return Kt}get needsCert(){return!0}stopRenewal(e){this.singleRenewalTimer?(clearTimeout(this.renewalTimer),this.renewalTimer=void 0):e&&(clearTimeout(e.renewalTimer),e.renewalTimer=void 0)}sanitizeRequest(e){return{assetId:e&&e.assetId?new Uint8Array(e.assetId):void 0,ssc:e&&e.ssc?new Uint8Array(e.ssc):void 0,sessionId:e&&e.sessionId?e.sessionId:void 0}}setKeyRequestInfo(e,t){let i=this.keyUriToKeyInfo[e];i?this.resolvePromise(i,Ct.GET_REQUEST_INFO,t,new Bt("Unexpected requestInfo",e,0,!0,kt.InvalidState)):this.logger.error(`Unexpected key requested ${this.hls.redactUrl(e)}`)()}handleParsedKeyResponse(e,t){let i=e.decryptdata.uri,s=t.statusCode;if(!(0!==s||t.ckc&&t.ckc.byteLength))return Promise.reject(new Bt("License request resulted in HTTP Error",i,t.statusCode,!0,kt.HttpError));if(0!==s)return Promise.reject(new Bt("License server responded with error",i,t.statusCode,!1,kt.LicenseServerError));if(!t.ckc||!t.ckc.byteLength)return Promise.reject(new Bt("License server responded with invalid license",i,t.statusCode,!1,kt.LicenseServerError));let r=t.renewalDate,a=new Date,n=r>a?r.getTime()-a.getTime():0;if(n>0){let t=!1;this.singleRenewalTimer?this.renewalTimer||(t=!0,this.renewalTimer=setTimeout(()=>{this.forceStartKeyRequest(e,!0).subscribe()},n)):(t=!0,clearTimeout(e.renewalTimer),e.renewalTimer=setTimeout(()=>{this.forceStartKeyRequest(e,!0).subscribe()},n)),t&&this.logger.info(`[Keys] ${this.systemString} Scheduling renewal in ${n} ms`)()}let o=this.makeProcessLicenseRequestMessage(e,t,n);return new Promise((t,i)=>{this.setPromise(e,Ct.PROCESS_LICENSE,{resolve:t,reject:i});let s=e.session;s.update(o).then(t=>{let i=e.decryptdata.keyId,r=s.keyStatuses.get(i);this.handleKeyStatusForKey(r,e)}).catch(t=>{i(new $t(t.message,e.decryptdata.uri,0,this.systemString)),e.promise=void 0})})}forceStartKeyRequest(e,t){return t&&this.stopRenewal(e),this.abortKeyRequest(e.decryptdata),this.keyLoader.getKeyFromDecryptData(e.decryptdata,void 0,!0).pipe(Qe(this.destroy$))}makeKeyRequests(e){let t=[];for(let i in e){let s=e[i],r=s.decryptdata,a=s.requestInfo,n=r.keyId;t.push({keyId:n,assetId:a?a.assetId:void 0,ssc:a?a.ssc:void 0,versionList:r.formatversions})}return t}getSchemeAndFlags(e){let t="ISO-23001-7"===e.method?Wt.CENC:Wt.CBCS,i=0;return this.hls.playingItem.secureStop&&(i|=1),{scheme:t,flags:i}}generateInitData(e,t,i){let{scheme:s,flags:r}=this.getSchemeAndFlags(t),a=this.makeKeyRequests([{decryptdata:t,requestInfo:i}]);return{initData:this.makeFpsKeySystemInitData(s,r,a),initDataType:"cenc"}}generateRequestInitialized(e,t){let i=this.makeKeyRequestMessage(e,t);return i?e.session.update(i).then(function(){e.requestInfo=void 0}.bind(this)).catch(function(t){throw this.logger.error(`[Keys] ${this.systemString} FAIL: generateRequestInitialized keyuri=${this.hls.redactUrl(e.decryptdata.uri)} message=${t.message}`)(),new $t(t.message,e.decryptdata.uri,0,this.systemString)}.bind(this)):Promise.reject(new Bt("Unable to generate request using existing keySession",e.decryptdata.uri,0,!0,kt.InvalidState))}getKeyRequestResponse(e,t){return new Promise(function(i,r){let a=e.decryptdata.uri;this.setPromise(e,Ct.GET_KEY_RESPONSE,{resolve:i,reject:r}),this.hls.trigger(s.b.LICENSE_CHALLENGE_CREATED,{keyuri:a,licenseChallenge:t,keysystem:this.systemString})}.bind(this))}resolveSPCPromise(e,t){let i=e.decryptdata.uri;this.resolvePromise(e,Ct.GET_CHALLENGE,t,new Bt("Unexpected challenge",i,0,!0,kt.InvalidState))}}var qt=i(4);const Yt={SessionId:"AirPlayPlaybackSessionID",APIProvider:"APIProviderID",MovieID:"PlaybackSessionID",SecureStopSPC:"SecureStopSPC",SessionLifespanSPC:"SessionLifespanSPC"},zt={NONE:0,CRKR:1668442994,RMKY:1919773561,CKCS:1667982195,CERT:1667592820,SPCS:1936745331,RNEW:1919837559,RLSE:1919710053,SSTP:1936946288,CDMI:1667525993},Qt={CENC:"EC396D13-FB13-4993-9D0D-71518ACF3D6F",CBCS:"F19BF03B-7470-41A4-9655-86D078307D59"};function Xt(e,t,i){if(i+4>e.byteLength)return;let s=t.getUint32(i);if((i+=4)+s>e.byteLength)return;let r=e.slice(i,i+s);return{pos:i+=s,data:r}}function Jt(e){let t={},i=new DataView(e.buffer),s=4;var r=i.getUint32(s);s+=4;for(let a=0;a<r&&s<e.byteLength&&!(s+16>e.byteLength);++a){let r=e.slice(s,s+16);if((s+=16)+4>e.byteLength)break;let a=Xt(e,i,s);if(!a)break;s=a.pos,t[g.b.utf8arrayToStr(r)]=a.data}return t}function Zt(e,t,i,s){let r=s?s.byteLength:0;return t.setUint32(i,r),r&&e.set(s,i+4),i+(4+r)}function ei(e){let t=4;for(let i in e)t+=28+(e[i].assetId?e[i].assetId.byteLength:0)+(e[i].ssc?e[i].ssc.byteLength:0)+(e[i].versionList?4*e[i].versionList.length:0);return t}function ti(e,t,i,s){t.setUint32(i,s.length),i+=4;for(let r in s){let a=s[r];if(e.set(a.keyId,i),i=Zt(e,t,i=Zt(e,t,i+=16,a.assetId),a.ssc),t.setUint32(i,a.versionList?a.versionList.length:0),i+=4,a.versionList)for(let e in a.versionList)t.setUint32(i,a.versionList[e]),i+=4}return i}class ii extends jt{constructor(e,t,i,s){super(e,t,i,s,void 0===e.config.useMultipleKeySessions||!e.config.useMultipleKeySessions)}ensureKeySessionForKeyInfo(e){if(!e.session)if(this.singleRenewalTimer&&0!==this.sessions.length)e.session=this.sessions[0];else{let t=this.mediaKeys.createSession();t?(this.sessions.push(t),this.addKeySessionListeners(t)):this.logger.error(`${this.systemString} FAIL: could not create MediaKeysSession`)(),e.session=t}}getKeyRequestInfo(e){return new Promise(function(t,i){let r=e.decryptdata,a=r.uri;this.setPromise(e,Ct.GET_REQUEST_INFO,{resolve:t,reject:i}),this.hls.trigger(s.b.KEY_REQUEST_STARTED,{keyuri:a,decryptdata:r,timestamp:Date.now()})}.bind(this))}makeProcessLicenseRequestMessage(e,t,i){let s=new Uint8Array(t.ckc);return (function(e){let t=0;for(let i in e)t+=24+e[i].ckc.byteLength;let i=0,s=new Uint8Array(8+t),r=new DataView(s.buffer);r.setUint32(0,zt.CKCS),r.setUint32(4,e.length),i+=8;for(let t in e){let a=e[t];s.set(a.keyId,i),i+=16,r.setUint32(i,a.expirySec),i=Zt(s,r,i+=4,a.ckc)}return s})([{keyId:e.decryptdata.keyId,expirySec:i/1e3,ckc:s}])}makeFpsKeySystemInitData(e,t,i){let s=(function(e,t,i,s){let r=ei(s),a=0,n=new Uint8Array(8+r),o=new DataView(n.buffer);return o.setUint32(a,e),o.setUint32(a+4,1<<24|16777215&i),a=ti(n,o,a+=8,s),n})(e,0,t,i);return qt.a.pssh(ii.systemId,[],s)}makeKeyRequestMessage(e){return (function(e){let t=ei(e),i=0,s=new Uint8Array(4+t),r=new DataView(s.buffer);return r.setUint32(0,zt.CRKR),i=ti(s,r,i+=4,e),s})([{keyId:e.decryptdata.keyId,assetId:e.requestInfo?e.requestInfo.assetId:void 0,ssc:e.requestInfo?e.requestInfo.ssc:void 0,versionList:e.decryptdata.formatversions}])}handleKeyMessage(e){if(e.message.byteLength<4)return void this.logger.error("Unexpected message")();let t=new Uint8Array(e.message),i=new DataView(e.message),s=i.getUint32(0);if(this.isDestroying&&s!==zt.RLSE)this.logger.warn(`In the middle of destroying, ignore command: ${s.toString(16)}`)();else switch(s){case zt.CERT:this.logger.warn("Certificate not set!")();break;case zt.RNEW:{let e=Jt(t);for(let t in e){let e=this.keyIdToKeyInfo[t];this.forceStartKeyRequest(e,!0).subscribe()}break}case zt.SPCS:{let e=Jt(t);for(let t in e){let i=this.keyIdToKeyInfo[t],s=e[t];this.resolveSPCPromise(i,s)}break}case zt.RLSE:this._handleLicenseRelease(t);break;case zt.CDMI:{let e=Xt(t,i,4);if(e){let t=this.cdmVersion=g.b.utf8arrayToStr(e.data);this.logger.info(`[Keys] ${this.systemString} CDM Version :  ${t}`)()}break}}}_handleLicenseRelease(e){let t={},i=new DataView(e.buffer);switch(i.getUint32(4)){case zt.SSTP:{if(!Yt){this.logger.error("No secure stop keys defined")();break}t[Yt.SessionId]=this.sessionId;let s=8;if(s+4>e.byteLength)break;t[Yt.APIProvider]=i.getUint32(s)===Wt.CENC?Qt.CENC:Qt.CBCS;let r=Xt(e,i,s+=4);if(!r)break;if(s=r.pos,t[Yt.MovieID]=g.b.utf8arrayToStr(r.data),!(r=Xt(e,i,s)))break;if(s=r.pos,t[Yt.SecureStopSPC]=r.data,!(r=Xt(e,i,s)))break;s=r.pos,t[Yt.SessionLifespanSPC]=r.data;break}}this.hls.trigger(s.b.LICENSE_RELEASED,{keysystem:this.systemString,itemId:this.itemId,releaseRecord:t})}}var si=ii;const ri={fpsd:g.b.strToUtf8array("fpsd"),fpsi:g.b.strToUtf8array("fpsi"),fpsk:g.b.strToUtf8array("fpsk"),fkri:g.b.strToUtf8array("fkri"),fkai:g.b.strToUtf8array("fkai"),fkcx:g.b.strToUtf8array("fkcx"),fkvl:g.b.strToUtf8array("fkvl")};function ai(e,t,i,s){let r=[ri.fpsk],a=qt.a.box(ri.fkri,new Uint8Array([0,0,0,0]),e);if(r.push(a),t&&t.byteLength&&r.push(qt.a.box(ri.fkai,t)),i&&i.byteLength&&r.push(qt.a.box(ri.fkcx,i)),s&&s.length){let e=new Uint8Array(4*s.length),t=0;for(let i of s)qt.a.set32(i,e,t),t+=4;r.push(qt.a.box(ri.fkvl,e))}return qt.a.box.apply(null,r)}var ni={initDataTypes:["cenc"]};const oi=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);class li extends Vt{constructor(e,t,i,s){super(e,t,i,s),this.hls=e,this.shouldDestroyMediaKeys=!0}static get systemId(){return oi}static get requestAccessConfig(){return ni}get needsCert(){return!1}generateInitData(e,t){let i=t.pssh;return{initData:qt.a.pssh(li.systemId,[],i),initDataType:"cenc"}}removeKey(e){let t=this.keyUriToKeyInfo[e.uri];t&&(t.oldSessions.forEach(t=>{this.removeSession(t,e)}),t.oldSessions=[],super.removeKey(e))}ensureKeySessionForKeyInfo(e){e.session&&(e.oldSessions.push(e.session),e.session=null),super.ensureKeySessionForKeyInfo(e)}startKeyRequest(e){let t=e.uri;return this.keyUriToKeyInfo[t]||(this.keyUriToKeyInfo[t]={decryptdata:e,session:null,aborted:!1,oldSessions:[]}),super.startKeyRequest(e)}_startKeyRenewal(e){this.stopRenewal(e),this.keyLoader.getKeyFromDecryptData(e.decryptdata,void 0,!0).pipe(Qe(this.destroy$)).subscribe()}getKeyRequestResponse(e,t){return new Promise(function(i,r){let a=e.decryptdata.uri;this.setPromise(e,Ct.GET_KEY_RESPONSE,{resolve:i,reject:r}),this.hls.trigger(s.b.LICENSE_CHALLENGE_CREATED,{keyuri:a,licenseChallenge:t,keysystem:this.systemString,keyId:e.decryptdata.keyId})}.bind(this))}generateRequestInitialized(e){let t=e.decryptdata.uri,i=e.licenseChallenge;e.requestInfo=void 0,this.resolvePromise(e,Ct.GET_CHALLENGE,i,new Bt("Unexpected challenge",t,0,!0,kt.InvalidState))}handleParsedKeyResponse(e,t){if(!this.isDestroying)return new Promise((i,s)=>{let r=e.decryptdata.uri;if(0!==t.statusCode)return s(new Bt("License server responded with error",r,t.statusCode,!1,kt.LicenseServerError));if(!t.license||!t.license.byteLength)return s(new Bt("License server responded with invalid license",r,t.statusCode,!1,kt.LicenseServerError));if(t.renewalDate){let i=t.renewalDate,s=new Date,r=i>s?i.getTime()-s.getTime():0;r>0&&(clearTimeout(e.renewalTimer),e.renewalTimer=setTimeout(this._startKeyRenewal.bind(this,e),r))}this.setPromise(e,Ct.PROCESS_LICENSE,{resolve:i,reject:s}),e.session.update(t.license).then(function(){this.resolvePromise(e,Ct.PROCESS_LICENSE,{},new Bt("Wrong key status",r,0,!0,kt.InvalidState))}.bind(this)).catch(t=>{this.logger.error(`${this.systemString} FAIL: Failed to update with key response message=${t.message}`)(),e.promise.reject(new $t(t.message,e.decryptdata.uri,0,this.systemString)),e.promise=void 0})});this.logger.warn("In the middle of destroying, ignore key message")()}handleKeyMessage(e){if(this.isDestroying)return void this.logger.warn("In the middle of destroying, ignore key message")();var t=new DOMParser;let i=String.fromCharCode.apply(null,new Uint16Array(e.message.buffer||e.message)),s=t.parseFromString(i,"application/xml").getElementsByTagName("Challenge")[0].childNodes[0].nodeValue,r=m.a.base64Decode(s),a=g.b.utf8arrayToStr(r),n=t.parseFromString(a,"application/xml").getElementsByTagName("KID")[0];var o;o=n.childNodes[0]?n.childNodes[0].nodeValue:n.getAttribute("VALUE");let l=m.a.base64Decode(o).subarray(0,16);T.changeEndianness(l);let d=this.keyIdToKeyInfo[g.b.utf8arrayToStr(l)],h=d.decryptdata.uri;d.licenseChallenge=r,this.resolvePromise(d,Ct.GET_CHALLENGE,r,new Bt("Unexpected challenge",h,0,!0,kt.InvalidState))}}var di=li;const hi={initDataTypes:["cenc","keyids"],distinctiveIdentifier:"optional",persistentState:"required"},ci=new Uint8Array([237,239,139,169,121,214,74,206,163,200,39,220,213,29,33,237]),ui={clearkey:{id:"clearkey",systemStringPrefix:"org.w3.clearkey",keyFormatString:"org.w3.clearkey"},fairplaystreaming:ce,playready:S,widevine:I},fi={clearkey:[["org.w3.clearkey",class extends Vt{constructor(e,t,i,s){super(e,t,i,s),this.abort$=new it}static get requestAccessConfig(){return Gt}get needsCert(){return!1}getKeyRequestInfo(e){return new Promise(function(t,i){let r=e.decryptdata,a=r.uri;this.setPromise(e,Ct.GET_REQUEST_INFO,{resolve:t,reject:i}),this.hls.trigger(s.b.KEY_REQUEST_STARTED,{keyuri:a,decryptdata:r,timestamp:Date.now()})}.bind(this))}setKeyRequestInfo(e,t){let i=this.keyUriToKeyInfo[e];i&&this.resolvePromise(i,Ct.GET_REQUEST_INFO,t,new Bt("Unexpected requestInfo",e,0,!0,kt.InvalidState))}getKeyRequestResponse(e,t){let i=e.decryptdata.uri;return this.keyLoader.fetchKeyHTTP(i,e.decryptdata,this.hls.config.keyLoadingDefaultTimeout).pipe(gt(e=>({response:this.parseResponse(t,e.decryptdata.key),statusCode:0,license:void 0,renewalDate:void 0})),Qe(this.abort$)).toPromise()}parseResponse(e,t){var i={kty:"oct",kid:e,k:m.a.base64UrlEncode(t)};return g.b.strToUtf8array(JSON.stringify({keys:[i]}))}handleParsedKeyResponse(e,t){if(!this.isDestroying)return new Promise((i,s)=>{let r=t.response;this.setPromise(e,Ct.PROCESS_LICENSE,{resolve:i,reject:s}),e.session.update(r).then(()=>{this.resolvePromise(e,Ct.PROCESS_LICENSE,{},new Bt("Wrong key status",e.decryptdata.uri,0,!0,kt.InvalidState))}).catch(t=>{this.logger.error(`${this.systemString} FAIL: Failed to update with key response message=${t.message}`)(),e.promise.reject(new $t(t.message,e.decryptdata.uri,t.code,this.systemString)),e.promise=void 0})});this.logger.warn("In the middle of destroying, ignore key message")()}generateInitData(e){return{initData:T.makeKeyIdsInitData([e]),initDataType:"keyids"}}_abortKeyRequest(e){this.abort$.next(),super._abortKeyRequest(e)}sanitizeRequest(e){return e}handleKeyMessage(e){if(this.isDestroying)return void this.logger.warn("In the middle of destroying, ignore key message")();if("license-request"!==e.messageType)return;let t=new Uint8Array(e.message),i=JSON.parse(g.b.utf8arrayToStr(t).trim());if(1!==i.kids.length)return;let s=m.a.base64Decode(i.kids[0]),r=this.keyIdToKeyInfo[g.b.utf8arrayToStr(s)];if(r){let e=r.decryptdata.uri;this.resolvePromise(r,Ct.GET_CHALLENGE,i.kids[0],new Bt("Unexpected challenge",e,0,!0,kt.InvalidState))}}}]],fairplaystreaming:[["com.apple.fps.3_0",class extends jt{constructor(e,t,i,s){super(e,t,i,s,!1),this.sessions=[],this.keyIdToKeyInfo={},this.keyUriToKeyInfo={},this.sessionIdToKeyUri={}}static get needsCert(){return!0}startKeyRequest(e){let t=e.uri;return this.keyUriToKeyInfo[t]||(this.keyUriToKeyInfo[t]={decryptdata:e,session:null,aborted:!1,licenseChallenge:null}),super.startKeyRequest(e)}handleKeyExchangeError(e){this.removeKey(e.decryptdata)}makeFpsKeySystemInitData(e,t,i){return (function(e,t,i){let s=[ri.fpsd,(function(e,t){let i=new Uint8Array(4);return qt.a.set32(e,i,0),qt.a.box(ri.fpsi,new Uint8Array([0,t>>16&255,t>>8&255,255&t]),i)})(e,t)];for(let e of i)s.push(ai(e.keyId,e.assetId,e.ssc,e.versionList));let r=qt.a.box.apply(null,s);return qt.a.pssh(jt.systemId,null,r)})(e,t,i)}makeKeyRequestMessage(e,t){if(t)return g.b.strToUtf8array("renew")}makeProcessLicenseRequestMessage(e,t,i){let s=JSON.stringify([{keyID:m.a.base64Encode(e.decryptdata.keyId),payload:m.a.base64Encode(t.ckc)}]);return g.b.strToUtf8array(s)}handleKeyMessage(e){let t,i=e.target,s=i.sessionId,r=e.messageType,a=this.sessionIdToKeyUri[s];if(a)t=this.keyUriToKeyInfo[a];else for(let e of Object.values(this.keyUriToKeyInfo))e&&e.session===i&&(t=e);if(t)switch(r){case"license-request":{let i=new Uint8Array(e.message),s=g.b.utf8arrayToStr(i);try{JSON.parse(s).forEach(e=>{let t,i=m.a.base64DecodeToStr(e.keyID),s=m.a.base64Decode(e.payload);t=this.keyIdToKeyInfo[i],this.resolveSPCPromise(t,s)})}catch(e){this.logger.warn("[Keys] got unexpected license-request format")(),this.resolveSPCPromise(t,i)}break}case"license-renewal":{let i=new Uint8Array(e.message);this.resolveSPCPromise(t,i);break}case"license-release":this._handleLicenseRelease(i);break;default:this.logger.error(`[Keys] Unexpected messageType ${r}`)()}else this.logger.warn("[Keys] No key associated with session")()}_handleLicenseRelease(e){e.update(g.b.strToUtf8array("acknowledged"))}}],["com.apple.fps",si]],playready:[["com.microsoft.playready",di]],widevine:[["com.widevine.alpha",class extends Vt{constructor(e,t,i,s){super(e,t,i,s),this.hls=e,this.shouldDestroyMediaKeys=!0}static get systemId(){return ci}static get requestAccessConfig(){return hi}get needsCert(){return!0}getKeyRequestResponse(e,t){return new Promise(function(i,r){let a=e.decryptdata.uri;this.setPromise(e,Ct.GET_KEY_RESPONSE,{resolve:i,reject:r}),this.hls.trigger(s.b.LICENSE_CHALLENGE_CREATED,{keyuri:a,licenseChallenge:t,keysystem:this.systemString,keyId:e.decryptdata.keyId})}.bind(this))}handleParsedKeyResponse(e,t){if(!this.isDestroying)return new Promise((i,s)=>{e.licenseChallenge=void 0;let r=e.decryptdata.uri;return 0!==t.statusCode?s(new Bt("License server responded with error",r,t.statusCode,!1,kt.LicenseServerError)):t.license&&t.license.byteLength?(this.setPromise(e,Ct.PROCESS_LICENSE,{resolve:i,reject:s}),void e.session.update(t.license).then(function(){let t=e.decryptdata.keyId;"usable"===e.session.keyStatuses.get(t)&&this.resolvePromise(e,Ct.PROCESS_LICENSE,{},new Bt("Wrong key status",r,0,!0,kt.InvalidState))}.bind(this)).catch(function(t){this.logger.error(`${this.systemString} FAIL: Failed to update with key response code=${t.code} message=${t.message}`)(),e.promise.reject(new $t(t.message,e.decryptdata.uri,t.code,this.systemString)),e.promise=void 0}.bind(this))):s(new Bt("License server responded with invalid license",r,t.statusCode,!1,kt.LicenseServerError))});this.logger.warn("In the middle of destroying, ignore key message")()}generateInitData(e,t){return{initData:t.pssh,initDataType:"cenc"}}generateRequestInitialized(e){let t=e.decryptdata.uri,i=e.licenseChallenge;e.requestInfo=void 0,this.resolvePromise(e,Ct.GET_CHALLENGE,i,new Bt("Unexpected challenge",t,0,!0,kt.InvalidState))}handleKeyMessage(e){if(this.isDestroying)return void this.logger.warn("In the middle of destroying, ignore key message")();let t=e.target,i=null,s=null;if(t.sessionId in this.sessionIdToKeyUri)switch(i=this.sessionIdToKeyUri[t.sessionId],s=this.keyUriToKeyInfo[i],e.messageType){case"license-request":{let t=new Uint8Array(e.message);s.licenseChallenge=t,this.resolvePromise(s,Ct.GET_CHALLENGE,t,new Bt("Unexpected challenge",i,0,!0,kt.InvalidState));break}case"license-renewal":{let t=new Uint8Array(e.message);s.licenseChallenge=t,this.keyLoader.getKeyFromDecryptData(s.decryptdata,void 0,!0).pipe(Qe(this.destroy$)).subscribe();break}}else this.logger.error(`${this.systemString} empty keyuri and keyInfo`)()}}]]},gi=ce.id;var pi,mi,yi=(()=>{class e{static createMediaKeys(t,i,s,r){let a=e.idToMediaKeysInfoMap[t];if(!a){let n;c.b.info(`[Keys] ${t} requesting key system access`)();let o=T.getCapabilities(i,s);n=e.requestKeySystemAccess(t,o,r).then((function(i){return e.idToMediaKeysInfoMap[t].keySystemAccess=i,c.b.info(`[Keys] ${t} creating CDM`)(),i.createMediaKeys()})).then((function(e){return c.b.info(`[Keys] ${t} created CDM`)(),e})).catch((function(e){throw c.b.error(`[Keys] FAIL: could not initialize ${t} key system: ${e.message}`)(),e})),a=e.idToMediaKeysInfoMap[t]={promise:n,keySystemAccess:null}}return a.promise}static destroyMediaKeys(){e.idToMediaKeysInfoMap={}}static getKeySystemIdForDecryptData(e){let t;if(e){t=gi;let i=e.format;for(let e in ui)if(ui[e].keyFormatString===i){t=e;break}}if(!t)throw Error("No matching key system");return t}static requestKeySystemAccess(t,i,s){if("undefined"==typeof navigator||void 0===navigator.requestMediaKeySystemAccess)return Promise.reject(new $t("navigator undefined",void 0,0,t));let r=fi[t],a=Promise.reject(new $t("no key systems to try",void 0,0,t));for(let t of r){let r=t[0],n=t[1],o=void 0===s||0===s.length?n.requestAccessConfig:s,l=[Object.assign({},o,i)];a=a.catch(e.requestKeySystemInternal.bind(null,r,l))}return a}static requestKeySystemInternal(e,t){return navigator.requestMediaKeySystemAccess(e,t)}static make(t,i,s,r){let a,n=e.idToMediaKeysInfoMap[t].keySystemAccess;if(!n)throw new $t(`No keySystemAccess for ${t}`,void 0,0,t);let o=ui[t].systemStringPrefix;for(let e of fi[t])if(e[0]===n.keySystem){a=e[1];break}if(!a)throw new $t(`No constructor associated with ${t}`,void 0,0,o);return new a(i,s,r,o)}static get availableKeySystems(){return Object.keys(ui)}static getKeySystemFormat(e){let t=ui[e];return t?t.keyFormatString:""}}return e.idToMediaKeysInfoMap={},e})();!(function(e){e.UNKNOWN="unkn",e.VIDEO="vide",e.AUDIO="soun",e.SUBTITLE="sbtl",e.CLOSEDCAPTION="clcp"})(pi||(pi={})),(function(e){e[e.NO=0]="NO",e[e.YES=1]="YES"})(mi||(mi={}));const vi=/^(\d+)x(\d+)$/,bi=/\s*(.+?)\s*=((?:\".*?\")|.*?)(?:,|$)/g,Ti={NAME:"",TYPE:"",DEFAULT:"",AUTOSELECT:"",FORCED:"",LANGUAGE:"",URI:"",AUDIO:"","VIDEO-RANGE":"","CLOSED-CAPTIONS":"",CODECS:"",BYTERANGE:"","INSTREAM-ID":"","GROUP-ID":"",CHANNELS:"",CHARACTERISTICS:"",KEYFORMAT:"",KEYFORMATVERSIONS:"","DATA-ID":"",VALUE:"",METHOD:"","HDCP-LEVEL":""},Si={BANDWIDTH:NaN,"AVERAGE-BANDWIDTH":NaN},Ii={"TIME-OFFSET":NaN,"FRAME-RATE":NaN},Ei={IV:null},_i={RESOLUTION:null};class Ri{constructor(e){this.validTags=e}isKey(e){return e in this.validTags}trySetValue(e,t,i){return!!this.isKey(e)&&(i[e]=this.parseFunc(t),!0)}}let Di=(()=>{class e{static parseTags(t){let i,s={};if(!t)return s;for(bi.lastIndex=0;null!==(i=bi.exec(t));){const t=i[1].toUpperCase(),r='"';let a=i[2];0===a.indexOf(r)&&a.lastIndexOf(r)===a.length-1&&(a=a.slice(1,-1));for(let i of e.tagParsers)if(i.trySetValue(t,a,s))break}return s}}return e.tagParsers=[new class extends Ri{parseFunc(e){return e}}(Ti),new class extends Ri{parseFunc(e){let t=parseInt(e);return t>Number.MAX_SAFE_INTEGER?1/0:t}}(Si),new class extends Ri{constructor(){super(...arguments),this.parseFunc=parseFloat}}(Ii),new class extends Ri{parseFunc(e){let t=(e||"0x").slice(2);t=(1&t.length?"0":"")+t;const i=new Uint8Array(t.length/2);for(let e=0;e<t.length/2;e++){let s=parseInt(t.slice(2*e,2*e+2),16);if(isNaN(s))return;i[e]=s}return i}}(Ei),new class extends Ri{parseFunc(e){const t=vi.exec(e);let i;return null!==t&&(i={width:parseInt(t[1],10),height:parseInt(t[2],10)}),i}}(_i)],e})();var Ai,Li,wi,ki,Ci,Pi,Mi,Oi=i(3);!(function(e){e[e.SDR=0]="SDR",e[e.HDR=1]="HDR",e[e.HDR10=2]="HDR10",e[e.DolbyVision=3]="DolbyVision",e[e.HLG=4]="HLG"})(Ai||(Ai={})),(function(e){e[e.H264=16]="H264",e[e.HEVC=64]="HEVC"})(Li||(Li={})),(function(e){e[e.DOVI=4]="DOVI",e[e.HEVC=3]="HEVC",e[e.VP09=2]="VP09",e[e.AVC=1]="AVC",e[e.UNKNOWN=0]="UNKNOWN"})(wi||(wi={})),(function(e){e[e.PQ=3]="PQ",e[e.HLG=2]="HLG",e[e.SDR=1]="SDR",e[e.UNKNOWN=0]="UNKNOWN"})(ki||(ki={})),(function(e){e[e.EC3=4]="EC3",e[e.AC3=3]="AC3",e[e.AAC=2]="AAC",e[e.MP3=1]="MP3",e[e.UNKNOWN=0]="UNKNOWN"})(Ci||(Ci={})),(function(e){e[e.VALID=1]="VALID",e[e.INVALID=0]="INVALID"})(Pi||(Pi={}));class Ni{constructor(...e){this.identifier=e}ensureSameIdentifierLength(e){if(this.identifier.length!==e.identifier.length)throw new Error(`Identifiers have non-matching lengths! (${this.identifier.length} vs ${e.identifier.length})`)}isGreaterThan(e){this.ensureSameIdentifierLength(e);for(let t=0;t<this.identifier.length;++t){if(this.identifier[t]<e.identifier[t])return!1;if(this.identifier[t]>e.identifier[t])return!0}return!1}isEqualTo(e){return this.ensureSameIdentifierLength(e),this.identifier.every((t,i)=>t===e.identifier[i])}}function xi(e,t,i){let s,r=t.length,a=i.length;if(r!==a){let e=t.filter(e=>!i.includes(e));s=`playlist has ${a} levels left, removed persistentIds:${JSON.stringify(e.map(e=>e.persistentId))}`}else s="no levels were removed";c.b.info(`Applied ${e} Filtering, ${s}`)()}function Fi(e){return Oi.b.isDolby(e)?wi.DOVI:Oi.b.isHEVC(e)?wi.HEVC:Oi.b.isVP09(e)?wi.VP09:Oi.b.isAVC(e)?wi.AVC:wi.UNKNOWN}function Bi(e){return Oi.b.isEC3(e)?Ci.EC3:Oi.b.isAC3(e)?Ci.AC3:Oi.b.isAAC(e)?Ci.AAC:Oi.b.isMP3(e)?Ci.MP3:Ci.UNKNOWN}function Ui(e,t,i){const{targetDuration:s,targetStartupMs:r}=i;return e.bandwidth<=t.avgBandwidth&&(e.avgBandwidth||e.bandwidth)*s/t.avgBandwidth*1e3+t.avgLatencyMs<=r}function $i(e,t,i,s){const r=(function(e,t,i){const s=(e,t,i)=>(e-t)*(e-i)<=0;return s(e,i.minValidBitrate,i.maxValidBitrate)&&s(t,i.minValidHeight,i.maxValidHeight)})(e.bitrate,e.height,t)?Pi.VALID:Pi.INVALID,a="PQ"===(n=e.videoRange)?ki.PQ:"HLG"===n?ki.HLG:"SDR"===n?ki.SDR:ki.UNKNOWN;var n;const{videoCodecRank:o,audioCodecRank:l}=(function(e){return{videoCodecRank:Fi(e.videoCodec),audioCodecRank:Bi(e.audioCodec)}})(e),d=e.bitrate<=t.maxPreferredBitrate?Pi.VALID:Pi.INVALID,h=e.audioChannelCount||1,c=i&&s&&!Ui(e,i,s)?Pi.INVALID:Pi.VALID;return new Ni(r,a,o,h,l,c,d,e.height)}function Vi(e){if(!e||!e.length)return;const t=e.sort((e,t)=>Fi(t)-Fi(e));return t&&t.length?t[0]:void 0}function Gi(e){if(!e||!e.length)return;const t=e.sort((e,t)=>Bi(t)-Bi(e));return t&&t.length?t[0]:void 0}function Ki(e,t){if(!e||!t||!t.length)return;let i=void 0;const s=t.filter(t=>t.groupId===e);if(s&&s.length){const e=s.sort((e,t)=>Oi.b.getChannelCount(t.channels)-Oi.b.getChannelCount(e.channels));e&&e.length&&(i=e[0].channels)}return i}function Hi(e,t,i){var s=function(i,s){return (function(i,s){let r=s?"audio":"video";e.has(i)||t.has(i)||(function(e,t){let i=MediaSource.isTypeSupported(`${e}/mp4;codecs=${t}`);return"mp4a.40.34"!==t||i||(i=MediaSource.isTypeSupported(`${e}/mpeg`)),i}(r,i)?e.add(i):t.add(i))})(i,s),t.has(i)};let r=!1;return i.audioCodecList&&(r=i.audioCodecList.some(e=>s(e,!0))),!r&&i.videoCodecList&&(r=i.videoCodecList.some(e=>s(e,!1))),!r}function Wi(e,t){for(let i in e)if(e[i].type===t)return e[i];return{}}function ji(e,t){return isNaN(e)||isNaN(t)||e<=t}function qi(e){return e.every(e=>e.iframes)}function Yi(e,t,i,s){let a=i?i.maxHdcpLevel:void 0,n=Array.from(e);a&&(n=(function(e,t){let i=function(e){switch(e){case"NONE":return 0;case"TYPE-0":return 1;case"TYPE-1":return 2;case"TYPE-2":return 3;default:return 4}},s=i(a),r=e.filter((function(e){let t=e.hdcpLevel;return!t||i(t)<=s}));return xi("HDCP",e,r),r})(n)),n.forEach(e=>{if(e.audioCodecList&&e.audioGroupId){let i=t.find(t=>t.groupId===e.audioGroupId),s=i?i.channels:void 0;s&&(e.audioChannelCount=parseInt(s))}});let o,l=!!s&&s.useMediaKeySystemAccessFilter,d=s&&void 0!==s.keySystemPreference,h=l&&d&&navigator&&"function"==typeof navigator.requestMediaKeySystemAccess;return(o=h?(function(e,t){let i=new Array,s=new Map;return e.forEach(e=>{let r=Array();!(function(e,t,i){let r,a=T.getCapabilities(t.videoCodecList,t.audioCodecList),n=JSON.stringify(a);s.has(n)?r=s.get(n):(r=yi.requestKeySystemAccess(e,a,[]).then(e=>!0).catch(e=>(c.b.warn(`Request key system error: ${e.message}`)(),!1)),s.set(n,r)),i.push(r)})(t,e,r);let a=Promise.all(r).then(t=>{if(void 0===t.find(e=>!1===e))return e});i.push(a)}),Promise.all(i).then(e=>e.filter(e=>Boolean(e)))})(n,s.keySystemPreference):Promise.resolve(n)).then(e=>{if(0===e.length||qi(e))throw new r.q(r.g.MEDIA_ERROR,r.d.MANIFEST_INCOMPATIBLE_CODECS_ERROR,void 0,"no level with compatible codecs found in manifest",void 0);h&&xi("Key System Support",n,e);let a,o=navigator&&navigator.mediaCapabilities,l=!!s&&s.useMediaCapabilities&&o&&"function"==typeof o.decodingInfo;return l?a=(function(e,t){let i=navigator&&navigator.mediaCapabilities,s=new Array,r=new Set,a=new Set,n=new Map;function o(e,t,s,r,a){let o={type:"media-source"};r?o.video=(function(e,t){let i={contentType:`video/mp4;codecs=${e}`,width:t.width,height:t.height,bitrate:t.avgBandwidth,framerate:t.iframes?8:t.frameRate};if(t.videoRange)switch(t.videoRange){case"PQ":Oi.b.isDolby(e)?(i.hdrMetadataType=Mi.DoVi,i.colorGamut="rec2020"):(Oi.b.isHEVC(e)||Oi.b.isVP09(e))&&(i.hdrMetadataType=Mi.HDR10,i.colorGamut="rec2020"),i.transferFunction="pq";break;case"HLG":i.colorGamut="rec2020",i.transferFunction="hlg"}return i})(s,e):o.audio=(function(e,t,i){let s={contentType:`audio/mp4;codecs=${e}`},r=Ki(t.audioGroupId,i);if(r){let e=r.split("/"),t=e[0];s.channels=t,e.find(e=>"JOC"===e)&&(s.spatialRendering=!0)}return s})(s,e,t);let l,d=JSON.stringify(o);if(n.has(d))l=n.get(d);else{try{l=i.decodingInfo(o).then(e=>{let t=e.configuration||e.supportedConfiguration,i=t instanceof Object&&(!o.video||void 0===Object.keys(o.video).find(e=>!(e in t.video)))&&(!o.audio||void 0===Object.keys(o.audio).find(e=>!(e in t.audio))),s=e.supported&&(!r||e.powerEfficient)&&i;return s||c.b.warn(`Unsupported config ${e.supported}/${e.powerEfficient}/${i} ${JSON.stringify(o)} supportedConfig=${JSON.stringify(t)}`)(),s})}catch(e){l=Promise.reject(e)}n.set(d,l)}a.push(l)}function l(e){c.b.info(`Unsupported level ${JSON.stringify(e,["avgBandwidth","audioCodecList","videoCodecList","videoRange","frameRate","width","height","iframes"])}`)()}for(let i of e){let e=Array();if(i.videoCodecList)for(let s of i.videoCodecList)o(i,t,s,!0,e);if(i.audioCodecList&&i.audioCodecList.length>0){const s=Gi(i.audioCodecList);o(i,t,s,!1,e)}let n=Promise.all(e).then(e=>{if(void 0===e.find(e=>!1===e))return i;l(i)}).catch(e=>{if(c.b.warn(`decodingInfo error: ${e.message}`)(),Hi(r,a,i))return i;l(i)});s.push(n)}return Promise.all(s).then(e=>e.filter(e=>Boolean(e)))})(e,t):(e=(function(e,t){let i=new Set,s=new Set,r=!MediaSource.isTypeSupported('audio/mp4; codecs="mp4a.40.2"; channels="-1"'),a=r&&!MediaSource.isTypeSupported('audio/mp4; codecs="mp4a.40.2"; channels="2"; features="INVALID"');c.b.info(`Platform support for channels: ${r}; features: ${a}`)();let n=e.filter((function(e){let n=!1;if(e.audioCodecList&&e.audioGroupId){const o=Ki(e.audioGroupId,t);o&&(n=(function(e,t){let n=Oi.b.isDolbyAtmos(e,t);if(a||r&&!n){!(function(e,t){let r=e+"/"+t;i.has(r)||s.has(r)||(function(e,t){let i,s,r=t.split("/"),a=parseInt(r[0]);r.length>1?(i=`audio/mp4;codecs="${e}";channels="${a}";features="${r[1]}"`,s=`audio/mp4;codecs="${e}";channels="8";features="${r[1]}"`):i=`audio/mp4;codecs="${e}";channels="${a}"`;let n=MediaSource.isTypeSupported(i);return!n&&s&&(n=MediaSource.isTypeSupported(s),c.b.info(`Using mimeCodecAlternate, isSupported: ${n}; mimeCodecAlternate: ${s}`)()),n}(e,t)?i.add(r):s.add(r))})(e,t);let r=e+"/"+t;return s.has(r)}return!!n})(Gi(e.audioCodecList),o))}return!n}));return xi("Richest Audio Codec Selection",e,n),n})(e=(function(e){let t=new Set,i=new Set,s=e.filter(Hi.bind(null,t,i));return xi("Platform Supported Media Codec",e,s),s})(e),t),a=Promise.resolve(e)),a.then(e=>{if(0===e.length||qi(e))throw new r.q(r.g.MEDIA_ERROR,r.d.MANIFEST_INCOMPATIBLE_CODECS_ERROR,void 0,"no level with compatible codecs found in manifest",void 0);if(0===(e=(function(e){const t=e.filter(e=>!e.iframes||!e.width||!e.height||e.width*e.height<=2488320);return xi("1080p iFrame",e,t),t})(e=(function(e,t){let i=e.filter(e=>{const{highestPlayablePeakBitRate:i,highestPlayableAverageBitRate:s,highestPlayableWidth:r,highestPlayableHeight:a,highestPlayableFrameRate:n}=(function(e,t){if(!t)return{highestPlayableAverageBitRate:void 0,highestPlayablePeakBitRate:void 0,highestPlayableWidth:void 0,highestPlayableHeight:void 0,highestPlayableFrameRate:void 0};let i=e.videoCodec,s=e.videoRange,r=t.videoDynamicRangeFormats,a=t.videoCodecs;return (function(e,t,i,s){if(!s&&!i)return{};let r,a,n=i?Wi(i,t):{},o=s?Wi(s,e):{};switch(e){case Ai.SDR:r=n,a=o;break;default:r=o,a=n}let l=Object.assign({},r);return l.highestPlayableAverageBitRate||l.highestPlayablePeakBitRate||(l.highestPlayableAverageBitRate=a.highestPlayableAverageBitRate,l.highestPlayablePeakBitRate=a.highestPlayablePeakBitRate),l.highestPlayableWidth||l.highestPlayableHeight||l.highestPlayableFrameRate||(l.highestPlayableWidth=a.highestPlayableWidth,l.highestPlayableHeight=a.highestPlayableHeight,l.highestPlayableFrameRate=a.highestPlayableFrameRate),l})(function(e,t){let i=Ai.SDR;return"PQ"===e&&Oi.b.isDolby(t)?i=Ai.DolbyVision:"PQ"===e&&Oi.b.isHEVC(t)?i=Ai.HDR10:"HLG"===e&&-1!==t.indexOf("hvc1")&&(i=Ai.HLG),i}(s,i),(function(e){let t=Li.H264;return(Oi.b.isHEVC(e)||Oi.b.isDolby(e))&&(t=Li.HEVC),t})(i),a,r)})(e,t);return ji(e.bandwidth,i)&&ji(e.avgBandwidth,s)&&ji(e.width,r)&&ji(e.height,a)&&ji(e.frameRate,n)});return xi("Highest Playable Platform Caps",e,i),i})(e,i))).length||qi(e))throw new r.q(r.g.MEDIA_ERROR,r.d.MANIFEST_INCOMPATIBLE_CODECS_ERROR,void 0,"no level with compatible codecs found in manifest",void 0);let t=i?i.videoDynamicRangeFormats:void 0;l&&!t&&(t=[{type:Ai.SDR},{type:Ai.HDR},{type:Ai.HDR10},{type:Ai.DolbyVision},{type:Ai.HLG}]);let{hdrLevels:s,sdrLevels:a}=(function(e,t){let i=new Array,s=new Array,r=(function(e){let t=!1,i=!1,s=!1;if(e&&e.length>0)for(let r=0;r<e.length;++r)switch(e[r].type){case Ai.DolbyVision:t=!0;break;case Ai.HDR10:i=!0;break;case Ai.HLG:s=!0}return{doViSupported:t,hdr10Supported:i,hlgSupported:s}})(t),{doViSupported:a,hdr10Supported:n,hlgSupported:o}=r;return c.b.info(`Supported videoDynamicRangeFormats DoVi/HDR10/HLG: ${a}/${n}/${o}`)(),e.forEach(e=>{let t=e.videoRange,r=e.videoCodec;switch(t){case"PQ":r&&(a&&Oi.b.isDolby(r)||n&&Oi.b.isHEVC(r))&&i.push(e);break;case"HLG":r&&o&&-1!==r.indexOf("hvc1")&&i.push(e);break;default:s.push(e)}}),{hdrLevels:i,sdrLevels:s}})(e,t);if(0===s.length&&0===a.length||qi(s)&&qi(a))throw new r.q(r.g.MEDIA_ERROR,r.d.MANIFEST_INCOMPATIBLE_VIDEO_RANGE_ERROR,void 0,"level with compatible VIDEO-RANGE not found in manifest",void 0);return{hdrLevels:s,sdrLevels:a}})}).catch(e=>{throw e instanceof r.q&&(e.fatal=!0,e.response=r.f.IncompatibleAsset),e})}!(function(e){e.HDR10="smpteSt2086",e.DoVi="smpteSt2094-10",e.HDR10Plus="smpteSt2094-40"})(Mi||(Mi={}));const zi=/{\$(.*?)}/g,Qi=/#EXTINF:(\d*(?:\.\d+)?)(?:,(.*))?|(?!#)(\S.+)|#EXT-X-BYTERANGE: *(.+)|#EXT-X-PROGRAM-DATE-TIME:(.+)|#EXT-X-BITRATE:(.+)|#.*/g,Xi=/(?:(?:#(EXTM3U))|(?:#EXT-X-(PLAYLIST-TYPE):(.+))|(?:#EXT-X-(MEDIA-SEQUENCE): *(\d+))|(?:#EXT-X-(TARGETDURATION): *(\d+))|(?:#EXT-X-(KEY):(.+))|(?:#EXT-X-(START):(.+))|(?:#EXT-X-(ENDLIST))|(?:#EXT-X-(DISCONTINUITY-SEQ)UENCE:(\d+))|(?:#EXT-X-(DIS)CONTINUITY))|(?:#EXT-X-(VERSION):(\d+))|(?:#EXT-X-(MAP):(.+))|(?:#EXT-X-(I-FRAMES)-ONLY)|(?:#EXT-X-(DEFINE):(.+))|(?:(#)(.*):(.*))|(?:(#)(.*))(?:.*)\r?\n?/,Ji=/#EXT-X-STREAM-INF:([^\n\r]*)[\r\n]+([^\r\n]+)|#EXT-X-I-FRAME-STREAM-INF:([^\r\n]+)|#EXT-X-DEFINE:([^\n\r]*)/g,Zi=/#EXT-X-MEDIA:(.*)/g,es=/#EXT-X-SESSION-DATA[^:]*:(.*)/g,ts=/(NAME|VALUE)=\"(.*)\",(NAME|VALUE)=\"(.*)\"|(IMPORT)=\"(.*)\"/;let is=function(e,t,i){return d.buildAbsoluteURL(t,e,{alwaysNormalize:!0,inheritQuery:i})},ss=function(e,t,i){if(void 0===e)return-1;let s=e.MediaSelectionGroupOptions,r=s.find((function(e){return e.MediaSelectionOptionsMediaType===t.mediaType&&e.MediaSelectionOptionsName===t.name&&e.MediaSelectionOptionsExtendedLanguageTag===t.lang}));return r||(r={MediaSelectionOptionsMediaType:t.mediaType,MediaSelectionOptionsExtendedLanguageTag:t.lang,MediaSelectionOptionsIsDefault:t.default,MediaSelectionOptionsName:t.name,MediaSelectionOptionsPersistentID:i,MediaSelectionOptionsTaggedMediaCharacteristics:t.characteristics},t.mediaType===pi.SUBTITLE&&(r.MediaSelectionOptionsDisplaysNonForcedSubtitles=t.forced?mi.NO:mi.YES),i++,s.push(r)),t.persistentID=r.MediaSelectionOptionsPersistentID,i},rs=function(e){let t,i=e.split(".");return i.length>2?(t=i.shift()+".",t+=parseInt(i.shift()).toString(16),t+=("000"+parseInt(i.shift()).toString(16)).substr(-4)):t=e,t},as=function(e){let t;try{t=JSON.parse(m.a.base64DecodeToStr(e))}catch(i){c.b.error(`Error ${i} decoding metadata value: '${e}'`)(),t=e}return t},ns=function(e,t){let i,s=!1;return e&&t&&(i=e.replace(zi,(function(e){zi.lastIndex=0;let i=zi.exec(e)[1];if(i&&t.hasOwnProperty(i))return t[i];s=!0}))),{updatedString:i,error:s}};const os=e=>"DATA-ID"in e;var ls=class{constructor(e,t){this.config=e,this.registerProgramDateTime=t,this._masterVariableList={}}destroy(){this._masterVariableList={}}get query(){return this.inheritQuery}set query(e){this.inheritQuery=e}static isValidPlaylist(e){return 0===e.indexOf("#EXTM3U")}static isMediaPlaylist(e){return e.indexOf("#EXTINF:")>0||e.indexOf("#EXT-X-PLAYLIST-TYPE:")>0}_shouldSelectKeyTag(e,t){return"AES-128"===t||"NONE"===t||void 0===this.config||void 0===this.config.keySystemPreference||e===yi.getKeySystemFormat(this.config.keySystemPreference)}_addDefaultClosedCaptionOption(e,t,i){let s={id:0,mediaType:pi.CLOSEDCAPTION,inStreamID:"CC1",groupId:"cc",name:"English-CC",type:"CLOSED-CAPTIONS",default:!1,autoselect:!1,forced:!1,lang:"en",characteristics:["public.accessibility.transcribes-spoken-dialog","public.accessibility.describes-music-and-sound"],persistentID:i,unchangedLevelCount:0};e.push(s),ss(t,s,i)}optOutClosedCaption(e){let t=!1,i=!1;if(e)for(let s=0;s<e.length;++s){let r=e[s];if(r.videoCodec&&(i=!0,!0!==r.iframes&&r.closedcaption&&"none"===r.closedcaption.toLowerCase())){t=!0;break}}return!i||t}parseMasterPlaylistMedia(e,t,i){let s,a,n={MediaSelectionGroupAllowEmptySelection:1,MediaSelectionGroupMediaCharacteristics:["public.audible"],MediaSelectionGroupMediaType:pi.AUDIO,MediaSelectionGroupOptions:[]},o={MediaSelectionGroupAllowEmptySelection:1,MediaSelectionGroupMediaCharacteristics:["public.legible"],MediaSelectionGroupMediaType:pi.SUBTITLE,MediaSelectionGroupOptions:[]},l={videoTracks:[],audioTracks:[],subtitleTracks:[],audioMediaSelectionGroup:n,subtitleMediaSelectionGroup:o},d=0;for(Zi.lastIndex=0;null!=(s=Zi.exec(e));){let e=ns(s[1],this._masterVariableList);if(e.error){a=new r.q(r.g.MEDIA_ERROR,r.d.LEVEL_LOAD_ERROR,!0,"encountered undefined/not imported EXT-X-DEFINE property",r.f.FormatError);break}let c,u,f,g,p=Di.parseTags(e.updatedString),m=pi.UNKNOWN,y=(h=p.CHARACTERISTICS)?h.split(/\s*,\s*/):new Array,v=p["GROUP-ID"],b=p.CHANNELS;switch(p.TYPE){case"VIDEO":m=pi.VIDEO,u=l.videoTracks;break;case"AUDIO":m=pi.AUDIO,u=l.audioTracks,f=n;let e=i.find((function(e){return e.audioGroupId===v}));g=e?e.audioCodecList:[];break;case"SUBTITLES":m=pi.SUBTITLE,u=l.subtitleTracks,f=o;break;case"CLOSED-CAPTIONS":m=pi.CLOSEDCAPTION,c=p["INSTREAM-ID"],u=l.subtitleTracks,f=o}let T={mediaType:m,groupId:v,channels:b,groupCodecList:g,name:p.NAME,type:p.TYPE,default:"YES"===p.DEFAULT,autoselect:"YES"===p.AUTOSELECT,forced:"YES"===p.FORCED,characteristics:y,persistentID:d,id:u?u.length:0,lang:w.shortenLanguageCode(p.LANGUAGE),unchangedLevelCount:0};p.URI&&(T.url=is(p.URI,t,this.inheritQuery)),T.name||(T.name=T.lang,T.mediaType===pi.CLOSEDCAPTION&&(T.name+=" CC")),u&&(T.id=u.length,u.push(T)),d=ss(f,T,d)}var h;return 0!==l.subtitleTracks.length||this.optOutClosedCaption(i)||this._addDefaultClosedCaptionOption(l.subtitleTracks,o,d),{parsedMasterPlaylistMedia:l,playlistParsingError:a}}static parseSessionData(e,t){let i,s=[],r=new Set;for(es.lastIndex=0;null!=(i=es.exec(e));){let e,t=Di.parseTags(i[1]);t.LANGUAGE=w.shortenLanguageCode(t.LANGUAGE),e=t.LANGUAGE?t["DATA-ID"]+"|"+t.LANGUAGE:void 0,os(t)?e&&r.has(e)||("com.apple.hls.other-tags"===t["DATA-ID"]&&(t.VALUE=as(t.VALUE)),s.push(t),e&&r.add(e)):c.b.error(`Error processing DATA-ID ${t["DATA-ID"]} and LANGUAGE ${t.LANGUAGE}`)()}return{itemList:s,baseUrl:t}}parseLevelPlaylist(e,t,i,s,a){let n,o,l,h,u,f,g=0,p=0,m={type:"",version:0,url:i,initSegments:{},fragments:[],live:!0,startSN:0,endSN:0,iframesOnly:!1,targetduration:0,totalduration:0,averagetargetduration:0},y=new R("NONE",i,null,null,null),v=!1,b=0,T=null,S=new C(this.inheritQuery),I=0,_={},D=!0,A=Object(Oi.c)(e)?e:0;for(Qi.lastIndex=0;null!==(n=Qi.exec(t));){const e=n[1];if(e){S.duration=parseFloat(e);const t=(" "+n[2]).slice(1);S.title=t||null,S.tagList.push(t?["INF",e,t]:["INF",e])}else if(n[3]){if(Object(Oi.c)(S.duration)){const e=g++;if(S.type=a,S.start=p+A,S.levelkey=y,v=!1,S.sn=e,S.level=s,S.cc=b,S.iframe=m.iframesOnly,S.baseurl=i,(h=ns((" "+n[3]).slice(1),_)).error){u=new r.q(r.g.MEDIA_ERROR,r.d.LEVEL_LOAD_ERROR,!0,"encountered undefined/not imported EXT-X-DEFINE property",r.f.FormatError);break}if(S.relurl=h.updatedString,S.bitrate=Object(Oi.c)(S.byteRangeEndOffset)?8*(S.byteRangeEndOffset-S.byteRangeStartOffset)/S.duration:I,S.rawProgramDateTime?(this.registerProgramDateTime(S.rawProgramDateTime,S.start),l=null):l&&(S.rawProgramDateTime=l,S.tagList.push(["PROGRAM-DATE-TIME",S.rawProgramDateTime]),this.registerProgramDateTime(S.rawProgramDateTime,S.start),l=null),m.fragments.push(S),T=S,p+=S.duration,D&&!m.initSegments[b])if(m.iframesOnly&&S.byteRangeStartOffset>0){let e=new C(this.inheritQuery);e.url=S.url,e.rawByteRange=Math.min(S.byteRangeStartOffset,1316)+"@0",e.baseurl=i,e.level=s,e.type=a,e.sn="initSegment",e.cc=b,e.decryptdata=y,v=!1,m.initSegments[b]=e,c.b.info(`generated implicit initSegment in cc ${b}`)()}else if(f){let e=Object.assign(new C(this.inheritQuery),f);e.cc=b,c.b.info(`assume initSegment from ${f.cc} in cc ${b}`)(),f=m.initSegments[b]=e}D=!1,S=new C(this.inheritQuery)}}else if(n[4]){if(S.rawByteRange=(" "+n[4]).slice(1),T){const e=T.byteRangeEndOffset;e&&(S.lastByteRangeEndOffset=e)}}else if(n[5])S.rawProgramDateTime=(" "+n[5]).slice(1),S.tagList.push(["PROGRAM-DATE-TIME",S.rawProgramDateTime]);else if(n[6]){let e=parseInt(n[6]);Object(Oi.c)(e)&&(I=1e3*e)}else{for(n=n[0].match(Xi),o=1;o<n.length&&void 0===n[o];o++);let e=ns((" "+n[o+1]).slice(1),_),t=ns((" "+n[o+2]).slice(1),_);if(e.error||t.error){u=new r.q(r.g.MEDIA_ERROR,r.d.LEVEL_LOAD_ERROR,!0,"encountered undefined/not imported EXT-X-DEFINE property",r.f.FormatError);break}const h=e.updatedString,T=t.updatedString;switch(n[o]){case"#":S.tagList.push(T?[h,T]:[h]);break;case"PLAYLIST-TYPE":m.type=h.toUpperCase();break;case"MEDIA-SEQUENCE":0===m.fragments.length?g=m.startSN=parseInt(h):c.b.warn(`Ignore MEDIA-SEQUENCE:${h} tag. Must appear before first fragment.`)();break;case"TARGETDURATION":m.targetduration=parseFloat(h);break;case"VERSION":m.version=parseInt(h);break;case"EXTM3U":break;case"ENDLIST":m.live=!1;break;case"DIS":b++,S.tagList.push(["DIS"]),D=!0;break;case"DISCONTINUITY-SEQ":b=parseInt(h);break;case"KEY":let e=h,t=Di.parseTags(e),I=t.METHOD in E?t.METHOD:void 0,A=t.URI,L=t.IV?t.IV:null,w=t.KEYFORMAT,k=(t.KEYFORMATVERSIONS?t.KEYFORMATVERSIONS:"1").split("/").map(Number).filter(isFinite);if(I)if(!v&&this._shouldSelectKeyTag(w,I)){let e;e=A?d.buildAbsoluteURL(i,A,{alwaysNormalize:!0}):i,"NONE"!==y.method&&(y.expiryPosition=p),y=new R(I,e,L,w,k),A&&(t.IV&&!L&&((u=new r.q(r.g.MEDIA_ERROR,r.d.MANIFEST_PARSING_ERROR,!0,`Invalid IV: ${t.IV}`,r.f.PlaylistErrorInvalidEntry)).url=i),v=!0)}else c.b.warn(`[Keys] Not selecting EXT-X-KEY tag : ${e}, IsKeySystemSelected: ${v}`)();else c.b.warn(`Invalid EXT-X-KEY tag: ${e}`)();break;case"START":let P=h,M=Di.parseTags(P)["TIME-OFFSET"];Object(Oi.c)(M)&&(m.startTimeOffset=M);break;case"I-FRAMES":m.iframesOnly=!0;break;case"MAP":let O=Di.parseTags(h);S.relurl=O.URI,S.rawByteRange=O.BYTERANGE,S.baseurl=i,S.level=s,S.type=a,S.sn="initSegment",S.levelkey=y,v=!1,S.rawProgramDateTime&&(l=S.rawProgramDateTime),S.cc=b,f=m.initSegments[b]=S,S=new C(this.inheritQuery);break;case"DEFINE":let N=ts.exec(h),x="NAME"===N[1]?N[2]:N[4],F="VALUE"===N[1]?N[2]:N[4],B=N[5],U=N[6];if(x||F||"IMPORT"!==B||!this._masterVariableList.hasOwnProperty(U)){if(!x||B||N[1]===N[3]||_.hasOwnProperty(x)){u=new r.q(r.g.MEDIA_ERROR,r.d.MANIFEST_PARSING_ERROR,!0,"IMPORT references variable not in master playlist and/or NAME",r.f.FormatError);break}_[x]=F}else _[U]=this._masterVariableList[U];break;default:c.b.warn(`line parsed but not handled: ${n}`)()}}}return(S=T)&&!S.relurl&&(m.fragments.pop(),p-=S.duration),m.live||(S.isLastFragment=!0),m.live||this.config.gapless?m.fragments.forEach(e=>{e.levelkey&&(e.levelkey.expiryPosition=1/0)}):"NONE"!==y.method&&(y.expiryPosition=p),m.totalduration=p,m.averagetargetduration=p/m.fragments.length,m.endSN=g-1,{levelDetails:m,playlistParsingError:u}}parseMasterPlaylist(e,t){let i,s,a,n,o=[];for(Ji.lastIndex=0;null!=(i=Ji.exec(e));)if(i[4]){let e="NAME"===(i=ts.exec(i[4]))[1]?i[2]:i[4],t="VALUE"===i[1]?i[2]:i[4],s=i[5];if(!e||this._masterVariableList.hasOwnProperty(e)||s||i[1]===i[3]){n=new r.q(r.g.MEDIA_ERROR,r.d.MANIFEST_PARSING_ERROR,!0,"invalid EXT-X-DEFINE tag in manifest",r.f.FormatError);break}this._masterVariableList[e]=t}else{a=ns(i[1]||i[3],this._masterVariableList);let e=Di.parseTags(a.updatedString);if(s=ns(i[2]||e.URI,this._masterVariableList),a.error||s.error){n=new r.q(r.g.MEDIA_ERROR,r.d.MANIFEST_PARSING_ERROR,!0,"manifest encountered undefined/not imported EXT-X-DEFINE property",r.f.FormatError);break}let d=e.BANDWIDTH,h=e["AVERAGE-BANDWIDTH"],u=h||d,f={persistentId:(u||0)+o.length%1e3/1e3,attrs:e,url:is(s.updatedString,t,this.inheritQuery),name:e.NAME,audioGroupId:e.AUDIO,iframes:!!i[3],bandwidth:d,avgBandwidth:h,bitrate:u,videoRange:e["VIDEO-RANGE"]?e["VIDEO-RANGE"]:"SDR",frameRate:e["FRAME-RATE"],unchangedLevelCount:0,hdcpLevel:e["HDCP-LEVEL"],closedcaption:e["CLOSED-CAPTIONS"],levelCodec:e.CODECS},g=e.RESOLUTION;if(g&&(f.width=g.width,f.height=g.height),e.CODECS){f.videoCodecList=new Array,f.audioCodecList=new Array;let t=e.CODECS.split(/[ ,]+/);var l=t.length;for(let e=0;e<l;e++){const i=t[e];switch(i.slice(0,4)){case"avc1":f.videoCodec=rs(i),f.videoCodecList.push(f.videoCodec);break;case"avc3":case"dvav":case"dva1":case"hev1":case"hvc1":case"dvh1":case"dvhe":case"vp09":f.videoCodec=i,f.videoCodecList.push(f.videoCodec);break;case"mp4a":case"ec-3":case"ac-3":f.audioCodec=i,f.audioCodecList.push(f.audioCodec);break;default:c.b.warn(`Unrecognized codec ${i}`)(),f.audioCodec=i,f.audioCodecList.push(f.audioCodec)}}f.audioCodecList.length>1&&(f.audioCodec=Gi(f.audioCodecList)),f.videoCodecList.length>1&&(f.videoCodec=Vi(f.videoCodecList))}o.push(f)}return{levels:o,playlistParsingError:n}}},ds=class{constructor(e){this.hls=e,this.logger=e.logger,this.loaders={}}destroy(){for(let e in this.loaders){let t=this.loaders[e];t&&t.destroy()}this.loaders={},this.hls=void 0}loadManifest(e,t){if(this.hls)return this.playlistParser=new ls(this.hls.config,this.registerProgramDateTime.bind(this)),this.playlistParser.query=Boolean(t.inheritQuery),new Promise((t,i)=>{this.load(e,{type:"manifest",promise:{resolve:t,reject:i}})});console.warn("loadManifest called without hls object")}retryPlaylistRequest(e){let t=e.loader;const i=new Promise((i,s)=>{t.context.promise={resolve:i,reject:s},e.retrying=t.scheduleRetry()});return e.retrying?i:void 0}isLoadingLevel(e){return this.loaders.level&&this.loaders.level.context&&this.loaders.level.context.level===e}loadLevel(e,t){return new Promise((i,s)=>{this.load(e,{type:"level",level:t,promise:{resolve:i,reject:s}})})}abort(e){let t=this.loaders[e];t&&(t.abort(),this.loaders[e]=void 0)}isLoadingAudioTrack(e){return this.loaders.audioTrack&&this.loaders.audioTrack.context&&this.loaders.audioTrack.context.id===e}loadAudioTrack(e,t){return new Promise((i,s)=>this.load(e,{type:"audioTrack",id:t,promise:{resolve:i,reject:s}}))}isLoadingSubtitleTrack(e){return this.loaders.subtitleTrack&&this.loaders.subtitleTrack.context&&this.loaders.subtitleTrack.context.id===e}loadSubtitleTrack(e,t){return new Promise((i,s)=>{this.load(e,{type:"subtitleTrack",id:t,promise:{resolve:i,reject:s}})})}load(e,t){let i=this.loaders[t.type];if(i){let s=i.context;if(s&&s.url===e&&s.level===t.level)return;this.logger.warn(`abort previous loader for type:${t.type}`)(),i.abort()}let r,a,n=this.hls.config;switch(t.type){case"manifest":r=p.isCustomUrl(e)?n.manifestLoadPolicy.customURL:n.manifestLoadPolicy.default;break;case"level":case"audioTrack":case"subtitleTrack":r=p.isCustomUrl(e)?n.playlistLoadPolicy.customURL:n.playlistLoadPolicy.default,this.logger.info(`[QE Critical] loading playlist for ${t.type} ${t.level||t.id}`)();break;default:return void this.logger.warn(`Load for unexpected type ${t.type}`)()}if(i=this.loaders[t.type]=t.loader=p.isCustomUrl(e)?new p(this.hls):void 0!==n.pLoader?new n.pLoader(n):new n.loader(n),t.sessionID=n.useHTTPPlaybackSessionId?this.hls.sessionID:void 0,t.url=e,t.responseType="",a={onSuccess:this.loadsuccess.bind(this),onError:this.loaderror.bind(this),onTimeout:this.loadtimeout.bind(this),onProgress:this.loadprogress.bind(this)},this.hls&&this.hls.trigger){let e;switch(t.type){case"manifest":e={event:s.b.MANIFEST_LOADING,payload:{url:t.url}};break;case"level":e={event:s.b.LEVEL_LOADING,payload:{url:t.url,level:t.level}};break;case"audioTrack":e={event:s.b.AUDIO_TRACK_LOADING,payload:{url:t.url,id:t.id}};break;case"subtitleTrack":e={event:s.b.SUBTITLE_TRACK_LOADING,payload:{url:t.url,id:t.id}}}e&&this.hls.trigger(e.event,e.payload)}i.load(t,r,a)}get parsedSessionData(){return this.sessionData}registerProgramDateTime(e,t){this.hls.registerProgramDateTime&&this.hls.registerProgramDateTime(e,t)}loadsuccess(e,t,i){var a=e.data,n=e.url,o=i.type,l=i.level,d=this.hls,h=this.playlistParser;if(this.logger.info(`[QE Critical] [Playlist]loadsuccess url/type/level ${this.hls.redactUrl(n)}, ${o}, ${l}`)(),this.loaders[o]=void 0,void 0!==n&&0!==n.indexOf("data:")||(n=i.url),t.tload=performance.now(),ls.isValidPlaylist(a))if(ls.isMediaPlaylist(a)){let e="audioTrack"!==o&&"subtitleTrack"!==o?isNaN(l)?0:l:isNaN(i.id)?0:i.id,c=isNaN(d.loadingItem.startTime)?0:d.loadingItem.startTime;this.logger.info(`shift playlist by ${c}`)();let u="audioTrack"===o?"audio":"subtitleTrack"===o?"subtitle":"main",f=h.parseLevelPlaylist(c,a,n,e,u),g=f.levelDetails,p=f.playlistParsingError;if(p)return void d.trigger(s.b.INTERNAL_ERROR,p);if(g.tload=t.tload,g.targetduration)switch(g.trequest=t.trequest,d.loadingItem.totalduration=g.totalduration,o){case"manifest":{g.isInitialMediaPlaylist=!0,d.updatePlaylistAttributes(g);let e={levels:[{persistentId:0,url:n,details:g,iframes:g.iframesOnly,bandwidth:void 0,bitrate:void 0,name:void 0,unchangedLevelCount:0,levelCodec:void 0}],audioTracks:[],url:n,stats:t,isMediaPlaylist:!0};i.promise.resolve(e);break}case"level":{t.tparsed=performance.now();let{playlistType:s}=d.updatePlaylistAttributes(g);i.promise.resolve({details:g,level:l||0,id:e||0,stats:t,playlistType:s});break}case"audioTrack":case"subtitleTrack":t.tparsed=performance.now(),i.promise.resolve({details:g,id:e,stats:t})}else{let e=new r.q(r.g.MEDIA_ERROR,r.d.MANIFEST_PARSING_ERROR,!0,"invalid targetduration",r.f.PlaylistErrorBadTargetDuration);e.url=n,d.trigger(s.b.INTERNAL_ERROR,e)}}else{let e=h.parseMasterPlaylist(a,n),o=e.levels,l=e.playlistParsingError;if(l&&d.trigger(s.b.INTERNAL_ERROR,l),this.sessionData=ls.parseSessionData(a,n),d.baseurl=n,o.length){let e=h.parseMasterPlaylistMedia(a,n,o),r=e.parsedMasterPlaylistMedia,l=e.playlistParsingError;l&&d.trigger(s.b.INTERNAL_ERROR,l);let c=r.audioTracks,u=r.subtitleTracks,f=r.audioMediaSelectionGroup,g=r.subtitleMediaSelectionGroup,p=!1;if(c.length){let e=!1;c.forEach(t=>{t.url||(e=!0)}),!1===e&&o[0].audioCodec&&!o[0].audioGroupId&&(this.logger.info("audio codec signaled in quality level, but no embedded audio track signaled, create one")(),c.unshift({type:"main",name:"main"}))}i.promise.resolve({levels:o,audioTracks:c,subtitleTracks:u,url:n,stats:t,audioMediaSelectionGroup:f,subtitleMediaSelectionGroup:g,isMediaPlaylist:p})}else(l=new r.q(r.g.MEDIA_ERROR,r.d.MANIFEST_PARSING_ERROR,!0,"no level found in manifest",r.f.PlaylistErrorInvalidEntry)).url=n,d.trigger(s.b.INTERNAL_ERROR,l)}else{let e=new r.q(r.g.NETWORK_ERROR,r.d.MANIFEST_PARSING_ERROR,!0,"no EXTM3U delimiter",r.f.PlaylistErrorMissingEXTM3U);e.url=n,d.trigger(s.b.INTERNAL_ERROR,e)}}loaderror(e,t){var i,s,a=t.loader;switch(t.type){case"manifest":i=r.d.MANIFEST_LOAD_ERROR,s=!1;break;case"level":i=r.d.LEVEL_LOAD_ERROR,s=!1;break;case"audioTrack":i=r.d.AUDIO_TRACK_LOAD_ERROR,s=!1;break;case"subtitleTrack":i=r.d.SUBTITLE_TRACK_LOAD_ERROR,s=!1}a&&(a.abort(),this.loaders[t.type]=void 0);let n=new r.p(r.g.NETWORK_ERROR,i,s,"Playlist load error",e,t.url,a,t);t.promise.reject(n)}loadtimeout(e,t){var i,s,a=t.loader,n=r.f.PlaylistNotReceived;switch(t.type){case"manifest":i=r.d.MANIFEST_LOAD_TIMEOUT,s=!1;break;case"level":i=r.d.LEVEL_LOAD_TIMEOUT,s=!1;break;case"audioTrack":i=r.d.AUDIO_TRACK_LOAD_TIMEOUT,s=!1;break;case"subtitleTrack":i=r.d.SUBTITLE_TRACK_LOAD_TIMEOUT,s=!1}a&&(a.abort(),this.loaders[t.type]=void 0);let o=new r.p(r.g.NETWORK_ERROR,i,s,"Playlist load timeout",n,t.url,a,t);t.promise.reject(o)}loadprogress(e,t,i){var a=t.loader;if(a&&a.loader&&200===a.loader.status&&(""===a.loader.responseType||"text"===a.loader.responseType)&&i&&i.length>10)if(ls.isValidPlaylist(i))this.logger.info("deregister for further progress updates")(),a.callbacks.onProgress=null;else{this.logger.error("[Playlist] response doesn't have #EXTM3U tag")(),a.abort(),this.loaders[t.type]=void 0;let e=new r.q(r.g.NETWORK_ERROR,r.d.MANIFEST_PARSING_ERROR,!0,"response doesnt have #EXTM3U tag",r.f.PlaylistErrorMissingEXTM3U);e.url=t.url,this.hls.trigger(s.b.INTERNAL_ERROR,e)}}},hs=i(12);class cs{constructor(e,t){this.hls=e,this.id=t,this.uriToDecryptingFragments={},this.logger=e.logger,this._onWorkerMessage=this._onWorkerMessage.bind(this),this._ensureHandlerFunc()}_setupInlineHandler(e){return this.observer=new hs.EventEmitter,this.observer.trigger=(e,t)=>{this.observer.emit(e,e,t)},this.observer.off=(e,t)=>this.observer.removeListener(e,t),this.decryptor=new e.SegmentDecryptorInline(this.observer,this.hls.config),e=>{this.decryptor.decrypt(e.data,e.frag.decryptdata,t=>this._onDecryptComplete(e,t))}}_setupWorkerHandler(e){let t;try{(t=e.createDecryptorWorker()).addEventListener("message",this._onWorkerMessage),t.onerror=e=>{let t=new r.h(r.g.OTHER_ERROR,r.d.INTERNAL_EXCEPTION,!0,e.message+" ("+e.filename+":"+e.lineno+")");t.event="decryptorWorker",t.err={message:e.message+" ("+e.filename+":"+e.lineno+")"},this.hls.trigger(s.b.INTERNAL_ERROR,t)},t.postMessage({cmd:"init",id:this.id,config:JSON.stringify(this.hls.config)}),this.worker=t}catch(e){throw t&&URL.revokeObjectURL(t.objectURL),e}return e=>{const i=e.frag.url;if(this.uriToDecryptingFragments[i])return;this.uriToDecryptingFragments[i]=e;const s=e.data,{decryptdata:r}=e.frag;t.postMessage({cmd:"segment-decrypt",fragPayload:s,decryptdata:r,fragObjId:i},[s])}}_genHandlerFunc(){return Promise.resolve().then(i.bind(null,28)).then(e=>{if(this.hls.config.enableWorker&&"undefined"!=typeof Worker)try{return this._setupWorkerHandler(e)}catch(e){this.logger.error("error while initializing SegmentDecryptorWorker, fallback on DecryptorInline")()}return this._setupInlineHandler(e)})}_ensureHandlerFunc(){return this.handlerPromise||(this.handlerPromise=this._genHandlerFunc()),this.handlerPromise}destroy(){return this.handlerPromise?this.handlerPromise.then(()=>this._destroy()):(this._destroy(),Promise.resolve())}_destroy(){this.handlerPromise=null;const{worker:e,decryptor:t,observer:i}=this;e&&(e.removeEventListener("message",this._onWorkerMessage),e.terminate(),this.worker=null),t&&(t.destroy(),this.decryptor=null),i&&(i.removeAllListeners(),this.observer=null)}decrypt(e,t,i,s){const{decryptdata:r}=t,a={frag:t,data:e,stats:i,onComplete:s};return this._ensureHandlerFunc().then(e=>{r.key?e(a):this.logger.error("Decrypt called on fragment without valid key")()})}_onDecryptComplete(e,t){e.onComplete&&e.onComplete({decryptedData:t,frag:e.frag,stats:e.stats,id:this.id})}_onWorkerMessage({data:e}){switch(e.event){case"init":URL.revokeObjectURL(this.worker.objectURL);break;case"segment-decrypted":if(!cs.isError(e)){const t=this.uriToDecryptingFragments[e.fragObjId];t&&t.onComplete&&(this._onDecryptComplete(t,e.data),delete this.uriToDecryptingFragments[e.fragObjId])}break;case s.b.ERROR:if(cs.isError(e)){let t=e.data;if(t&&t.details===r.d.FRAG_DECRYPT_ERROR){let i=new r.i(t.type,t.details,t.fatal,t.reason);this.hls.trigger(e.event,i)}}}}static isError(e){return e.data&&"details"in e.data}}var us=class{constructor(e){this.hls=e,this.destroy$=new it,this.logger=e.logger,this.loaders={},this.serverInfoReported=!1}destroy(){this.destroy$.next();let e=this.loaders;for(let t in e){let i=e[t];i&&i.destroy()}this.loaders={}}loadFragment(e){return new Promise((t,i)=>{let r,a,n,o=e.type,l=this.loaders[o],d=this.hls.config;e.loaded=0,l&&(this.logger.warn(`abort previous fragment loader for type:${o}`)(),l.abort()),l=this.loaders[o]=e.loader=p.isCustomUrl(e.url)?new p(this.hls):void 0!==d.fLoader?new d.fLoader(d):new d.loader(d),r={url:e.url,frag:e,responseType:"arraybuffer",progressData:!1,promise:{resolve:t,reject:i},type:o,sessionID:d.useHTTPPlaybackSessionId?this.hls.sessionID:void 0,collectServerInstanceInfo:this.serverInfoReported||"main"!==e.type||"number"!=typeof e.sn?void 0:d.fragLoadPolicy.default.reportHTTPResponseHeaders};let h=e.byteRangeStartOffset,c=e.byteRangeEndOffset;isNaN(h)||isNaN(c)||(r.rangeStart=h,e.byteRange&&e.decryptdata&&"AES-128"===e.decryptdata.method&&("initSegment"===e.sn?c+=(c-h)%16?16-(c-h)%16:16:e.iframe&&(c+=(c-h)%16?16-(c-h)%16:16,h=h>=16?h-16:h,r.rangeStart=h,r.iframe=!0)),r.rangeEnd=c),a=p.isCustomUrl(e.url)?d.fragLoadPolicy.customURL:d.fragLoadPolicy.default,n={onSuccess:this.loadsuccess.bind(this),onError:this.loaderror.bind(this),onTimeout:this.loadtimeout.bind(this),onProgress:this.loadprogress.bind(this)},this.hls.trigger(s.b.FRAG_LOADING,{frag:e}),l.load(r,a,n)})}loadsuccess(e,t,i){let s=e.data,r=i.frag;if(!isNaN(e.contentLen)&&e.contentLen!==e.len){let t=`fragment is shorter than expected. content len ${e.contentLen} vs actual len ${e.len}`;return this.logger.error(t)(),void this.loaderror({code:409,text:t},i)}i.serverInstanceInfo&&(this.serverInfoReported=!0),r.loader=void 0,r.loadSuccess=!0,this.loaders[r.type]=void 0,r.decryptdata&&"AES-128"===r.decryptdata.method?(this.segmentDecryptor||(this.segmentDecryptor=new cs(this.hls,"main")),i.iframe&&i.rangeStart&&(r.decryptdata.iv=new Uint8Array(s.slice(0,16)),s=s.slice(16)),this.hls.keyLoader.getKeyFromDecryptData(r.decryptdata,void 0).pipe(ke(e=>{r.decryptdata.key=e.key,this.segmentDecryptor.decrypt(s,r,t,e=>{i.promise.resolve({payload:new Uint8Array(e.decryptedData),frag:e.frag,stats:e.stats})})}),Qe(this.destroy$)).subscribe()):i.promise.resolve({payload:s,frag:r,stats:t,serverInfo:i.serverInstanceInfo})}loaderror(e,t){let i=this.loaders[t.type];i&&i.abort();let s=new r.l(r.g.NETWORK_ERROR,r.d.FRAG_LOAD_ERROR,!1,"Frag load error",e,i,t.frag);t.promise.reject(s)}loadtimeout(e,t){let i=this.loaders[t.type];i&&i.abort();let s=new r.l(r.g.NETWORK_ERROR,r.d.FRAG_LOAD_TIMEOUT,!1,"Frag load timeout",r.f.NoResponseFromMediaRequest,i,t.frag);t.promise.reject(s)}loadprogress(e,t,i){let r=t.frag;r.loaded=e.loaded,this.hls.trigger(s.b.FRAG_LOAD_PROGRESS,{frag:r,stats:e})}};const fs=12e4;function gs(e){return e&&"id"in e}function ps(e){return e&&"bitrate"in e}class ms{constructor(e,t,i){this.observer=e,this.mediaType=t,this.variantList=i||[]}destroy(){this.validVariantListInternal=void 0,this.variantListInternal=[],this.idToVariantListMap.clear(),this.idToPenaltyBoxExpiry.clear(),this.whiteListFilters=[],this.blackListFilters=[],void 0!==this.penaltyBoxTimer&&(clearTimeout(this.penaltyBoxTimer),this.penaltyBoxTimer=void 0)}reset(){this.validVariantListInternal=void 0,this.variantListInternal=[],this.idToVariantListMap=new Map,this.idToPenaltyBoxExpiry=new Map,this.whiteListFilters=[],this.blackListFilters=[[Number.POSITIVE_INFINITY,e=>this.isRemovedOrInPenaltyBox(e)]],this.stopTimers()}stopTimers(){void 0!==this.penaltyBoxTimer&&(clearTimeout(this.penaltyBoxTimer),this.penaltyBoxTimer=void 0)}startTimers(){this.penaltyBoxTimer||this.setOrResetPenaltyBoxTimer(this.getMinExpiry())}getMediaType(){return this.mediaType}get variantList(){return this.variantListInternal}set variantList(e){this.reset(),this.variantListInternal=ms.sortVariants(Array.from(e)),this.variantListInternal.forEach(e=>{this.idToVariantListMap.set(ms.getUniqueId(e),e)})}get validVariantList(){return this.validVariantListInternal||(this.validVariantListInternal=this.variantListInternal.filter(e=>this.isValidVariant(e))),this.validVariantListInternal}markValidListDirty(){this.validVariantListInternal=void 0}getVariantInfo(e){return this.idToVariantListMap.get(e)}getVariantInfoIfValid(e){let t=this.idToVariantListMap.get(e);if(void 0!==t&&this.isValidVariant(t))return t}getVariantListPosition(e){let t=this.validVariantList.findIndex(t=>ms.getUniqueId(t)===e);return t>=0?t:void 0}isRemovedOrInPenaltyBox(e){let t=performance.now(),i=ms.getUniqueId(e),s=this.idToPenaltyBoxExpiry.get(i);return void 0!==s&&t<s}isValidVariant(e){let t=performance.now();return this.blackListFilters.every(i=>{let s=t<i[0],r=i[1];return!s||!r(e)})&&this.whiteListFilters.every(t=>t(e))}addWhitelistFilter(e){this.whiteListFilters.push(e),this.markValidListDirty()}addBlacklistFilter(e,t){this.blackListFilters.push([e,t]),this.markValidListDirty(),void 0===this.penaltyBoxTimer&&this.setOrResetPenaltyBoxTimer(e)}moveAllMatchingHostsToPenaltyBoxOrRemovePermanently(e,t){let i=this.idToVariantListMap.get(e);if(void 0===i||void 0===i.url)return;let s=d.getHostName(i.url),r=performance.now()+fs,a=t?Number.POSITIVE_INFINITY:r;this.addBlacklistFilter(a,t=>{let i=t.url;return ms.getUniqueId(t)!==e&&void 0!==i&&d.getHostName(i)===s})}addLevelToPenaltyBoxInternal(e,t){this.idToPenaltyBoxExpiry.has(e)&&c.b.warn(`add a variant ${e} to penalty box, current expiry: ${this.idToPenaltyBoxExpiry.get(e)}, now: ${performance.now()} new expiry: ${t}`)(),this.idToPenaltyBoxExpiry.set(e,t),this.markValidListDirty(),c.b.info(`variant ${e} in penalty box until ${t}`)(),void 0===this.penaltyBoxTimer&&this.setOrResetPenaltyBoxTimer(t)}addLevelToPenaltyBox(e){if(c.b.info(`addLevelToPenaltyBox(${e}) containsVariant=${this.idToVariantListMap.has(e)}`)(),!this.idToVariantListMap.has(e))return;let t=performance.now()+fs;this.addLevelToPenaltyBoxInternal(e,t),this.triggerLevelChangeEvent(!1)}removeLevelPermanentlyInternal(e){this.idToPenaltyBoxExpiry.set(e,Number.POSITIVE_INFINITY),this.markValidListDirty(),c.b.info(`variant ${e} removed permanently`)()}removeLevelPermanently(e){this.idToVariantListMap.has(e)&&(this.removeLevelPermanentlyInternal(e),this.triggerLevelChangeEvent(!1))}removeAllMatchingHDCPLevelsPermanently(e){this.removeLevelPermanently(e)}getMinExpiry(){let e=Number.POSITIVE_INFINITY;return performance.now(),this.blackListFilters.forEach(t=>{let i=t[0];e=Math.min(e,i)}),this.idToPenaltyBoxExpiry.forEach(t=>{e=Math.min(e,t)}),e}handlePenaltyBoxTimer(){let e=performance.now(),t=!1;this.blackListFilters=this.blackListFilters.filter(i=>{let s=i[0],r=e<s;return t=t||!r,r}),this.idToPenaltyBoxExpiry.forEach((i,s,r)=>{e>=i&&(r.delete(s),c.b.info(`remove variant ${s} from penalty box`)(),t=!0)}),this.markValidListDirty(),this.setOrResetPenaltyBoxTimer(this.getMinExpiry()),t&&this.triggerLevelChangeEvent(!1)}setOrResetPenaltyBoxTimer(e){this.penaltyBoxTimer&&(clearTimeout(this.penaltyBoxTimer),this.penaltyBoxTimer=void 0);let t=performance.now();isFinite(e)&&(this.penaltyBoxTimer=setTimeout(this.handlePenaltyBoxTimer.bind(this),Math.max(0,Math.ceil(e-t))))}triggerLevelChangeEvent(e){if(this.observer&&this.mediaType===pi.AUDIO){let e={audioTracks:this.validVariantList};this.observer.trigger(s.b.AUDIO_TRACKS_UPDATED,e)}}static sortVariants(e){return e.sort((function(e,t){return ps(e)&&ps(t)?e.bitrate-t.bitrate:gs(e)&&gs(t)?e.id-t.id:1})),e}static getUniqueId(e){let t=NaN;return ps(e)?t=e.persistentId:gs(e)&&(t=e.id),t}}var ys=ms;class vs{constructor(e,t,i){this.levelManager=e,this.loadFn=t,this.abortFn=i}destroy(){this.stop()}loadLevel(e,t=!0,i=0){let s=this.levelManager.getVariantInfoIfValid(e);if(!s)return void c.b.warn(`level ${e} invalid`)();let r=s.details;(!r||r.live&&vs.needToRefreshLevel(r))&&(t&&(this._levelLoadTimer=null),0===i?this._loadLevelInternal(s):this._levelLoadTimer=setTimeout(this._loadLevelInternal.bind(this,s),i))}_loadLevelInternal(e){e.details&&(e.details.trequest=performance.now()),this.loadFn(e)}stop(){this._levelLoadTimer=null,this.abortFn()}static getLiveRefreshInterval(e){return 1e3*(e.averagetargetduration?e.averagetargetduration:e.targetduration)}static needToRefreshLevel(e){let t=vs.getLiveRefreshInterval(e),i=performance.now()-e.trequest;return e.live&&i>=t}handleLevelLoad(e,t,i,s=0){let a=this.levelManager.getVariantInfoIfValid(e),n=a.details,o={success:!0,error:null};if(t.live){let l=vs.getLiveRefreshInterval(t);!t.isInitialMediaPlaylist&&n&&t.endSN===n.endSN?(l/=2,l=Math.max(l,5e3),a.unchangedLevelCount++,c.b.info(`level ${e} unchangedLevelCount ${a.unchangedLevelCount}`)()):a.unchangedLevelCount=0,a.unchangedLevelCount>=2?(o.success=!1,o.error=r.f.LivePlaylistUpdateError,this._levelLoadTimer=null):(l-=performance.now()-i.trequest,l+=s,c.b.info(`reloadInterval: ${l}`)(),l=Math.max(1e3,Math.round(l)),c.b.info(`level ${e} reload in ${l} ms`)(),this._levelLoadTimer=setTimeout(this.loadLevel.bind(this,e),l))}else this._levelLoadTimer=null;return o}set _levelLoadTimer(e){this._levelLoadTimerInternal&&clearTimeout(this._levelLoadTimerInternal),this._levelLoadTimerInternal=e}}var bs=vs,Ts=class extends P{constructor(e,...t){super(e,...t),this.hls=e}_handleMediaPlaylistNetworkError(e,t){let i,s,r,a=e.response,n=a?a.code:a,o=Object(Oi.c)(e.context.id)?e.context.id:e.context.level;return i=this.hls.networkErrorHandler.getActionForPlaylistNetworkError(e,this,t),this.logger.warn(`variant ${o} encountered error ${n} errorAction ${i.errorAction} prefetch=${t}`)(),i.errorAction===Ds.RetryRequest?(r=this._attemptRetry(e,t))||(e.fatal=!0):s=this.hls.networkErrorHandler.handleNetworkError(i.errorAction,i.errorActionFlags,e,o,void 0,this.variantManager,this),e.fatal&&!this.hls.bufferEndPromiseWrapper&&this.hls.fatalErrorRequiresAction(e)&&this.hls.bufferDryPromise.then(()=>{this.hls.upgradeInternalErrorIfNecessary(e)}).catch(e=>{this.logger.error(`get an error in buffer dry promise ${e.message}`)()}),r}};function Ss(e){return"PQ"===e.videoRange||"HLG"===e.videoRange}var Is=class extends ys{constructor(e,t,i){super(e,pi.VIDEO),this.variantList=t,this.hdrMode=i}reset(){super.reset(),this.compatibleVariants=new Set,this.addWhitelistFilter(e=>Ss(e)===this.hdrMode),this.addWhitelistFilter(e=>0===this.compatibleVariants.size||this.compatibleVariants.has(ys.getUniqueId(e)))}set variantList(e){this.hasHDRLevels=e.some(e=>Ss(e)),this.hasIframeLevels=e.some(e=>e.iframes),super.variantList=e,this.validCodecList=new Set;for(let t=0;t<e.length;t++){let i=e[t].videoCodecList;if(i)for(let e=0;e<i.length;e++)this.validCodecList.add(i[e])}}get variantList(){return super.variantList}removeAllMatchingHDCPLevelsPermanently(e){const t=this.idToVariantListMap.get(e);if(!t)return;let i=t.hdcpLevel,s=Number.POSITIVE_INFINITY;this.addBlacklistFilter(s,t=>{let s=ys.getUniqueId(t),r=t.hdcpLevel;return void 0===i&&s===e||void 0!==r&&r===i}),this.triggerLevelChangeEvent(!1)}set hdrMode(e){this.hdrModeInternal!==e&&(this.clearStartingVariant(),this.hdrModeInternal=e,this.markValidListDirty())}get hdrMode(){return this.hdrModeInternal}getHighestCodecByFamily(e){let t=e.split(".")[0],i=new Set([...this.validCodecList].filter(e=>e.includes(t)));switch(t){case"avc1":case"avc3":i.forEach(t=>{let i=e.split("."),s=t.split(".");i[0]===s[0]&&s[1]>i[1]&&(e=t)});break;case"vp09":i.forEach(t=>{t>e&&(e=t)}),e=e.substring(0,13);break;case"hvc1":case"hev1":i.forEach(t=>{let i=e.split("."),s="H"===i[3].substring(0,1)?1:0,r=i[3].substring(1),a=t.split("."),n="H"===a[3].substring(0,1)?1:0,o=a[3].substring(1);i[0]===a[0]&&(a[1]>i[1]||a[2]>i[2]||n>s||o>r)&&(e=t)});break;case"dvhe":case"dvh1":i.forEach(t=>{let i=e.split("."),s=t.split(".");i[0]===s[0]&&(s[1]>i[1]||s[2]>i[2])&&(e=t)})}return e}clearStartingVariant(){c.b.info("setting startingId undefined")(),this.startingVariant=void 0,this.compatibleVariants=new Set,this.compatibleAudioGroups=new Set}set startingId(e){let t=this.getVariantInfoIfValid(e);if(!t)return void c.b.warn(`Invalid starting variant selected ${e}`)();let{levels:i,audioGroups:s}=(function(e,t){let i=new Set;return{levels:e.filter((function(e){let s=(function(e,t){let i=!0;e.videoCodec&&t.videoCodec&&(i=Oi.b.isCompatibleVideoCodec(e.videoCodec,t.videoCodec));let s=!1;e.videoRange&&t.videoRange?s=e.videoRange===t.videoRange:e.videoRange||t.videoRange||(s=!0);let r=!0;return e.audioCodec&&t.audioCodec&&(r=Oi.b.isCompatibleAudioCodec(e.audioCodec,t.audioCodec)),r&&i&&s})(t,e);if(s){let t=e.audioGroupId;t&&i.add(t)}return s})),audioGroups:i}})(this.variantList,t);this.startingVariant=t,this.compatibleVariants=new Set(i.map(ys.getUniqueId)),this.compatibleAudioGroups=s,this.markValidListDirty()}get startingId(){return this.startingVariant?ys.getUniqueId(this.startingVariant):NaN}triggerLevelChangeEvent(e){if(!this.observer)return;let t={requiresReset:e,levels:this.validVariantList};this.observer.trigger(s.b.LEVELS_CHANGED,t)}};const Es={minValidBitrate:2e6,maxValidBitrate:5e6,maxPreferredBitrate:3e6,minValidHeight:480,maxValidHeight:720};function _s(e){return JSON.stringify(e,["persistentId","bitrate","bandwidth","avg-bandwidth","width","height","videoCodec","audioCodec","videoRange","iframes","frameRate"])}class Rs extends Ts{constructor(e,t){super(e,s.b.LEVEL_PTS_UPDATED,s.b.LEVEL_UPDATED,s.b.PREFERRED_HOST_CHANGED),this.playlistLoader=t,this._manualLevel=-1,this._loadediframeLevelIds=[],this._lastPreloadIFrameLevelId=void 0,this.dynamicRangeListener=this.onDynamicRangeQueryChange.bind(this)}destroy(){this.reset(),this.stopDynamicRangeQuery(),this._manualLevel=-1,this.levelLoader&&this.levelLoader.destroy(),this.variantManager&&this.variantManager.destroy(),super.destroy()}reset(){this.stopLoad(),this._loadediframeLevelIds=[],this._lastPreloadIFrameLevelId=null}resetLoadSource(){this._levelInfo=void 0}cleanupLevels(){let e=this.validLevels;this.levelRetryCount=0,e&&e.forEach(e=>{const t=e.details;t&&t.live&&(e.unchangedLevelCount=0)})}startLoad(){this.cleanupLevels()}stopLoad(){this.levelLoader&&this.levelLoader.stop(),this.cleanupLevels()}isSameLevel(e,t){return void 0===e==(void 0===t)&&e.persistentId===t.persistentId}get displaySupportsHdr(){return this.startDynamicRangeQuery(),!this.dynamicRangeQuery||this.dynamicRangeQuery.matches}startDynamicRangeQuery(){if(!this.dynamicRangeQuery&&"function"==typeof matchMedia){let e=matchMedia("(dynamic-range: high)"),t=matchMedia("bad query");e.media!==t.media&&(this.dynamicRangeQuery=e,this.dynamicRangeQuery.addListener(this.dynamicRangeListener))}}stopDynamicRangeQuery(){this.dynamicRangeQuery&&(this.dynamicRangeQuery.removeListener(this.dynamicRangeListener),this.dynamicRangeQuery=null)}onDynamicRangeQueryChange(){this.logger.info(`HDR display support changed = ${this.displaySupportsHdr}`)(),this.setHDRMode(this.displaySupportsHdr,!0)}setHDRMode(e,t){if(e!==this.variantManager.hdrMode)if(!e||this.variantManager.hasHDRLevels)try{if(this.stopLoad(),this.startLoad(),this.variantManager.hdrMode=e,this.chooseFirstLevel(),t){let e={requiresReset:!0,levels:this.validLevels};this.hls.trigger(s.b.LEVELS_CHANGED,e)}}catch(t){let i=new r.q(r.g.MEDIA_ERROR,r.d.MANIFEST_INCOMPATIBLE_VIDEO_RANGE_ERROR,!0,`No levels matching display hdrMode=${e}`,r.f.IncompatibleAsset);this.hls.trigger(s.b.INTERNAL_ERROR,i)}else this.logger.info("No hdr levels, not switching to hdr")();else this.logger.info("No change in hdr mode")()}setFirstLevelOnManager(e){let t=this.hls.config.targetStartupMs-(performance.now()-this.hls.tloadsource);this.hls.hasPlaybackEverStarted&&t<0&&(t=this.hls.config.targetStartupMs);let i=(function(e,t,i,s){if(!e||0===e.length||qi(e))return void c.b.warn("no non-iframe level found in levels")();let r=(function(e,t,i,s){let r,a;for(let l=0;l<e.length;++l){var n,o=e[l];o.iframes||(n=$i(o,t,i,s),(!r||n.isGreaterThan(a)||n.isEqualTo(a)&&o.bitrate>r.bitrate)&&(r=o,a=n))}return r})(e,t,i,s);if(r)return r;c.b.warn("no valid first level found in levels")()})(e.validVariantList,Es,this.hls.config.enableAdaptiveStartup?this.hls.bandwidthHistoryController.getEstimate():void 0,this.hls.config.enableAdaptiveStartup?{targetDuration:this.hls.config.defaultTargetDuration,targetStartupMs:t,metricsOverride:this.hls.config.adaptiveStartupMetricsOverride}:void 0);if(!i)throw Error("No first level found");return e.startingId=i.persistentId,i}chooseFirstLevel(){if(!this.variantManager)throw Error("variantManager undefined");let e=this.setFirstLevelOnManager(this.variantManager);this.hls.preferredHostName=d.getHostName(e.url),this.hls.nextAutoLevel=this.variantManager.startingId,this.logger.info(`First level ${e.persistentId}: ${_s(e)}`)();let t=this.variantManager.validVariantList.filter(e=>d.getHostName(e.url)===this.hls.preferredHostName).length,i=this.variantManager.validVariantList.length-t;this.logger.info(`Primary/Backup levels: ${t}/${i}`)()}parseManifestLoadedData(e){const t=this.hls,i=/chrome|firefox/.test(navigator.userAgent.toLowerCase());let s=[],r=e.audioTracks,{audioMediaSelectionGroup:a,subtitleMediaSelectionGroup:n}=e,o=!1,l=!1,d=!1,h=t.platformInfo;for(let t=0;t<e.levels.length;++t){let r=e.levels[t];o=o||Boolean(r.videoCodec),i&&r.audioCodec&&-1!==r.audioCodec.indexOf("mp4a.40.34")&&(r.audioCodec=void 0),l=l||Boolean(r.audioCodec)||Boolean(r.audioGroupId),d=d||r.iframes,s.push(r)}return o&&l&&(s=s.filter(({videoCodec:e})=>Boolean(e))),this.logger.info(`playlist has ${s.length} levels, ${_s(s)}`)(),Yi(s,r,h,this.hls.config).then(t=>{let{hdrLevels:i,sdrLevels:s}=t,d=i.concat(s);this.logger.info(`[QE Critical] manifest loaded, ${d.length} valid levels found, levels ${_s(d)}`)(),this.logger.info(`valid levels: hdr=${i.length} sdr=${s.length} supportsHdr=${this.displaySupportsHdr}`)();let h=new Is(this.hls,d,this.displaySupportsHdr&&i.length>0);this.setFirstLevelOnManager(h);let c=h.compatibleAudioGroups,u=new Array,f=new Set,g=!1;r.forEach(e=>{c.has(e.groupId)&&(e.id=u.length,f.add(e.persistentID),u.push(e),g||(g=!!e.url))}),r=u;let p=new ys(this.hls,pi.AUDIO,r),m=a?a.MediaSelectionGroupOptions:void 0;if(m){let e=new Array;m.forEach(t=>{f.has(t.MediaSelectionOptionsPersistentID)&&e.push(t)}),a.MediaSelectionGroupOptions=e}let y={levels:h,audioTracks:p,subtitleTracks:new ys(this.hls,pi.SUBTITLE,e.subtitleTracks),isMediaPlaylist:e.isMediaPlaylist,audioCodecFound:l,videoCodecFound:o,altAudio:g,audioMediaSelectionGroup:a,subtitleMediaSelectionGroup:n};return Promise.resolve(y)})}setVariantManager(e){this.reset(),this.levelLoader&&this.levelLoader.destroy(),this.variantManagerInternal=e,e.hdrMode=this.displaySupportsHdr&&e.hasHDRLevels,this.levelLoader=new bs(e,e=>this._loadLevelInternal(e),()=>{this.playlistLoader.abort("level")}),e.variantList.length>0&&this.chooseFirstLevel()}get variantManager(){return this.variantManagerInternal}get validLevels(){return this.variantManager&&this.variantManager.validVariantList||[]}get hasIframeLevels(){return!!this.variantManager&&this.variantManager.hasIframeLevels}get level(){return this._levelInfo?this._levelInfo.persistentId:void 0}get currentVariantId(){return this.level}get levelInfo(){return this._levelInfo}static isSwitchUp(e,t){let i=!1;return e&&t&&(i=e.bitrate<t.bitrate&&e.iframes===t.iframes),i}addToLoadedLevels(e){this._loadediframeLevelIds.push(e),this._loadediframeLevelIds.sort((function(e,t){return t-e}))}preloadiFrameLevelPlaylists(){if(this.playlistLoader.isLoadingLevel(this._lastPreloadIFrameLevelId)||!this.validLevels.some(e=>e.iframes))return;let e=this.hls.abrController.findNextABRAutoLevelInMode(!0),t=this.getLevelWithPersistentId(e).levelInfo;return t?(void 0===t.details&&(this.logger.info(`[iframes] preloading iframe playlist for level: ${e}`)(),this._lastPreloadIFrameLevelId=e,this.levelLoader.loadLevel(e,!1)),e):void 0}doesLevelMatchIframeMode(e){return e&&e.iframes===this.hls.iframeMode}getLevelWithPersistentId(e){let t,i;return isNaN(e)||e<0?this.logger.warn(`invalid levelID ${e}`)():this.variantManager&&(t=this.variantManager.getVariantInfoIfValid(e),i=this.variantManager.getVariantListPosition(e)),{levelInfo:t,levelListPosition:i}}containsFallbackVariant(){return this.containsFallbackVariantForMode(this.hls.iframeMode)}containsFallbackVariantForMode(e){return this.validLevels.filter(t=>t&&t.iframes===e).length>1}isCurrentLevelNonSDR(){return this._levelInfo.videoRange&&"SDR"!==this._levelInfo.videoRange}lowestBitrateLevel(e){let t=this,i=e.find((function(e){return t.doesLevelMatchIframeMode(e)}));return void 0!==i?i.persistentId:void 0}getTrickPlayResumeLevel(e){let t=this.validLevels,i=this.hls.config.targetStartupMs,s=1,r=this.hls.config.defaultTargetDuration,a=this.variantManager.getVariantListPosition(e);if(a){let e=t[a];e&&e.details&&(r=e.details.targetduration,s=Math.ceil(i/(1e3*r)))}const n={avgLatencyMs:1500,avgBandwidth:this.hls.abrController.getBandwidthEstimate()},o={targetDuration:r*s,targetStartupMs:i,metricsOverride:{maxValidHeight:0,maxValidBitrate:0,maxPreferredBitrate:0}};this.logger.info(`Revising trickplay resume level based on targetStartUpMs/targetDuration/bandWidth : ${o.targetStartupMs}/${o.targetDuration}/${n.avgBandwidth}`)();let l=t.filter(e=>!e.iframes&&(!e.width||!e.height||e.width*e.height<=2488320)),d=e;l.length>0&&(d=l[0].persistentId);let h=l.filter(e=>Ui(e,n,o));return this.logger.info(`Picking resume level from validLevels/regLevels/resumeLevels ${t.length}/${l.length}/${h.length}`)(),h.length>0&&(d=h[h.length-1].persistentId),d}set level(e){const t=this.hls;if(!this.validLevels)return;let i=this.getLevelWithPersistentId(e).levelInfo;i&&this.doesLevelMatchIframeMode(i)?this.setLevelInternal(i):t.trigger(s.b.INTERNAL_ERROR,{type:r.g.OTHER_ERROR,details:r.d.LEVEL_SWITCH_ERROR,level:e,fatal:!1,reason:"invalid level idx, or level doesnt match iframe mode",response:r.f.CantSwitchInTime})}setLevelInternal(e){const t=this.hls;let i=!1;if(!1===this.isSameLevel(this._levelInfo,e)){let r=void 0!==this._levelInfo?this._levelInfo.persistentId:this._levelInfo,a=void 0!==this._levelInfo?this._levelInfo.bitrate:this._levelInfo;this.logger.info(`switching from ${r}:${a} to level ${e.persistentId}:${e.bitrate}`)(),i=Rs.isSwitchUp(this._levelInfo,e),this._levelInfo=e,t.trigger(s.b.LEVEL_SWITCH,e),t.trigger(s.b.LEVEL_SWITCHING,e)}this.levelLoader.loadLevel(e.persistentId),i&&(this.logger.info(`Switched to a new level: ${e.persistentId} attemptSafeNextLevelSwitch`)(),this.hls.streamController.attemptSafeNextLevelSwitch())}_loadLevelInternal(e){this.playlistLoader.loadLevel(e.url,e.persistentId).then(e=>{this.onLevelLoaded(e)}).catch(t=>{this._handleMediaPlaylistNetworkError(t,e.iframes!==this.hls.iframeMode)})}_attemptRetry(e,t){let i=this.hls.playlistLoader.retryPlaylistRequest(e);return i?i.then(e=>{this.onLevelLoaded(e)}).catch(e=>{this._handleMediaPlaylistNetworkError(e,t)}):void 0}get manualLevel(){return this._manualLevel}set manualLevel(e){this._manualLevel=e,void 0!==this._startLevel||this.hls.iframeMode||-1===e||(this._startLevel=e),-1!==e&&(this.level=e)}set firstLevel(e){this.variantManager&&(this.variantManager.startingId=e)}get firstLevel(){return this.variantManager?this.variantManager.startingId:NaN}get startLevel(){if(void 0===this._startLevel){let e=this.hls.config.startLevel;return void 0!==e?e:this.firstLevel}return this._startLevel}set startLevel(e){this._startLevel=e}_startedLoadingLevels(){return void 0!==this._levelInfo}_checkIfLevelExpired(e){let t=this.getLevelWithPersistentId(e).levelInfo,i=this.hls.media;if(!(t&&t.details&&i&&i.readyState))return;let s=t.details;if(this.levelIsExpired(s)){let a,n=s.fragments[0].start,o=n+s.totalduration;this.logger.error(`level ${e} behind currentTime=${i.currentTime} range:${n.toFixed(3)}-${o.toFixed(3)}`)();let l={type:"level",level:e,id:void 0},d=new r.p(r.g.NETWORK_ERROR,r.d.LEVEL_LOAD_ERROR,!1,r.f.LivePlaylistUpdateError.text,r.f.LivePlaylistUpdateError,this.hls.url,a,l),h=t.iframes!==this.hls.iframeMode;this._handleMediaPlaylistNetworkError(d,h)}}levelIsExpired(e){let t=this.hls.media;return t&&t.readyState&&e.fragments.length>0&&e.live&&e.PTSKnown&&e.fragments[0].start+e.totalduration<t.currentTime}onLevelUpdated(e){this._checkIfLevelExpired(e.level)}onLevelPtsUpdated(e){this._checkIfLevelExpired(e.level)}onLevelLoaded(e){var t;const i=e.level;let a=this.getLevelWithPersistentId(i).levelInfo,n=e.details;if(void 0!==a&&a.iframes&&this.addToLoadedLevels(a.persistentId),!this._startedLoadingLevels()&&n.isInitialMediaPlaylist||i===(null===(t=this._levelInfo)||void 0===t?void 0:t.persistentId)){let t=this.hls.isLive?this.hls.streamController.getLivePlaylistRefreshDelay(n):0,s=this.levelLoader.handleLevelLoad(i,n,e.stats,t);if(s.success)this.levelRetryCount=0;else switch(s.error){case r.f.LivePlaylistUpdateError:let t;e.livePlaylistUpdateError=!0;let n={type:"level",level:i,id:e.id},o=new r.p(r.g.NETWORK_ERROR,r.d.LEVEL_LOAD_ERROR,!1,r.f.LivePlaylistUpdateError.text,r.f.LivePlaylistUpdateError,this.hls.url,t,n),l=a.iframes!==this.hls.iframeMode;this._handleMediaPlaylistNetworkError(o,l)}}this.hls.trigger(s.b.LEVEL_LOADED,e)}get nextLoadLevel(){if(-1!==this._manualLevel)return this._manualLevel;if(this.hls.iframeMode&&this._loadediframeLevelIds.length>0){let e=this.hls.nextAutoLevel,t=this._loadediframeLevelIds.find((function(t){return t<=e}));return void 0!==t?t:e}return this.hls.nextAutoLevel}set nextLoadLevel(e){this.level=e,-1===this._manualLevel&&(this.hls.nextAutoLevel=e)}getLowerAutoLevel(e){let t;for(let i=e-1;i>=0;i--)if(this.doesLevelMatchIframeMode(this.validLevels[i])&&d.getHostName(this.validLevels[i].url)===this.hls.preferredHostName){t=this.validLevels[i].persistentId;break}return t}setNextAutoVariant(e){this.hls.nextAutoLevel=e}getNextBestAutoVariant(e){if(!this.variantManager)return;if(!this.doesLevelMatchIframeMode(this.variantManager.getVariantInfo(e)))return this.logger.warn("getNextBestAutoVariant: non-matching i-frame mode, using current level")(),this.currentVariantId;let t=this.variantManager.getVariantListPosition(e),i=this.getLowerAutoLevel(t);if("number"!=typeof i)for(let e=t+1;e<this.validLevels.length;++e)if(this.doesLevelMatchIframeMode(this.validLevels[e])&&d.getHostName(this.validLevels[e].url)===this.hls.preferredHostName){i=this.validLevels[e].persistentId;break}return i}onPreferredHostChanged(e){if(e.mediaType===pi.VIDEO||isNaN(this.level)||0===this.variantManager.variantList.length)return;let t,i=this.variantManager.getVariantInfo(this.level);(t=this.variantManager.validVariantList.find(e=>e.bandwidth===i.bandwidth&&d.getHostName(e.url)===this.hls.preferredHostName))&&(this.logger.warn(`preemptively switching video host to ${this.hls.preferredHostName}`)(),this.level=t.persistentId)}handleError(e){if("frag"in e&&e.frag&&"main"!==e.frag.type)return;let t;if(e instanceof r.j)t=e.frag&&Object(Oi.c)(e.frag.level)?e.frag.level:this._levelInfo.persistentId;else if(e instanceof r.k)t=e.frag&&Object(Oi.c)(e.frag.level)?e.frag.level:this._levelInfo.persistentId;else{if(!(e instanceof r.o))return;t=e.level}if(!isNaN(t)){let{levelInfo:i,levelListPosition:s}=this.getLevelWithPersistentId(t);if(!i)return void this.logger.warn(`${t} in penalty box, skip`)();this.hls.networkErrorHandler.handleError(e,i,t,s,this.variantManager,this)}}resetAndLoadSDRLevels(){try{this.logger.info("Falling back to SDR")(),this.setHDRMode(!1,!0)}catch(e){return!1}return!0}abortiFrameFragRequest(e){this.hls.streamController.abortiFrameFragRequest()}}var Ds,As,Ls=Rs;!(function(e){e[e.DoNothing=0]="DoNothing",e[e.SendEndCallback=1]="SendEndCallback",e[e.SendAlternateToPenaltyBox=2]="SendAlternateToPenaltyBox",e[e.RemoveAlternatePermanently=3]="RemoveAlternatePermanently",e[e.InsertDiscontinuity=4]="InsertDiscontinuity",e[e.RetryRequest=5]="RetryRequest",e[e.DefaultToSDR=6]="DefaultToSDR",e[e.AbortRequest=7]="AbortRequest",e[e.RemoveAllMatchingHDCPLevelsPermanently=8]="RemoveAllMatchingHDCPLevelsPermanently"})(Ds||(Ds={})),(function(e){e[e.MoveAllAlternatesMatchingHost=2]="MoveAllAlternatesMatchingHost"})(As||(As={}));var ws=class extends P{constructor(e){super(e,s.b.FRAG_LOADED),this.hls=e,this.consecutiveSendAlternateToPenaltyBox=new Map,this.consecutiveSendAlternateToPenaltyBox.set(pi.VIDEO,{val:0}),this.consecutiveSendAlternateToPenaltyBox.set(pi.AUDIO,{val:0}),this.consecutiveSendAlternateToPenaltyBox.set(pi.SUBTITLE,{val:0})}destroy(){super.destroy()}_modifyErrorActionIfLastValidVariantInternal(e,t){switch(e){case Ds.SendAlternateToPenaltyBox:e=Ds.RetryRequest,401!==t&&403!==t&&407!==t||(e=Ds.SendEndCallback);break;case Ds.RemoveAlternatePermanently:e=Ds.SendEndCallback}return e}_modifyErrorActionIfCurrentLevelIsLastValidLevel(e,t,i,s){let{errorAction:r,errorActionFlags:a}=e,n=i.containsFallbackVariant(),o=r;if(!n){if(r=this._modifyErrorActionIfLastValidVariantInternal(r,t),s&&i instanceof Ls){let e=i.isCurrentLevelNonSDR(),t=this.hls.hasPlaybackEverStarted;s&&!t&&e&&(r=Ds.DefaultToSDR)}a=0,this.logger.info(`fallbackVariantAvailable ${n} changing action from ${o} to ${r}`)()}return{errorAction:r,errorActionFlags:a}}_modifyErrorActionIfCurrentLevelIsLastValidiFrameLevel(e){let t=this.hls.levelController.containsFallbackVariant(),{errorAction:i,errorActionFlags:s}=e;return t||(i=Ds.AbortRequest,s=0),{errorAction:i,errorActionFlags:s}}_getActionForCommonNetworkError(e){let t,i;switch(e){case 500:case 502:case 503:case 504:case 404:case 409:case 401:case 403:case 407:case-12888:case-12884:t=Ds.SendAlternateToPenaltyBox,i=As.MoveAllAlternatesMatchingHost;break;case 410:t=Ds.RemoveAlternatePermanently,i=As.MoveAllAlternatesMatchingHost;break;default:t=Ds.SendAlternateToPenaltyBox,i=0}return{errorAction:t,errorActionFlags:i}}_findAlternateHost(e,t){let i,s,r=this.hls.preferredHostName,a=e.validVariantList,n=e.getVariantInfoIfValid(t),o=e.getMediaType()===pi.VIDEO;for(let e=0;e<a.length;e++){let t=a[e],l=d.getHostName(t.url);if(o){if(ps(n)&&ps(t)&&n.bandwidth===t.bandwidth&&r!==l&&this.hls.isValidCDN(l)){i=t,s=l;break}}else if(gs(n)&&gs(t)&&n.persistentID===t.persistentID&&r!==l&&this.hls.isValidCDN(l)){i=t,s=l;break}}return this.hls.removeCDNFromWhiteList(r),i?(this.logger.warn(`Backup host found, switching from ${r} to ${s}`)(),this.hls.preferredHostName=s,o&&ps(i)?i.persistentId:gs(i)?i.id:void 0):NaN}_modifyActionOnTimeout(e,t,i){let s=this._getMediaTypeFourCC(e),a=this.consecutiveSendAlternateToPenaltyBox.get(s),{errorAction:n,errorActionFlags:o}=t;switch(e.details){case r.d.LEVEL_LOAD_TIMEOUT:case r.d.AUDIO_TRACK_LOAD_TIMEOUT:case r.d.SUBTITLE_TRACK_LOAD_TIMEOUT:case r.d.FRAG_LOAD_TIMEOUT:!i&&++a.val>=this.hls.config.maxNumAddLevelToPenaltyBox&&(this.logger.warn(`Hit max consecutive penalty due to timeout count: ${e.details}`)(),n=Ds.SendEndCallback)}return{errorAction:n,errorActionFlags:o}}getActionForManifestError(e){let{errorAction:t,errorActionFlags:i}=this._getActionForCommonNetworkError(e.response.code);return t=this._modifyErrorActionIfLastValidVariantInternal(t),i=0,this.logger.info(`Manifest error ${t}`)(),{errorAction:t,errorActionFlags:i}}getActionForPlaylistNetworkError(e,t,i){let s=e.response.code,a=e.details,n=this._getActionForCommonNetworkError(s);if(i)n.errorActionFlags&=~As.MoveAllAlternatesMatchingHost;else{let e=a===r.d.LEVEL_LOAD_ERROR||a===r.d.LEVEL_LOAD_TIMEOUT;n=this._modifyErrorActionIfCurrentLevelIsLastValidLevel(n,s,t,e)}return n=this._modifyActionOnTimeout(e,n,i),this.logger.info(`Got playlist error ${s} ${e.message} ${JSON.stringify(n)}`)(),n}getActionForMediaFragNetworkError(e,t,i){let s=e.response.code,r=e.frag,a=this._getActionForCommonNetworkError(s);if(i)a.errorActionFlags&=~As.MoveAllAlternatesMatchingHost;else if("main"===r.type&&this.hls.iframeMode)a=this._modifyErrorActionIfCurrentLevelIsLastValidiFrameLevel(a);else{let e="main"===r.type;a=this._modifyErrorActionIfCurrentLevelIsLastValidLevel(a,s,t,e)}return a=this._modifyActionOnTimeout(e,a,i),e.errorAction=a.errorAction,this.logger.info(`Got fragment error ${s} ${e.message} prefetch=${i} ${JSON.stringify(a)}`)(),a}getActionForCryptKeyNetworkError(e,t,i,s){let r,a=Boolean(!e.stats||e.stats.isOkToRetry),n=Boolean(e.keyErrorReason&&e.keyErrorReason===kt.OutputRestricted),o=Ds.DoNothing;return o=n?Ds.RemoveAllMatchingHDCPLevelsPermanently:a?i?Ds.SendAlternateToPenaltyBox:(r=this._getActionForCommonNetworkError(e.response.code)).errorAction:Ds.RemoveAlternatePermanently,t&&!s&&(o=this._modifyErrorActionIfLastValidVariantInternal(o)),this.logger.info(`[Keys] Got crypt key error isCurrentLevel=${t} isTimeout=${i} hasFallback=${s}, errorAction ${o}`)(),{errorAction:o,errorActionFlags:0}}getActionForSessionDataNetworkError(){return Ds.DoNothing}handleError(e,t,i,s,a,n){let o,l;if((e instanceof r.k||e instanceof r.o)&&n.containsFallbackVariant()&&(l=this.handleNetworkError(Ds.SendAlternateToPenaltyBox,As.MoveAllAlternatesMatchingHost,e,i,void 0,a,n)),a)if(a.validVariantList&&0!==a.validVariantList.length){if(l&&!l.errorHandled)if(o=n.getNextBestAutoVariant(i),-1===n.manualLevel&&o)this.logger.warn(`level controller,${e.details}: switch to next best level for next fragment`)(),n.setNextAutoVariant(o);else if(!(e instanceof r.j)){let t=n.playTillEndOfBufferAndRetry(this.hls.media);e.retrying=t.retry,e.fatal=t.fatal}}else this.logger.error("No more variants left after error handling")(),e.fatal=!0,l.errorHandled=!0}_handleMoveMatchingHostFlag(e,t,i){let r;return t.moveAllMatchingHostsToPenaltyBoxOrRemovePermanently(e,i),r=this._findAlternateHost(t,e),isNaN(r)||this.hls.trigger(s.b.PREFERRED_HOST_CHANGED,{mediaType:t.getMediaType()}),r}handleNetworkError(e,t,i,s,a,n,o){let l,d=!0,h=i.details;switch(isNaN(s)&&h!==r.d.MANIFEST_LOAD_ERROR&&this.logger.warn(`invalid variantId:${s}, could be ignoring error details:${h}`)(),e){case Ds.RemoveAlternatePermanently:case Ds.SendAlternateToPenaltyBox:{if(isNaN(s))break;let i=n.getVariantInfoIfValid(s);if(!i){this.logger.warn(`handleNetworkError: ${s} not valid`)();break}let r,a=0!=(t&As.MoveAllAlternatesMatchingHost)&&this.hls.hasFallBack();!p.isCustomUrl(i.url)&&a&&(r=this._handleMoveMatchingHostFlag(s,n,e===Ds.RemoveAlternatePermanently)),isNaN(r)&&(r=o.getNextBestAutoVariant(s)),e===Ds.RemoveAlternatePermanently?n.removeLevelPermanently(s):n.addLevelToPenaltyBox(s),o.setNextAutoVariant(r),this.hls.iframeMode&&(o.manualLevel=r);break}case Ds.RemoveAllMatchingHDCPLevelsPermanently:isNaN(s)||n.removeAllMatchingHDCPLevelsPermanently(s);break;case Ds.RetryRequest:a?l=a():d=!1;break;case Ds.AbortRequest:o.abortiFrameFragRequest(i);break;case Ds.SendEndCallback:i.fatal=!0;break;case Ds.DefaultToSDR:if(!(d=o.resetAndLoadSDRLevels())){let e=new r.h(r.g.OTHER_ERROR,r.d.INTERNAL_EXCEPTION,!0,"no valid alternates found in fallback");e.response=r.f.NoValidAlternates,this.hls.upgradeInternalErrorIfNecessary(e),d=!0}break;case Ds.DoNothing:default:d=!1}return{errorHandled:d,retryPromise:l}}_getMediaTypeFourCC(e){let t,i;switch("frag"in e?i=e.frag.type:"type"in e.context&&(i=e.context.type),i){case"level":case"main":t=pi.VIDEO;break;case"audioTrack":case"audio":t=pi.AUDIO;break;case"subtitleTrack":case"subtitle":t=pi.SUBTITLE;break;default:t=pi.UNKNOWN}return t}onFragLoaded(e){let t=this._getMediaTypeFourCC(e);this.consecutiveSendAlternateToPenaltyBox.get(t).val=0}},ks=function(e,t){let i,s,r=0,a=e.length-1;for(;r<=a;){let n=t(s=e[i=(r+a)/2|0]);if(n>0)r=i+1;else{if(!(n<0))return s;a=i-1}}return null};const Cs={isBuffered:function(e,t){if(e){let i=e.buffered;for(let e=0;i&&e<i.length;e++)if(t>=i.start(e)&&t<=i.end(e))return!0}return!1},bufferInfo:function(e,t,i){if(e){var s=this.buffered(e);return this.bufferedInfo(s,t,i)}return{len:0,start:t,end:t,nextStart:void 0}},buffered:function(e){var t=[];if(e){var i,s=e.buffered;for(t=[],i=0;s&&i<s.length;i++)t.push({start:s.start(i),end:s.end(i)})}return t},subtitleBufferInfo:function(e,t,i){if(e){var s=this.bufferedCues(e);return this.bufferedInfo(s,t,i)}return{len:0,start:t,end:t,nextStart:void 0}},fragmentsBufferedInfo:function(e,t,i){const s=[];for(const t of e)s.push({start:t.start,end:t.start+t.duration});return this.bufferedInfo(s,t,i)},bufferedCues:function(e){var t,i=[];if(e)for(i=[],t=0;t<e.length;t++)i.push({start:e[t].startTime,end:e[t].endTime});return i},bufferedInfo:function(e,t,i){var s,r,a,n,o,l=[];for(e.sort((function(e,t){return e.start-t.start||t.end-e.end})),o=0;o<e.length;o++){var d=l.length;if(d){var h=l[d-1].end;e[o].start-h<i?e[o].end>h&&(l[d-1].end=e[o].end):l.push(e[o])}else l.push(e[o])}for(o=0,s=0,r=a=t;o<l.length;o++){var c=l[o].start,u=l[o].end;if(t+i>=c&&t<u)r=c,s=(a=u)-t;else if(t+i<c){n=c;break}}return{len:s,start:r,end:a,nextStart:n}},toRangeString:e=>`[${e.start.toFixed(3)},${e.end.toFixed(3)}]`,canContinuePlaybackWithoutGap(e,t,i,s,r){if("LIVE"!==s)return!0;if(!e||!r||!r.PTSKnown)return!1;let a=performance.now()+(r.tload-r.trequest);return r.fragments[0].start+(a-r.tload)/1e3<=Cs.bufferInfo(e,t,i).end}};var Ps,Ms,Os=Cs;!(function(e){e.AlmostDryWaterLevel="AlmostDryWaterLevel",e.LowWaterLevel="LowWaterLevel",e.HighWaterLevel="HighWaterLevel"})(Ps||(Ps={})),(function(e){e.VideoAudio="VideoAudio",e.Video="Video",e.Audio="Audio",e.Subtitle="Subtitle"})(Ms||(Ms={}));class Ns extends P{constructor(e,t,i,r,a,n,o,l){super(e,s.b.DESIRED_RATE_CHANGED),this.media=t,this.getEstimatedWaterLevel=i,this.bufferMonitorType=r,this.maxBufferHole=a,this.almostDryWaterLevelSeconds=l,this._maxBufferSeconds=n,this._targetDuration=o,this.listenerMap={seeking:this.stopBufferMonitor.bind(this),seeked:this.startBufferMonitor.bind(this)},this.addListeners()}destroy(){this.removeListeners(),this.stopBufferMonitor(),this.media=null,this.listenerMap=null,this.getEstimatedWaterLevel=null,super.destroy()}addListeners(){let e=this.media;if(e)for(let t in this.listenerMap){let i=this.listenerMap[t];e.addEventListener(t,i)}}removeListeners(){let e=this.media;if(e&&this.listenerMap)for(let t in this.listenerMap){let i=this.listenerMap[t];e.removeEventListener(t,i)}}set targetDuration(e){this._targetDuration!==e&&(this._targetDuration=e,this.startBufferMonitor())}get targetDuration(){return this._targetDuration}set maxBufferSeconds(e){this._maxBufferSeconds!==e&&(this._maxBufferSeconds=e,this.startBufferMonitor())}get maxBufferSeconds(){return this._maxBufferSeconds}notifyWaterLevelChanged(){this.startBufferMonitor()}get highWaterLevelSeconds(){return Math.max(this.maxBufferSeconds-this.targetDuration,this.lowWaterLevelSeconds)}get lowWaterLevelSeconds(){return this.targetDuration}onDesiredRateChanged(e){const t=e.oldRate,i=e.newRate;t!==i&&(0===t?this.startBufferMonitor():0===i&&this.stopBufferMonitor())}stopBufferMonitor(){clearTimeout(this.bufferChangeTimer)}startBufferMonitor(){let e=this.media;if(this.stopBufferMonitor(),!this.hls||!e||e.paused||e.seeking)return void this.logger.info("Not arming buffer monitor")();let t,i,s=e.currentTime,r=this.getEstimatedWaterLevel();if(r>this.highWaterLevelSeconds)t=this.highWaterLevelSeconds,i=Ps.HighWaterLevel;else if(r>this.lowWaterLevelSeconds)t=this.lowWaterLevelSeconds,i=Ps.LowWaterLevel;else{if(!(r>this.almostDryWaterLevelSeconds))return void this.logger.info(`Not arming buffer monitor buffer:${r}s @${s}`)();t=this.almostDryWaterLevelSeconds,i=Ps.AlmostDryWaterLevel}let a=1e3*(r-t);this.bufferChangeTimer=setTimeout(this.checkBufferLevel.bind(this,t,i),a)}checkBufferLevel(e,t){this.media,this.getEstimatedWaterLevel()<=e&&(this.logger.info(`buffer fell below ${t}`)(),this.hls.trigger(s.b.BUFFER_CHANGED,{reason:t,bufferType:this.bufferMonitorType})),this.startBufferMonitor()}}var xs=i(7);const Fs={getIframeStartMediaTime:function(e,t,i,s){return Fs.getIframeMediaTime(e.start+(s>1?0:e.duration),t,i,s)},getIframeEndMediaTime:function(e,t,i,s){return Fs.getIframeMediaTime(e.start+(s<0?0:e.duration),t,i,s)},getIframeMediaTime:function(e,t,i,s){return(e-i)/s+t},getIframeRealTime:function(e,t,i,s){return((e=Math.max(e,t))-t)*s+i}};var Bs=Fs;const Us={findFragmentBySNAndBuffer:function(e,t,i=0,s=0,r=0){let a;const n=e?t[e.sn-t[0].sn+1]:null;return i<s?(i>s-r&&(r=0),a=n&&!this.fragmentWithinToleranceTest(i,r,n)?n:ks(t,this.fragmentWithinToleranceTest.bind(null,i,r))):a=t[t.length-1],a},fragmentWithinToleranceTest:function(e,t,i){let s=Math.min(t,i.duration+(i.deltaPTS?i.deltaPTS:0));return i.start+i.duration-s<=e?1:i.start-s>e&&i.start?-1:0},startFragmentInCC(e,t,i){let s=t-i.cc;if(0===s){let t=e[i.sn-e[0].sn-1];s=t&&t.cc===i.cc?-1:0}return s},endFragmentInCC(e,t,i){let s=t-i.cc;if(0===s){let t=e[i.sn-e[0].sn+1];s=t&&t.cc===i.cc?1:0}return s},findStartEndFragmentsInCC:function(e,t){let i,s;return e&&e.length>0&&!isNaN(t)&&(i=ks(e,Us.startFragmentInCC.bind(null,e,t)),s=ks(e,Us.endFragmentInCC.bind(null,e,t))),i&&isNaN(i.cc)&&(i=void 0),s&&isNaN(s.cc)&&(s=void 0),[i,s]},getTimeRangeForCC:function(e,t){let i=Us.findStartEndFragmentsInCC(e,t),s=i[0],r=i[1],a=[];return s&&r&&(a=[s.startPTS?s.startPTS:s.start,r.endPTS?r.endPTS:r.start+r.duration]),a},snapToCCTimeRange:function(e,t,i){let s=e,r=Us.getTimeRangeForCC(t,i);return!isNaN(r[0])&&s<r[0]&&(s=r[0]),s},_fragmentMediaTimeTest(e,t,i,s,r){let a=Bs.getIframeStartMediaTime(r,t,i,s),n=s>1?1:-1;return Bs.getIframeEndMediaTime(r,t,i,s)<=e?n:a>e?-1*n:0},findNextIframe:function(e,t,i,s,r,a){let n;if(e&&e.iframe){let o=i>1?1:-1,l=Math.max(0,Math.min(e.sn-a[0].sn+o,a.length-1));if(e.sn!==a[l].sn)do{if(n=a[l],Bs.getIframeStartMediaTime(n,s,r,i)>=t)break;l+=o}while(l>0&&l<a.length)}else n=ks(a,this._fragmentMediaTimeTest.bind(this,t,s,r,i));return n}};var $s=Us;class Vs extends hs.EventEmitter{trigger(e,t){this.emit(e,e,t)}}class Gs{constructor(e,t){this.hls=e,this.logger=e.logger,this.id=t,this.typeSupported={mp4:MediaSource.isTypeSupported("video/mp4"),mpeg:MediaSource.isTypeSupported("audio/mpeg"),mp3:MediaSource.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:MediaSource.isTypeSupported('audio/mp4; codecs="ac-3"'),ec3:MediaSource.isTypeSupported('audio/mp4; codecs="ec-3"')},this.onWorkerMessage=this.onWorkerMessage.bind(this),this._ensureHandlerFunc()}_setupInlineHandler(e){const t=this.observer=new Vs;t.trigger=(e,i)=>t.emit(e,e,i),t.off=(e,i)=>t.removeListener(e,i);const i=(e,t)=>this.onWorkerMessage({data:{event:e,data:t}});[s.b.FRAG_DECRYPTED,s.b.FRAG_PARSING_INIT_SEGMENT,s.b.FRAG_PARSING_DATA,s.b.FRAG_PARSED,s.b.INTERNAL_ERROR,s.b.FRAG_PARSING_METADATA,s.b.FRAG_PARSING_USERDATA,s.b.FRAG_PARSING_CAPTIONDATA,s.b.INIT_PTS_FOUND].forEach(e=>t.on(e,i));const r=this.demuxer=new e.DemuxerInline(t,this.typeSupported,this.hls.config,navigator.vendor);return r.push.bind(r)}_setupWorkerHandler(e){const{vendor:t}=navigator;let i;this.logger.info("demuxing in webworker")();try{(i=e.createDemuxerWorker()).addEventListener("message",this.onWorkerMessage),i.onerror=e=>{let t=new r.h(r.g.OTHER_ERROR,r.d.INTERNAL_EXCEPTION,!0,e.message+" ("+e.filename+":"+e.lineno+")");t.response=r.f.InternalError,t.event="demuxerWorker",t.err={message:e.message+" ("+e.filename+":"+e.lineno+")"},this.hls.trigger(s.b.INTERNAL_ERROR,t)},i.postMessage({cmd:"init",typeSupported:this.typeSupported,vendor:t,id:this.id,config:JSON.stringify(this.hls.config),options:{streamID:this.hls.streamID,sessionID:this.hls.sessionID}}),this.worker=i}catch(e){throw i&&URL.revokeObjectURL(i.objectURL),e}return(e,t,s,r,a,n,o,l,d,h,c,u)=>{e instanceof Uint8Array&&(e=e.buffer),i.postMessage({cmd:"demux",data:e,decryptdata:t,initSegment:s,timeOffset:r,discontinuity:a,trackSwitch:n,contiguous:o,duration:l,accurateTimeOffset:d,defaultInitPTS:h,iframeMediaStart:c,iframeDuration:u},[e])}}_genHandlerFunc(){return Promise.resolve().then(i.bind(null,28)).then(e=>{if(this.hls.config.enableWorker&&"undefined"!=typeof Worker)try{return this._setupWorkerHandler(e)}catch(e){this.logger.error("error while initializing DemuxerWorker, fallback on DemuxerInline")()}return this._setupInlineHandler(e)})}_ensureHandlerFunc(){return this.handlerPromise||(this.handlerPromise=this._genHandlerFunc()),this.handlerPromise}destroy(){this.handlerPromise?this.handlerPromise.then(()=>{this._destroy()}):this._destroy()}_destroy(){this.handlerPromise=null;const{worker:e,demuxer:t,observer:i}=this;e&&(e.removeEventListener("message",this.onWorkerMessage),e.terminate(),this.worker=null),t&&(t.destroy(),this.demuxer=null),i&&(i.removeAllListeners(),this.observer=null)}push(e,t,i,s,r,a){this._ensureHandlerFunc().then(n=>{const o=void 0!==i.startDTS?i.startDTS:i.start,l=i.decryptdata,d=this.frag,h=!(d&&i.cc===d.cc),c=!(d&&i.level===d.level),u=d&&"number"==typeof d.sn&&i.sn===d.sn+1,f=!c&&u,g=void 0!==i.iframeMediaStart?i.iframeMediaStart:void 0,p=void 0!==i.iframeMediaDuration?i.iframeMediaDuration:void 0;this.frag=i,this.iframeMediaStart=g,this.accurateTimeOffset=r,n(e,l,t,o,h,c,f,s,r,a,g,p)})}isValidFragParsingData(e,t,i,s,r){let a,n;Object(Oi.c)(s)?(n=s,a=.01,isFinite(n)&&isFinite(r)&&(n+=r)):i?(n=void 0!==e.startDTS?e.startDTS:e.start,Math.abs(t.startDTS-n)>.5&&this.logger.warn(`Significant DTS drift vs playlist sn=${e.sn} startDTS=${t.startDTS} expectedDTS=${n}`)(),a=e.duration):this.logger.warn(`accurateTimeOffset==false, bypass DTS check startDTS==${t.startDTS}`)();const o=t.startPTS>=0&&t.startDTS>=0&&e.duration>0&&(!Object(Oi.c)(t.endPTS)||t.endPTS>=t.startPTS)&&(!Object(Oi.c)(t.endDTS)||t.endDTS>=t.startDTS)&&(void 0===n||void 0!==a&&Math.abs(t.startDTS-n)<=a);if(!o){const i=Object(Oi.c)(t.endPTS)?t.endPTS.toFixed(3):"undefined",s=Object(Oi.c)(t.endDTS)?t.endDTS.toFixed(3):"undefined",o=void 0===n?"undefined":n.toFixed(3);this.logger.error(`${t.type}: ${e.type} frag ${e.sn} failed demuxer sanity check PTS:[${t.startPTS.toFixed(3)},${i}] DTS:[${t.startDTS.toFixed(3)},${s}] expectedStartDTS=${o} dur=${e.duration.toFixed(3)} iframe=${e.iframe} fudge=${a} audioPrimingDelay=${r}`)()}return o}onWorkerMessage({data:{event:e,data:t}}){const{hls:i,id:a,frag:n}=this;let o;if(t=Object.assign(Object.assign({},t),{id:a,frag:n}),Gs.checkWorkerMessageType(t,e,xs.a.INIT))this.worker&&URL.revokeObjectURL(this.worker.objectURL);else{if(Gs.checkWorkerMessageType(t,e,s.b.FRAG_PARSING_DATA)){const{frag:i}=this;!this.isValidFragParsingData(i,t,this.accurateTimeOffset,this.iframeMediaStart,this.hls.config.audioPrimingDelay)&&isNaN(this.iframeMediaStart)&&(e=s.b.INTERNAL_ERROR,o=new r.k(r.g.MEDIA_ERROR,r.d.FRAG_PARSING_ERROR,!1,"Failed demuxer sanity check",i))}else Gs.checkWorkerMessageType(t,e,s.b.INTERNAL_ERROR)&&(t&&t.details===r.d.FRAG_PARSING_ERROR?o=new r.k(t.type,t.details,t.fatal,t.reason,this.frag):t&&t.details===r.d.REMUX_ALLOC_ERROR&&"bytes"in t&&(o=new r.o(t.type,t.details,t.fatal,t.reason,t.response,t.bytes,n)));i.trigger(e,o||t)}}static checkWorkerMessageType(e,t,i){return t===i}}var Ks=Gs;const Hs={mergeDetails:function(e,t){var i,s=Math.max(e.startSN,t.startSN)-t.startSN,r=Math.min(e.endSN,t.endSN)-t.startSN,a=t.startSN-e.startSN,n=e.fragments,o=t.fragments,l=0;for(let e=s;e<=r;++e)if(n[a+e]&&o[e]){l=n[a+e].cc-o[e].cc;break}e.initSegments=e.initSegments||{},t.initSegments=t.initSegments||{};let d={};for(let s in o){let r=n[a+s],h=o[s],u=h.cc+l;t.initSegments[h.cc]&&(d[u]=t.initSegments[h.cc],d[u].cc=u,e.initSegments[u]&&(d[u].data=e.initSegments[u].data)),h.cc=u,r&&!isNaN(r.startPTS)&&(h.sn===r.sn?(h.start=h.startPTS=r.startPTS,h.endPTS=r.endPTS,h.duration=r.duration,h.backtracked=r.backtracked,h.dropped=r.dropped,i=h):c.b.warn(`mismatch in sn during merge newFrag.sn: ${h.sn} vs oldFrag.sn: ${r.sn}`)())}if(t.initSegments=d,i)Hs.updateFragPTSDTS(t,i,i.startPTS,i.endPTS,i.startDTS,i.endDTS);else if(a>=0&&a<n.length){var h=n[a].start;for(let e in o)o[e].start+=h}t.PTSKnown=s<=r&&Boolean(e.PTSKnown)},getExpiredFragmentsRange:function(e,t){if(e.startSN>=t.startSN)return{start:void 0,end:void 0};var i,s,r=Math.max(e.startSN,t.startSN)-t.startSN,a=Math.min(e.endSN,t.endSN)-t.startSN,n=t.startSN-e.startSN,o=e.fragments;return a<r&&o.length>0&&!isNaN(r)&&r<o.length?(i=o[r].start,s=o[o.length-1].start+o[o.length-1].duration):n&&o.length>0&&!isNaN(r)&&!isNaN(n)&&r<o.length&&(i=o[r].start,s=o[r+n-1].start+o[r+n-1].duration),{start:i,end:s}},updateFragPTSDTS:function(e,t,i,s,r,a){if(!isNaN(t.startPTS)){let e=Math.abs(t.startPTS-i);isNaN(t.deltaPTS)?t.deltaPTS=e:t.deltaPTS=Math.max(e,t.deltaPTS),i=Math.min(i,t.startPTS),s=Math.max(s,t.endPTS),r=Math.min(r,t.startDTS),a=Math.max(a,t.endDTS)}const n=i-t.start;t.start=t.startPTS=i,t.endPTS=s,t.startDTS=r,t.endDTS=a,t.duration=s-i;const o=t.sn;if(!e||o<e.startSN||o>e.endSN)return 0;let l=o-e.startSN,d=e.fragments,h=d[l];t!==h&&(c.b.warn(`frag may be copy input:${JSON.stringify(t,["level","id","sn","cc"])} details:${JSON.stringify(h,["level","id","sn","cc"])}`)(),h.start=t.start,h.endPTS=t.endPTS,h.startPTS=t.startPTS,h.startDTS=t.startDTS,h.endDTS=t.endDTS,h.duration=t.duration,h.deltaPTS=t.deltaPTS);for(let e=l;e>0;e--)Hs.updatePTS(d,e,e-1);for(let e=l;e<d.length-1;e++)Hs.updatePTS(d,e,e+1);return e.PTSKnown=!0,n},updatePTS:function(e,t,i){var s=e[t],r=e[i],a=r.startPTS;isNaN(a)?r.start=i>t?s.start+s.duration:Math.max(s.start-r.duration,0):i>t?(s.duration=a-s.start,s.duration<0&&c.b.warn(`negative duration computed for frag ${s.sn},level ${s.level}, there should be some duration drift between playlist and fragment!`)()):(r.duration=s.start-a,r.duration<0&&c.b.warn(`negative duration computed for frag ${r.sn},level ${r.level}, there should be some duration drift between playlist and fragment!`)())}};var Ws,js=Hs,qs=function(e){for(var t="",i=e.length,s=0;s<i;s++)t+="["+e.start(s).toFixed(3)+","+e.end(s).toFixed(3)+"]";return t},Ys=i(8);!(function(e){e.STOPPED="STOPPED",e.IDLE="IDLE",e.KEY_LOADING="KEY_LOADING",e.FRAG_LOADING="FRAG_LOADING",e.PLAYLIST_LOADING="PLAYLIST_LOADING",e.FRAG_LOADING_WAITING_RETRY="FRAG_LOADING_WAITING_RETRY",e.PARSING="PARSING",e.PARSED="PARSED",e.BUFFER_FLUSHING="BUFFER_FLUSHING",e.BUFFER_FLUSHING_WAITING_PLAYLIST="BUFFER_FLUSHING_WAITING_PLAYLIST",e.ENDED="ENDED",e.ERROR="ERROR",e.WAITING_INIT_PTS="WAITING_INIT_PTS",e.WAITING_DISCONTINUITY="WAITING_DISCONTINUITY"})(Ws||(Ws={}));var zs=class extends P{constructor(e,t,...i){super(e,...i),this.hls=e,this.name=t,this.destroy$=new it,this.logger=e.logger,this.config=e.config,this._state=Ws.STOPPED,this.maxBufferAheadSec=this.config&&this.config.maxBufferLength||30}destroy(){this.destroy$.next(),super.destroy()}startLoad(e){}set state(e){this.state!==e&&(this.state,this._state=e)}get state(){return this._state}get curVariantId(){return this.variantController.currentVariantId}retryFragRequest(e){let t=e.frag;var i=this.fragLoadError;i?i++:i=1;let s=this.config,a=e.details===r.d.FRAG_LOAD_ERROR?s.fragLoadPolicy.default.errorRetry:s.fragLoadPolicy.default.timeoutRetry;if(i<=a.maxNumRetry){this.fragLoadError=i,t.loadCounter=0;var n=Math.min(Math.pow(2,i-1)*a.retryDelayMs,a.maxRetryDelayMs);this.logger.warn(`${this.constructor.name}: frag loading failed, retry in ${n} ms`)(),this.retryDate=performance.now()+n,this.state=Ws.FRAG_LOADING_WAITING_RETRY,e.retrying=!0}else this.logger.error(`${this.constructor.name}: reaches max retry, redispatch as fatal ...`)(),e.fatal=!0,e.retrying=!1}_handleFragmentNetworkError(e,t){let i,s;if(e.frag&&Object(Oi.c)(e.frag.level)){i=e.frag.level;let r=this.hls.networkErrorHandler.getActionForMediaFragNetworkError(e,this.variantController,t);s=this.hls.networkErrorHandler.handleNetworkError(r.errorAction,r.errorActionFlags,e,i,this.retryFragRequest.bind(this,e),this.variantController.variantManager,this.variantController),this.state!==Ws.IDLE&&this.logger.warn(`State not IDLE after error handling ${this.state} ${i} errorAction=${r.errorAction}`)()}else this.logger.warn("fragment network error could not be handled for the invalid frag or frag without variant id")();e.fatal&&!this.hls.bufferEndPromiseWrapper&&this.hls.fatalErrorRequiresAction(e)&&this.hls.bufferDryPromise.then(()=>{this.hls.upgradeInternalErrorIfNecessary(e)}).catch(e=>{this.logger.error("get an error in buffer dry promise")()})}handleBufferFullError(e,t,i,s,r,a){if(e.parent===t&&(this.state===Ws.PARSING||this.state===Ws.PARSED)){if(r){let{trackType:r}=e,a=1e3*this.targetDuration,n=Ds.RetryRequest;1e3*s.len<a&&(this.variantController.containsFallbackVariant()?n=Ds.SendAlternateToPenaltyBox:(this.logger.warn(`${t} buffer too small to sustain playback @${i}`)(),n=Ds.SendEndCallback)),this.logger.info(`${t} handleBufferFullError errorAction:${n} ${a}ms`)(),n===Ds.RetryRequest?this.hls.bufferController.scheduleAppendRetry(r,a):(this.hls.bufferController.abortPendingAppendsByParent("main",0,Number.POSITIVE_INFINITY),this.hls.networkErrorHandler.handleNetworkError(n,0,e,i,void 0,this.variantController.variantManager,this.variantController))}else this.logger.warn(`${t} buffer full and not buffered. flush everything`)(),a();e.fatal&&(this.state=Ws.ERROR)}}logFragmentTiming(e,t){e&&this.config.enablePerformanceLogging&&this.logger.info(`[timing] ${JSON.stringify({t:performance.now(),name:this.name,level:e.level,sn:e.sn,cc:e.cc,stage:t})}`)()}escalateInternalError(e){this.hls.upgradeInternalErrorIfNecessary(e)?(this.state=Ws.ERROR,this.logger.error(`${this.constructor.name}: ${e.type}, ${e.details}, ${e.response}, switch to ${this.state} state ...`)()):(this.state=Ws.IDLE,this.tick())}handleInternalError(e){return this.state===Ws.ERROR||!!e.fatal&&(this.escalateInternalError(e),!0)}};const Qs=["audio","video","audiovideo"];function Xs(e){return Qs.includes(e)}var Js=(function(e){function t(t){var i=e.call(this)||this;return i._value=t,i}return fe(t,e),Object.defineProperty(t.prototype,"value",{get:function(){return this.getValue()},enumerable:!0,configurable:!0}),t.prototype._subscribe=function(t){var i=e.prototype._subscribe.call(this,t);return i&&!i.closed&&t.next(this._value),i},t.prototype.getValue=function(){if(this.hasError)throw this.thrownError;if(this.closed)throw new Ze;return this._value},t.prototype.next=function(t){e.prototype.next.call(this,this._value=t)},t})(it);function Zs(e){return!Se(e)&&e-parseFloat(e)+1>=0}function er(e){var t=e.index,i=e.period,s=e.subscriber;if(s.next(t),!s.closed){if(-1===i)return s.complete();e.index=t+1,this.schedule(e,i)}}var tr=(function(){function e(e,t){this.notifier=e,this.source=t}return e.prototype.call=function(e,t){return t.subscribe(new ir(e,this.notifier,this.source))},e})(),ir=(function(e){function t(t,i,s){var r=e.call(this,t)||this;return r.notifier=i,r.source=s,r.errors=null,r.retries=null,r.retriesSubscription=null,r}return fe(t,e),t.prototype.error=function(t){if(!this.isStopped){var i=this.errors,s=this.retries,r=this.retriesSubscription;if(s)this.errors=null,this.retriesSubscription=null;else{i=new it;try{s=(0,this.notifier)(i)}catch(t){return e.prototype.error.call(this,t)}r=je(this,s)}this._unsubscribeAndRecycle(),this.errors=i,this.retries=s,this.retriesSubscription=r,i.next(t)}},t.prototype._unsubscribe=function(){var e=this.errors,t=this.retriesSubscription;e&&(e.unsubscribe(),this.errors=null),t&&(t.unsubscribe(),this.retriesSubscription=null),this.retries=null},t.prototype.notifyNext=function(e,t,i,s,r){var a=this._unsubscribe;this._unsubscribe=null,this._unsubscribeAndRecycle(),this._unsubscribe=a,this.source.subscribe(this)},t})(Me),sr=(function(){function e(e){this.callback=e}return e.prototype.call=function(e,t){return t.subscribe(new rr(e,this.callback))},e})(),rr=(function(e){function t(t,i){var s=e.call(this,t)||this;return s.add(new _e(i)),s}return fe(t,e),t})(Ae),ar=(function(){function e(e){this.total=e}return e.prototype.call=function(e,t){return t.subscribe(new nr(e,this.total))},e})(),nr=(function(e){function t(t,i){var s=e.call(this,t)||this;return s.total=i,s.count=0,s}return fe(t,e),t.prototype._next=function(e){++this.count>this.total&&this.destination.next(e)},t})(Ae);class or extends zs{constructor(e,t,...i){super(e,t,s.a.FRAG_PARSING_DATA,s.a.FRAG_PARSED,s.a.BUFFER_SOURCE_RESETTING,...i),this.hls=e,this.sbid=t,this.waitingForKey=new Js(null),this.bufferController=e.bufferController}cancelCurrentLoad(){let e=this.fragCurrent;e&&this.state===Ws.FRAG_LOADING&&(e.loader&&e.loader.abort(),this.fragCurrent=null,this.state=Ws.IDLE)}clearPendingData(){this.pendingParsedData&&(this.pendingParsedData.frag.loadCounter=0,this.pendingParsedData=null)}ensurePendingDataForSeek(e){if(this.state===Ws.WAITING_DISCONTINUITY&&this.pendingParsedData){const t=this.pendingParsedData.frag;(e<t.start-this.config.discontinuitySeekTolerance||e>t.start+t.duration)&&(this.logger.info(`[${this.sbid}] clearing pending data, seekToPos: ${e}, frag: ${t.fragTag}, range: ${t.rangeString}`)(),this.clearPendingData(),this.state=Ws.IDLE)}}pushPendingData(){const e=!!this.pendingParsedData;if(e){const e=this.pendingParsedData,t=e.frag;this.fragCurrent=t,this.state=Ws.PARSING,this.appended=!1,this.stats.cached=!0,this.clearPendingData(),this.handleFragParsingData(e,!0),this.state===Ws.PARSING&&(this.state=Ws.PARSED,this.nextLoadPosition=t.start+t.duration,this.logger.info(`[${t.type}] re-parse pendingParsedData from cached frag data ${t.fragTag} range: ${t.rangeString}, nextLoadPosition: ${this.nextLoadPosition}`)())}return e}ensureInitSegmentForFragInfo(e,t,i){this.bufferController.sourceBufferHasProperInitSegment(this.sbid,e)||this.doCreateSbAndAppendInitSegment(e,t,i)}doCreateSbAndAppendInitSegment(e,t,i){const{codec:s,container:r,type:a}=t,{cc:n,level:o}=e;if("yes"===this.bufferController.isCompatibleTransition(n)){this.bufferController.createBuffer(this.sbid,a,n,s,r,i);const l=t.initSegment;if(this.logger.info(`[${this.sbid}] doCreateSbAndAppend track:${t.type}, container:${t.container}, codecs[level/parsed]=[${i}/${t.codec}]`)(),l){this.appended=!0,this.pendingBuffering=!0;let i={level:o,sn:"initSegment",cc:n,decryptdata:{keyId:e.decryptdata?e.decryptdata.keyId:null}};this.logFragmentTiming(e,"appending"),this.bufferController.appendBuffer(t.type,l,NaN,NaN,this.sbid,"initSegment",i),this.logFragmentTiming(e,"parsed")}}}setWaitingDiscontinuity(e){this.clearPendingData(),this.pendingParsedData=e,this.state=Ws.WAITING_DISCONTINUITY}onBufferSourceResetting(){this.onMediaDetaching()}onFragParsingData(e){const t=this.fragCurrent,i=e.frag;t&&e.id===this.sbid&&i.sn===t.sn&&i.level===t.level&&(this.handleFragParsingData(e,!1),this.tick())}onFragParsed(e){const t=this.fragCurrent,i=e.frag;t&&e.id===this.sbid&&i.sn===t.sn&&i.level===t.level&&this.state===Ws.PARSING&&(this.logFragmentTiming(t,"parsed"),this.stats.tparsed=performance.now(),this.state=Ws.PARSED,(this.hls.isLive||this.hls.config.gapless)&&i.decryptdata&&i.decryptdata.isEncrypted&&this.hls.keyLoader.updateExpiryPosition(i.decryptdata,i.level,i.start),this.checkAppendedParsed()),this.tick()}fetchKey(e){let t=e.decryptdata;return t.uri!==this.waitingForKey.value&&this.waitingForKey.next(t.uri),this.hls.keyLoader.getKeyFromDecryptData(e.decryptdata,e.level,!1).pipe((s=e=>e.pipe(vt((e,t)=>e instanceof r.n&&this._handleKeyError(e,this.variantController.currentVariantId)?(function(e,t,i){void 0===e&&(e=0);var s=-1;return Zs(void 0)?s=Number(void 0)<1?1:Number(void 0):ht(void 0)&&(i=void 0),ht(i)||(i=Et),new He(function(t){var r=Zs(e)?e:+e-i.now();return i.schedule(er,r,{index:0,period:s,subscriber:t})})})(this.config.keyLoadingRetryDelay*Math.min(t+1,5)):rt(e))),function(e){return e.lift(new tr(s,e))}),Dt(3e4),vt(()=>(this.state===Ws.KEY_LOADING&&(this.state=Ws.IDLE,this.tick()),ft(!0))),qe((i,s)=>{if(this.logger.warn(`[${this.name}] got key error state=${this.state}`)(),i instanceof r.n);else if(i instanceof dt){let i=this.hls.keyLoader.getLevelIdsForKey(t),s=i.has(this.variantController.currentVariantId)&&!this.variantController.containsFallbackVariant(),a=new r.n(r.g.NETWORK_ERROR,r.d.KEY_LOAD_TIMEOUT,s,"Key load timed out",r.f.CryptResponseReceivedSlowly,e.decryptdata,{isOkToRetry:!s},i);this._handleKeyError(a,this.variantController.currentVariantId)}else this.logger.warn(`Unhandled error ${i.message}`)();return ft(!1)}),(i=()=>{this.waitingForKey.next(null)},function(e){return e.lift(new sr(i))}),Qe(this.waitingForKey.pipe((function(e){return e.lift(new ar(1))}))),Qe(this.destroy$));var i,s}_handleKeyError(e,t){let i=new Array,s=!1;e.levelIds.forEach((function(e){e===t?s=!0:i.push(e)})),s?i.push(t):this.logger.warn(`Other levels got key error keyuri=${this.hls.redactUrl(e.decryptdata.uri)} levelIds=${JSON.stringify(i)}`)();let a=this.variantController.variantManager,n=!1;return i.forEach(i=>{let s=i===t,o=this.variantController.containsFallbackVariant(),{errorAction:l,errorActionFlags:d}=this.hls.networkErrorHandler.getActionForCryptKeyNetworkError(e,s,e.details===r.d.KEY_LOAD_TIMEOUT,o);n=n||s&&l===Ds.RetryRequest,this.hls.networkErrorHandler.handleNetworkError(l,d,e,i,void 0,a,this.variantController)}),a.validVariantList&&0!==a.validVariantList.length||(this.logger.warn(`${this.name} no valid levels left`)(),e.fatal=!0),e.fatal?(this.escalateInternalError(e),n=!1):n||(this.resetNextLoadPositionState(),this.state===Ws.KEY_LOADING&&(this.state=Ws.IDLE)),n}handleInternalError(e){return!!super.handleInternalError(e)||e instanceof r.n&&(this._handleKeyError(e,this.curVariantId),!0)}}var lr=class extends or{constructor(e){super(e,"main",s.b.MEDIA_ATTACHING,s.b.MEDIA_DETACHING,s.b.MANIFEST_LOADING,s.b.LEVEL_LOADED,s.b.FRAG_LOAD_EMERGENCY_ABORTED,s.b.FRAG_PARSING_INIT_SEGMENT,s.b.INTERNAL_ERROR,s.b.AUDIO_TRACK_SWITCHING,s.b.AUDIO_TRACK_SWITCHED,s.b.BUFFER_CREATED,s.b.BUFFER_APPENDED,s.b.BUFFER_FLUSHED,s.b.BUFFER_SOURCE_RESET,s.b.LEVELS_CHANGED,s.b.BANDWIDTH_CHANGED,s.b.BUFFER_CHANGED,s.b.STALLED),this.gaplessAllowed=!0,this.config=e.config,this._state=Ws.STOPPED,this.ontick=this.doTick.bind(this),this.firstPlaybackStarted=!1,this.pendingPlayPromises=[],this.startTargetDurationFactor=this.config&&this.config.startTargetDurationFactor?this.config.startTargetDurationFactor:1,this.config.audioStreamController&&(this.audioStreamController=new this.config.audioStreamController(e,this.tick)),this.config.subtitleStreamController&&(this.subtitleStreamController=new this.config.subtitleStreamController(e,this.tick))}destroy(){this.stopLoad(),this.tickInterval&&(clearInterval(this.tickInterval),this.tickInterval=null),this.clearTickImmediate(),this.clearReadyForNextItem(),this.state=Ws.STOPPED,super.destroy()}get loadingItemStartTime(){return this.hls.loadingItem.startTime}get playingItemStartTime(){return this.hls.playingItem.startTime}get targetDuration(){return this.bufferMonitor&&this.bufferMonitor.targetDuration}get highWaterLevel(){return this.bufferMonitor&&this.bufferMonitor.highWaterLevelSeconds}get levels(){return this.hls.levels}startLoad(e){var t;if(this.logger.info(`startLoad(${e})`)(),this.levels&&this.levels.length>0){let t=this.lastCurrentTime,i=this.hls;if(this.stopLoad(),this.tickInterval||(this.tickInterval=setInterval(this.ontick,100)),!this.config.useFirstLevelAtIncompatDiscontinuity||this.iframeMode||this.pendingParsedData||(this.levelId=-1),this.fragLoadError=0,!this.startFragRequested){let e=i.startLevel;-1===e&&(e=this.hls.levelController.firstLevel,this.bitrateTest=!0),(!this.levelId||this.levelId<0)&&(this.levelId=i.nextLoadLevel=e),this.loadedmetadata=!1}t>0&&-1===e&&(e=t),this.state=Ws.IDLE,this.hls.isPreloadingItem||this.seek(e),this.tick()}else this.forceStartLoad=!0,this.state=Ws.STOPPED;this.iframeEOS=!1,this.autoPausedRestartTime=void 0,null===(t=this.subtitleStreamController)||void 0===t||t.startLoad()}stopLoad(){var e,t;this.state!==Ws.STOPPED&&(this.cancelCurrentLoad(),this.fragPrevious=null,this._destroyDemuxer(),this.state=Ws.STOPPED,this.forceStartLoad=!1,null===(e=this.audioStreamController)||void 0===e||e.stopLoad(),null===(t=this.subtitleStreamController)||void 0===t||t.stopLoad())}signalReadyForNextItem(e){this.nextItemImmediate||(this.nextItemImmediate=Object(Ys.setImmediate)(this.readyForNextItem.bind(this,e)))}clearReadyForNextItem(){Object(Ys.clearImmediate)(this.nextItemImmediate),this.nextItemImmediate=null}readyForNextItem(e){this.clearReadyForNextItem(),this.altAudio=!1,this.logger.info(`[gapless] item fully appended @ ${e}; media.duration ${this.media.duration}s`)(),this.hls.trigger(s.b.READY_FOR_NEXT_ITEM,{duration:e})}tick(){this.tickImmediate||(this.tickImmediate=Object(Ys.setImmediate)(this.doTick.bind(this)))}clearTickImmediate(){Object(Ys.clearImmediate)(this.tickImmediate),this.tickImmediate=null}doTick(){var e,t;switch(this.clearTickImmediate(),this.state){case Ws.BUFFER_FLUSHING:this.fragLoadError=0;break;case Ws.IDLE:this.hls.bufferController.evictItemCompleted()&&this._doTickIdle();break;case Ws.PLAYLIST_LOADING:if(!this.hls.playlistLoader.isLoadingLevel(this.levelId)){var i=this.hls.levelWithPersistentId(this.levelId).levelInfo;i&&i.details&&(this.state=Ws.IDLE)}break;case Ws.FRAG_LOADING_WAITING_RETRY:var s=performance.now(),r=this.retryDate;(!r||s>=r||this.media&&this.media.seeking)&&(this.state=Ws.IDLE);break;case Ws.WAITING_DISCONTINUITY:this.checkDiscontinuityState(!1);break;case Ws.PARSED:this._ensureAudioStartLoad(this.fragCurrent);break;case Ws.ERROR:case Ws.STOPPED:case Ws.FRAG_LOADING:case Ws.KEY_LOADING:case Ws.PARSING:case Ws.BUFFER_FLUSHING_WAITING_PLAYLIST:case Ws.ENDED:}this._checkIfLoadedMetadata(),this._checkIfPlaybackLikelyToKeepUp(),this.immediateSwitchCanEnd&&this.immediateLevelSwitchEnd(),this._checkFragmentChanged(),this._loadSessionDataIfNecessary(),null===(e=this.audioStreamController)||void 0===e||e.doTick(),null===(t=this.subtitleStreamController)||void 0===t||t.doTick()}checkDiscontinuityState(e){var t,i;if(this.state!==Ws.WAITING_DISCONTINUITY)return;const s=this.pendingParsedData.frag,r=s.cc;if("yes"===this.bufferController.isCompatibleTransition(r))return this.logger.error(`[main] no longer waiting for compatibility update, going back to IDLE state, cc: ${r}`)(),void(this.state=Ws.IDLE);if(this.altAudio&&this.audioStreamController.state!==Ws.WAITING_DISCONTINUITY)return;let a;const n=this._getPlaybackPos();if(this.media.seeking){if(this.logger.info(`[main] checkDiscontinuityState seeking, seekToPos: ${n}, pendingFrag: ${s.fragTag}, range: ${s.rangeString}`)(),n>=s.start-this.config.discontinuitySeekTolerance&&n<=s.start+s.duration){const e=this.calculateStartTime();this.logger.info(`[main] seeking into disco seekToPos: ${n}, resetting to latest frag start ${e}`)(),a=e}}else if(e){const e=this.calculateStartTime(),t=e+s.duration,i=this.targetDuration;e<t&&Math.abs(e-n)<i&&(a=e)}return!!Object(Oi.c)(a)&&(this.logger.info(`[QE Critical] [main] checkDiscontinuityState *** resetting source buffer *** cc: ${r}, seekToPos: ${a}, stalled: ${e}, seeking: ${null===(t=this.media)||void 0===t?void 0:t.seeking}, currentTime: ${null===(i=this.media)||void 0===i?void 0:i.currentTime}, playbackPos: ${n}`)(),this.resetMediaSource({seekToPos:a,cc:r},!0),!0)}calculateStartTime(){var e,t,i,s;const r=null!==(i=null===(t=null===(e=this.audioStreamController)||void 0===e?void 0:e.pendingDataInfo)||void 0===t?void 0:t.startPTS)&&void 0!==i?i:-1,a=null===(s=this.pendingParsedData)||void 0===s?void 0:s.startPTS;return this.logger.info(`[main] calculateStartTime: audioStartPTS: ${-1===r?"no alt":r}, mainStartPTS: ${a}`)(),Math.max(r,a)}_doTickIdle(){const e=this.hls,t=e.config,i=this.media;if(this.pushPendingData())return;if(void 0!==this.levelLastLoaded&&!i&&(this.startFragRequested||!t.startFragPrefetch))return;if(this.hls.isLive&&0===this.desiredRate)return;let s;if(s=this.loadedmetadata?i.currentTime:this.nextLoadPosition,Object(Oi.c)(this.needsResetForCC)){const e=this.needsResetForCC;return this.needsResetForCC=null,void this.resetMediaSource({seekToPos:s,cc:e},!0)}const r=this.getSourceBufferInfo(s);let{len:a,end:n}=r;if(a>this.highWaterLevel)return void this._prefetchIframes(s,n);let o=!this.levelAtSwitch||this.iframeMode?e.nextLoadLevel:this.levelAtSwitch,l=this.hls.levelWithPersistentId(o).levelInfo;if(!l)return;this.levelId=e.nextLoadLevel=o;const d=l.details;if(d&&(this.bufferMonitor.targetDuration=d.targetduration),e.playlistLoader.isLoadingLevel(o)&&this.state===Ws.BUFFER_FLUSHING)return void(this.state=Ws.BUFFER_FLUSHING_WAITING_PLAYLIST);if(e.playlistLoader.isLoadingLevel(o))return void(this.state=Ws.PLAYLIST_LOADING);let h=this.fragPrevious;if(!d.live&&h&&h.isLastFragment&&!l.iframes){const e=Math.min(i.duration,h.start+h.duration);let t=this.playingItemStartTime,a=0===r.len&&s!==e;if(e-Math.max(r.end,h.start)<=Math.max(.2,h.duration)&&!a)return this.logger.info(`check ending: ${JSON.stringify(r)} = this.getSourceBufferInfo(${s}); playingItemStartTime ${t}`)(),this.logger.info(`check ending: fragPrevious.sn ${h.sn} ${h.startPTS} ${h.isLastFragment}`)(),this.logger.info(`check ending: ${e-Math.max(r.end,h.start)} = ${e} - Math.max(${r.end}, ${h.start}) <= Math.max(0.2, ${h.duration})`)(),void(this.hls.config.gapless&&this.gaplessAllowed?this.hls.playingItem.itemId!==this.hls.loadingItem.itemId?this.logger.info(`[gapless] delay readyForNextItem because item ${this.hls.playingItem.itemId} is still playing and item ${this.hls.loadingItem.itemId} hasn't started`)():this.signalReadyForNextItem(r.end):(this.logger.info("video: item fully appended")(),this.hls.bufferController.endBuffer(this.altAudio?"video":void 0),this.state=Ws.ENDED))}this._flushingBuffer&&!this.iframeMode&&(n=this._startOffsetOfBufferFlush,a=void 0),this._fetchPayloadOrEos(s,n,a,d)}_prefetchIframes(e,t){if(!1===this.config.enableIFramePreloading)return;let i=this.hls.levelController.preloadiFrameLevelPlaylists();if(!i)return;let s=this.hls.levelController.getLevelWithPersistentId(i).levelInfo;if(!s||!s.iframes)return void this.logger.warn("Non-iframe level was preloaded ${iFrameLevel} ${iFrameLevelInfo?.iframes}")();let r=s.details;if(r&&this.fragPrevious){let s=this.fragPrevious.cc;r.initSegments[s]&&!r.initSegments[s].data&&(this._loadFragmentOrKey(r.initSegments[s],r,e,t),this.hls.keyLoader.getKeyFromDecryptData(r.initSegments[s].decryptdata,i).pipe(Qe(this.destroy$)).subscribe())}}getSourceBufferInfo(e,t=this.config.maxBufferHole){return Cs.bufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,e,t)}_getVideoAudioSourceBufferInfo(){let e;return e=this.loadedmetadata?this._getPlaybackPos():this.nextLoadPosition,Cs.bufferInfo(this.media?this.media:this.mediaBuffer,e,this.config.maxBufferHole)}combinedBufferEmpty(){let e=this._getVideoAudioSourceBufferInfo().len<this.config.almostDryBufferSec,t=e;if(this.subtitleStreamController.isSubtitleTrackEnabled()){let i=this.subtitleStreamController.estimateCurrentWaterLevel()<this.config.almostDryBufferSec;t=e||i}return t}estimateCurrentWaterLevel(){return this._getVideoAudioSourceBufferInfo().len}_getPlaybackPos(){return Object(Oi.c)(this.seekToPos)?this.seekToPos:this.media.currentTime}resetNextLoadPositionState(){this.loadedmetadata||(this.nextLoadPosition,this.seekToPos,this.logger.info("_resetNextLoadPositionState")(),this.seek(this.seekToPos),this.startFragRequested=!1)}_fetchPayloadOrEos(e,t,i,s){var r;const a=this.fragPrevious,n=s.fragments,o=n.length;if(0===o)return;let l,d=n[0].start,h=n[o-1].start+n[o-1].duration;if(s.live){let e=this.config.initialLiveManifestSize;if(o<e)return void this.logger.warn(`Can not start playback of a level, reason: not enough fragments ${o} < ${e}`)();if(null===(l=this._ensureFragmentAtLivePoint(s,t,d,h,a,n,o)))return}else t<d&&(l=n[0]);let c=this.hls.levelWithPersistentId(this.levelId).levelInfo;if(!l)if(c.iframes&&this.iframeMode){const e=this.iframeReferenceClockTime,o=this.media.currentTime,d=this.desiredRate,h=i<2?this.hls.config.initialIframeFPS:this.hls.config.desiredIframeFPS,c=this.hls.config.leftMediaTimeToAutoPause;let u=this.media.seekable,f=u.start(0),g=u.end(u.length-1);if(d>1&&g-e<c)return this.logger.info(`[iframes] near the end of media, resuming normal playback, bufferLen: ${i}, maxTime ${g}, ifrct ${e}`)(),this.autoPausedRestartTime=g-c,this.hls.setRate(0),void this.tick();if(d<0&&e-f<d/-2)return this.logger.info(`[iframes] near the start of media, pausing playback at ${this.autoPausedRestartTime} left, bufferLen: ${i}, minTime ${f}, ifrct ${e}`)(),this.autoPausedRestartTime=f,this.hls.setRate(1),void this.tick();if(this.iframeEOS)return;let p=a&&a.iframe&&Object(Oi.c)(this.iframeBaseTime)?a:void 0;if(this.logger.info(`[iframes] prev sn: ${a?a.sn:"N/A"}, level: ${a?a.level:"N/A"}, cc: ${a?a.cc:"N/A"}, iframe: ${a?a.iframe:"N/A"}, mt: ${o.toFixed(3)}, ifrct: ${e.toFixed(3)}, ifrate: ${d}, iffps: ${h}, buffered: ${this.bufferedRangeString}, bufferLen: ${i.toFixed(3)}, seeking: ${this.media.seeking}, readyState: ${this.media.readyState}`)(),isNaN(this.iframeMediaAnchorTime)){this._resetIframeFragments(),this.iframeEOS=!1;let t=$s.findNextIframe(void 0,e,d,e,e,n);if(!t)return this.logger.info(`[iframes] no anchorFrag for time ${e}, setting iframeEOS`)(),void(this.iframeEOS=!0);let i=$s.getTimeRangeForCC(n,t.cc),s=Math.abs(d);const a=2;if(d>1&&(i[1]-e)/s<a)return void this.logger.info(`[iframes] FF too close to end of ccRange: ${i[0].toFixed(3)}-${i[1].toFixed(3)}, at ifrct: ${e.toFixed(3)}, wait to anchor`)();if(d<0&&(e-i[0])/s<a)return void this.logger.info(`[iframes] RW too close to start of ccRange: ${i[0].toFixed(3)}-${i[1].toFixed(3)}, at ifrct: ${e.toFixed(3)}, wait to anchor`)();let o;this.ccRange=i,this.iframeBaseTime=e;let l="N/A";if(d>1)o=this.iframeBaseTime;else{let e=this.audioStreamController?this.audioStreamController.getAudioTimeRangeForCC(t.cc):void 0;e.length?(o=Math.max(e[0],i[0]),l=e?`${e[0].toFixed(3)}-${e[1].toFixed(3)}`:"N/A"):o=i[0]+this.config.maxBufferHole}if(this.iframeMediaAnchorTime=Math.ceil(o),this.logger.info(`[iframes] setting initial ifbt: ${e.toFixed(3)}, startCCTime: ${o.toFixed(3)}, ccRange: ${i[0].toFixed(3)}-${i[1].toFixed(3)}, audioCCRange: ${l}, for cc: ${t.cc}`)(),"no"===this.bufferController.isCompatibleTransition(t.cc)){const e={seekToPos:this.iframeMediaAnchorTime,cc:t.cc};return this.logger.info("[iframes] resetting source buffer for incompatible cc")(),this.fragPrevious=void 0,this.iframeMediaAnchorTime=void 0,void this.resetMediaSource(e,!0)}return null===(r=this.audioStreamController)||void 0===r||r.startLoadAtTargetTime({cc:t.cc,seekToPos:this.iframeMediaAnchorTime}),this.immediateLevelSwitch(!0),void this.seek(this.iframeMediaAnchorTime)}if(this.ccRange&&(this.ccRange[0]>e||this.ccRange[1]<e))return this.logger.info(`[iframes] ifrct: ${e.toFixed(3)} is outside of ccRange: ${this.ccRange[0].toFixed(3)}-${this.ccRange[1].toFixed(3)}, clearing iframeMediaAnchorTime`)(),this.fragPrevious=void 0,this.iframeMediaAnchorTime=void 0,void(this.altAudio&&this.audioStreamController&&this.audioStreamController.flushAudioBuffer(0,Number.POSITIVE_INFINITY));if(!this.media.seeking){const e=Math.abs(d)/4;this.maxIframeRealTime=Bs.getIframeRealTime(t,this.iframeMediaAnchorTime,this.iframeBaseTime,this.desiredRate);let i=this.iframeLagTime;i>e&&(i=d>1?i:-1*i,this.iframeMediaAnchorTime=t,this.iframeBaseTime=this._getBoundedTime(this.maxIframeRealTime+i),this.logger.info(`[iframes] catch-up mode, max_ifrt ${this.maxIframeRealTime.toFixed(3)}, diff from reference: ${i.toFixed(3)}, new ifmat: ${this.iframeMediaAnchorTime.toFixed(3)}, new ifbt: ${this.iframeBaseTime.toFixed(3)}`)())}const m=this.iframeMediaAnchorTime,y=this.iframeBaseTime,v=1/h;if(this.logger.info(`[QE Critical] [iframes] picked frag params maxMediaTime: ${t}, ifmat: ${m}, ifbt: ${y}`)(),(l=$s.findNextIframe(p,t,d,m,y,n))&&a&&l.cc!==a.cc)return;l?s.initSegments[l.cc]&&!s.initSegments[l.cc].data?(l=s.initSegments[l.cc],this.logger.info("[iframes] loading init segment")()):(this.scaledFragments||(this.scaledFragments=[]),s.live&&(this.ccRange=$s.getTimeRangeForCC(n,l.cc)),l.iframeMediaStart=t,l.iframeMediaDuration=Math.max(l.duration/Math.abs(d),v),this.logger.info(`[iframes] picked frag sn: ${l.sn}, level: ${l.level}, cc: ${l.cc}, range: ${l.rangeString}, iframeMediaStart ${l.iframeMediaStart.toFixed(3)}, iframeMediaDuration: ${l.iframeMediaDuration.toFixed(3)}, ifmat: ${m.toFixed(3)}, ifbt: ${y.toFixed(3)}`)(),this.scaledFragments.push(l)):p?(this.logger.error("[iframes] no more frags, but we should have found an end fragment, so set iframeEOS")(),this.iframeEOS=!0):(this.logger.error("[iframes] no initial iframe frag, so go back to rate 1")(),this.hls.setRate(1))}else l=this._findFragment(a,n,t,h,s);if(l){l.decryptdata&&l.decryptdata.isEncrypted&&this.fetchKey(l).subscribe();let i=s.initSegments[l.cc];i&&!i.data&&(l=i);const r=this.bufferController.isCompatibleTransition(l.cc),n="no"!==r,o=!n&&!this.pendingParsedData;let d="initSegment"===l.sn||n||o;a&&a.cc!==l.cc&&("no"===r&&this.pendingParsedData?this.logger.error(`[${this.sbid}} why are we back in idle you crazy controller? not compatible, already have cached frag ${l.fragTag}`)():d&&this.logger.info(`[${this.sbid}] loading into discontuity, frag ${l.fragTag}, isCompatible: ${r}, need to cache: ${o}, loadedmetadata: ${this.loadedmetadata}`)()),d&&(this.levelAtSwitch&&!this.iframeMode&&(this.levelAtSwitch=void 0),this._loadFragmentOrKey(l,s,e,t))}}_loadSessionDataIfNecessary(){let e=this.media;if(!this.sessionDataLoading&&e&&e.readyState>=e.HAVE_ENOUGH_DATA&&this.playbackLikelyToKeepUp){let e=this.hls.sessionData;if(!e||e&&!e.itemList)return;this.hls.trigger(s.b.SESSION_DATA_LOADING,{sessionData:e}),this.sessionDataLoading=!0}}get waitingForIncompatibleCC(){return this.state===Ws.WAITING_DISCONTINUITY}resetMediaSource(e,t=!1){this.startFragRequested=!1,this.needsResetForCC=void 0,this._bufferedFrags=[],this.tstalled=void 0,this.nudgeRetry=0,this.onMediaDetaching(),this.bufferResetResumeLoadInfo=e;const{cc:i,seekToPos:s}=e;this.logger.error(`[main] resetting media source for cc ${i}, seekToPos ${s}`)(),this.hls.bufferController.resetMediaSource(t),this.hls.timelineController&&this.hls.timelineController.resetTracks()}setNeedsResetForCC(e){var t;this.cancelCurrentLoad(),null===(t=this.audioStreamController)||void 0===t||t.cancelCurrentLoad(),this.needsResetForCC=e}_ensureFragmentAtLivePoint(e,t,i,s,r,a,n){const o=this.hls.config,l=this.media;let d,h=void 0!==o.liveMaxLatencyDuration?o.liveMaxLatencyDuration:o.liveMaxLatencyDurationCount*e.targetduration;if(t<Math.max(i-o.maxFragLookUpTolerance,s-h)){let s=this.liveSyncPosition=this.computeLivePosition(i,e);t=s,l&&l.readyState&&l.duration>s&&(this.logger.info("adjust currentTime to liveSyncPosition")(),l.currentTime=s)}if(e.PTSKnown&&t>s&&l&&l.readyState)return null;if(this.startFragRequested&&!e.PTSKnown){if(r){var c=r.sn+1;c>=e.startSN&&c<=e.endSN&&(d=a[c-e.startSN])}d||(d=a[Math.min(n-1,Math.round(n/2))])}return d}_findFragment(e,t,i,s,r){const a=this.hls.config;let n,o,l=a.maxFragLookUpTolerance;if((o=$s.findFragmentBySNAndBuffer(e,t,i,s,l))&&"initSegment"!==o.sn){const i=o.sn-r.startSN,s=e&&o.level===e.level,l=t[i-1],d=t[i+1];if(n=o,e&&n.sn===e.sn)if(s&&!n.backtracked)if(n.sn<r.endSN){let t=e.deltaPTS;t&&t>a.maxBufferHole&&e.dropped&&i?(n=l,this.logger.warn("SN just loaded, with large PTS gap between audio and video, maybe frag is not starting with a keyframe ? load previous one to try to overcome this")(),e.loadCounter--):n=d}else n=null;else n.backtracked&&(d&&d.backtracked?(this.logger.warn(`Already backtracked from fragment ${d.sn}, will not backtrack to fragment ${n.sn}. Loading fragment ${d.sn}`)(),n=d):(this.logger.warn("Loaded fragment with dropped frames, backtracking 1 segment to find a keyframe")(),n.dropped=0,l?(l.loadCounter&&l.loadCounter--,(n=l).backtracked=!0):n=null))}return n}_ensureDemuxer(){this.demuxer||(this.demuxer=new Ks(this.hls,"main"))}_destroyDemuxer(){Object(Ys.clearImmediate)(this.demuxImmediate),this.demuxer&&(this.demuxer.destroy(),this.demuxer=null)}_loadFragmentOrKey(e,t,i,a){const n=this.hls,o=n.config;if(this.logger.info(`${e.type} loading ${e.fragTag} of [${t.startSN},${t.endSN}], iframe:${t.iframesOnly} range: ${e.rangeString}, currentTime: ${this.media.currentTime}, pos:${i?i.toFixed(3):"undefined"}, bufferEnd:${a?a.toFixed(3):"undefined"}, loadCount:${e.loadCounter} URL ${this.hls.redactUrl(e.relurl)} `)(),void 0!==this.fragLoadIdx?this.fragLoadIdx++:this.fragLoadIdx=0,e.loadCounter){e.loadCounter++;let t=o.fragLoadingLoopThreshold;if(e.loadCounter>t&&Math.abs(this.fragLoadIdx-e.loadIdx)<t){let t=new r.j(r.g.MEDIA_ERROR,r.d.FRAG_LOOP_LOADING_ERROR,!1,"Frag has already been loaded more than 3 times",r.f.CorruptStream,e);return t.iframe=e.iframe,void n.trigger(s.b.INTERNAL_ERROR,t)}}else e.loadCounter=1;e.loadIdx=this.fragLoadIdx,this.fragCurrent=e,this.startFragRequested=!0,"initSegment"!==e.sn&&(e.iframe?this.nextLoadPosition=e.iframeMediaStart+e.iframeMediaDuration:this.nextLoadPosition=e.start+e.duration),e.autoLevel=n.autoLevelEnabled,e.bitrateTest=this.bitrateTest,this.logFragmentTiming(e,"loading"),n.fragmentLoader.loadFragment(e).then(function(t){this.logFragmentTiming(e,"loaded"),this._processLoadedFrag(t)}.bind(this)).catch(function(e){this._handleFragmentError(e)}.bind(this)),this.demuxImmediate=Object(Ys.setImmediate)(this._ensureDemuxer.bind(this)),this.state=Ws.FRAG_LOADING}set state(e){const t=this.state;super.state=e,this.hls.trigger(s.b.STREAM_STATE_TRANSITION,{previousState:t,nextState:e})}get state(){return super.state}getBufferedFrag(e){return ks(this._bufferedFrags,(function(t){let i=t.iframe?t.iframeMediaStart:t.startPTS,s=t.iframe?t.iframeMediaStart+t.iframeMediaDuration:t.endPTS;return e<i?-1:e>s?1:0}))}get currentLevel(){let e=this.media;if(e){const t=this.getBufferedFrag(e.currentTime);if(t)return t.level}return-1}get nextBufferedFrag(){let e=this.media;return e?this.followingBufferedFrag(this.getBufferedFrag(e.currentTime)):null}followingBufferedFrag(e){return e?this.getBufferedFrag(e.endPTS+.5):null}get nextLevel(){const e=this.nextBufferedFrag;return e?e.level:-1}_checkFragmentChanged(){var e,t,i=this.media;if(i&&i.readyState&&!1===i.seeking&&((t=i.currentTime)>i.playbackRate*this.lastCurrentTime&&(this.lastCurrentTime=t),Cs.isBuffered(i,t)?e=this.getBufferedFrag(t):Cs.isBuffered(i,t+.1)&&(e=this.getBufferedFrag(t+.1)),e)){var r=e;if(r!==this.fragPlaying){this.hls.trigger(s.b.FRAG_CHANGED,{frag:r});const e=r.level;this.fragPlaying&&this.fragPlaying.level===e||this.hls.trigger(s.b.LEVEL_SWITCHED,{level:e}),this.fragPlaying=r}}}_resetIframeFragments(){if(!this.scaledFragments)return;let e=this.scaledFragments;for(let t=0;t<e.length;t++){let i=e[t];i.loadCounter=0,Object(Oi.c)(i.iframeMediaStart)&&(i.iframeMediaStart=void 0,i.iframeMediaDuration=void 0)}this.scaledFragments=void 0}get seeking(){return Object(Oi.c)(this.seekToPos)||this.media&&this.media.seeking}adjustSeekPosition(e){let t=this.media,i=Cs.bufferInfo(t,e,0),s=e;if(0===i.len){let t=Math.max(this.config.maxBufferHole,this.config.maxFragLookUpTolerance);(s=this._ensureNudgeStartTime(i.nextStart,e,t,this.state))&&this.logger.warn(`adjusted seek ${e}->${s}`)()}return s}seek(e,t=!0){var i,r;if(isNaN(e))return;if(e<0)return void(this.seekToPos=void 0);if(this.media&&t){let t=this.adjustSeekPosition(e);Math.abs(e-t)>=Number.EPSILON&&(e=t)}let a=isNaN(this.seekToPos)||Math.abs(e-this.seekToPos)>=Number.EPSILON;if(this.nextLoadPosition=this.lastCurrentTime=this.seekToPos=e,this.playbackLikelyToKeepUp=!1,this.media){if(a){if(null===(i=this.audioStreamController)||void 0===i?void 0:i.hasInitialSeekToPos){const t=this.ccForTime(e);this.logger.info(`[main] audioStreamController issuing seek to: ${e}, cc: ${t}`)(),null===(r=this.audioStreamController)||void 0===r||r.startLoadAtTargetTime({cc:t,seekToPos:e})}this.iframeMode||(this.logger.info(`startSeek(${e})`)(),this.hls.trigger(s.b.SEEKING))}this.media.paused||this._mediaPause(),t&&e>=0&&this.loadedmetadata&&this.media.currentTime!==e&&!this._flushingBuffer&&(this.logger.info(`adjust currentTime seekToPos=${e}`)(),this.iframeModeSeek=this.iframeMode,this.mediaSeekFn?this.mediaSeekFn(e):this.media.currentTime=e)}}completeSeek(){!Object(Oi.c)(this.seekToPos)||this.media.seeking||this._flushingBuffer||(this.logger.info(`completeSeek(${this.seekToPos}) currentTime=${this.media.currentTime}`)(),this.seekToPos=void 0,this.iframeModeSeek||this.hls.trigger(s.b.SEEKED),this.iframeModeSeek=!1)}set playbackLikelyToKeepUp(e){this._playbackLikelyToKeepUp!==e&&(this._playbackLikelyToKeepUp=e,this.hls.trigger(s.b.PLAYER_STATE_CHANGE,{playbackLikelyToKeepUp:e}))}get playbackLikelyToKeepUp(){return Boolean(this._playbackLikelyToKeepUp)}get _avgBufferAppendMs(){return!this._numAppends||this._numAppends<2?400:this._totalBufferAppendMs/this._numAppends}updateAppendBufferAvg(e){(isNaN(this._numAppends)||isNaN(this._totalBufferAppendMs))&&(this._numAppends=0,this._totalBufferAppendMs=0),this._totalBufferAppendMs+=e,++this._numAppends}get _avgParseBw(){return this._totalParseSec?this._totalParsedBits/this._totalParseSec:0}updateParseBwAvg(e,t){this._totalParseSec||(this._totalParsedBits=0,this._totalParseSec=0),this._totalParsedBits+=8*e,this._totalParseSec+=t/1e3}_likelyToAppendFragInTime(e,t,i,s){let r=t.len,a=this.mediaBuffer?this.getSourceBufferInfo(e):t,n=!1,o=1/0;if(a.len>=s)o=0;else if(this.fragCurrent&&Math.abs(this.fragCurrent.start-a.end)<=this.hls.config.maxBufferHole){let e=this._avgBufferAppendMs/1e3;if(this.fragCurrent.loader){let e=this.fragCurrent.loader.stats,t=i.realBitrate?Math.max(i.realBitrate,i.bitrate):i.bitrate,s=e.total?8*e.total:Math.ceil(this.fragCurrent.duration*t),r=8*e.loaded,a=s-r,n=r/(performance.now()-e.tfirst)*1e3;o=a/(n?Math.min(this.hls.abrController.getBandwidthEstimate(),n):this.hls.abrController.getBandwidthEstimate())}else if(this.state===Ws.PARSING){let e=(performance.now()-this.stats.tload)/1e3,t=8*this.stats.total/this._avgParseBw;o=Math.max(0,t-e)}else this.state===Ws.PARSED&&this.pendingBuffering&&(o=0);o+=e}return(n=o<=r)&&!this.playbackLikelyToKeepUp&&this.logger.info(`[main] Probably haveEnough bufferLen=${r} nextFragAppendedDur=${o.toFixed(3)}`)(),n}_checkIfPlaybackLikelyToKeepUp(){var e;if(!this.media||!this.loadedmetadata)return void(this.playbackLikelyToKeepUp=!1);let t=this.levelId,i=this.hls.levelWithPersistentId(t).levelInfo,s=i?i.details:void 0;if(!i||!s)return;let r=Object(Oi.c)(this.seekToPos)?this.seekToPos:this.media.currentTime,a=Cs.bufferInfo(this.media,r,this.hls.config.maxBufferHole),n=a.len;if(n<=0)return void(this.playbackLikelyToKeepUp=!1);let o=Math.min(s.targetduration,15);this.fragPrevious&&(o=Math.min(this.fragPrevious.duration,o));let l=Math.max(1,o*this.startTargetDurationFactor),d=this.iframeMode||n>=o||n>=l,h=s.fragments[s.fragments.length-1],c=s.fragments[0].start+s.totalduration,u="yes"!==this.bufferController.isCompatibleTransition(null===(e=this.fragCurrent)||void 0===e?void 0:e.cc)||this.fragCurrent&&this.fragPrevious&&this.fragCurrent.cc!==this.fragPrevious.cc;d&&s.live?d=r<=c-h.duration:s.live||(d=d||r>=c-o),d=d||u||this._likelyToAppendFragInTime(r,a,i,o),this.media&&!this.media.ended&&this.media.paused&&d&&0!==this.desiredRate&&!this._flushingBuffer&&(this.logger.info(`[main] haveEnough desiredRate=${this.desiredRate} bufferLen=${n} discontinuity=${u}`)(),this._mediaPlay()),d?this.completeSeek():this.media.controls&&this.seeking&&!this.media.paused&&(this.logger.warn(`Seeking but not enough buffer !media.paused bufferLen=${n}`)(),this._mediaPause()),this.playbackLikelyToKeepUp=d&&this.media&&this.media.readyState>=this.media.HAVE_ENOUGH_DATA}_mediaPlay(){if(this.media){if(this.playPromise||this._flushingBuffer)return void this.logger.warn(`Ignoring play command playPromise/flushing ${Boolean(this.playPromise)}/${this._flushingBuffer}`)();this._expectPlayEvent=this._expectPlayEvent||this.media.paused,this.logger.info(`play() expectPlayEvent=${this._expectPlayEvent}`)(),this.playPromise=this.media.originalPlay(),this.playPromise&&this.playPromise.then(function(){this.playPromise=null,this._handlePendingPlayPromises()}.bind(this)).catch(function(e){this.playPromise=null,this._expectPlayEvent=!1,this._handlePendingPlayPromises(e||{}),"NotAllowedError"===e.name?(this.logger.warn("play() not allowed, going back to rate 0")(),this.hls.desiredRate=0):this.logger.error(e.message)()}.bind(this))}}_handlePendingPlayPromises(e){let t=this.pendingPlayPromises,i=t.length;if(e)for(let s=0;s<i;s++)t[s].reject(e);else for(let e=0;e<i;e++)t[e].resolve();this.pendingPlayPromises=[]}_mediaPauseInternal(){this._expectPauseEvent=this._expectPauseEvent||!this.media.paused,this.logger.info(`pause() expectPauseEvent=${this._expectPauseEvent}`)(),this.media.originalPause()}_mediaPause(){this.media&&(this.logger.info(`pause() playPromise=${Boolean(this.playPromise)}`)(),this.playPromise?this.playPromise.then(()=>{(0===this.desiredRate||this.seeking&&!this.playbackLikelyToKeepUp)&&this._mediaPauseInternal()}):this._mediaPauseInternal())}_getBoundedTime(e){return isNaN(this.lastMediaDuration)?Math.max(0,e):Math.min(this.lastMediaDuration,Math.max(0,e))}_getIframeReferenceClockTime(e){let t=(e-this.iframeReferenceClockStart)*this.desiredRate/1e3+this.iframeReferenceClockMediaTimeBase;return this._getBoundedTime(t)}get iframeReferenceClockTime(){return this._getIframeReferenceClockTime(performance.now())}get iframeLagTime(){return isNaN(this.maxIframeRealTime)?0:this.desiredRate>1?Math.max(0,this.iframeReferenceClockTime-this.maxIframeRealTime):this.desiredRate<0?Math.max(0,this.maxIframeRealTime-this.iframeReferenceClockTime):void 0}get realCurrentTime(){return this.iframeMode?this.iframeReferenceClockTime:Object(Oi.c)(this.seekToPos)?this.hls.isPreloadingItem?this.seekToPos-this.playingItemStartTime:this.seekToPos:this.media?this.hls.isPreloadingItem?this.media.currentTime-this.playingItemStartTime:this.media.currentTime:void this.logger.info("invalid realCurrentTime")()}set realCurrentTime(e){let t=this.hls.isPreloadingItem?this.playingItemStartTime:0;this.logger.info(`[gapless] set realCurrentTime = ${e+t}`)(),this.media.currentTime=e+t}get iframeMode(){return this.isIframeRate(this.desiredRate)}get effectiveRate(){return this.media?this.iframeMode?this.desiredRate:this.media.paused?0:1:0}isIframeRate(e){return 0!==e&&1!==e}get canContinuePlaybackWithoutGap(){let e=this.hls.nextLoadLevel,t=this.hls.levelWithPersistentId(e).levelInfo,i=t?t.details:void 0;return Cs.canContinuePlaybackWithoutGap(this.mediaBuffer||this.media,this.media.currentTime,this.config.maxBufferHole,this.hls.playlistType,i)&&(!this.altAudio||!this.audioStreamController||this.audioStreamController.canContinuePlaybackWithoutGap)}get desiredRate(){return void 0!==this._desiredRate?this._desiredRate:0}set desiredRate(e){if(!this.media)return;const t=this.desiredRate,i=this.isIframeRate(e),r=this.isIframeRate(this.desiredRate);if(!i&&!r||t===e)return this.logger.info(`Ordinary rate change ${t} -> ${e}`)(),this._desiredRate=e,this.hls.isLive&&t!==e&&(0===e?(this.hls.levelController.stopLoad(),this.altAudio&&this.hls.audioTrackController&&this.hls.audioTrackController.stopLoad()):this.canContinuePlaybackWithoutGap||(this._mediaPause(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY),this.pendingExpiredLiveBufferRange=null,this.altAudio&&this.audioStreamController&&this.audioStreamController.flushAudioBuffer(0,Number.POSITIVE_INFINITY),this.hls.levelController.cleanupLevels())),0!==e||this.media.paused?1===e&&this.media.paused&&this._checkIfPlaybackLikelyToKeepUp():this._mediaPause(),void(t!==e&&this.hls.trigger(s.b.DESIRED_RATE_CHANGED,{oldRate:t,newRate:e}));const a=performance.now(),n=this.realCurrentTime,o=this.media.currentTime;let l,d,h;if(r&&(d=this._getIframeReferenceClockTime(a),h=this.getSourceBufferInfo(this.iframeMediaAnchorTime).end,l=this.getBufferedFrag(Math.min(o,h)-.001)),this._resetIframeFragments(),this.iframeEOS=!1,this.iframeMediaAnchorTime=void 0,this.iframeBaseTime=void 0,this.iframeRateSetTime=a,this.fragPrevious=void 0,this._desiredRate=e,this.logger.info(`[iframes] rate change ${t} -> ${e}, rct: ${n.toFixed(3)}, mt: ${o.toFixed(3)}, ifrct: ${r?d.toFixed(3):"N/A"}`)(),i){let t=this.media.seekable.end(this.media.seekable.length-1);if(e>1&&t-o<this.hls.config.leftMediaTimeToAutoPause)return void this.logger.info("[iframes] not setting FF iframe rate, too close to end of media")();let i=!r;if(this.iframeReferenceClockStart=a,this.iframeReferenceClockMediaTimeBase=n,i){this.iframeSwitchTime=performance.now();let e=this.hls.levelWithPersistentId(this.levelId).levelInfo;e&&!e.iframes?this.levelAtSwitch=this.levelId:this.logger.warn(`currentLevel is in penalty or an i-frame level ${this.levelId} levelAtSwitch:${this.levelAtSwitch}`)(),isNaN(this.levelAtSwitch)&&(this.levelAtSwitch=this.hls.startLevel),this.muteValueAtSwitch=this.hls.media.muted,this.hls.media.muted=!0,this.iframesInSourceBuffer=void 0,this.hls.abrController.nextAutoLevel=-1;let t=this.hls.levelController.nextLoadLevel,i=this.hls.levelWithPersistentId(t).levelInfo,s=i&&i.width&&i.height?`${i.width}x${i.height}`:"N/A";this.hls.loadLevel=t,this.logger.info(`[QE Critical] [iframes] entering iframe mode, levelAtSwitch: ${this.levelAtSwitch}, iframeLevel: ${t}, resolution: ${s}, bandwidth: ${i?i.bandwidth:"undefined levelInfo"}`)()}else this.logger.info("[iframes] staying in iframe mode with rate switch")();this.immediateLevelSwitch(!0)}else if(r){let e,t=this.levelAtSwitch;this.logger.info(`[QE Critical]  [iframes] leaving iframe mode, iframeReferenceClockTime: ${d.toFixed(3)}, buffered: ${this.bufferedRangeString}, bufferEnd: ${h}, currentFrag: ${l?l.rangeString:"N/A"}, resume level: ${t}`)(),void 0!==this.autoPausedRestartTime?(this.logger.info(`[iframes] setting resumePosition to autoPausedRestartTime: ${this.autoPausedRestartTime.toFixed(3)}`)(),e=this.autoPausedRestartTime,this.autoPausedRestartTime=void 0):(this.logger.info(`[iframes] setting resumePosition to iframeReferenceClockTime: ${d.toFixed(3)}`)(),e=d),t=this.variantController.getTrickPlayResumeLevel(this.levelAtSwitch),this.logger.info(`[iframes] level before/during/after trickplay : ${this.levelAtSwitch}/${this.variantController.level}/${t}`)(),this.hls.media.muted=this.muteValueAtSwitch,this.hls.loadLevel=-1,this.hls.nextAutoLevel=t,this.levelAtSwitch=t,this.iframeSwitchTime=performance.now(),this.immediateLevelSwitch(!0),this.seek(e),this.hls.media.muted=this.muteValueAtSwitch}this.hls.trigger(s.b.DESIRED_RATE_CHANGED,{oldRate:t,newRate:e}),this.tick()}immediateLevelSwitch(e=!1){let t=this.media;this.immediateSwitch||(this.immediateSwitch=!0,t&&this._mediaPause());var i=this.fragCurrent;i&&i.loader&&i.loader.abort(),this.fragCurrent=null,this.pendingParsedData=void 0,this.fragLoadIdx+=2*this.config.fragLoadingLoopThreshold,this.flushMainBuffer(0,Number.POSITIVE_INFINITY,e),this.relaxHighBufferStallRule=0,this.immediateSwitchCanEnd=!0}immediateLevelSwitchEnd(){let e=this.media;if(!e||!this.loadedmetadata||!this.immediateSwitchCanEnd)return;let t=e&&e.buffered.length,i=performance.now()-this.iframeSwitchTime,s=!e.seeking||i>=this.config.iframeMaxExitSeekDuration;t&&s&&this.state!==Ws.BUFFER_FLUSHING&&(this.immediateSwitchCanEnd=!1,this.iframeSwitchTime=void 0,void 0!==this.iframeRateSetTime&&(this.logger.info(`[iframes] level switch to ${this.levelId} for (${this.desiredRate}x) playback, spentTime = ${performance.now()-this.iframeRateSetTime}`)(),this.iframeRateSetTime=void 0),this.relaxHighBufferStallRule=this.config.iframeStallMaxRetry,this.immediateSwitch=!1,Object(Oi.c)(this.seekToPos)||Cs.isBuffered(e,e.currentTime)&&(e.currentTime=Math.max(0,e.currentTime-1e-4),this.logger.info(`immediateLevelSwitchEnd nudged currentTime to ${e.currentTime} seekable ${JSON.stringify(this.media.seekable)} readyState ${this.media.readyState}`)()))}nextLevelSwitch(){let e=this.media;if(e&&e.readyState){let a,n,o;if(this.fragLoadIdx+=2*this.config.fragLoadingLoopThreshold,(n=this.getBufferedFrag(e.currentTime))&&n.startPTS>1&&this.flushMainBuffer(0,n.startPTS-1),e.paused)a=0;else{var t=this.hls.nextLoadLevel,i=this.hls.levelWithPersistentId(t).levelInfo,s=this.fragLastKbps;a=s&&this.fragCurrent?this.fragCurrent.duration*i.bitrate/(1e3*s)+1:0}if((o=this.getBufferedFrag(e.currentTime+a))&&(o=this.followingBufferedFrag(o))){var r=this.fragCurrent;r&&r.loader&&r.loader.abort(),this.fragCurrent=null,this.flushMainBuffer(o.startPTS,Number.POSITIVE_INFINITY)}}}attemptSafeNextLevelSwitch(){if(!1===this.hls.config.allowFastSwitchUp||this.hls.iframeMode)return;let e=this.media;if(e&&e.readyState&&this.hls.abrController.isSafeToFlushExcessBuffer()){let i,s;if(this.fragLoadIdx+=2*this.config.fragLoadingLoopThreshold,i=this.hls.abrController.getSafeBufferFlushPosition()+this.hls.config.maxStarvationDelay,s=this.getBufferedFrag(e.currentTime+i)){let e=this.followingBufferedFrag(s);if(e){var t=this.fragCurrent;t&&t.loader&&t.loader.abort(),this.fragCurrent=null,this.flushMainBuffer(e.startPTS,Number.POSITIVE_INFINITY),this.hls.isLive&&(this.fragPrevious=s,this.preserveFragPrevious=!0)}}}}flushMainBuffer(e,t,i=!1,s,r){this.state=Ws.BUFFER_FLUSHING,this._flushingBuffer=!0,this._startOffsetOfBufferFlush=e,this.hls.bufferController.flushBufferRange(e,t,this.altAudio?"video":void 0,i,s,r)}installMediaFunctions(e){if(e&&e.play&&e.pause){let t,i;t=e.originalPlay?e.originalPlay:e.originalPlay=e.play.bind(e),i=e.originalPause?e.originalPause:e.originalPause=e.pause.bind(e),e.play=function(){let e=this.media;return e&&e.paused&&!e.seeking&&e.duration&&e.currentTime&&e.currentTime>=e.duration-this.hls.config.maxTotalDurationTolerance&&(this.fragPrevious=void 0,this.seek(0)),this.hls.desiredRate=1,e.currentTime>0&&!e.paused&&!e.ended&&e.readyState>2?Promise.resolve():new Promise((e,t)=>{this.pendingPlayPromises.push({resolve:e,reject:t})})}.bind(this),e.pause=function(){this.hls.desiredRate=0}.bind(this),"function"==typeof HTMLMediaElement&&(Object.defineProperty(e,"currentTime",{enumerable:!0,configurable:!0,get:function(){return Object.getPrototypeOf(this),Object.getOwnPropertyDescriptor(HTMLMediaElement.prototype,"currentTime").get.call(this)},set:this.seek.bind(this)}),this.mediaSeekFn=Object.getOwnPropertyDescriptor(HTMLMediaElement.prototype,"currentTime").set.bind(e)),this.config.overridePlaybackRate&&Object.defineProperty(e,"playbackRate",{enumerable:!0,configurable:!0,get:function(){return 1},set:function(e){Object.getOwnPropertyDescriptor(HTMLMediaElement.prototype,"playbackRate").set.call(this,e)}})}}uninstallMediaFunctions(){let e=this.media;e&&(e.originalPlay&&(e.play=e.originalPlay,delete e.originalPlay),e.originalPause&&(e.pause=e.originalPause,delete e.originalPause),this.mediaSeekFn&&(delete e.currentTime,this.mediaSeekFn=null),this.config.overridePlaybackRate&&(e.playbackRate=1,delete e.playbackRate))}onMediaAttaching(e){let t=this.hls,i=-1;if(this.levels&&this.levels.length>0)if(t.pendingSeekToDate)i=t.resolvePendingSeekToDate(),t.pendingSeekToDate=void 0;else{let e=this.config;e.autoStartLoad&&(i=e.startPosition)}this.playPromise=null,this._expectPauseEvent=this._expectPlayEvent=!1,this._attachMedia(e.media,i)}_attachMedia(e,t=NaN){let i=this.hls;this.media=this.mediaBuffer=e,this.mediaEventListeners={seeking:this.onMediaSeeking.bind(this),seeked:this.onMediaSeeked.bind(this),ended:this.onMediaEnded.bind(this),playing:this.onMediaPlaying.bind(this),play:this.onMediaPlay.bind(this),pause:this.onMediaPause.bind(this),durationchange:this.onMediaDurationChange.bind(this),timeupdate:this.onMediaTimeUpdate.bind(this)};for(let t in this.mediaEventListeners)e.addEventListener(t,this.mediaEventListeners[t]);void 0===this._desiredRate&&(this._desiredRate=e.autoplay?1:e.paused?0:1,this.logger.info(`Setting desiredRate based on media state ${this._desiredRate}`)()),e.autoplay&&this._mediaPause(),this.bufferMonitor&&this.bufferMonitor.destroy(),this.bufferMonitor=new Ns(this.hls,this.media,()=>this.estimateCurrentWaterLevel(),Ms.VideoAudio,this.config.maxBufferHole,this.maxBufferAheadSec,this.config.defaultTargetDuration,this.config.almostDryBufferSec),this.stallMonitor&&this.stallMonitor.destroy(),this.stallMonitor=new class extends P{constructor(e,t,i,r,a,n){super(e,s.b.BUFFER_APPENDED,s.b.DESIRED_RATE_CHANGED),this.media=t,this.lowBufferThreshold=i,this.lowBufferWatchdogPeriod=r,this.highBufferWatchdogPeriod=a,this.seekWatchdogPeriod=n,this.listenerMap={seeking:this.onseeking.bind(this),seeked:this.onseeked.bind(this),timeupdate:this.ontimeupdate.bind(this),ended:this.onended.bind(this),playing:this.onplaying.bind(this)},this.seekOrWaitingForPlay=t.seeking||t.paused||t.readyState<t.HAVE_FUTURE_DATA,this.addListeners()}destroy(){this.removeListeners(),this.stop(),this.media=null,this.listenerMap=null,super.destroy()}addListeners(){let e=this.media;if(e)for(let t in this.listenerMap){let i=this.listenerMap[t];e.addEventListener(t,i)}}removeListeners(){let e=this.media;if(e&&this.listenerMap)for(let t in this.listenerMap){let i=this.listenerMap[t];e.removeEventListener(t,i)}}set lastCurrentTime(e){this.tlastCurrentTime=performance.now(),this._lastCurrentTime=e,this.start()}get lastCurrentTime(){return this._lastCurrentTime}ontimeupdate(){if(!this.media)return;let e=this.media.currentTime;e<this.lastCurrentTime&&!this.media.seeking&&this.logger.warn(`[stall] timeupdate went backward but not seeking ${e} ${this.lastCurrentTime}`)(),this.lastCurrentTime!==e&&(this.lastCurrentTime=e)}onseeking(){let e=!this.seekOrWaitingForPlay||Math.abs(this.media.currentTime-this.lastCurrentTime)>=Number.EPSILON;this.seekOrWaitingForPlay=!0,this.updateSeekWatchdogStart(e),e?this.lastCurrentTime=this.media.currentTime:this.start()}onseeked(){this.updateSeekWatchdogStart(!0),this.lastCurrentTime=this.media.currentTime}onplaying(){this.seekOrWaitingForPlay=!1,this.tseekWatchdogStart=void 0,this.lastCurrentTime=this.media.currentTime}onended(){this.stop()}onDesiredRateChanged(e){const t=e.oldRate,i=e.newRate;t!==i&&(0===t?(this.updateSeekWatchdogStart(!0),this.lastCurrentTime=this.media.currentTime):0===i&&this.stop())}onBufferAppended(){this.updateSeekWatchdogStart(),this.start()}onBufferFlushed(){this.start()}updateSeekWatchdogStart(e=!1){let t=this.media;(e||!isFinite(this.tseekWatchdogStart))&&this.seekOrWaitingForPlay&&t&&Os.isBuffered(t,t.currentTime)&&(this.tseekWatchdogStart=performance.now())}stop(){this.stallMonitorTimer&&(clearTimeout(this.stallMonitorTimer),this.stallMonitorTimer=null)}get tstalled(){return this.seekOrWaitingForPlay?this.tseekWatchdogStart:this.tlastCurrentTime}start(){let e=this.media,t=e.currentTime;if(this.stop(),!e||0===this.hls.desiredRate||e.ended||0===e.buffered.length||e.seeking&&!Os.isBuffered(e,t)||void 0===this.tlastCurrentTime||t!==this.lastCurrentTime)return;let i,s=performance.now(),r=this.tstalled;if(i=this.seekOrWaitingForPlay?this.seekWatchdogPeriod:Os.bufferInfo(e,t,0).len<=this.lowBufferThreshold?this.lowBufferWatchdogPeriod:this.highBufferWatchdogPeriod,!isFinite(r))return;let a=Math.max(100,1e3*i-(s-r));this.stallMonitorTimer=setTimeout(this.checkForStall.bind(this),a)}checkForStall(){let e,t=performance.now(),i=this.media,r=i.currentTime;if(r===this.lastCurrentTime){let s=this.tstalled,a=t-s,n=Os.bufferInfo(i,r,0),o=n.len<=this.lowBufferThreshold,l=this.seekOrWaitingForPlay?xs.b.Seek:o?xs.b.LowBuffer:xs.b.HighBuffer;(l===xs.b.Seek&&a>=1e3*this.seekWatchdogPeriod||l===xs.b.HighBuffer&&a>=1e3*this.highBufferWatchdogPeriod||l===xs.b.LowBuffer&&a>=1e3*this.lowBufferWatchdogPeriod)&&(e={type:l,isLowBufferStall:o,bufferInfo:n,tstalled:s,stallDurationMs:a})}e?(this.logger.warn(`stall detected ${Math.round(e.stallDurationMs)}ms type:${e.type}`)(),this.hls.trigger(s.b.STALLED,e)):this.start()}}(this.hls,this.media,.5,this.hls.config.lowBufferWatchdogPeriod,this.hls.config.highBufferWatchdogPeriod,this.hls.config.seekWatchdogPeriod),Object(Oi.c)(t)&&i.startLoad(t)}onMediaDetaching(){var e=this.media;e&&e.ended&&this.seek(0);var t=this.levels;if(t&&t.length>0&&t.forEach(e=>{e.details&&e.details.fragments.forEach(e=>{e.loadCounter=void 0,e.backtracked=void 0})}),e){for(let t in this.mediaEventListeners)e.removeEventListener(t,this.mediaEventListeners[t]);this.mediaEventListeners={}}this._handlePendingPlayPromises({}),this.pendingPlayPromises=[],this.playPromise=null,this._expectPauseEvent=this._expectPlayEvent=!1,this.media=this.mediaBuffer=null,this.bufferMonitor&&(this.bufferMonitor.destroy(),this.bufferMonitor=null),this.stallMonitor&&(this.stallMonitor.destroy(),this.stallMonitor=null),this.loadedmetadata=!1,this.stopLoad()}onMediaDurationChange(){let e=this.media;e?this.lastMediaDuration=e.duration:this.logger.warn("Listening to media.durationchanged but this.media == null")()}onBufferSourceReset(e){const{cc:t,seekToPos:i}=this.bufferResetResumeLoadInfo;this.logger.info(`[QE Critical] Buffer source fully reset, starting load at seekToPos: ${i}, cc: ${t}`)(),this._attachMedia(e.media,i)}evictLoadingItem(e,t){let i=this.hls.loadingItem;this.flushMainBuffer(e,Number.POSITIVE_INFINITY,!0,{duration:e},e=>{this.hls.bufferController.updateDurationAfterEvictItem(e.duration),this.hls.trigger(s.b.ITEM_EVICTED,{url:i.url,evictedItemId:i.itemId,reason:t})})}dequeueSource(e=r.m.ApplicationInitiated){let t=this.playingItemStartTime,i=this.loadingItemStartTime;if(Object(Oi.c)(i)&&Object(Oi.c)(t)&&i>t){this.logger.info(`[gapless] dequeue preloaded url '${this.hls.loadingItem.url}' from ${i}s; playingItemStartTime ${t}`)();let s=this.media.currentTime;this.hls.stopLoad(),this.evictLoadingItem(i,e),this.hls.reloadSource(s)}}endSource(){this.logger.info("[gapless] end source")(),this.gaplessAllowed=!1,this.hls.bufferController.endBuffer(this.altAudio?"video":void 0),this.state=Ws.ENDED}shouldReloadLameDuck(e,t){if(!this.hls.config.gapless||this.hls.loadingItem===this.hls.playingItem)return!1;let i=this.loadingItemStartTime,s=0===e.len&&i&&i>t,r=e.len>0&&e.end<i;return s?this.logger.info(`[gapless] seek to unbuffered time range @ ${t}. bufferInfo ${JSON.stringify(e)} next item start time ${i}`)():r&&this.logger.info(`[gapless] seek to buffered time range @ ${t} but there are unloaded fragments after ${e.end}s. bufferInfo ${JSON.stringify(e)} next item start time ${i}`)(),s||r}onMediaSeeking(){let e=this.media,t=e?e.currentTime:void 0,i=this.config;if(!e)return void this.logger.warn("Listening to media.onseeking but this.media == null")();if(this.iframeModeSeek&&!this.iframeMode&&Object(Oi.c)(this.seekToPos))return void this.logger.info("received seeking event for wrong mode type, don't overwrite existing seekToPos")();Object(Oi.c)(t)&&this.logger.info(`media seeking to ${t.toFixed(3)}`)();let a=this.loadingItemStartTime,n=this.playingItemStartTime,o=this.getSourceBufferInfo(t);if(t<n&&o.end<n){this.logger.info(`[gapless] seeked out of playable range ${t} ${n}`)(),this.state=Ws.ERROR;let e=new r.h(r.g.OTHER_ERROR,r.d.INTERNAL_EXCEPTION,!0,"seeked out of playable range");this.hls.trigger(s.b.ERROR,e)}else{if(this.shouldReloadLameDuck(o,t))return this.logger.info(`[gapless] seek back to unfinished playing item ${t}; loadingItemStartTime ${a} playingItemStartTime ${n}`)(),this.hls.stopLoad(),this.evictLoadingItem(a,r.m.SeekToUnbufferedTimeRanges),void this.hls.reloadSource(t);if(this.state===Ws.FRAG_LOADING){let e=this.fragCurrent;if(0===o.len&&e){let s=i.maxFragLookUpTolerance,r=e.start-s,a=e.start+e.duration+s;this.iframeModeSeek&&(r=e.iframeMediaStart-s,a=e.iframeMediaStart+e.iframeMediaDuration+s),(t<r||t>a)&&(e.loader&&e.loader.abort(),this.fragCurrent=null,this.fragPrevious=null,this.state=Ws.IDLE)}}else if(this.state===Ws.ENDED)0===o.len&&(this.fragPrevious=void 0),this.state=Ws.IDLE;else if(this.state===Ws.WAITING_DISCONTINUITY){if(this.pendingParsedData){const e=this.ccForTime(t),i=this.pendingParsedData.frag.cc;this.logger.info(`[main] seeking while waiting for discontinuity pending, seekToCC: ${e}, pendingCC: ${i}`)()}this.ensurePendingDataForSeek(t)}else!this.iframeMode&&this.appended&&(this.state===Ws.PARSING||this.state===Ws.PARSED)&&this.fragCurrent&&(t<this.fragCurrent.startPTS||t>this.fragCurrent.endPTS)&&(this.hls.bufferController.abortPendingAppendsByParent("main",0,Number.POSITIVE_INFINITY),this.hls.bufferController.hasPendingAppends("main")||(this.appended=!1,this.pendingBuffering=!1,this.state=Ws.IDLE));this.state!==Ws.FRAG_LOADING&&void 0!==this.fragLoadIdx&&(this.fragLoadIdx+=2*i.fragLoadingLoopThreshold),this.seek(t,!1),this.tick()}}onMediaSeeked(){const e=this.media,t=e?e.currentTime:void 0;Object(Oi.c)(t)&&this.logger.info(`[QE Critical]  media seeked to ${t.toFixed(3)}`)(),Math.abs(t-this.seekToPos)>=Number.EPSILON&&this.logger.warn(`currentTime ${t} doesn't match last seekToPos ${this.seekToPos}`)(),this._checkIfPlaybackLikelyToKeepUp(),this.tick()}onMediaEnded(){}onMediaPlaying(){this.firstPlaybackStarted||(this.firstPlaybackStarted=!0),this._checkIfPlaybackLikelyToKeepUp()}onMediaPlay(){this._expectPlayEvent||(this.logger.warn(`Unexpected play event received seeking=${this.seeking}`)(),this.media.controls&&!this.seeking&&(this.logger.info("Assumed play came from controls, setting rate 1")(),this.hls.setRate(1))),this._expectPlayEvent=!1}onMediaPause(){this._expectPauseEvent||(this.logger.warn(`Unexpected pause event received seeking=${this.seeking}`)(),this.media.controls&&!this.seeking&&(this.logger.info("Assumed pause came from controls, setting rate 0")(),this.hls.setRate(0))),this._expectPauseEvent=!1}resetLoadSource(){this.fragCurrent=null,this.fragPrevious=null,this.altAudio=!1,this._destroyDemuxer(),this.onManifestLoading()}onManifestLoading(){this.hls.isPreloadingItem||this.hls.bufferController.resetBuffer(),this._bufferedFrags=[],this.tstalled=void 0,this.hls.isPreloadingItem||this.seek(0),this.clearPendingData(),this.gaplessAllowed=!0,this.startFragRequested=!1}startItemLoad(e,t,i,s){var r=e.some(e=>e.audioCodecList&&e.audioCodecList.some(e=>-1!==e.indexOf("mp4a.40.2")));let a=e.some(e=>e.audioCodecList&&e.audioCodecList.some(e=>-1!==e.indexOf("mp4a.40.5")));this.shouldOverrideCodec=r&&a,this.shouldOverrideCodec&&this.logger.warn("both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC")();let n=this.config;(n.autoStartLoad||this.forceStartLoad)&&(isNaN(s)&&(this.hls.pendingSeekToDate&&t?(s=this.hls.resolvePendingSeekToDate(),this.hls.pendingSeekToDate=void 0):s=n.startPosition),this.hls.startLoad(s))}_mergeLiveExpiredBufferRange(e,t){if(!e.start&&!e.end&&!this.pendingExpiredLiveBufferRange)return e;var i={start:void 0,end:void 0};if(this.pendingExpiredLiveBufferRange){var s=e.start?Math.min(this.pendingExpiredLiveBufferRange.start,e.start):this.pendingExpiredLiveBufferRange.start,r=e.end?Math.max(this.pendingExpiredLiveBufferRange.end,e.end):this.pendingExpiredLiveBufferRange.end;t>this.pendingExpiredLiveBufferRange.end&&t>e.end?(i={start:s,end:r},this.pendingExpiredLiveBufferRange=void 0):t<=this.pendingExpiredLiveBufferRange.end&&t<=e.end?this.pendingExpiredLiveBufferRange={start:s,end:r}:(i=this.pendingExpiredLiveBufferRange,this.pendingExpiredLiveBufferRange=e)}else t>e.end?i=e:this.pendingExpiredLiveBufferRange=e;return i}onLevelLoaded(e){var t=e.details,i=e.level,r=this.hls.levelWithPersistentId(i).levelInfo,a=t.totalduration,n=0;if(!(e.livePlaylistUpdateError||this.hls.isLive&&0===this.desiredRate)&&this.media){if(this.levelLastLoaded=i,t.live){var o=r.details;if(o&&t.fragments.length>0){let e=js.getExpiredFragmentsRange(o,t);if(js.mergeDetails(o,t),n=t.fragments[0].start,this.liveSyncPosition=this.computeLivePosition(n,o),t.PTSKnown,this.config.liveFlushExpiredFrags){var l=this._mergeLiveExpiredBufferRange(e,this.media.currentTime);l.start&&l.end&&this.flushMainBuffer(l.start,l.end)}}else t.PTSKnown=!1}else t.PTSKnown=!1;if(r.details=t,this.hls.trigger(s.b.LEVEL_UPDATED,{details:t,level:i}),!1===this.startFragRequested&&!this.hls.isPreloadingItem&&(void 0===this.seekToPos||-1===this.seekToPos||-1===this.lastCurrentTime||t.live&&0===this.seekToPos)){let e,i=t.startTimeOffset;this.hls.pendingSeekToDate&&(i=this.hls.resolvePendingSeekToDate(),this.hls.pendingSeekToDate=void 0),Object(Oi.c)(i)?(i<0&&(i=n+a+i),e=i):e=t.live?this.computeLivePosition(n,t):0,this.seek(e)}this.state===Ws.PLAYLIST_LOADING?this.state=Ws.IDLE:this.state===Ws.BUFFER_FLUSHING_WAITING_PLAYLIST&&(this.state=Ws.BUFFER_FLUSHING),this.tick()}}_processLoadedFrag(e){var t=this.fragCurrent,i=e.frag;if(this.state===Ws.FRAG_LOADING&&t&&"main"===i.type&&i.level===t.level&&i.sn===t.sn){let r=e.stats,a=this.hls.levelWithPersistentId(t.level).levelInfo;if(!a)return void(this.state=Ws.IDLE);let n=a.details;if(this.logger.info(`[QE Critical]  ${t.type} Loaded  ${t.sn} of [${n.startSN},${n.endSN}], level: ${t.level}, cc: ${t.cc}, start: ${t.start} URL ${this.hls.redactUrl(t.relurl)}, bytesLoaded: ${r.loaded}, fragLoadMs: ${r.tload-r.trequest}`)(),this.bitrateTest=!1,this.stats=r,!0===i.bitrateTest&&this.hls.nextLoadLevel)this.state=Ws.IDLE,this.startFragRequested=!1,r.tparsed=r.tbuffered=performance.now(),this.hls.trigger(s.b.FRAG_BUFFERED,{stats:r,frag:t,id:"main"}),this.tick();else if("initSegment"===i.sn)this.state=Ws.IDLE,r.tparsed=r.tbuffered=performance.now(),n.initSegments[i.cc].data=e.payload,this.hls.trigger(s.b.FRAG_BUFFERED,{stats:r,frag:t,id:"main"}),this.tick();else{this.state=Ws.PARSING;let s=n.totalduration,r=t.level,a=t.sn;this.pendingBuffering=!0,this.appended=!1,this.logger.info(`${t.type} Parsing ${a} of [${n.startSN} ,${n.endSN}],level ${r}, cc ${t.cc} URL ${this.hls.redactUrl(t.relurl)}`)();let o=this.media,l=!(o&&o.seeking)&&(n.PTSKnown||!n.live),d=n.initSegments[i.cc]?n.initSegments[i.cc].data:new Uint8Array;this._ensureDemuxer(),this.logFragmentTiming({level:r,sn:"initSegment",cc:t.cc},"parsing"),this.logFragmentTiming(t,"parsing"),this.demuxer.push(e.payload,d,t,s,l,void 0)}}this.fragLoadError=0,this.hls.trigger(s.b.FRAG_LOADED,e)}onFragParsingInitSegment(e){var t;const i=this.fragCurrent,s=e.frag;if(i&&"main"===e.id&&s.sn===i.sn&&s.level===i.level&&this.state===Ws.PARSING){const i=e.track,{codec:r,type:a}=i,n=this.bufferController.updateKnownCodecs(a,s.cc,r,void 0),o=this.bufferController.getCurrentInitInfoForParent(this.sbid),l=null===(t=this.hls.levelWithPersistentId(this.levelId))||void 0===t?void 0:t.levelInfo;"video"!==i.type&&"audiovideo"!==i.type||(this.logger.info("[gapless] disallowing gapless for non-audio track")(),this.gaplessAllowed=!1),this.logger.info(`[${s.type}] onFragParsingInitSegment, trackType: ${i.type}, frag: ${s.fragTag}, currentSbInitInfo: ${o?JSON.stringify(o):"N/A"}`)(),n||s.cc!==(null==o?void 0:o.cc)?this.doCreateSbAndAppendInitSegment(s,i,null==l?void 0:l.levelCodec):(this.logger.warn(`[${this.sbid}] incompatible codecs[parsed]=[${i.codec}] on track switch, will wait for a source buffer reset`)(),this.setNeedsResetForCC(s.cc))}}_ensureAudioStartLoad(e){var t,i;if(e&&(null===(t=this.audioStreamController)||void 0===t?void 0:t.waitingToStart)){const t=this.config.firstAudioMustOverlapVideoStart,s=this._getPlaybackPos();this.logger.info(`[main] received first frag ${e.fragTag}, and audioStreamController is waiting to start, frag startPTS: ${e.startPTS&&e.startPTS.toFixed(3)}, playbackPos: ${s}, mustOverlap: ${t}`)();const r=t?e.startPTS:s;if(isNaN(r)||r<0)return void this.logger.warn(`${this.name} ${e.fragTag} invalid seekToPos ${r} for audio start`)();null===(i=this.audioStreamController)||void 0===i||i.startLoadAtTargetTime({cc:e.cc,seekToPos:r})}}handleFragParsingData(e,t){var i,r;const a=e.frag,n=null===(i=this.hls.levelWithPersistentId(this.levelId))||void 0===i?void 0:i.levelInfo;t&&this.logger.info(`[${this.sbid}] handleFragParsingData parsing cached data for frag ${a.fragTag}`)();let o=this.hls.bufferController.isCompatibleTransition(a.cc);if("yes"!==o)this.logger.info(`[${this.sbid}] caching frag ${a.fragTag}, compatible: ${o}, seeking: ${null===(r=this.media)||void 0===r?void 0:r.seeking}, wasCached: ${t}`)(),this.setWaitingDiscontinuity(e);else if(this.state===Ws.PARSING)if(null!=this.waitingForKey.value)this.clearPendingData(),this.pendingParsedData=e,this.state=Ws.KEY_LOADING,this.logger.info(`[main] cached ${e.type} data from frag ${a.fragTag} to handle KEY_LOADING`)();else{let t=a;if(isNaN(e.endPTS)&&(e.endPTS=e.startPTS+a.duration,e.endDTS=e.startDTS+a.duration),this._ensureAudioStartLoad(t),this.ensureInitSegmentForFragInfo(a,e.track,void 0),"video"===e.type)if(t.dropped=e.dropped,t.dropped)if(t.backtracked)this.logger.warn("Already backtracked on this fragment, appending with the gap")();else{if(this.fragPrevious&&this.fragPrevious.cc===t.cc)return this.logger.warn(`missing video frame(s), backtracking fragment in ${t.cc}`)(),t.backtracked=!0,this.nextLoadPosition=e.startPTS,this.state=Ws.IDLE,this.fragPrevious=t,void this.tick();this.logger.warn(`missing video frame(s) in new cc ${t.cc}), reset dropped count and restart @ frag ${t.sn}`)(),e.dropped=0}else t.backtracked=!1;let i=this.hls;if(!this.iframeMode){let r=js.updateFragPTSDTS(n.details,t,e.startPTS,e.endPTS,e.startDTS,e.endDTS);i.trigger(s.b.LEVEL_PTS_UPDATED,{details:n.details,level:this.levelId,drift:r,type:e.type,start:e.startPTS,end:e.endPTS})}[e.data1,e.data2].forEach(s=>{Xs(e.type)?s&&s.length&&this.state===Ws.PARSING&&(this.appended=!0,this.pendingBuffering=!0,this.iframeMode&&(this.media.currentTime,this.iframeBaseTime,t.start,this.iframeBaseTime,"video"===e.type||e.type),this.logFragmentTiming(a,"appending"),i.bufferController.appendBuffer(e.type,s,e.startPTS,e.endPTS,"main","data",a)):this.logger.warn(`not appending data because of trackType ${e.type}`)()})}}onAudioTrackSwitching(e){var t=!!e.url,i=e.id;if(!t){if(this.mediaBuffer!==this.media){this.mediaBuffer=this.media;let e=this.fragCurrent;e.loader&&e.loader.abort(),this.fragCurrent=null,this.fragPrevious=null,this._destroyDemuxer(),this.state=Ws.IDLE}let e=this.hls;this.hls.bufferController.flushBufferRange(0,Number.POSITIVE_INFINITY,"audio"),e.trigger(s.b.AUDIO_TRACK_SWITCHED,{id:i}),this.altAudio=!1}}onAudioTrackSwitched(e){var t=e.id,i=this.hls.audioTrackController.resolveTrackId(t).trackInfo;if(!i)return;let s=!!i.url;if(s){let e=this.videoBuffer;e&&this.mediaBuffer!==e&&(this.mediaBuffer=e)}this.altAudio=s,this.tick()}onBufferCreated(e){let t,i,s,r=e.tracks,a=!1;for(s in r){let e=r[s];"main"===e.id?(i=s,t=e,"video"===s&&(this.videoBuffer=r[s].buffer)):a=!0}this.mediaBuffer=a&&t?t.buffer:this.media}onBufferAppended(e){let t=this.media;if(t.seeking&&t.paused&&t.buffered.length){let e=this.adjustSeekPosition(this.media.currentTime);Math.abs(t.currentTime-e)>=Number.EPSILON&&(t.currentTime=e)}if("main"===e.parent){e.frag&&this.logFragmentTiming(e.frag,"appended");const t=this.state;t!==Ws.PARSING&&t!==Ws.PARSED||(this.pendingBuffering=e.pending>0,this.checkAppendedParsed())}this.bufferMonitor.notifyWaterLevelChanged()}addIframeToCurrentLevel(e){e&&Object(Oi.c)(e.iframeMediaStart)&&(this.iframesInSourceBuffer&&this.iframesInSourceBuffer.level===e.level?this.iframesInSourceBuffer.buffered++:this.iframesInSourceBuffer={level:e.level,buffered:1,loading:0})}countIframesInCurrentLevel(e){let t=this.iframesInSourceBuffer&&e===this.iframesInSourceBuffer.level?this.iframesInSourceBuffer.buffered:0,i=0,s=this.fragCurrent;return s&&s.iframeMediaStart&&s.level===e&&i++,{level:e,loading:i,buffered:t}}checkAppendedParsed(){if(!(this.state!==Ws.PARSED||this.appended&&this.pendingBuffering)){const e=this.fragCurrent;if(e){const t=this.mediaBuffer?this.mediaBuffer:this.media;let i;this.logger.info(`main buffered: ${qs(t.buffered)} media.currentTime=${this.media.currentTime}`)(),e.iframe?(this.media.currentTime,this.iframeBaseTime,e.start,this.iframeBaseTime,(i=this._bufferedFrags.filter(e=>Cs.isBuffered(t,(e.iframeMediaStart+e.iframeMediaStart+e.iframeMediaDuration)/2))).push(e),this.addIframeToCurrentLevel(e),this._bufferedFrags=i.sort((function(e,t){return e.iframeMediaStart-t.iframeMediaStart}))):((i=this._bufferedFrags.filter(e=>Cs.isBuffered(t,(e.startPTS+e.startPTS+e.duration)/2))).push(e),this._bufferedFrags=i.sort((function(e,t){return e.startPTS-t.startPTS}))),this.fragPrevious=e;const r=this.stats;r&&!r.cached&&(r.tbuffered=performance.now(),this.fragLastKbps=Math.round(8*r.total/(r.tbuffered-r.tfirst)),this.updateAppendBufferAvg(r.tbuffered-r.tparsed),this.updateParseBwAvg(r.total,r.tparsed-r.tload)),this.hls.trigger(s.b.FRAG_BUFFERED,{stats:r,frag:e,id:"main"}),this.state=Ws.IDLE}this.tick()}}_handleFragmentError(e){if(e instanceof r.l){let t=e.details,i=this.variantController.variantManager.getVariantInfo(e.frag.level),s=(null==i?void 0:i.iframes)!==this.iframeMode;this._handleFragmentNetworkError(e,s),t===r.d.FRAG_LOAD_ERROR&&!e.fatal&&e.frag.iframe&&e.errorAction===Ds.AbortRequest&&(this.state=Ws.IDLE),this.resetNextLoadPositionState(),e.fatal&&this.escalateInternalError(e)}else this.logger.warn(`Unexpected error ${e.message}`)()}abortiFrameFragRequest(){this.cancelCurrentLoad()}onInternalError(e){if(super.handleInternalError(e))return;let t;if((e instanceof r.l||e instanceof r.k||e instanceof r.j||e instanceof r.o)&&(t=e.frag||this.fragCurrent)&&"main"!==t.type)return;this.hls.levelController.handleError(e);let i=this.media,s=i&&Cs.isBuffered(i,i.currentTime)&&Cs.isBuffered(i,i.currentTime+.5);if(e instanceof r.j)e.fatal||(t.iframe&&e.errorAction===Ds.AbortRequest?this.state=Ws.IDLE:this.retryFragRequest(e));else if(e instanceof r.b){let t=this._getVideoAudioSourceBufferInfo();this.handleBufferFullError(e,"main",this.levelId,t,s,()=>{this.fragCurrent=null,this.flushMainBuffer(0,Number.POSITIVE_INFINITY)})}else e instanceof r.k&&(this.state=e.fatal?Ws.ERROR:Ws.IDLE,this.logger.warn(`streamcontroller: ${e.details} while parsing frag,switch to ${this.state} state ...`)())}_ensureNudgeStartTime(e,t,i,s){let r=e;if(void 0===r&&s===Ws.WAITING_DISCONTINUITY){let e=this.fragCurrent?this.fragCurrent:this.fragPlaying;if(e){let i=this.hls.levelController.getLevelWithPersistentId(e.level).levelInfo,s=i?i.details.fragments:void 0,a=e.start+e.duration;s&&(e.start>t?r=e.start:a>t?r=a:this.logger.warn(`Cannot nudge to frag.sn ${e.sn} [${e.start},${a}] at incompatible discontinuity. nextBufferStart ${r} currentTime ${t}`)())}}if(Object(Oi.c)(r)){let e=r-t;(e>i||e<=0)&&(r=void 0)}return r}_checkIfLoadedMetadata(){let e=this.media;if(!e||!e.readyState)return;let t=e.currentTime,i=this.mediaBuffer?this.mediaBuffer:e,s=i.buffered,r=this.loadingItemStartTime;if(!this.loadedmetadata&&e.readyState>=e.HAVE_METADATA&&e.seekable.length&&s.length){this.loadedmetadata=!0,this.bufferResetResumeLoadInfo&&(this.logger.info(`[main] issuing seek for bufferResetResumeLoadInfo ${JSON.stringify(this.bufferResetResumeLoadInfo)}`)(),this.seek(this.bufferResetResumeLoadInfo.seekToPos,!1),this.bufferResetResumeLoadInfo=void 0),r=Object(Oi.c)(r)?r:0;const a=Object(Oi.c)(this.seekToPos)?this.seekToPos:r;let n=e.seeking?t:a;const o=Cs.isBuffered(i,n);this.hls.isPreloadingItem||t===n&&o||(o||e.seeking||(n=s.start(0),this.logger.info(`target start position not buffered, seek to buffered.start(0) ${n}`)()),this.logger.info(`adjust currentTime from ${t} to ${n}`)(),this.seek(n))}}onFragLoadEmergencyAborted(){this.state=Ws.IDLE,this.resetNextLoadPositionState(),this.tick()}onBufferFlushed(e){const t=this.mediaBuffer?this.mediaBuffer:this.media;this._bufferedFrags=this._bufferedFrags.filter(e=>Cs.isBuffered(t,(e.startPTS+e.endPTS)/2)),this.fragLoadIdx+=2*this.config.fragLoadingLoopThreshold,this.state===Ws.BUFFER_FLUSHING_WAITING_PLAYLIST?this.state=Ws.PLAYLIST_LOADING:this.state=Ws.IDLE,this.preserveFragPrevious||(this.fragPrevious=null),this.preserveFragPrevious=void 0,this._flushingBuffer=!1,this._startOffsetOfBufferFlush=void 0;let i=e&&e.seekAfterFlush;this.media&&Object(Oi.c)(this.seekToPos)&&i&&(this.logger.info(`[iframes] buffer flushed, iframeSeekTo: ${this.seekToPos.toFixed(3)}, currentTime: ${this.media.currentTime.toFixed(3)}, seekable: ${JSON.stringify(this.media.seekable)}, readyState ${this.media.readyState}`)(),this.seek(this.seekToPos)),this.bufferMonitor.notifyWaterLevelChanged(),this.tick()}ccForTime(e){var t;const i=null===(t=this.hls.levelWithPersistentId(this.levelLastLoaded).levelInfo)||void 0===t?void 0:t.details;let s;return i&&(s=ks(i.fragments,$s.fragmentWithinToleranceTest.bind(null,e,0))),null==s?void 0:s.cc}onLevelsChanged(e){if(e.requiresReset){if(this.state!==Ws.STOPPED&&this.media){let e=this.realCurrentTime;this.clearPendingData(),this.resetMediaSource({seekToPos:e,cc:this.ccForTime(e)})}}else(this.state===Ws.PLAYLIST_LOADING||this.state===Ws.KEY_LOADING||this.state===Ws.FRAG_LOADING&&!this.hls.levelController.getLevelWithPersistentId(this.fragCurrent.level).levelInfo||this.state!==Ws.STOPPED&&!this.hls.levelController.getLevelWithPersistentId(this.levelId).levelInfo)&&(this.cancelCurrentLoad(),this.clearPendingData(),this.hls.levels&&this.hls.levels.length>0?this.state=Ws.IDLE:(this.logger.error("Empty level list")(),this.state=Ws.ERROR),this.tick())}onBandwidthChanged(){this.tick()}onBufferChanged(){this.tick()}onStalled(e){var t,i;const a=this.hls,n=this.config,o=this.config.maxSeekHole;let l=e.type,d=e.isLowBufferStall,h=e.bufferInfo,c=e.stallDurationMs,u=this.media,f=u.currentTime;const g=h.len;let p=o;if(this.tstalled=e.tstalled,this.logger.warn(`stall state, audio state: ${null!==(i=null===(t=this.audioStreamController)||void 0===t?void 0:t.state)&&void 0!==i?i:"N/A"}, main state: ${this.state}, currentTime: ${f}, buffered: ${this.bufferedRangeString}`)(),this.checkDiscontinuityState(!0))return;if(!this.stallReported&&(this.stallReported=!0,this.logger.warn(`playback stall type:${l} @${f}, state: ${this.state}, buffer length: ${g}, buffered ranges: ${this.bufferedRangeString} stallMs=${Math.round(c)}`)(),!this.iframeMode)){let e=d?r.f.InsufficientDataAvailable:r.f.VideoDecoderBadDataErr,t=new r.c(r.g.MEDIA_ERROR,r.d.BUFFER_STALLED_ERROR,!1,"buffer stalled error",e);t.buffer=g,a.trigger(s.b.INTERNAL_ERROR,t)}let m,y=this.nudgeRetry||0;if(d){if(g>p)return void this.logger.warn("Got low buffer stall but above jump threshold")();var v=this._ensureNudgeStartTime(h.nextStart,f,n.maxSeekHole,this.state);if(v){this.nudgeRetry=++y;const e=y*n.nudgeOffset;this.logger.info(`adjust currentTime from ${u.currentTime} to next buffered @ ${v} + nudge ${e}`)(),u.currentTime=v+e,(m=new r.c(r.g.MEDIA_ERROR,r.d.BUFFER_SEEK_OVER_HOLE,!1,"got buffer seek over hole error",r.f.InsufficientDataAvailable)).hole=v+e-f,a.trigger(s.b.INTERNAL_ERROR,m)}}else if(this.relaxHighBufferStallRule)this.relaxHighBufferStallRule--,m=new r.c(r.g.MEDIA_ERROR,r.d.BUFFER_STALLED_ERROR,!1,"got buffer stalled error",r.f.VideoDecoderBadDataErr),a.trigger(s.b.INTERNAL_ERROR,m);else if(this.nudgeRetry=++y,y<n.nudgeMaxRetry){const e=u.currentTime,t=e+y*n.nudgeOffset;this.logger.info(`adjust currentTime from ${e} to ${t}`)(),u.currentTime=t,m=new r.c(r.g.MEDIA_ERROR,r.d.BUFFER_NUDGE_ON_STALL,!1,"got buffer nudge error on stall",r.f.InsufficientDataAvailable),a.trigger(s.b.INTERNAL_ERROR,m)}else this.logger.error(`still stuck in high buffer @${f} after ${n.nudgeMaxRetry}, raise fatal error`)(),m=new r.c(r.g.MEDIA_ERROR,r.d.BUFFER_STALLED_ERROR,!0,"got fatal buffer error",r.f.VideoDecoderBadDataErr),a.trigger(s.b.INTERNAL_ERROR,m)}onMediaTimeUpdate(){let e=this.media.currentTime;if(this.stallReported&&(this.logger.info(`playback not stuck anymore @${e}, after ${Math.round(performance.now()-this.tstalled)}ms`)(),this.stallReported=!1),this.tstalled=void 0,this.nudgeRetry=0,this.relaxHighBufferStallRule=0,this.hls.config.gapless){let t=this.loadingItemStartTime,i=this.playingItemStartTime;t&&e>=t&&i!==t&&!this.media.seeking&&this.hls.handleItemTransitioned()}}computeLivePosition(e,t){let i=void 0!==this.config.liveSyncDuration?this.config.liveSyncDuration:this.config.liveSyncDurationCount*t.targetduration;return e+Math.max(0,t.totalduration-i)}get liveSyncPosition(){return this._liveSyncPosition}set liveSyncPosition(e){this._liveSyncPosition=e}get playbackEverStarted(){return this.firstPlaybackStarted}get bufferedRangeString(){let e=`main${this.mediaBuffer&&this.mediaBuffer.buffered.length?qs(this.mediaBuffer.buffered):"[N/A]"}`;if(this.altAudio){const t=this.audioStreamController.mediaBuffer;e+=`/audio${t&&t.buffered.length?qs(t.buffered):"[N/A]"}`}return e}get variantController(){return this.hls.levelController}getLivePlaylistRefreshDelay(e){let t=Cs.bufferInfo(this.media,this.media.currentTime,this.config.maxBufferHole),i=0===t.len||t.len<Math.max(this.config.liveMinPlayingBufferLen,e.targetduration),s=this.fragCurrent&&"number"==typeof this.fragCurrent.sn&&e.endSN>this.fragCurrent.sn;return i&&s?this.config.livePlaylistRefreshDelay:0}},dr=class extends P{constructor(e){super(e,s.b.MEDIA_ATTACHED,s.b.MEDIA_DETACHING,s.b.FRAG_PARSING_METADATA),this.id3Track=void 0,this.media=void 0}destroy(){P.prototype.destroy.call(this)}onMediaAttached(e){this.media=e.media,this.media&&(this.id3Track=this.media.addTextTrack("metadata","id3"),this.id3Track.mode="hidden")}onMediaDetaching(){this.media=void 0}onFragParsingMetadata(e){const t=e.frag,i=e.samples;if(!this.hls.config.enableID3Cues)return;let s=window.WebKitDataCue||window.VTTCue||window.TextTrackCue,r=t.endPTS?t.endPTS:t.duration+t.start;for(let e=0;e<i.length;e++){let t=i[e].pts,a=e<i.length-1?i[e+1].pts:r;t===a&&(a+=1e-4),i[e].frames&&i[e].frames.forEach(e=>{if(e&&!this.shouldIgnore(e)){let i=new s(t,a,"");i.value=e,this.id3Track.addCue(i)}})}}shouldIgnore(e){return"PRIV"===e.key&&("com.apple.streaming.transportStreamTimestamp"===e.info||"com.apple.streaming.audioDescription"===e.info)}};function hr(e){return(t,i)=>{let s=0,r=0;for(const{timestamp:a,value:n,duration:o}of t){const t=Math.pow(Math.max(0,a-i)/1e3,e);s+=t*n,r+=t*o}return s/r}}const cr={"uniform-time-weighted":hr(0),"linear-time-weighted":hr(1),"quadratic-time-weighted":hr(2)};class ur{constructor(e,t=(()=>{})){this.windowSize=e,this.cleanupCallback=t,this.latencyEntries=[],this.bandwidthEntries=[],this.minEntries=1,this.cleanUpExpiredEntries=this.cleanUpExpiredEntries.bind(this)}record(e){const{trequest:t,tfirst:i,tload:s,bitsDownloaded:r}=e;this.recordLatency(t,i),this.recordBandwidth(t,s,r)}getEstimate(e="quadratic-time-weighted"){if(this.latencyEntries.length<this.minEntries)return;const t=performance.now()-this.windowSize,i=cr[e],s=this.latencyEntries.map(({start:e,end:t})=>({timestamp:t,value:t-e,duration:1})),r=(function(e,t){const i=[...e].sort((e,t)=>e.start-t.start),s=[];for(const e of i)0===s.length||s[s.length-1].end<=e.start?s.push(e):s[s.length-1]=t(s[s.length-1],e);return s})(this.bandwidthEntries,(e,t)=>({start:e.start,end:Math.max(e.end,t.end),bitsDownloaded:e.bitsDownloaded+t.bitsDownloaded})).map(({start:e,end:t,bitsDownloaded:i})=>({timestamp:t,duration:(t-e)/1e3,value:i}));return{avgLatencyMs:i(s,t),avgBandwidth:i(r,t)}}recordLatency(e,t){this.latencyEntries.push({start:e,end:t}),this.updateCleanupTimeout(t)}recordBandwidth(e,t,i){this.bandwidthEntries.push({start:e,end:t,bitsDownloaded:i}),this.updateCleanupTimeout(t)}setCleanupTimeout(e){this.cleanupTimeout=setTimeout(this.cleanUpExpiredEntries,Math.max(e-performance.now(),0)),this.cleanupTimestamp=e}clearCleanupTimeout(){void 0!==this.cleanupTimeout&&(clearTimeout(this.cleanupTimeout),this.cleanupTimeout=void 0),this.cleanupTimestamp=void 0}updateCleanupTimeout(e){const t=e+this.windowSize;(!this.cleanupTimestamp||t<this.cleanupTimestamp)&&(this.clearCleanupTimeout(),this.setCleanupTimeout(t))}cleanUpExpiredEntries(){this.clearCleanupTimeout();const e=performance.now()-this.windowSize;if(this.latencyEntries=this.latencyEntries.filter(t=>t.end>=e),this.bandwidthEntries=this.bandwidthEntries.filter(t=>t.end>=e),this.cleanupCallback(),this.latencyEntries.length>0||this.bandwidthEntries.length>0){const e=Math.min(...this.latencyEntries.map(e=>e.end),...this.bandwidthEntries.map(e=>e.end));this.updateCleanupTimeout(e)}}destroy(){this.clearCleanupTimeout()}}class fr extends P{constructor(e){super(e,s.b.MEDIA_DETACHED),this.bwEstimator=new ur(e.config.bandwidthHistoryWindowSize,()=>this.getAndCacheBandwidthEstimate()),this.ttl=e.config.bandwidthHistoryTTL,this.persistBandwidthEstimate=this.persistBandwidthEstimate.bind(this),"undefined"!=typeof window&&"function"==typeof window.addEventListener&&window.addEventListener("beforeunload",this.persistBandwidthEstimate),this.onMediaDetached=this.persistBandwidthEstimate,this.storage=e.config.storage,this.storageKey=e.config.bandwidthHistoryStorageKey}getAndCacheBandwidthEstimate(){const e=this.bwEstimator.getEstimate(this.hls.config.bandwidthHistoryAggregationMethod);return e&&(this.aggregatedAt=performance.now(),this.cachedBandwidthEstimate=e),e}sample({trequest:e,tfirst:t,tload:i,loaded:s}){this.bwEstimator.record({trequest:e,tfirst:t,tload:i,bitsDownloaded:8*s}),this.getAndCacheBandwidthEstimate()}getEstimate(){if(performance.now()-this.aggregatedAt<=this.hls.config.bandwidthHistoryGetEstimateThrottleMs)return this.cachedBandwidthEstimate;const e=this.getAndCacheBandwidthEstimate();if(e)return e;try{const t=JSON.parse(this.storage.get(this.storageKey));if(t.expires&&t.expires>=Date.now())return t}catch(e){this.logger.warn(`Unable to get persisted bandwidth history, returning undefined: ${e.message}`)()}}persistBandwidthEstimate(){if(void 0===this.storage.set)return void this.logger.warn("`storage.set` is not supported! Not persisting bandwidth estimate")();const e=this.getAndCacheBandwidthEstimate();e&&this.storage.set(this.storageKey,JSON.stringify(Object.assign({},e,{expires:Date.now()+this.ttl})))}destroy(){"undefined"!=typeof window&&"function"==typeof window.removeEventListener&&window.removeEventListener("beforeunload",this.persistBandwidthEstimate),this.bwEstimator.destroy(),super.destroy()}}var gr,pr=class{constructor(e,t,i,s={}){this._logger=e.logger,this._intervalTimeout=i.rtcIntervalTimeout,this._interval=setInterval(this._handlePeriodic.bind(this),this._intervalTimeout),this._state=ie,this._hls=e,this._sessStartTime=this._stateStartTime=this._intervalStartTime=Date.now(),this._variantStartTime=0,this._minSwitchWindow=1e4,this._sessionData={},this._intervalData={},this._playStalledData={},this._mediaEngineStalledData={},this._keySessionCompleteData={},this._playLikelyToKeepUpData={},this._playRateChangedData={},this._playErrorData={},this._switchCompleteData={},this._variantEndData={},this._nwErrorData={},this._dimensionData={maxVideoQltyIndex:0,maxReWd:0,maxReHt:0},this._miscData={periodicEvtCnt:0,playLikelyToKeepUpEvtCnt:0,keyDataDict:{},fragmentCnt:0,sessVariantList:{},intervalVariantList:{},nonFatalMediaErrList:{},nonFatalNwErrList:{},playlistMimeTypes:new Set,segmentMimeTypes:new Set,decodedFramesForVariant:0,decodedFramesForVariantSampleCount:0,intervalSegmentBytes:0,intervalSegmentAdt:0,intervalSegmentProcessTime:0,sessSegmentBytes:0,sessSegmentAdt:0,sessSegmentProcessTime:0,sessVideoBytes:0,sessVideoDuration:0,sessAudioBytes:0,sessAudioDuration:0,intervalVideoBytes:0,intervalVideoDuration:0,intervalAudioBytes:0,intervalAudioDuration:0},t?s.reportingAgent&&(this.reportingAgent=s.reportingAgent,this._logger.info(`[QE Critical] [RTCA] - Reporting session started, base SessionID: ${this.reportingAgent.SessionID}`)()):this._logger.info("[RTCA] - Reporting is disabled")(),this._eventEmitter=e.media,this._accessLogReporter={SessionID:e.sessionID,ServiceName:s.serviceName,ClientName:s.appName},this._accessLogData=this.createAccessLogEntry(),this._accesslog=[],this._errorlog=[]}destroy(){clearInterval(this._interval),this._accesslog=[],this._errorlog=[],this._accessLogData=void 0,this._accessLogReporter=void 0,this.reportingAgent=null,this._eventEmitter=void 0}get currentItemId(){return this.itemId}set currentItemId(e){this.itemId=e}setMedia(e){!e&&this._interval&&clearInterval(this._interval),this.media=e}updateSvrAddrStats(e){let t=h.parseURL(e);if(t&&t.netLoc){let e=t.netLoc.indexOf(":"),i=e>=0?t.netLoc.slice(0,e):t.netLoc;i.startsWith("//")&&(i=i.slice(2)),this._accessLogData.svrAddr?i!==this._accessLogData.svrAddr&&this._accessLogData.svrAddrChanged++:this._accessLogData.svrAddrChanged=0,this._accessLogData.svrAddr=i}}convertStringObjectToPrimitive(e){return e?"object"==typeof e?e.toString():e:""}createAccessLogEntry(){return{fragmentCnt:0,overdue:0,startPTS:0,obrMax:0,obrMin:0,audioBytes:0,audioDuration:0,videoBytes:0,videoDuration:0,svrAddrChanged:0,svrAddr:"",PlayTimeWC:0,ViFrDr:0,StallCount:0,MediaEngineStallCount:0,ADT:0,NetBytes:0,StartupTime:0,OBRMean:0,OBRLast:0}}translateToAccessLogItem(e,t,i){let s,r=this.convertStringObjectToPrimitive(e);this.updateSvrAddrStats(r),(s=this._switchCompleteData.MediaDur?this._switchCompleteData.MediaDur:this._getBufferedDuration())||(s=0);let a={uri:r,"s-ip":this._accessLogData.svrAddr,"s-ip-changes":this._accessLogData.svrAddrChanged,"sc-wwan-count":-1,"c-transfer-duration":this._accessLogData.ADT,bytes:this._accessLogData.NetBytes,"c-total-media-requests":this._accessLogData.fragmentCnt,"cs-guid":this._accessLogReporter.SessionID,"c-start-time":this._accessLogData.startPTS,"c-startup-time":this._accessLogData.StartupTime,"c-duration-watched":this._accessLogData.PlayTimeWC/1e3,"c-frames-dropped":this._accessLogData.ViFrDr,"c-stalls":this._accessLogData.StallCount,"c-duration-downloaded":this._accessLogData.lastMediaDur?s-this._accessLogData.lastMediaDur:s,"c-overdue":this._accessLogData.overdue,"c-avg-video-bitrate":8*this._accessLogData.videoBytes/(this._accessLogData.videoDuration||1),"c-observed-max-bitrate":this._accessLogData.obrMax,"c-observed-min-bitrate":this._accessLogData.obrMin,"sc-indicated-bitrate":t.bandwidth?t.bandwidth:0,"sc-indicated-avg-bitrate":t.avgBandwidth?t.avgBandwidth:0,"c-observed-bitrate":this._accessLogData.OBRMean,"c-switch-bitrate":this._accessLogData.OBRLast,"c-provisional-entry":!1};return i.playlistType&&(a["s-playback-type"]=i.playlistType),this._accessLogData.audioBytes&&(a["c-avg-audio-bitrate"]=8*this._accessLogData.audioBytes/(this._accessLogData.audioDuration||1)),a}translateToErrorLogItem(e,t){let i=this.convertStringObjectToPrimitive(e);return this.updateSvrAddrStats(i),{date:new Date,"cs-guid":this._accessLogReporter.SessionID+"-"+this.currentItemId,uri:i,"s-ip":this._accessLogData.svrAddr,status:t.ErrCode,domain:t.ErrDomain}}addToAccessLog(e,t,i){if(!e||""===e)return;let s=this.translateToAccessLogItem(e,t,i);if(s){let e=this._accesslog.length-20;e>0&&this._accesslog.splice(0,e),this._accesslog.push(s)}this._accessLogData=this.createAccessLogEntry(),this._accessLogData.lastMediaDur=this._switchCompleteData.MediaDur?this._switchCompleteData.MediaDur:this._getBufferedDuration()}addToErrorLog(e,t){let i=this.translateToErrorLogItem(e,t);if(i){let e=this._errorlog.length-20;e>0&&this._errorlog.splice(0,e),this._errorlog.push(i)}}get accessLog(){let e=this._accesslog.slice(0);if(e){let t=this._miscData.curLevelUrl;if(t&&""!==t){let i=this._getVariantInfo(t),s=this.translateToAccessLogItem(t,i,this._miscData);s&&(s["c-provisional-entry"]=!0,e.push(s))}}return e}get errorLog(){return this._errorlog}notify(e,t){if(this._state!==oe||e===F.ended)switch(e){case F.canplay:this._handleCanPlay();break;case F.desiredratechange:this._handleDesiredRateChange(t);break;case F.pause:case F.playing:this._handleRateChange();break;case F.ended:this._handlePlayEnded();break;case F.bufferstalled:this._handleBufferStalled();break;case F.mediaenginestalled:this._handleMediaEngineStalled();break;case F.mediaerror:this._handleMediaError(t);break;case F.variantend:this._handleVariantEnd();break;case F.levelloaded:this._handleLevelLoaded(t);break;case F.levelswitched:case F.levelloaderror:this._handleLevelSwitched(t);break;case F.nwerror:this._handleNwError(t);break;case F.playbackinfo:this._handlePlaybackInfo(t);break;case F.manifestparsed:case F.manifestloaded:case F.fragloading:case F.fragloaded:case F.fragbuffered:this._aggregateStats(e,t);break;case F.segmentkeyloaded:case F.spcrequested:case F.spcreceived:case F.spcsubmitted:case F.spccreated:case F.ckcrequested:case F.ckcreceived:case F.ckcsubmitted:case F.ckcprocessed:case F.keyaborted:case F.ckcerror:case F.spcerror:this._handleKeySessionEvents(e,t)}}_handleCanPlay(){if(!this._isLikelyToKeepUp){const e=Date.now();this._state===ie&&this._setValue([this._intervalData,this._sessionData],"InitTime",e-this._sessStartTime),this._miscData.lastLikelyToKeepUpTime=e,this._setValue([this._playLikelyToKeepUpData,this._playRateChangedData,this._accessLogData],"StartupTime",e-this._stateStartTime),this._sendPlayLikelyToKeepUpEvent(),this._isLikelyToKeepUp=!0}}_handleDesiredRateChange(e){this._desiredRate=e.rate}_handleRateChange(){(this._rate!==this._desiredRate||0!==this._desiredRate&&this._state!==re)&&(this._rate=this._desiredRate,this._updateStateTimes(V,100*this._rate),this._sendPlayRateChangedEvent())}_handlePlayEnded(){let e=this._sessionData.NetBytes,t=this._intervalData.NetBytes;e=1e3*Math.round(e/1e3),t=1e3*Math.round(t/1e3),this._sessionData.NetBytes=e,this._intervalData.NetBytes=t,this._handlePeriodic(),this._updateStateTimes(B,void 0),this._sendSummaryEvent()}_handlePeriodic(){this._finalizeStatsForPeriodic(),this._sendPeriodicEvent()}_handleBufferStalled(){this._state===re&&(this._updateStateTimes($,void 0),this._inc([this._sessionData,this._intervalData,this._accessLogData],"StallCount",1),this._sendPlayStalledEvent())}_handleMediaEngineStalled(){this._state===re&&(this._updateStateTimes(K,void 0),this._inc([this._sessionData,this._intervalData],"MediaEngineStallCount",1),this._sendMediaEngineStalledEvent())}_handleVariantEnd(){if(this._state===re){const e=Date.now(),t=Math.min(e-this._variantStartTime,e-this._stateStartTime),i=Math.abs(t*(this._miscData.lastPlayRate/100));this._inc([this._variantEndData],"VarPlayTime",i),this._inc([this._variantEndData],"VarPlayTimeWC",t)}this._sendVariantEndEvent()}_handleLevelLoaded(e){if(!this._miscData.playlistType){this._miscData.playlistType=e.playlistType;let t=this._getVariantInfo(e.url);t&&(t.targetduration=e.targetduration)}this._miscData.playlistMimeTypes.has(e.contentType)||this._miscData.playlistMimeTypes.add(e.contentType),this._inc([this._sessionData,this._intervalData],"PlaylistADT",e.adt),this._setValue([this._playLikelyToKeepUpData],"PlaylistADT",e.adt),this._updateMaxValue([this._sessionData,this._intervalData],"MaxPlaylistDT",e.adt)}_handleKeySessionEvents(e,t){const i=t.timestamp;let s=this._miscData.keyDataDict[t.keyuri]||{};switch(e){case F.segmentkeyloaded:s.keyFormat="identity",s.keyDeliveryTime=t.adt,this._state===ie&&(s.keyInitTime=i-this._sessStartTime),this._miscData.keyData=s,this._sendKeySessionCompleteEvent();break;case F.spcrequested:s.keySessionStartTime=s.SPCRequestStartTime=i,this._state===ie&&(s.keyInitTime=i-this._sessStartTime),this._miscData.keyDataDict[t.keyuri]=s;break;case F.spcreceived:s.SPCRequestTime=i-s.SPCRequestStartTime;break;case F.spcsubmitted:s.keyFormat=t.keyFormat,s.SPCSubmitStartTime=i;break;case F.spccreated:s.cdmVersion=t.cdmVersion,s.SPCCreationTime=i-s.SPCSubmitStartTime;break;case F.ckcrequested:s.CKCRequestStartTime=i;break;case F.ckcreceived:s.CKCResponseTime=i-s.CKCRequestStartTime;break;case F.ckcsubmitted:s.CKCSubmitStartTime=i;break;case F.ckcprocessed:s&&(s.CKCProcessTime=i-s.CKCSubmitStartTime,s.keyDeliveryTime=i-s.keySessionStartTime,this._miscData.keyData=s,this._sendKeySessionCompleteEvent(),delete this._miscData.keyDataDict[t.keyuri]);break;case F.keyaborted:case F.ckcerror:case F.spcerror:s&&(s.isKeyError=!0,s.keyErrorType=e,this._miscData.keyData=s,this._sendKeySessionCompleteEvent(),delete this._miscData.keyDataDict[t.keyuri])}}_handleLevelSwitched(e){const t=Date.now();let i,s=!1;if(this._miscData.curLevelUrl){let t=this._getVariantInfo(this._miscData.curLevelUrl),r=this._getVariantInfo(e.url);i=r.bandwidth<t.bandwidth?"Down":"Up",s=r.iframes}if(this._inc([this._sessionData,this._intervalData],"SwCnt",1),this._miscData.isBadSw=this._isBadSw(i,s,t,this._minSwitchWindow,this._miscData,e.isSeeking),e.failedSwitchUrl)this._miscData.failedSwitchUrl=e.failedSwitchUrl;else{if(this._state===re){const e=Math.min(t-this._variantStartTime,t-this._stateStartTime),i=Math.abs(e*(this._miscData.lastPlayRate/100));this._inc([this._switchCompleteData],"PlayTimeLastSW",i);const s=Math.min(e,t-this._intervalStartTime);this._updateLevelStats(s,this._miscData.curLevelUrl)}this._miscData.lastSwitchDir=i,this._miscData.lastSwitchTime=t,this._miscData.variantStartTimeMedia=this._getCurrentMediaTimeMilliSec(),this._miscData.lastLevelIsIframe=s,this._miscData.prevLevelUrl=this._miscData.curLevelUrl,this._miscData.curLevelUrl=e.url,this._variantStartTime=t}this._sendSwitchComplete()}_handleMediaError(e){if(this._inc([this._sessionData,this._intervalData],"PlayerErrCount",1),e.fatal)this._inc([this._sessionData,this._intervalData],"FatalPlayerErrCount",1),this._miscData.playErrCode=e.details,this._miscData.playErrIsFatal=e.fatal,this._miscData.playErrCount=1,this._miscData.playErrDomain=e.type,this._updateStateTimes(G,void 0),this._sendPlayError();else{let t=this._miscData.nonFatalMediaErrList[e.details]||0;this._miscData.nonFatalMediaErrList[e.details]=t+1}}_handleNwError(e){if(this._inc([this._sessionData,this._intervalData],"NwErrCount",1),e.fatal)this._miscData.nwErrTime=Date.now(),this._inc([this._sessionData,this._intervalData],"FatalNwErrCount",1),this._miscData.nwErrCode=e.details,this._miscData.nwErrIsFatal=e.fatal,this._miscData.nwErrDomain=e.type,this._miscData.nwErrReason=e.code,this._updateStateTimes(H,void 0),this._sendNwError();else{let t=e.details+"/"+e.code,i=this._miscData.nonFatalNwErrList[t]||0;this._miscData.nonFatalNwErrList[t]=i+1}}_handleBatchMediaError(){let e=this._miscData.nonFatalMediaErrList;Object.keys(e).forEach(t=>{this._miscData.playErrCode=t,this._miscData.playErrIsFatal=!1,this._miscData.playErrCount=e[t],this._sendPlayError()}),this._miscData.nonFatalMediaErrList={}}_handleBatchNwError(){let e=this._miscData.nonFatalNwErrList;Object.keys(e).forEach(t=>{let i=t.split("/");this._miscData.nwErrTime=Date.now(),this._miscData.nwErrCode=i[0],this._miscData.nwErrReason=parseInt(i[1]),this._miscData.nwErrIsFatal=!1,this._miscData.nwErrCount=e[t],this._sendNwError()}),this._miscData.nonFatalNwErrList={}}_handlePlaybackInfo(e){e.droppedVideoFrames<this._miscData.droppedVideoFrames&&(this._miscData.droppedVideoFrames=0),e.decodedFrameCount<this._miscData.decodedFrameCount&&(this._miscData.decodedFrameCount=0);let t=e.droppedVideoFrames-(this._miscData.droppedVideoFrames||0),i=e.decodedFrameCount-(this._miscData.decodedFrameCount||0);this._miscData.droppedVideoFrames=e.droppedVideoFrames,this._miscData.decodedFrameCount=e.decodedFrameCount,this._miscData.decodedFramesForVariant+=i,this._miscData.decodedFramesForVariantSampleCount+=1,t&&(this._inc([this._accessLogData],"ViFrDr",t),t>=3?(this._inc([this._sessionData,this._intervalData],"GroupViFrDr",t),this._inc([this._sessionData,this._intervalData],"GroupViFrDrEvtCount",1)):(this._inc([this._sessionData,this._intervalData],"SparseViFrDr",t),this._inc([this._sessionData,this._intervalData],"SparseViFrDrEvtCount",1)))}_sendSummaryEvent(){clearInterval(this._interval);let e=this._sessionData.NetBytes||0,t=this._sessionData.ADT||0,i=e&&t?8*e/(t/1e3):0,s=this._sessionData.SegmentProcessTime||0,r=e&&t?8*e/((t+s)/1e3):0,a=this._sessionData.SegmentParseTime||0;e=this._miscData.sessSegmentBytes,t=this._miscData.sessSegmentAdt,s=this._miscData.sessSegmentProcessTime;let n=e&&t?8*e/((t+s+a)/1e3):0,o=8*(this._miscData.sessVideoBytes||0)/(this._miscData.sessVideoDuration||1),l=8*(this._miscData.sessAudioBytes||0)/(this._miscData.sessAudioDuration||1),d=this._findTimeWeightedValues(this._miscData.sessVariantList),h=this._getVariantInfo(this._miscData.curLevelUrl),c=this._miscData.manifestData||{},u="";this._miscData.playlistMimeTypes.forEach(e=>{u+=e+","});let f="";this._miscData.segmentMimeTypes.forEach(e=>{f+=e+","}),this._sessionData.PlayType=this._miscData.playlistType,this._sessionData.TWOBR=i,this._sessionData.PerceivedTWOBR=r,this._sessionData.NetTWOBR=n,this._sessionData.AvgVideoBitrate=o,this._sessionData.AvgAudioBitrate=l,this._sessionData.PlayerTWIBR=d.twIBR,this._sessionData.PlayerTWIABR=d.twIABR,this._sessionData.TWBitRk=d.twBRnk,this._sessionData.TargetDur=h.targetduration,this._sessionData.VariantList=c.trimmedVarList,this._sessionData.PlaylistMimeType=u.slice(0,-1),this._sessionData.SegmentMimeType=f.slice(0,-1),this._sessionData.Rate=this._miscData.lastPlayRate,this._sessionData.ReWd=h.width,this._sessionData.ReHt=h.height,this._fillAndFire(B,W,this._sessionData),this._sessionData={},this._miscData.sessVariantList={},this._miscData.sessSegmentBytes=0,this._miscData.sessSegmentAdt=0,this._miscData.sessSegmentProcessTime=0}_sendPeriodicEvent(){let e=this._intervalData.NetBytes,t=this._intervalData.ADT,i=e&&t?8*e/(t/1e3):0,s=this._intervalData.SegmentProcessTime||0,r=e&&t?8*e/((t+s)/1e3):0,a=this._intervalData.SegmentParseTime||0;e=this._miscData.intervalSegmentBytes,t=this._miscData.intervalSegmentAdt,s=this._miscData.intervalSegmentProcessTime;let n=e&&t?8*e/((t+s+a)/1e3):0,o=8*(this._miscData.intervalVideoBytes||0)/(this._miscData.intervalVideoDuration||1),l=8*(this._miscData.intervalAudioBytes||0)/(this._miscData.intervalAudioDuration||1),d=this._findTimeWeightedValues(this._miscData.intervalVariantList),h=this._getVariantInfo(this._miscData.curLevelUrl),c=this._miscData.manifestData||{};this._intervalData.EventCounter=++this._miscData.periodicEvtCnt,this._intervalData.PlayType=this._miscData.playlistType,this._intervalData.TWOBR=i,this._intervalData.PerceivedTWOBR=r,this._intervalData.NetTWOBR=n,this._intervalData.AvgVideoBitrate=o,this._intervalData.AvgAudioBitrate=l,this._intervalData.PlayerTWIBR=d.twIBR,this._intervalData.PlayerTWIABR=d.twIABR,this._intervalData.TWBitRk=d.twBRnk,this._intervalData.TargetDur=h.targetduration,this._intervalData.VariantList=c.trimmedVarList,this._intervalData.Rate=this._miscData.lastPlayRate,this._intervalData.ReWd=h.width,this._intervalData.ReHt=h.height,(this._intervalData.PlayTimeWC>0||this._intervalData.ADT)&&this._fillAndFire(U,j,this._intervalData),this._intervalData={},this._miscData.intervalVariantList={},this._miscData.intervalSegmentBytes=0,this._miscData.intervalSegmentAdt=0,this._miscData.intervalSegmentProcessTime=0,this._miscData.intervalVideoBytes=0,this._miscData.intervalVideoDuration=0,this._miscData.intervalAudioBytes=0,this._miscData.intervalAudioDuration=0}_sendPlayStalledEvent(){const e=Date.now();let t=this._getVariantInfo(this._miscData.curLevelUrl);this._playStalledData.MediaDur=this._getBufferedDuration(),this._playStalledData.BitRnk=t.brRnk,this._playStalledData.Codecs=t.codecs,this._playStalledData.PlayTime=this._sessionData.PlayTime,this._playStalledData.PlayType=this._miscData.playlistType,this._playStalledData.LastLikelyToKeepUp=e-this._miscData.lastLikelyToKeepUpTime,this._playStalledData.LastSwitch=e-this._miscData.lastSwitchTime,this._playStalledData.NwErrTime=this._miscData.nwErrTime,this._playStalledData.NwErrCode=this._miscData.nwErrCode,this._playStalledData.LaSwDir=this._miscData.lastSwitchDir,this._playStalledData.TargetDur=t.targetduration,this._playStalledData.PlayerIABR=t.avgBandwidth,this._playStalledData.PlayerIBR=t.bandwidth,this._playStalledData.Rate=this._miscData.lastPlayRate,this._fillAndFire($,q,this._playStalledData),this._playStalledData={}}_sendMediaEngineStalledEvent(){const e=Date.now();let t=this._getVariantInfo(this._miscData.curLevelUrl);this._mediaEngineStalledData.MediaDur=this._getBufferedDuration(),this._mediaEngineStalledData.BitRnk=t.brRnk,this._mediaEngineStalledData.Codecs=t.codecs,this._mediaEngineStalledData.PlayTime=this._sessionData.PlayTime,this._mediaEngineStalledData.PlayType=this._miscData.playlistType,this._mediaEngineStalledData.LastLikelyToKeepUp=e-this._miscData.lastLikelyToKeepUpTime,this._mediaEngineStalledData.LastSwitch=e-this._miscData.lastSwitchTime,this._mediaEngineStalledData.LaSwDir=this._miscData.lastSwitchDir,this._mediaEngineStalledData.TargetDur=t.targetduration,this._mediaEngineStalledData.PlayerIABR=t.avgBandwidth,this._mediaEngineStalledData.PlayerIBR=t.bandwidth,this._mediaEngineStalledData.Rate=this._miscData.lastPlayRate,this._fillAndFire(K,J,this._mediaEngineStalledData),this._mediaEngineStalledData={}}_sendKeySessionCompleteEvent(){this._keySessionCompleteData.KeyFormat=this._miscData.keyData.keyFormat,this._keySessionCompleteData.CDMVersion=this._miscData.keyData.cdmVersion,this._keySessionCompleteData.SPCRequestTime=this._miscData.keyData.SPCRequestTime,this._keySessionCompleteData.SPCCreationTime=this._miscData.keyData.SPCCreationTime,this._keySessionCompleteData.CKCResponseTime=this._miscData.keyData.CKCResponseTime,this._keySessionCompleteData.CKCProcessTime=this._miscData.keyData.CKCProcessTime,this._keySessionCompleteData.KeyDeliveryTime=this._miscData.keyData.keyDeliveryTime,this._keySessionCompleteData.CurrentMediaTime=this._getCurrentMediaTimeMilliSec(),this._keySessionCompleteData.KeyInitTime=this._miscData.keyData.keyInitTime,this._miscData.keyData.isKeyError&&(this._keySessionCompleteData.KeyErrorType=this._miscData.keyData.keyErrorType),this._fillAndFire(6104,Y,this._keySessionCompleteData),this._keySessionCompleteData={},delete this._miscData.keyData}_sendPlayLikelyToKeepUpEvent(){let e=this._getVariantInfo(this._miscData.curLevelUrl);this._playLikelyToKeepUpData.EventCounter=++this._miscData.playLikelyToKeepUpEvtCnt,this._playLikelyToKeepUpData.PlayType=this._miscData.playlistType,this._playLikelyToKeepUpData.PlayerIABR=e.avgBandwidth,this._playLikelyToKeepUpData.PlayerIBR=e.bandwidth,this._playLikelyToKeepUpData.MediaDur=this._getBufferedDuration(),this._playLikelyToKeepUpData.BitRnk=e.brRnk,this._playLikelyToKeepUpData.Codecs=e.codecs,this._playLikelyToKeepUpData.TargetDur=e.targetduration,this._fillAndFire(6105,z,this._playLikelyToKeepUpData),this._playLikelyToKeepUpData={}}_sendPlayRateChangedEvent(){let e=this._getVariantInfo(this._miscData.curLevelUrl);this._playRateChangedData.Rate=this._miscData.lastPlayRate,this._playRateChangedData.PlayType=this._miscData.playlistType,this._playRateChangedData.StNPT=this._getCurrentMediaTimeMilliSec(),this._playRateChangedData.PlayerIABR=e.avgBandwidth,this._playRateChangedData.PlayerIBR=e.bandwidth,this._playRateChangedData.BitRnk=e.brRnk,this._playRateChangedData.MediaDur=this._getBufferedDuration(),this._playRateChangedData.Codecs=e.codecs,this._fillAndFire(V,Q,this._playRateChangedData),this._playRateChangedData={}}_sendPlayError(){const e=Date.now();let t=this._getVariantInfo(this._miscData.curLevelUrl);this._playErrorData.ErrCode=this._miscData.playErrCode,this._playErrorData.ErrIsFatal=this._miscData.playErrIsFatal,this._playErrorData.PlayerErrCount=this._miscData.playErrCount,this._playErrorData.ErrDomain=this._miscData.playErrDomain,this._playErrorData.PlayType=this._miscData.playlistType,this._playErrorData.BitRnk=t.brRnk,this._playErrorData.MediaDur=this._getBufferedDuration(),this._playErrorData.PlayTime=this._sessionData.PlayTime,this._playErrorData.PlayTimeWC=this._sessionData.PlayTimeWC,this._playErrorData.PlayerIABR=t.avgBandwidth,this._playErrorData.PlayerIBR=t.bandwidth,this._playErrorData.LastLikelyToKeepUp=e-this._miscData.lastLikelyToKeepUpTime,this._playErrorData.LastSwitch=e-this._miscData.lastSwitchTime,this._playErrorData.VideoQltyIndex=t.qltyIndex,this.addToErrorLog(this._miscData.curLevelUrl,this._playErrorData),this._fillAndFire(G,X,this._playErrorData),this._playErrorData={}}_sendSwitchComplete(){let e=this._miscData.prevLevelUrl,t=this._miscData.failedSwitchUrl||this._miscData.curLevelUrl,i=!!this._miscData.failedSwitchUrl;this._miscData.failedSwitchUrl=void 0;let s=this._getVariantInfo(e),r=this._getVariantInfo(t);this._switchCompleteData.FrBitRnk=s.brRnk,this._switchCompleteData.ToBitRnk=r.brRnk,this._switchCompleteData.TimeToBitrate=Date.now()-this._sessStartTime,this._switchCompleteData.MediaDur=this._getBufferedDuration(),this._switchCompleteData.Rate=this._miscData.lastPlayRate,this._switchCompleteData.PlayType=this._miscData.playlistType,this._switchCompleteData.SwFail=i,this._switchCompleteData.PlayerIBR=r.bandwidth,this._switchCompleteData.PlayerIABR=r.avgBandwidth,this._switchCompleteData.LastPlayerIBR=s.bandwidth,this._switchCompleteData.LastPlayerIABR=s.avgBandwidth,this._switchCompleteData.PlayTime=this._sessionData.PlayTime,this._switchCompleteData.BadSw=this._miscData.isBadSw,this._switchCompleteData.ReWd=r.width,this._switchCompleteData.ReHt=r.height,this.addToAccessLog(e,s,this._miscData),this._fillAndFire(6109,Z,this._switchCompleteData),this._switchCompleteData={}}_sendVariantEndEvent(){let e=this._getVariantInfo(this._miscData.curLevelUrl),t=this._miscData.decodedFramesForVariant/(this._miscData.decodedFramesForVariantSampleCount||1);this._miscData.decodedFramesForVariant=0,this._miscData.decodedFramesForVariantSampleCount=0,this._variantEndData.Rate=this._miscData.lastPlayRate,this._variantEndData.PlayType=this._miscData.playlistType,this._variantEndData.VarAvgBitrate=e.avgBandwidth,this._variantEndData.VarPeakBitrate=e.bandwidth,this._variantEndData.VarBitRk=e.brRnk,this._variantEndData.VarSTTime=this._miscData.variantStartTimeMedia,this._variantEndData.VarEndTime=this._getCurrentMediaTimeMilliSec(),this._variantEndData.IFR=e.framerate,this._variantEndData.ODR=t,this._variantEndData.ReWd=e.width,this._variantEndData.ReHt=e.height,this._fillAndFire(6111,ee,this._variantEndData),this._variantEndData={}}_sendNwError(){let e=this._getVariantInfo(this._miscData.curLevelUrl);this._nwErrorData.BitRnk=e.brRnk,this._nwErrorData.PlayTime=this._sessionData.PlayTime,this._nwErrorData.PlayTimeWC=this._sessionData.PlayTimeWC,this._nwErrorData.PlayType=this._miscData.playlistType,this._nwErrorData.ErrCode=this._miscData.nwErrCode,this._nwErrorData.ErrReason=this._miscData.nwErrReason,this._nwErrorData.ErrIsFatal=this._miscData.nwErrIsFatal,this._nwErrorData.NwErrCount=this._miscData.nwErrCount,this._nwErrorData.ErrDomain=this._miscData.nwErrDomain,this.addToErrorLog(this._miscData.curLevelUrl,this._nwErrorData),this._fillAndFire(H,te,this._nwErrorData),this._nwErrorData={}}_aggregateStats(e,t){switch(e){case F.manifestparsed:this._aggregateManifestParsedStats(t);break;case F.manifestloaded:this._aggregateManifestLoadedStats(t);break;case F.fragloading:this._aggregateFragLoadingStats();break;case F.fragloaded:this._aggregateFragLoadedStats(t);break;case F.fragbuffered:this._aggregateFragBufferedStats(t)}}_aggregateManifestParsedStats(e){let t=e.levels||[],i={},s={},r=0,a=0,n=this._getMaxNormalizedPeak(t);t.forEach(e=>{if(e.attrs){let t=this._getVideoFourCC(e.attrs.CODECS),s=this._getVideoQualityIndex(t,e.attrs["VIDEO-RANGE"])||0,r={codecs:e.attrs.CODECS,width:e.width,height:e.height,bandwidth:parseInt(e.attrs.BANDWIDTH),avgBandwidth:parseInt(e.attrs["AVERAGE-BANDWIDTH"]),framerate:parseFloat(e.attrs["FRAME-RATE"]),iframes:e.iframes,brRnk:this._getBitrateRank(parseInt(e.attrs.BANDWIDTH),t,n),qltyIndex:s};a=s>a?s:a,i[e.url]=r}let t=e.width*e.height;t>r&&(r=t,s={width:e.width,height:e.height})}),this._miscData.manifestData={},this._miscData.manifestData.variantList=i,this._miscData.manifestData.trimmedVarList=Object.keys(i).length>0?Object.values(i).map(e=>e.bandwidth+":"+e.avgBandwidth).join(","):void 0,this._dimensionData.maxVideoQltyIndex=a,this._dimensionData.maxReWd=s.width,this._dimensionData.maxReHt=s.height}_aggregateManifestLoadedStats(e){this._miscData.playlistMimeTypes.has(e.contentType)||this._miscData.playlistMimeTypes.add(e.contentType),this._inc([this._sessionData,this._intervalData],"MasterPlaylistADT",e.adt)}_aggregateFragLoadingStats(){this._inc([this._sessionData,this._intervalData],"MediaRequestsSent",1)}_aggregateFragObserverdBitrate(e,t,i,s){const r=8*i/(s/1e3);return{obr:r,obrLast:8*e.bytes/(e.adt/1e3),obrMean:r/t}}_aggregateFragMinMaxBitrate(e,t){(!e.obrMax||t>e.obrMax)&&(e.obrMax=t),(!e.obrMin||t<e.obrMin)&&(e.obrMin=t)}_hasGap(e,t,i,s){return void 0!==e&&void 0!==i&&(e-s>1||i-t>1)}_aggregateFragLoadedStats(e){if(this._miscData.segmentMimeTypes.has(e.contentType)||this._miscData.segmentMimeTypes.add(e.contentType),"string"==typeof e.cdnServer&&de.includes(e.cdnServer.toLowerCase())&&(this._miscData.lastMediaCDNServer=e.cdnServer),e.serverInfo&&(this._miscData.serverInfo=e.serverInfo),"main"===e.fragType||"video"===e.fragType){this._inc([this._sessionData,this._intervalData,this._accessLogData],"NetBytes",e.bytes),this._inc([this._sessionData,this._intervalData,this._accessLogData],"ADT",e.adt),this._inc([this._sessionData,this._intervalData,this._accessLogData],"SegmentProcessTime",e.processTime);const t=this._aggregateFragObserverdBitrate(e,++this._miscData.fragmentCnt,this._sessionData.NetBytes,this._sessionData.ADT),i=this._aggregateFragObserverdBitrate(e,++this._accessLogData.fragmentCnt,this._accessLogData.NetBytes,this._accessLogData.ADT);if(this._playStalledData.OBRLast=t.obrLast,this._playStalledData.OBRMean=t.obrMean,this._mediaEngineStalledData.OBRLast=t.obrLast,this._mediaEngineStalledData.OBRMean=t.obrMean,this._accessLogData.OBRLast=i.obrLast,this._accessLogData.OBRMean=i.obrMean,this._aggregateFragMinMaxBitrate(this._accessLogData,i.obr),(this.media?this.media.currentTime:0)>e.startPTS&&this._eventEmitter&&!this._eventEmitter.seeking&&this._accessLogData.overdue++,this._hasGap(e.startPTS,e.endPTS,this._accessLogData.lastStartPTS,this._accessLogData.lastEndPTS)){let e=this._getVariantInfo(this._miscData.curLevelUrl);this.addToAccessLog(this._miscData.curLevelUrl,e,this._miscData)}this._accessLogData.startPTS||(this._accessLogData.startPTS=e.startPTS),this._accessLogData.lastStartPTS=e.startPTS,this._accessLogData.lastEndPTS=e.endPTS,this._miscData.sessVideoBytes+=e.bytes,this._miscData.sessVideoDuration+=e.duration,this._miscData.intervalVideoBytes+=e.bytes,this._miscData.intervalVideoDuration+=e.duration,this._accessLogData.videoBytes+=e.bytes,this._accessLogData.videoDuration+=e.duration}else"audio"===e.fragType&&(this._miscData.sessAudioBytes+=e.bytes,this._miscData.sessAudioDuration+=e.duration,this._miscData.intervalAudioBytes+=e.bytes,this._miscData.intervalAudioDuration+=e.duration,this._accessLogData.audioBytes+=e.bytes,this._accessLogData.audioDuration+=e.duration)}_aggregateFragBufferedStats(e){"main"!==e.fragType&&"video"!==e.fragType||(this._miscData.intervalSegmentBytes+=e.bytes,this._miscData.intervalSegmentAdt+=e.adt,this._miscData.intervalSegmentProcessTime+=e.processTime,this._miscData.sessSegmentBytes+=e.bytes,this._miscData.sessSegmentAdt+=e.adt,this._miscData.sessSegmentProcessTime+=e.processTime,this._inc([this._sessionData,this._intervalData,this._accessLogData],"SegmentParseTime",e.parseTime))}_inc(e,t,i){t&&i&&e&&t&&e.forEach(e=>{e[t]=e[t]?e[t]+i:i})}_updateMaxValue(e,t,i){t&&i&&e&&t&&e.forEach(e=>{(!e[t]||e[t]<i)&&(e[t]=i)})}_setValue(e,t,i){t&&i&&e&&t&&e.forEach(e=>{e[t]=i})}_clearValue(e,t){t&&e&&t&&e.forEach(e=>{delete e[t]})}_updateLevelStats(e,t){if(e&&t){let i=this._getVariantInfo(t),s={bandwidth:i.bandwidth,avgBandwidth:i.avgBandwidth,framerate:i.framerate,brRnk:i.brRnk,playTime:0},r=s,a=Object.assign({},s),n=this._miscData.intervalVariantList,o=this._miscData.sessVariantList,l=n[t]?n[t].playTime:0,d=o[t]?o[t].playTime:0;r.playTime=l+e,a.playTime=d+e,n[t]=r,o[t]=a}}_finalizeStatsForPeriodic(){const e=Date.now();let t=e-this._intervalStartTime,i=e-this._stateStartTime;if(this._intervalStartTime=e,this._miscData.pInterval=t,i=Math.min(t,i),this._setValue([this._intervalData],"PInterval",t),this._state===re){this._inc([this._intervalData],"PlayTimeWC",i);const t=Math.abs(i*(this._miscData.lastPlayRate/100));this._inc([this._intervalData],"PlayTime",t);const s=Math.min(e-this._variantStartTime,i);this._updateLevelStats(s,this._miscData.curLevelUrl)}else this._state===ae?this._inc([this._intervalData],"StallTime",i):this._state===ne?this._inc([this._intervalData],"MediaEngineStallTime",i):this._state===se&&this._inc([this._intervalData],"PauseTime",i);this._handleBatchMediaError(),this._handleBatchNwError()}_updateStateTimes(e,t){if(-1===le.indexOf(e))return;const i=Date.now(),s=i-this._stateStartTime,r=Math.min(i-this._intervalStartTime,s),a=Math.min(i-this._variantStartTime,s);if(this._state===re){this._inc([this._sessionData,this._accessLogData],"PlayTimeWC",s);const e=Math.abs(s*(this._miscData.lastPlayRate/100));this._inc([this._sessionData],"PlayTime",e);let t=Math.abs(r*(this._miscData.lastPlayRate/100));this._inc([this._intervalData],"PlayTimeWC",r),this._inc([this._intervalData],"PlayTime",t);let i=Math.abs(a*(this._miscData.lastPlayRate/100));this._inc([this._variantEndData],"VarPlayTime",i),this._inc([this._variantEndData],"VarPlayTimeWC",a),this._inc([this._switchCompleteData],"PlayTimeLastSW",i);let n=Math.min(a,r);this._updateLevelStats(n,this._miscData.curLevelUrl),this._inc([this._playRateChangedData],"RateChangePlayTime",s),this._setValue([this._playStalledData,this._mediaEngineStalledData,this._playErrorData,this._nwErrorData],"LastResume",s)}else this._state===ae?(this._inc([this._sessionData],"StallTime",s),this._inc([this._intervalData],"StallTime",r),this._setValue([this._sessionData,this._playErrorData,this._playRateChangedData],"LastStall",s)):this._state===ne?(this._inc([this._sessionData],"MediaEngineStallTime",s),this._inc([this._intervalData],"MediaEngineStallTime",r),this._setValue([this._sessionData,this._playErrorData,this._playRateChangedData],"LastMediaEngineStall",s)):this._state===se&&(this._inc([this._sessionData],"PauseTime",s),this._inc([this._intervalData],"PauseTime",r),this._setValue([this._sessionData,this._playErrorData,this._playRateChangedData],"LastPause",s));switch(this._stateStartTime=i,e){case $:this._state=ae,this._miscData.lastPlayRate=0,this._isLikelyToKeepUp=!1;break;case K:this._state=ne,this._miscData.lastPlayRate=0,this._isLikelyToKeepUp=!1;break;case V:0===t?this._state=se:(this._state=re,this._clearValue([this._sessionData],"LastStall"),this._clearValue([this._sessionData],"LastMediaEngineStall"),this._clearValue([this._sessionData],"LastPause")),this._miscData.lastPlayRate=t;break;case H:case G:case B:this._state=oe,this._miscData.lastPlayRate=0,this._isLikelyToKeepUp=!1}}_fillAndFire(e,t,i){if(!(e&&t&&i&&this.reportingAgent))return;this._miscData.lastMediaCDNServer&&(i.LastMediaCDNServer=this._miscData.lastMediaCDNServer),this._miscData.serverInfo&&(i.ServerInfo=this._miscData.serverInfo),i.MaxVideoQltyIndex=this._dimensionData.maxVideoQltyIndex,i.MaxReWd=this._dimensionData.maxReWd,i.MaxReHt=this._dimensionData.maxReHt,i.IsGapless=this._hls.inGaplessMode,i.IsAudioOnly=this._hls.streamController.gaplessAllowed,this._hls.config.gapless&&this._hls.eventReporter.getFirstInstance()&&(e===B||6111===e||e===U)?i.IsFirstItem=!0:i.IsFirstItem=this._hls.isFirstItem,i.ItemID=this._hls.sessionID+"-"+this.currentItemId;let s={};t.forEach(e=>{let t=i[e];if(isNaN(t)||(t=Number(Number(t).toFixed(2))),"object"==typeof t)for(var r in t)t.hasOwnProperty(r)&&(s[r]=t[r]);else s[e]=t});const r=e===B||e===U?1:0;this.reportingAgent.issueReportingEvent(e,s,r)}_findTimeWeightedValues(e){let t={};if(e){let i=0,s=0,r=0,a=0,n=0;Object.values(e).forEach(e=>{e.playTime&&(s+=e.bandwidth*e.playTime,i+=e.brRnk*e.playTime,r+=e.playTime,e.avgBandwidth&&(a+=e.avgBandwidth*e.playTime,n+=e.playTime))}),r&&(t.twBRnk=i/r,t.twIBR=s/r),a&&n&&(t.twIABR=a/n)}return t}_getBufferedDuration(){let e=0;if(this.media&&this.media.buffered){let t=this.media.buffered;for(let i=0;i<t.length;i++)e+=t.end(i)-t.start(i)}return Math.round(1e3*e)}_getVariantInfo(e){return e&&this._miscData.manifestData&&this._miscData.manifestData.variantList&&this._miscData.manifestData.variantList[e]?this._miscData.manifestData.variantList[e]:{}}_getVideoFourCC(e){return e?e.split(",").map(e=>e.split(".")[0].trim()).find(e=>he.hasOwnProperty(e)):e}_getVideoQualityIndex(e,t){return"object"==typeof he[e]?he[e][t]:he[e]}_getNormalizedPeak(e,t){return"object"==typeof he[t]?1.5*e:1*e}_getMaxNormalizedPeak(e){let t=0;return e.forEach(e=>{let i=e.attrs;if(i){let e=i.BANDWIDTH||0,s=this._getNormalizedPeak(e,this._getVideoFourCC(i.CODECS)),r=Math.max(e,s);t=r>t?r:t}}),t}_getBitrateRank(e,t,i){const s=Math.max(1,this._getNormalizedPeak(e,t));return Math.ceil(100*s/i)}_getCurrentMediaTimeMilliSec(){return this.media&&this.media.currentTime?Math.round(1e3*this.media.currentTime):0}_isBadSw(e,t,i,s,r,a){let n=!1,o=r.lastSwitchTime||0,l=r.lastSwitchDir||e;return i-o<s&&l!==e&&r.lastLevelIsIframe===t&&!a&&(n=!0),n}},mr=class extends P{constructor(e){super(e,s.b.MEDIA_ATTACHING,s.b.MEDIA_DETACHING,s.b.MANIFEST_LOADING,s.b.MANIFEST_LOADED,s.b.MANIFEST_PARSED,s.b.LEVEL_LOADED,s.b.FRAG_LOADING,s.b.FRAG_LOADED,s.b.FRAG_BUFFERED,s.b.KEY_LOADED,s.b.LEVEL_SWITCHED,s.b.KEY_REQUEST_STARTED,s.b.ITEM_TRANSITIONED,s.b.ERROR,s.b.INTERNAL_ERROR),this.enablePerformanceLogging=this.hls.config.enablePerformanceLogging,this.enableRtcReporting=this.hls.config.enableRtcReporting,this.firstInstance=!0,this.rtcAggregatorGroup={playingAggregator:void 0,loadingAggregator:void 0},this.media=null}destroy(){this._removeMediaEventListeners(this.media),P.prototype.destroy.call(this)}get accessLog(){let e=this._getAggregator();return e?e.accessLog:[]}get errorLog(){let e=this._getAggregator();return e?e.errorLog:[]}getFirstInstance(){return this.firstInstance}setAppData(e){this.appData=e}setRate(e){this.desiredRate=e,this._logAndReport("Set desired rate to: "+e,F.desiredratechange,{rate:e})}onItemTransitioned(e){this._logAndReport(null,F.desiredratechange,{rate:0}),this._logAndReport("[QE Critical] Play ended",F.ended),this.logger.info("Destroying RTC Aggregator, itemId: "+this.rtcAggregatorGroup.playingAggregator.currentItemId)(),this.rtcAggregatorGroup.playingAggregator.destroy(),this.firstInstance&&(this.firstInstance=!1),this.rtcAggregatorGroup.playingAggregator=this.rtcAggregatorGroup.loadingAggregator,this.rtcAggregatorGroup.loadingAggregator=void 0}onMediaAttaching(e){this.media=e.media,this._addMediaEventListeners(this.media),this._getAggregator()&&this._getAggregator().setMedia(this.media)}onMediaDetaching(){let e=this.frag?this.frag.level:void 0;this._logAndReport(`Variant end for level: ${e}`,F.variantend),this._logAndReport(null,F.desiredratechange,{rate:0}),this._logAndReport("[QE Critical] Play ended",F.ended),this._removeMediaEventListeners(this.media),clearInterval(this.timer),this._getAggregator()&&this._getAggregator().destroy()}onFragLoading(){this._logAndReport(null,F.fragloading)}onFragLoaded(e){if(e&&e.frag){let t={fragType:e.frag.type,adt:e.stats.tload-e.stats.trequest,processTime:e.stats.tdataack-e.stats.tload,bytes:e.stats.total,duration:e.frag.duration||0,startPTS:e.frag.start,endPTS:e.frag.start+e.frag.duration,contentType:e.stats.contentType,cdnServer:e.stats.cdnServer,serverInfo:e.serverInfo};this._logAndReport(null,F.fragloaded,t)}}onFragBuffered(e){if(e&&e.frag){let t=e.stats,i={fragType:e.frag.type,adt:t.tload-t.trequest,processTime:t.tdataack-t.tload,parseTime:t.tparsed-t.tdataack,bytes:t.total};this._logAndReport(null,F.fragbuffered,i)}}onKeyLoaded(e){"AES-128"===e.decryptdata.method&&this._logAndReport(null,F.segmentkeyloaded,{adt:e.stats.tload-e.stats.trequest,timestamp:e.timestamp})}onKeyRequestStarted(e){this._logAndReport(null,F.spcrequested,e)}findCurLevelInfo(e){let t=this.hls.levelController.variantManager.getVariantInfo(e);return t||this.logger.warn(`Level ${e} is missing from variantManager`)(),t}onLevelSwitched(e){let t=this.level,i=this.level=e.level;t>=0&&this._logAndReport(`Variant end for level: ${t}`,F.variantend);let s=this.findCurLevelInfo(i);if(s){let r=JSON.stringify(s,["bitrate","bandwidth","avgBandwidth","width","height"])+JSON.stringify(s.attrs,["CODECS","FRAME-RATE"]);e.url=s.url,e.isSeeking=this.isSeeking,this._logAndReport(`[QE Critical] Playing level switch from ${t} to ${i}. ${r}`,F.levelswitched,e)}}onManifestLoading(){let e=void 0,t=void 0;if(this.hls.userInfo&&(this.enableRtcReporting=this.hls.userInfo.diagnosticsAndUsage||this.hls.userInfo.internalBuild),this.hls.config.enableRtcReporting&&!this.enableRtcReporting&&(this.enableRtcReporting=!0),this.hls.playingItem.itemId===this.hls.loadingItem.itemId){let i=this.hls.playingItem.appData;this.rtcAggregatorGroup.playingAggregator=new pr(this.hls,this.enableRtcReporting,this.hls.config,i),this.rtcAggregatorGroup.playingAggregator.currentItemId=this.hls.playingItem.itemId,e=this.hls.playingItem.itemId,t=i&&i.reportingAgent?i.reportingAgent.SessionID:void 0}else{let i=this.hls.loadingItem.appData;this.rtcAggregatorGroup.loadingAggregator=new pr(this.hls,this.enableRtcReporting,this.hls.config,i),this.rtcAggregatorGroup.loadingAggregator.currentItemId=this.hls.loadingItem.itemId,e=this.hls.loadingItem.itemId,t=i&&i.reportingAgent?i.reportingAgent.SessionID:void 0}this.logger.info(`[QE Critical] isGapless: ${this.hls.inGaplessMode}, isAudioOnly: ${this.hls.streamController.gaplessAllowed}, isFirstItem: ${this.hls.isFirstItem}, SessionID: ${t}, sub itemID: ${e}`)()}onManifestLoaded(e){this._logAndReport(null,F.manifestloaded,{adt:e.stats.tload-e.stats.trequest,contentType:e.stats.contentType})}onManifestParsed(e){this._logAndReport(null,F.manifestparsed,e)}onLevelLoaded(e){let t={url:e.details.url,targetduration:e.details.targetduration,adt:e.stats.tload-e.stats.trequest,contentType:e.stats.contentType,playlistType:e.playlistType};this._logAndReport(null,F.levelloaded,t)}onError(e){return this.onInternalError(e)}onInternalError(e){if(e){let t={details:e.details,fatal:e.fatal,type:r.g.MEDIA_ERROR};e.type===r.g.NETWORK_ERROR?(t.type=e.type,t.code=e.response?e.response.code:void 0,e instanceof r.p&&(e.fatal||(t.failedSwitchUrl=e.url,t.isSeeking=this.isSeeking,this._logAndReport(null,F.levelloaderror,t))),this._logAndReport("Network Error",F.nwerror,t)):e.type!==r.g.MEDIA_ERROR&&e.type!==r.g.MUX_ERROR&&e.type!==r.g.KEY_SYSTEM_ERROR&&e.type!==r.g.OTHER_ERROR||(e.details!==r.d.BUFFER_STALLED_ERROR||e.fatal?this._logAndReport("Media Error",F.mediaerror,t):e.response.code===r.f.InsufficientDataAvailable.code?this._logAndReport("[QE Critical] Buffer stalled due to insufficient data",F.bufferstalled):this._logAndReport("Stalled due to high buffer (media engine)",F.mediaenginestalled))}}notifyKeySessionEvent(e,t){switch(t.timestamp=Date.now(),e){case F.spcreceived:this._logAndReport(null,F.spcreceived,t);break;case F.spcsubmitted:this._logAndReport(null,F.spcsubmitted,t);break;case F.spccreated:this._logAndReport(null,F.spccreated,t),this._logAndReport(null,F.ckcrequested,t);break;case F.ckcsubmitted:this._logAndReport(null,F.ckcreceived,t),this._logAndReport(null,F.ckcsubmitted,t);break;case F.ckcprocessed:this._logAndReport(null,F.ckcprocessed,t);break;case F.keyaborted:this._logAndReport(null,F.keyaborted,t);break;case F.spcerror:this._logAndReport(null,F.spcerror,t);break;case F.ckcerror:this._logAndReport(null,F.ckcerror,t)}}_getAggregator(){if(void 0!==!this.hls.playingItem&&void 0!==this.hls.loadingItem)return this.hls.playingItem.itemId!==this.hls.loadingItem.itemId?this.rtcAggregatorGroup.loadingAggregator:this.rtcAggregatorGroup.playingAggregator}_timeRangeToArray(e){let t=[];for(let i=0;i<e.length;i++)t.push([e.start(i),e.end(i)]);return t}_isWebkitMediaElement(e){return"webkitDroppedFrameCount"in e}_isHtmlVideoElement(e){return"getVideoPlaybackQuality"in e}_videoPlaybackInfo(){let e=this.hls.media;if(!e)return;let t,i,s={readyToPlay:e.readyState>=e.HAVE_FUTURE_DATA,playbackLikelyToKeepUp:this.hls.playbackLikelyToKeepUp,rate:e.playbackRate,paused:e.paused,position:e.currentTime,duration:e.duration,seekableTimeRanges:this._timeRangeToArray(e.seekable),loadedTimeRanges:this._timeRangeToArray(e.buffered)};if(this._isHtmlVideoElement(e)){let r=e.getVideoPlaybackQuality;if(r&&typeof r==typeof Function){let r=e.getVideoPlaybackQuality();t=s.droppedVideoFrames=r.droppedVideoFrames,s.corruptedVideoFrames=r.corruptedVideoFrames,s.totalVideoFrames=r.totalVideoFrames,i=s.totalVideoFrames-t}}else this._isWebkitMediaElement(e)&&(t=s.droppedVideoFrames=e.webkitDroppedFrameCount,i=s.decodedFrameCount=e.webkitDecodedFrameCount);this._logAndReport(`[QE Critical] hls player: ${JSON.stringify(s)}`,F.playbackinfo,{droppedVideoFrames:t,decodedFrameCount:i})}_addMediaEventListeners(e){e&&(this.onloadstart=this._onloadstart.bind(this),this.onpause=this._onpause.bind(this),this.onplaying=this._onplaying.bind(this),this.onseeking=this._onseeking.bind(this),e.addEventListener("loadstart",this.onloadstart),e.addEventListener("pause",this.onpause),e.addEventListener("playing",this.onplaying),e.addEventListener("seeking",this.onseeking))}_removeMediaEventListeners(e){e&&(e.removeEventListener("loadstart",this.onloadstart),e.removeEventListener("pause",this.onpause),e.removeEventListener("playing",this.onplaying),e.removeEventListener("seeking",this.onseeking))}_onloadstart(){this.timer&&clearInterval(this.timer),this.timer=setInterval(this._videoPlaybackInfo.bind(this),1e3),this._logAndReport("[QE Critical] [PlayerEvent]LoadStart")}_onpause(){this._logAndReport("[QE Critical] [PlayerState]Paused/rate=0",F.pause),this._logAndReport("[QE Critical] [PlayerEvent]Paused")}_onplaying(){this.timer||(this.timer=setInterval(this._videoPlaybackInfo.bind(this),1e3)),this._logAndReport("[QE Critical] [PlayerEvent]CanPlay",F.canplay),this._logAndReport("[QE Critical] [PlayerState]Playing/rate="+this.desiredRate,F.playing),this.isSeeking=!1,this.logger.info("[QE Critical] [PlayerEvent]Playing, sessionID: "+this.hls.sessionID+"-"+this.hls.playingItem.itemId)()}_onseeking(){this._logAndReport("[QE Critical] [PlayerEvent]Seeking"),this.isSeeking=!0}_logAndReport(e,t,i){this.enablePerformanceLogging&&e&&this.logger.info(e)(),this._getAggregator()&&t&&this._getAggregator().notify(t,i)}},yr=class{constructor(e){this.alpha_=e?Math.exp(Math.log(.5)/e):0,this.estimate_=0,this.totalWeight_=0,this.numSamples_=0}sample(e,t){var i=Math.pow(this.alpha_,e);this.estimate_=t*(1-i)+i*this.estimate_,this.totalWeight_+=e,this.numSamples_++}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){var e=1-Math.pow(this.alpha_,this.totalWeight_);return this.estimate_/e}return this.estimate_}};!(function(e){e.LowBandwidth="LowBandwidth",e.HighBandwidth="HighBandwidth"})(gr||(gr={}));class vr extends P{constructor(e){super(e,s.a.MEDIA_ATTACHING,s.a.MEDIA_DETACHING,s.a.LEVEL_PTS_UPDATED,s.a.LEVEL_UPDATED,s.a.AUDIO_TRACK_LOADED),this._needsFlush=!1,this._needsEos=!1,this.bufferCodecEventsExpected=0,this.numAppended=0,this.flushBufferCounter=0,this.postFlushAction=void 0,this.postFlushContext=void 0,this.sbInfoMap=new Map,this.parentToTrackName=new Map,this.flushRange=[],this._msDuration=null,this._levelDuration=null,this.pendingTracks=new Map,this.trackCodecByCC={},this.parentInitInfo={},this.invalidSourceBufferNb=0,this.sourceBufferTimeout=1e4,this.alwaysResetOnNewCC=e.config.alwaysResetOnNewCC}get totalItemDuration(){return this.postFlushContext?this.postFlushContext.duration:this._msDuration}destroy(){this.sbInfoMap.forEach(e=>{this.abortPendingAppendsInternal(e,0,Number.POSITIVE_INFINITY)}),this._clearTimer(),P.prototype.destroy.call(this)}_clearTimer(){this.sbOpenTimer&&(clearTimeout(this.sbOpenTimer),this.sbOpenTimer=null)}onLevelPtsUpdated(e){if("audio"===e.type&&this.updateMp3Timestamps){let t=this.sbInfoMap.get("audio");if(t&&t.sourceBuffer){let i=t.sourceBuffer;if(Math.abs(i.timestampOffset-e.start)>.1){let t=i.updating;try{i.abort()}catch(e){t=!0,this.logger.warn("can not abort audio buffer: "+e)()}t?this.audioTimestampOffset=e.start:(this.logger.warn("change mpeg audio timestamp offset from "+i.timestampOffset+" to "+e.start)(),i.timestampOffset=e.start)}}}this.onLevelUpdated(e)}setExpectedSB(e,t,i){let s=0;i&&(t||e)&&(s=(t?1:0)+(e?1:0)),this.sourceBufferNb=s,this.pendingTracks.clear()}onMediaAttaching(e){this.logger.info("media source attaching")();let t=this.media=e.media;if(t){var i=this.mediaSource=new MediaSource;this.onmso=this.onMediaSourceOpen.bind(this),this.onmse=this.onMediaSourceEnded.bind(this),this.onmsc=this.onMediaSourceClose.bind(this),i.addEventListener("sourceopen",this.onmso),i.addEventListener("sourceended",this.onmse),i.addEventListener("sourceclose",this.onmsc),t.src=URL.createObjectURL(i),this._objectUrl=t.src,this.sbOpenTimer||(this.sbOpenTimer=setTimeout(this._handleMediaSourceTimeout.bind(this),this.sourceBufferTimeout))}}onMediaDetaching(){this.logger.info("media source detaching")();var e=this.mediaSource;if(e){if("open"===e.readyState)try{e.endOfStream()}catch(e){this.logger.error(`onMediaDetaching:${e.message} while calling endOfStream`)()}e.removeEventListener("sourceopen",this.onmso),e.removeEventListener("sourceended",this.onmse),e.removeEventListener("sourceclose",this.onmsc),this.media&&(URL.revokeObjectURL(this._objectUrl),this.media.src===this._objectUrl?(this.media.removeAttribute("src"),this.media.load()):this.logger.warn("media.src was changed by a third party - skip cleanup")()),this.mediaSource=null,this.media=null,this._objectUrl=null,this.pendingTracks.clear(),this.parentInitInfo={},this.parentToTrackName.clear(),this.sbInfoMap.forEach(e=>{this.abortPendingAppendsInternal(e,0,Number.POSITIVE_INFINITY)}),this.sbInfoMap.clear(),this.flushRange=[],this.numAppended=0,this.currentCC=void 0,this.updateMp3Timestamps=!1,this.postFlushAction=void 0,this.postFlushContext=void 0}this.onmso=this.onmse=this.onmsc=null,this._clearTimer(),this.resettingMediaSource||this.hls.trigger(s.a.MEDIA_DETACHED)}resetLoadSource(){this.parentInitInfo={}}_handleMediaSourceTimeout(){this.logger.warn("Timeout while waiting for sourceopen callback from MediaSource")(),this.sbOpenTimer=null}onMediaSourceOpen(){if(this._clearTimer(),this.resettingMediaSource){this.resettingMediaSource=!1,this.updateMediaElementDuration();const e={media:this.media};this.hls.trigger(s.a.BUFFER_SOURCE_RESET,e)}else this.hls.trigger(s.a.MEDIA_ATTACHED,{media:this.media});let e=this.mediaSource;e&&e.removeEventListener("sourceopen",this.onmso),this.checkPendingTracks()}ignoreSourceBuffer(e){let t=this.mediaSource;t&&t.sourceBuffers&&t.sourceBuffers.length>0?this.invalidSourceBufferNbAfterReset=e:(this.invalidSourceBufferNb=e,this.checkPendingTracks())}ensureCompatibleTracksForGaplessPlayback(e){let t=!0;const i=this.sbInfoMap;if(Qs.find(e=>i.get(e)&&i.get(e).sourceBuffer))for(let s=0;s<Qs.length&&t;++s){let r=Qs[s],a=i.get(r)&&i.get(r).sourceBuffer,n=e.get(r);if(a&&n){let e=this.pickCodec(n.codec,n.levelCodec);t=Oi.b.isCompatibleCodecString(e,a.codec)}else a?t=!1:n&&(t=!1)}else this.logger.info("no sourceBuffer")();return t}matchSourceBufferCount(){const e=this.pendingTracks.size;let t=this.sourceBufferNb-this.invalidSourceBufferNb,i=e&&(t<=e||0===t);return i&&this.hls.isPreloadingItem&&((i=this.ensureCompatibleTracksForGaplessPlayback(this.pendingTracks))||this.hls.dequeueSource(r.m.InvalidFormat)),i}checkPendingTracks(){this.matchSourceBufferCount()&&(this.createSourceBuffers(this.pendingTracks),this.pendingTracks.clear(),this.doAppendAll())}onMediaSourceClose(){}onMediaSourceEnded(){}static updateBufferedInfo(e,t){let i=0,s=[];e.buffered.forEach(e=>{if(e.startPTS>=e.endPTS)return;let r=t.find(t=>!(t.start>e.endPTS||t.end<=e.startPTS));if(r){let t=Math.max(r.start,e.startPTS),a=Math.min(r.end,e.endPTS);i+=e.bytes*(a-t)/(e.endPTS-e.startPTS),s.push(e)}}),e.totalBytes=i,e.buffered=s}static mergeToBuffer(e,t){let i=Array.from(e);return i.forEach(e=>{let i=Math.max(t.startPTS,e.startPTS),s=Math.min(t.endPTS,e.endPTS);i>=s||(e.bytes=(1-(s-i)/(e.endPTS-e.startPTS))*e.bytes,e.startPTS<t.startPTS?e.endPTS=i:e.startPTS=s)}),i.push(t),(i=i.filter(e=>e.bytes>0)).sort((e,t)=>e.startPTS-t.startPTS),i}onSBUpdateEnd(e){if(this.audioTimestampOffset){let e=this.sbInfoMap.get("audio");if(e&&e.sourceBuffer){let t=e.sourceBuffer;this.logger.warn("change mpeg audio timestamp offset from "+t.timestampOffset+" to "+this.audioTimestampOffset)(),t.timestampOffset=this.audioTimestampOffset,delete this.audioTimestampOffset}}this._needsFlush&&this.doFlush(),this._needsEos&&this.checkEos();let t=this.ensureSBInfo(e),i=t.parent,r=t.inFlight;t.inFlight=void 0,r&&(this.logAppendTiming(i,r,"appended"),Object(Oi.c)(r.startPTS)&&Object(Oi.c)(r.endPTS)&&(t.buffered=vr.mergeToBuffer(t.buffered,r)));let a=0,n=this.parentToTrackName.get(i);n&&n.forEach(e=>{a+=this.ensureSBInfo(e).appendQueue.length});let o={};this.sbInfoMap.forEach((e,t)=>{e.sourceBuffer&&(o[t]=e.sourceBuffer.buffered,vr.updateBufferedInfo(e,Os.buffered(e.sourceBuffer)),e.totalBytes>e.maxTotalBytes&&(e.maxTotalBytes=e.totalBytes))});let l={parent:i,pending:a,timeRanges:o,frag:r?r.frag:void 0};this.hls.trigger(s.a.BUFFER_APPENDED,l),this._needsFlush||this.doAppending(e),this.updateMediaElementDuration()}onSBUpdateError(e,t){this.logger.error("sourceBuffer error:",t)();let i=this.sbInfoMap.get(e).parent,a=new r.b(r.g.MEDIA_ERROR,r.d.BUFFER_APPENDING_ERROR,!1,t.message,r.f.VideoDecoderBadDataErr,i,e);this.hls.trigger(s.a.INTERNAL_ERROR,a)}resetMediaSource(e=!1){if(this.media&&!this.resettingMediaSource){let t=this.media;this.resettingMediaSource=!0,this.resetBuffer(e),this.hls.trigger(s.a.BUFFER_SOURCE_RESETTING),this.onMediaDetaching(),this.onMediaAttaching({media:t})}}resetBuffer(e=!1){this.sbInfoMap.forEach(e=>{this.abortPendingAppendsInternal(e,0,Number.POSITIVE_INFINITY);let t=e.sourceBuffer;if(t)try{this.mediaSource.removeSourceBuffer(t),t.removeEventListener("updateend",e.onupdateend),t.removeEventListener("error",e.onerror)}catch(e){this.logger.error(e)()}}),this._needsFlush=!1,this.parentToTrackName.clear(),this.sbInfoMap.clear(),this.flushRange=[],this.numAppended=0,e?(this.invalidSourceBufferNb=0,this.invalidSourceBufferNbAfterReset=void 0):this.invalidSourceBufferNbAfterReset?(this.invalidSourceBufferNb=this.invalidSourceBufferNbAfterReset,this.invalidSourceBufferNbAfterReset=void 0):this.invalidSourceBufferNb=0}createBuffer(e,t,i,s,r,a){let n=0;for(let e of this.sbInfoMap.values())e.sourceBuffer&&++n;if(0===n||this.hls.isPreloadingItem){this.pendingTracks.set(t,{codec:s,container:r,parent:e,cc:i,levelCodec:a});let n=this.mediaSource;n&&"open"===n.readyState&&this.checkPendingTracks()}}ensureSBInfo(e){let t=this.sbInfoMap.get(e);return t||(t={appendQueue:[],parent:void 0,inFlight:void 0,buffered:[],totalBytes:0,maxTotalBytes:0,gotQuotaExceeded:!1,appendErrors:0},this.sbInfoMap.set(e,t)),t}createSourceBuffers(e){const t=this.mediaSource;let i={};for(let[a,n]of e){let o=this.ensureSBInfo(a);if(!o.sourceBuffer){let l=this.pickHighestCodec(n.codec,n.levelCodec),d=`${n.container};codecs=${l}`;this.logger.info(`creating sourceBuffer(${d}) for codec/levelCodec ${n.codec}/${n.levelCodec}`)();try{let h=t.addSourceBuffer(d);h.codec=l,o.sourceBuffer=h,h.timestampOffset=-1*this.hls.config.audioPrimingDelay,o.onupdateend=e=>{this.onSBUpdateEnd(a)},o.onerror=e=>{this.onSBUpdateError(a,e)},h.addEventListener("updateend",o.onupdateend),h.addEventListener("error",o.onerror),i[a]={id:n.parent,codec:l,container:n.container,buffer:h},void 0!==this.currentCC&&this.currentCC!==n.cc?this.logger.error("createSourceBuffers: track cc mismatch!")():this.currentCC=n.cc,"audio"===a&&"audio/mpeg"===n.container&&(this.updateMp3Timestamps=!0)}catch(e){this.logger.error(`error while trying to add sourceBuffer:${e.message}`)();let t=new r.r(r.g.MEDIA_ERROR,r.d.BUFFER_ADD_CODEC_ERROR,!1,e.message,r.f.VideoDecoderBadDataErr);t.mimeType=d,this.hls.trigger(s.a.INTERNAL_ERROR,t)}}}this.hls.trigger(s.a.BUFFER_CREATED,{tracks:i})}pickCodec(e,t){return void 0===(e=t&&"vp09"===e?t.substring(0,13):e||t)?"":e}pickHighestCodec(e,t){let i=e||t;return Oi.b.isVideoCodec(i)&&i.split(",").length<2&&(i=this.hls.levelController.variantManager.getHighestCodecByFamily(e)),void 0===i?"":i}updateKnownCodecs(e,t,i,s){let r=!0;if(i=this.pickCodec(i,s),this.trackCodecByCC[e]||(this.trackCodecByCC[e]={}),this.trackCodecByCC[e][t]){let s=this.trackCodecByCC[e][t];r=r&&Oi.b.isCompatibleCodecString(s,i)}return this.trackCodecByCC[e][t]=i,r}isTrackCompatibleTransition(e,t){let i=this.currentCC;if(void 0===i||i===t)return"yes";if(this.alwaysResetOnNewCC)return"no";let s,r=this.trackCodecByCC,a=r[e]&&r[e][i]?r[e][i]:void 0,n=r[e]&&r[e][t]?r[e][t]:void 0;return a&&n?s=Oi.b.isCompatibleCodecString(a,n)?"yes":"no":r.audiovideo&&r.audiovideo[i]&&(r.video&&r.video[t]||r.audio&&r.audio[t])?s="no":(r.audio&&r.audio[i]||r.video&&r.video[i])&&r.audiovideo&&r.audiovideo[t]?s="no":n&&(s="no"),s}isParentCompatibleTransition(e,t){return"main"===e?this.trackCodecByCC.audiovideo?this.isTrackCompatibleTransition("audiovideo",t):this.isTrackCompatibleTransition("video",t):"audio"===e?this.isTrackCompatibleTransition("audio",t):"unknown"}isCompatibleTransitionWithSeparateSourceBuffers(e){let t=this.isTrackCompatibleTransition("video",e),i=2===this.sourceBufferNb?this.isTrackCompatibleTransition("audio",e):"yes",s="unknown";return"no"===t||"no"===i?s="no":"yes"===t&&"yes"===i&&(s="yes"),s}isCompatibleTransitionWithCombinedSourceBuffer(e){return this.isTrackCompatibleTransition("audiovideo",e)}isCompatibleTransition(e){var t;return isNaN(e)?"unknown":null!==(t=this.trackCodecByCC.audiovideo)&&void 0!==t&&t?this.isCompatibleTransitionWithCombinedSourceBuffer(e):this.isCompatibleTransitionWithSeparateSourceBuffers(e)}appendBuffer(e,t,i,s,r,a,n){let{level:o,sn:l,cc:d}=n,h={level:o,sn:l,cc:d};n.decryptdata&&n.decryptdata.keyId&&(h.decryptdata={keyId:n.decryptdata.keyId});let c={type:e,data:t,startPTS:i,endPTS:s,parent:r,content:a,frag:h};this._needsFlush&&this.logger.warn(`Flush is in process and type/content: ${e}/${a} will not be appended, sn/cc/level ${l}/${d}/${o}`)();let u=this.parentToTrackName.get(r);if(u||(u=new Set,this.parentToTrackName.set(r,u)),u.add(e),!this._needsFlush){let t=this.ensureSBInfo(e);t.parent&&t.parent!==r&&this.logger.warn(`Unexpected parent for ${e} ${t.parent} !== ${r}`)(),t.appendQueue.push(c),this.doAppending(e)}}scheduleAppendRetry(e,t){let i=this.sbInfoMap.get(e);i&&(clearTimeout(i.retryTimeout),i.retryTimeout=setTimeout(()=>{this.doAppending(e)},t))}getCurrentInitInfoForParent(e){return this.parentInitInfo[e]}clearTrackNamesForParent(e){this.parentToTrackName.delete(e)}hasPendingAppends(e){let t=!1,i=this.parentToTrackName.get(e);return i&&i.forEach(e=>{let i=this.sbInfoMap.get(e);i&&(t=t||i.appendQueue.length>0||void 0!==i.inFlight)}),t}abortPendingAppendsByParent(e,t,i){let s=this.parentToTrackName.get(e);s&&s.forEach(e=>{this.abortPendingAppendsByType(e,t,i)})}abortPendingAppendsByType(e,t,i){let s=this.sbInfoMap.get(e);s&&this.abortPendingAppendsInternal(s,t,i)}abortPendingAppendsInternal(e,t,i){e.appendQueue=e.appendQueue.filter(e=>e.endPTS<=t||e.startPTS>=i),e.retryTimeout&&(clearTimeout(e.retryTimeout),e.retryTimeout=void 0)}getEstimatedMaxBuffer(e){let t=this.sbInfoMap.get(e);return t&&t.sourceBuffer&&t.gotQuotaExceeded?t.maxTotalBytes:Number.POSITIVE_INFINITY}endBuffer(e){this.sbInfoMap.forEach((t,i)=>{if(!e||i===e){let e=t.sourceBuffer;e&&!e.ended&&(e.ended=!0,this.logger.info(`${i} sourceBuffer now EOS`)())}}),this.checkEos()}checkEos(){var e=this.sbInfoMap,t=this.mediaSource;if(t&&"open"===t.readyState){for(let t of e.values()){let e=t.sourceBuffer;if(e){if(!e.ended)return;if(e.updating)return void(this._needsEos=!0)}}this.logger.info("all media data available, signal endOfStream() to MediaSource and stop loading fragment")();try{t.endOfStream()}catch(e){this.logger.warn("exception while calling mediaSource.endOfStream()")()}this._needsEos=!1}else this._needsEos=!1}flushBufferRange(e,t,i,s=!1,r,a){i?this.abortPendingAppendsByType(i,e,t):this.sbInfoMap.forEach(i=>{this.abortPendingAppendsInternal(i,e,t)}),this.flushRange.push({start:e,end:t,type:i,forceAll:s}),this.flushBufferCounter=0,a?(r&&this.postFlushContext&&(r.duration===this.postFlushContext.duration?this.logger.warn(`[gapless] duplicated EVICT_ITEMs: flush(${e}, ${t}, ${r.duration}) vs flush(${this.postFlushContext.duration},infinity); media duration ${this.media.duration}`)():this.logger.error(`[gapless] different EVICT_ITEMs overlapped: flush(${e}, ${t}, ${r.duration}) vs flush(${this.postFlushContext.duration},infinity); media duration ${this.media.duration}`)()),this.postFlushAction=a,this.postFlushContext=r):this.postFlushAction&&this.logger.info(`[gapless] flush(${e}, ${t}) overlap EVICT_ITEM flush(${this.postFlushContext?this.postFlushContext:"undefined"},infinity); media duration ${this.media.duration}`)(),this.doFlush()}onLevelUpdated(e){let t=e.details;t&&0!==t.fragments.length&&(this._levelDuration=t.totalduration+t.fragments[0].start,this.updateMediaElementDuration())}onAudioTrackLoaded(e){this.onLevelUpdated(e)}updateMediaElementDuration(){let e=this.media,t=this.mediaSource,i=this._levelDuration;if(null===i||!e||!t||"open"!==t.readyState)return;if(Qs.find(e=>this.isSourceBufferUpdating(e)))return;let s=e.duration;if(null===this._msDuration||!isFinite(s)||i>this._msDuration&&i>s)try{t.duration=i,this._msDuration=i}catch(e){this.logger.error(`Exception setting mediasource duration ${e.message}`)()}}isSourceBufferUpdating(e){if(Xs(e)){let t=this.sbInfoMap.get(e);return void 0!==t&&void 0!==t.sourceBuffer&&t.sourceBuffer.updating}let t=!1;for(let[e,i]of this.sbInfoMap.entries()){let s=i.sourceBuffer;s&&(s.updating&&this.logger.warn(`sourceBuffer '${e}' is busy`)(),t=t||s.updating)}return t}sourceBufferHasProperInitSegment(e,t){const i=this.parentInitInfo[e];return!!i&&Object(xs.c)(t)===Object(xs.c)(i)}updateDurationAfterEvictItem(e){this.logger.info(`[gapless] media duration after EVICT_ITEM flush = ${e}`)(),this._msDuration=this._levelDuration=e,this.mediaSource.duration=e}shouldEvictItem(){return void 0!==this.postFlushAction}ensureItemEvicted(){let e=!1;return this.shouldEvictItem()&&!this.isSourceBufferUpdating()&&(this.postFlushAction(this.postFlushContext),this.postFlushAction=void 0,this.postFlushContext=void 0,e=!0),e}evictItemCompleted(){return this.ensureItemEvicted(),!this.shouldEvictItem()}doFlush(){let e=!this.shouldEvictItem();for(;this.flushRange.length;){var t=this.flushRange[0];if(!this.flushBuffer(t.start,t.end,t.type,t.forceAll))return void(this._needsFlush=!0);this.flushRange.shift(),this.flushBufferCounter=0}if(0===this.flushRange.length){this._needsFlush=!1;var i=0;try{this.sbInfoMap.forEach(e=>{i+=e.sourceBuffer.buffered.length})}catch(e){this.logger.error("error while accessing sourceBuffer.buffered")()}this.numAppended=i,this.hls.trigger(s.a.BUFFER_FLUSHED,{seekAfterFlush:e})}}doAppendAll(){for(let e of this.sbInfoMap.keys())this.doAppending(e)}doAppending(e){let t=this.ensureSBInfo(e),i=t.appendQueue;if(clearTimeout(t.retryTimeout),t.retryTimeout=void 0,0===i.length||!this.media)return;if(this.media.error)return this.logger.error("trying to append although a media error occured, flush segment and abort")(),void this.sbInfoMap.forEach(e=>{this.abortPendingAppendsInternal(e,0,Number.POSITIVE_INFINITY)});let a=t.sourceBuffer;if(!a)return void this.logger.warn(`Source buffer not yet created for ${e}`)();if(a.updating)return;let n=i.shift();try{const{type:e,frag:o,content:l,parent:d,startPTS:h,endPTS:c,data:u}=n;a.ended=!1,t.parent=d;let f={type:e,parent:d,content:l,frag:o,startPTS:h,endPTS:c};if(this.hls.trigger(s.a.BUFFER_APPENDING,f),t.inFlight={startPTS:h,endPTS:c,bytes:u.byteLength,tstart:performance.now(),frag:o},this.logAppendTiming(d,t.inFlight,"appending"),"data"===l){let e=this.parentInitInfo[d];const t=Object(xs.c)(o),i=e?Object(xs.c)(e):void 0;i!==t&&this.logger.error(`mismatching initSegment: ${i} to data: ${t}`)()}else if(this.alwaysResetOnNewCC&&"initSegment"===l){const e=this.parentInitInfo[d];if(e&&e.cc!==o.cc)throw{message:"alwaysResetOnNewCC detected cc switch without reset"}}if(a.appendBuffer(u),"initSegment"===l){const{cc:e,level:t,sn:i}=o;this.parentInitInfo[d]={cc:e,level:t,sn:i},o.decryptdata&&o.decryptdata.keyId&&(this.parentInitInfo[d].decryptdata={keyId:o.decryptdata.keyId})}t.appendErrors=0,this.numAppended++}catch(a){if(t.inFlight=void 0,this.logger.error(`error while trying to append buffer:${a.message}`)(),i.unshift(n),22!==a.code){let i=new r.b(r.g.MEDIA_ERROR,r.d.BUFFER_APPEND_ERROR,!1,a.message,r.f.VideoDecoderBadDataErr,n.parent,n.type);if(++t.appendErrors,t.appendErrors>this.hls.config.appendErrorMaxRetry)return this.logger.error(`fail ${this.hls.config.appendErrorMaxRetry} times to append segment in sourceBuffer`)(),this.abortPendingAppendsByType(e,0,Number.POSITIVE_INFINITY),i.fatal=!0,void this.hls.trigger(s.a.INTERNAL_ERROR,i);i.fatal=!1,this.hls.trigger(s.a.INTERNAL_ERROR,i)}else{t.gotQuotaExceeded=!0,vr.updateBufferedInfo(t,Os.buffered(t.sourceBuffer)),++t.appendErrors;let e=new r.b(r.g.MEDIA_ERROR,r.d.BUFFER_FULL_ERROR,!1,a.message,r.f.AllocationFailed,n.parent,n.type,t.maxTotalBytes);this.hls.trigger(s.a.INTERNAL_ERROR,e)}}}abortBuffer(e){let t=this.sbInfoMap.get(e);t&&(this.logger.warn("aborting any appends for "+e)(),t.sourceBuffer.abort(),delete this.parentInitInfo[t.parent])}flushBuffer(e,t,i,s=!1){let r,a,n,o;if(this.sbInfoMap.size>0)if(this.logger.info(`flushBuffer,pos/start/end/forceAll: ${this.media.currentTime.toFixed(3)}/${e}/${t}/${s}/${i}`)(),this.flushBufferCounter<this.numAppended)for(let[l,d]of this.sbInfoMap.entries()){if(i&&l!==i)continue;let h=d.sourceBuffer;if(h){if(h.ended=!1,h.updating)return this.logger.warn("cannot flush, sb updating in progress")(),!1;try{for(let i=0;i<h.buffered.length;i++)if(r=h.buffered.start(i),a=h.buffered.end(i),-1!==navigator.userAgent.toLowerCase().indexOf("firefox")&&t===Number.POSITIVE_INFINITY?(n=e,o=t):(n=Math.max(r,e),o=Math.min(a,t)),s&&Math.min(o,a)>n||Math.min(o,a)-n>.5)return this.flushBufferCounter++,h.remove(n,o),!1}catch(e){this.logger.warn("exception while accessing sourcebuffer, it might have been removed from MediaSource")()}}}else this.logger.warn(`abort flushing too many retries: ${this.hls.streamController.bufferedRangeString}`)();return!0}logAppendTiming(e,t,i){this.hls.config.enablePerformanceLogging&&this.logger.info(`[timing] ${JSON.stringify({t:performance.now(),name:e,level:t.frag.level,sn:t.frag.sn,cc:t.frag.cc,startPTS:t.startPTS,endPTS:t.endPTS,stage:i})}`)()}}var br=vr,Tr=i(13),Sr={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},Ir=function(e){var t=e;return Sr.hasOwnProperty(e)&&(t=Sr[e]),String.fromCharCode(t)},Er=15,_r=100,Rr={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},Dr={17:2,18:4,21:6,22:8,23:10,19:13,20:15},Ar={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},Lr={25:2,26:4,29:6,30:8,31:10,27:13,28:15},wr=["white","green","blue","cyan","red","yellow","magenta","black","transparent"],kr={verboseFilter:{DATA:3,DEBUG:3,INFO:2,WARNING:2,TEXT:1,ERROR:0},time:null,verboseLevel:0,setTime:function(e){this.time=e},log:function(e,t){var i=this.verboseFilter[e];this.verboseLevel>=i&&console.log(this.time+" ["+e+"] "+t)}},Cr=function(e){for(var t=[],i=0;i<e.length;i++)t.push(e[i].toString(16));return t};class Pr{constructor(e,t,i,s,r){this.foreground=e||"white",this.underline=t||!1,this.italics=i||!1,this.background=s||"black",this.flash=r||!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(e){var t;t=e,Object.assign(this,t)}isDefault(){return"white"===this.foreground&&!this.underline&&!this.italics&&"black"===this.background&&!this.flash}equals(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}copy(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class Mr{constructor(e,t,i,s,r,a){this.uchar=e||" ",this.penState=new Pr(t,i,s,r,a)}reset(){this.uchar=" ",this.penState.reset()}setChar(e,t){this.uchar=e,this.penState.copy(t)}setPenState(e){this.penState.copy(e)}equals(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}copy(e){this.uchar=e.uchar,this.penState.copy(e.penState)}isEmpty(){return" "===this.uchar&&this.penState.isDefault()}}class Or{constructor(){this.chars=[];for(var e=0;e<_r;e++)this.chars.push(new Mr);this.pos=0,this.currPenState=new Pr}equals(e){for(var t=!0,i=0;i<_r;i++)if(!this.chars[i].equals(e.chars[i])){t=!1;break}return t}copy(e){for(var t=0;t<_r;t++)this.chars[t].copy(e.chars[t])}isEmpty(){for(var e=!0,t=0;t<_r;t++)if(!this.chars[t].isEmpty()){e=!1;break}return e}setCursor(e){this.pos!==e&&(this.pos=e),this.pos<0?(kr.log("ERROR","Negative cursor position "+this.pos),this.pos=0):this.pos>_r&&(kr.log("ERROR","Too large cursor position "+this.pos),this.pos=_r)}moveCursor(e){var t=this.pos+e;if(e>1)for(var i=this.pos+1;i<t+1;i++)this.chars[i].setPenState(this.currPenState);this.setCursor(t)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(e){e>=144&&this.backSpace();var t=Ir(e);this.pos>=_r?kr.log("ERROR","Cannot insert "+e.toString(16)+" ("+t+") at position "+this.pos+". Skipping it!"):(this.chars[this.pos].setChar(t,this.currPenState),this.moveCursor(1))}clearFromPos(e){var t;for(t=e;t<_r;t++)this.chars[t].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){for(var e=[],t=!0,i=0;i<_r;i++){var s=this.chars[i].uchar;" "!==s&&(t=!1),e.push(s)}return t?"":e.join("")}setPenStyles(e){this.currPenState.setStyles(e),this.chars[this.pos].setPenState(this.currPenState)}}class Nr{constructor(){this.rows=[];for(var e=0;e<Er;e++)this.rows.push(new Or);this.currRow=Er-1,this.nrRollUpRows=null,this.reset()}reset(){for(var e=0;e<Er;e++)this.rows[e].clear();this.currRow=Er-1}equals(e){for(var t=!0,i=0;i<Er;i++)if(!this.rows[i].equals(e.rows[i])){t=!1;break}return t}copy(e){for(var t=0;t<Er;t++)this.rows[t].copy(e.rows[t])}isEmpty(){for(var e=!0,t=0;t<Er;t++)if(!this.rows[t].isEmpty()){e=!1;break}return e}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(e){this.rows[this.currRow].insertChar(e)}setPen(e){this.rows[this.currRow].setPenStyles(e)}moveCursor(e){this.rows[this.currRow].moveCursor(e)}setCursor(e){kr.log("INFO","setCursor: "+e),this.rows[this.currRow].setCursor(e)}setPAC(e){kr.log("INFO","pacData = "+JSON.stringify(e));var t=e.row-1;if(this.nrRollUpRows&&t<this.nrRollUpRows-1&&(t=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==t){for(let e=0;e<Er;e++)this.rows[e].clear();var i=this.currRow+1-this.nrRollUpRows;const e=this.lastOutputScreen;if(e){var s=e.rows[i].cueStartTime;if(s&&s<kr.time)for(let s=0;s<this.nrRollUpRows;s++)this.rows[t-this.nrRollUpRows+s+1].copy(e.rows[i+s])}}this.currRow=t;var r=this.rows[this.currRow];if(null!==e.indent){var a=e.indent,n=Math.max(a-1,0);r.setCursor(e.indent),e.color=r.chars[n].penState.foreground}var o={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:!1};this.setPen(o)}setBkgData(e){kr.log("INFO","bkgData = "+JSON.stringify(e)),this.backSpace(),this.setPen(e),this.insertChar(32)}setRollUpRows(e){this.nrRollUpRows=e}rollUp(){if(null!==this.nrRollUpRows){kr.log("INFO","TEXT "+this.getDisplayText());var e=this.currRow+1-this.nrRollUpRows,t=this.rows.splice(e,1)[0];t.clear(),this.rows.splice(this.currRow,0,t),kr.log("INFO","Rolling up")}else kr.log("DEBUG","roll_up but nrRollUpRows not set yet")}getDisplayText(e){e=e||!1;for(var t=[],i="",s=-1,r=0;r<Er;r++){var a=this.rows[r].getTextString();a&&(s=r+1,e?t.push("Row "+s+": '"+a+"'"):t.push(a.trim()))}return t.length>0&&(i=e?"["+t.join(" | ")+"]":t.join("\n")),i}getTextAndFormat(){return this.rows}}class xr{constructor(e,t){this.chNr=e,this.outputFilter=t,this.mode=null,this.verbose=0,this.displayedMemory=new Nr,this.nonDisplayedMemory=new Nr,this.lastOutputScreen=new Nr,this.currRollUpRow=this.displayedMemory.rows[Er-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.currRollUpRow=this.displayedMemory.rows[Er-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.lastCueEndTime=null}getHandler(){return this.outputFilter}setHandler(e){this.outputFilter=e}setPAC(e){this.writeScreen.setPAC(e)}setBkgData(e){this.writeScreen.setBkgData(e)}setMode(e){e!==this.mode&&(this.mode=e,kr.log("INFO","MODE="+e),"MODE_POP-ON"===this.mode?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),"MODE_ROLL-UP"!==this.mode&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)}insertChars(e){for(var t=0;t<e.length;t++)this.writeScreen.insertChar(e[t]);var i=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";kr.log("INFO",i+": "+this.writeScreen.getDisplayText(!0)),"MODE_PAINT-ON"!==this.mode&&"MODE_ROLL-UP"!==this.mode||(kr.log("TEXT","DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){kr.log("INFO","RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){kr.log("INFO","BS - BackSpace"),"MODE_TEXT"!==this.mode&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){kr.log("INFO","DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(e){kr.log("INFO","RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)}ccFON(){kr.log("INFO","FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){kr.log("INFO","RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){kr.log("INFO","TR"),this.setMode("MODE_TEXT")}ccRTD(){kr.log("INFO","RTD"),this.setMode("MODE_TEXT")}ccEDM(){kr.log("INFO","EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){kr.log("INFO","CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){kr.log("INFO","ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(kr.log("INFO","EOC - End Of Caption"),"MODE_POP-ON"===this.mode){var e=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,kr.log("TEXT","DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)}ccTO(e){kr.log("INFO","TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)}ccMIDROW(e){var t={flash:!1,underline:!1,italics:!1};if(t.underline=e%2==1,t.italics=e>=46,t.italics)t.foreground="white";else{var i=Math.floor(e/2)-16;t.foreground=["white","green","blue","cyan","red","yellow","magenta"][i]}kr.log("INFO","MIDROW: "+JSON.stringify(t)),this.writeScreen.setPen(t)}outputDataUpdate(e=!1){var t=kr.time;null!==t&&this.outputFilter&&(this.outputFilter.updateData&&this.outputFilter.updateData(t,this.displayedMemory),null!==this.cueStartTime||this.displayedMemory.isEmpty()?this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue&&(this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),!0===e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue()),this.cueStartTime=this.displayedMemory.isEmpty()?null:t):this.cueStartTime=t,this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))}}var Fr=class{constructor(e=1,t,i){this.field=e,this.currChNr=-1,this.lastCmdA=null,this.lastCmdB=null,this.channels=[new xr(1,t),new xr(2,i)],this.dataCounters={padding:0,char:0,cmd:0,other:0}}getHandler(e){return this.channels[e].getHandler()}setHandler(e,t){this.channels[e].setHandler(t)}addData(e,t){let i,s,r,a=null;kr.setTime(e);for(var n=0;n<t.length;n+=2)s=127&t[n],r=127&t[n+1],s>=16&&s<=31&&s===this.lastCmdA&&r===this.lastCmdB?(this.lastCmdA=null,this.lastCmdB=null,kr.log("DEBUG","Repeated command ("+Cr([s,r])+") is dropped")):0!==s||0!==r?(kr.log("DATA","["+Cr([t[n],t[n+1]])+"] -> ("+Cr([s,r])+")"),(i=this.parseCmd(s,r))||(i=this.parseMidrow(s,r)),i||(i=this.parsePAC(s,r)),i||(i=this.parseBackgroundAttributes(s,r)),i||(a=this.parseChars(s,r))&&(this.currChNr&&this.currChNr>=0?this.channels[this.currChNr-1].insertChars(a):kr.log("WARNING","No channel found yet. TEXT-MODE?")),i?this.dataCounters.cmd+=2:a?this.dataCounters.char+=2:(this.dataCounters.other+=2,kr.log("WARNING","Couldn't parse cleaned data "+Cr([s,r])+" orig: "+Cr([t[n],t[n+1]])))):this.dataCounters.padding+=2}parseCmd(e,t){var i;if(!((20===e||21===e||28===e||29===e)&&32<=t&&t<=47||(23===e||31===e)&&33<=t&&t<=35))return!1;i=20===e||23===e?1:2;var s=this.channels[i-1];return 20===e||21===e||28===e||29===e?32===t?s.ccRCL():33===t?s.ccBS():34===t?s.ccAOF():35===t?s.ccAON():36===t?s.ccDER():37===t?s.ccRU(2):38===t?s.ccRU(3):39===t?s.ccRU(4):40===t?s.ccFON():41===t?s.ccRDC():42===t?s.ccTR():43===t?s.ccRTD():44===t?s.ccEDM():45===t?s.ccCR():46===t?s.ccENM():47===t&&s.ccEOC():s.ccTO(t-32),this.lastCmdA=e,this.lastCmdB=t,this.currChNr=i,!0}parseMidrow(e,t){var i=null;if((17===e||25===e)&&32<=t&&t<=47){if((i=17===e?1:2)!==this.currChNr)return kr.log("ERROR","Mismatch channel in midrow parsing"),!1;var s=this.channels[i-1];return s.insertChars([32]),s.ccMIDROW(t),kr.log("DEBUG","MIDROW ("+Cr([e,t])+")"),this.lastCmdA=e,this.lastCmdB=t,!0}return!1}parsePAC(e,t){var i,s;if(!((17<=e&&e<=23||25<=e&&e<=31)&&64<=t&&t<=127||(16===e||24===e)&&64<=t&&t<=95))return!1;i=e<=23?1:2,s=64<=t&&t<=95?1===i?Rr[e]:Ar[e]:1===i?Dr[e]:Lr[e];var r=this.interpretPAC(s,t);return this.channels[i-1].setPAC(r),this.lastCmdA=e,this.lastCmdB=t,this.currChNr=i,!0}interpretPAC(e,t){var i,s={color:null,italics:!1,indent:null,underline:!1,row:e};return i=t>95?t-96:t-64,s.underline=1==(1&i),i<=13?s.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(i/2)]:i<=15?(s.italics=!0,s.color="white"):s.indent=4*Math.floor((i-16)/2),s}parseChars(e,t){var i,s=null,r=null,a=null;(e>=25?(s=2,a=e-8):(s=1,a=e),17<=a&&a<=19)?(i=17===a?t+80:18===a?t+112:t+144,kr.log("INFO","Special char '"+Ir(i)+"' in channel "+s),r=[i],this.lastCmdA=e,this.lastCmdB=t):32<=e&&e<=127&&(r=0===t?[e]:[e,t],this.lastCmdA=null,this.lastCmdB=null);if(r){var n=Cr(r);kr.log("DEBUG",`Char codes =  ${n.join(",")}`)}return r}parseBackgroundAttributes(e,t){var i,s,r;return((16===e||24===e)&&32<=t&&t<=47||(23===e||31===e)&&45<=t&&t<=47)&&(i={underline:!1},16===e||24===e?(s=Math.floor((t-32)/2),i.background=wr[s],t%2==1&&(i.background=i.background+"_semi")):45===t?i.background="transparent":(i.foreground="black",47===t&&(i.underline=!0)),r=e<24?1:2,this.channels[r-1].setBkgData(i),this.lastCmdA=null,this.lastCmdB=null,!0)}reset(){for(var e=0;e<this.channels.length;e++)this.channels[e]&&this.channels[e].reset();this.lastCmdA=null,this.lastCmdB=null}cueSplitAtTime(e){for(var t=0;t<this.channels.length;t++)this.channels[t]&&this.channels[t].cueSplitAtTime(e)}};class Br{constructor(e,t){this.handler=e,this.track=t,this.startTime=null,this.endTime=null,this.screen=null}dispatchCue(){null!==this.startTime&&(this.handler.addCues("cc"+this.track,this.startTime,this.endTime,this.screen),this.startTime=null)}newCue(e,t,i){(null===this.startTime||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=i,this.handler.createCaptionsTrack(this.track)}}function Ur(e,t,i){return e.substr(i||0,t.length)===t}function $r(e){let t=5381,i=e.length;for(;i;)t=33*t^e.charCodeAt(--i);return(t>>>0).toString()}function Vr(e){let t=Math.floor(e),i=t+.5,s=t+1;return e>=i?e-i>=s-e?s:i:e-t>=i-e?i:t}function Gr(e,t=0,i=8589934592){if(!Number.isFinite(t))return e;const s=i/2,r=Math.abs(e-t)%i;return t+(e>t?-1:1)*(r>s?i-r:-r)}var Kr={parse:function(e,t,i,s,r,a,n){let o=g.b.utf8arrayToStr(new Uint8Array(e)).trim().replace(/\r\n|\n\r|\n|\r/g,"\n").split("\n"),l="00:00.000",d=0,h=0,c=0,u=[],f=null,p=!0,m=!1;const y=new Tr.WebVTTParser(window,Tr.WebVTTParser.StringDecoder(),n);y.oncue=function(e){let t=i[s],r=i.ccOffset;t&&t.new&&(void 0!==h?r=i.ccOffset=t.start:(function(e,t,i){let s=e[t],r=e[s.prevCC];if(!r||!r.new&&s.new)return e.ccOffset=e.presentationOffset=s.start,void(s.new=!1);for(;r&&r.new;)e.ccOffset+=s.start-r.start,s.new=!1,r=e[(s=r).prevCC];e.presentationOffset=i})(i,s,c)),c&&(r=c-i.presentationOffset),m&&(e.startTime=Gr(e.startTime+r-h,0,8589934592/9e4),e.endTime=Gr(e.endTime+r-h,0,8589934592/9e4)),e.id=$r(Vr(e.startTime).toString())+$r(Vr(e.endTime-e.startTime).toString())+$r(e.text),e.text=decodeURIComponent(encodeURIComponent(e.text)),e.endTime>0&&u.push(e)},y.onparsingerror=function(e){f=e},y.onflush=function(){f&&a?a(f):r(u)},o.forEach(e=>{if(p){if(Ur(e,"X-TIMESTAMP-MAP=")){p=!1,m=!0,e.substr(16).split(",").forEach(e=>{Ur(e,"LOCAL:")?l=e.substr(6):Ur(e,"MPEGTS:")&&(d=parseInt(e.substr(7)))});try{d=Gr(Gr(d)-t,9e4*i.ccOffset),h=(function(e){let t=parseInt(e.substr(-3)),i=parseInt(e.substr(-6,2)),s=parseInt(e.substr(-9,2)),r=e.length>9?parseInt(e.substr(0,e.indexOf(":"))):0;return isNaN(t)||isNaN(i)||isNaN(s)||isNaN(r)?-1:(t+=1e3*i,t+=6e4*s,t+=36e5*r)})(l)/1e3,c=d/9e4,-1===h&&(f=new Error(`Malformed X-TIMESTAMP-MAP: ${e}`))}catch(t){m=!1,f=new Error(`Malformed X-TIMESTAMP-MAP: ${e}`)}return}""===e&&(p=!1)}y.parse(e+"\n")}),y.flush()}};const Hr=e=>"cc1"===e||"cc2"===e;function Wr(e){let t=[];for(let i=0;i<e.length;i++){let s=e[i];("captions"===s.kind||"subtitles"===s.kind||"metadata"===s.kind&&s.customTextTrackCueRenderer)&&t.push(s)}return t}function jr(e,t){return(e?e.id:void 0)===(t?t.id:void 0)}const qr=1001/3e4;function Yr(e){if(e&&e.cues)for(;e.cues.length>0;)e.removeCue(e.cues[0])}class zr extends P{constructor(e){super(e,s.b.MEDIA_ATTACHING,s.b.MEDIA_DETACHING,s.b.FRAG_PARSING_USERDATA,s.b.FRAG_PARSING_CAPTIONDATA,s.b.SUBTITLE_TRACKS_UPDATED,s.b.FRAG_LOADED,s.b.LEVEL_SWITCHING,s.b.INIT_PTS_FOUND,s.b.INLINE_STYLES_PARSED),this.hls=e,this.hls=e,this.config=e.config,this.enabled=!0,this.Cues=e.config.cueHandler,this.textTracks=[],this.tracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cueRanges=[],this.channelToTrackMap={},this.mediaAttached=!1,this.gotTracks=!1}addCues(e,t,i,s){const r=this.cueRanges;let a=!1;for(let e=r.length;e--;){let s=r[e],h=(n=s[0],o=s[1],l=t,d=i,Math.min(o,d)-Math.max(n,l));if(h>=0&&(s[0]=Math.min(s[0],t),s[1]=Math.max(s[1],i),a=!0,h/(i-t)>.5))return}var n,o,l,d;a||r.push([t,i]),this.Cues.newCue(this.channelToTrackMap[e],t,i,s,this.media)}removeParsedFrag(e){let t=this.unparsedVttFrags.indexOf(e);t>-1&&this.unparsedVttFrags.splice(t,1)}onInitPtsFound(e){"main"===e.id&&(this.initPTS[e.frag.cc]=e.initPTS90k),this.unparsedVttFrags.length&&this.unparsedVttFrags.forEach(t=>{t.frag&&t.frag.cc===e.frag.cc?(this._processUnparsedVttFrags(t),this.removeParsedFrag(t)):this.logger.info(`[subtitle] ignore PTS ${e.initPTS90k} for cc ${e.frag.cc}; not for frag ${t.frag.sn} ${t.frag.cc}`)()})}forgetFragsWaitingForInitPTS(){let e=this.unparsedVttFrags;return e.length&&this.logger.info(`[subtitle] don't forget ${e.length} frags waiting for initPTS`)(),e}getExistingTrack(e){const t=this.media;if(t)for(let i=0;i<t.textTracks.length;i++){let s=t.textTracks[i],r="cc"+e;if(Hr(r)&&!0===s[r])return s}return null}sendAddTrackEvent(e,t){var i=null;try{i=new window.Event("addtrack")}catch(e){(i=document.createEvent("Event")).initEvent("addtrack",!1,!1)}i.track=e,t.dispatchEvent(i)}createCaptionsTrackGuts(e,t,i){let s="cc"+e;if(!this.channelToTrackMap[s]){let r=this.getExistingTrack(e);if(r)this.channelToTrackMap[s]=r,Yr(this.channelToTrackMap[s]),this.sendAddTrackEvent(this.channelToTrackMap[s],this.media);else{const e=this.createTextTrack("captions",t,i);e&&Hr(s)&&(e[s]=!0,this.channelToTrackMap[s]=e)}}return this.channelToTrackMap[s]}createCaptionsTrack(e){return this.createCaptionsTrackGuts(e,this.config["captionsTextTrack"+e+"Label"],this.config.captionsTextTrack1LanguageCode)}createTextTrack(e,t,i){const s=this.media;if(s){let r=!1;"metadata"!==e&&this.config.customTextTrackCueRenderer&&(r=!0,e="metadata");let a=s.addTextTrack(e,t,i);return r&&(a.customTextTrackCueRenderer=!0),a}}destroy(){P.prototype.destroy.call(this)}onMediaAttaching(e){this.media=e.media,this.mediaAttached=!0,this.attachSubtitleTracks()}onMediaDetaching(){Yr(this.textTrack1),Yr(this.textTrack2)}resetCCs(){this.lastSn=-1,this.prevCC=-1,this.vttCCs={ccOffset:0,presentationOffset:0}}resetTracks(){this._cleanTracks(),this.cueRanges=[]}_cleanTracks(){const e=this.media;if(e){const t=e.textTracks;if(t)for(let e=0;e<t.length;e++)Yr(t[e])}}getCuesOfEnabledTrack(e,t=!1){let i=[];if(t){let t=this._getCuesOfEnabledTrack(e);for(let e=0;e<t.length;e++){let s=t[e];Boolean(s.webVTTCue)&&i.push(s)}}else i=this._getCuesOfEnabledTrack(e);return i}_getCuesOfEnabledTrack(e){let t=this.textTracks[e];return t&&t.cues?Array.from(t.cues):null}attachSubtitleTracks(){this.mediaAttached&&this.gotTracks&&(this.tracks.forEach(e=>{let t;if("sbtl"===e.mediaType)t=this.createTextTrack("subtitles",e.name,e.lang);else{let i=1;e.inStreamID&&(i=Number(e.inStreamID.substring(2))),t=this.createCaptionsTrackGuts(i,e.name,e.lang)}this.textTracks.push(t)}),this.hls.trigger(s.b.SUBTITLE_TRACKS_CREATED))}onSubtitleTracksUpdated(e){this.resetCCs(),this._cleanTracks(),this.textTracks=[],this.unparsedVttFrags=this.unparsedVttFrags||[],this.initPTS=[],this.cueRanges=[],this.config.enableWebVTT&&(this.tracks=e.subtitleTracks||[]),this.gotTracks=!0,this.attachSubtitleTracks()}onLevelSwitching(){this.enabled="NONE"!==this.hls.levelWithPersistentId(this.hls.levelController.level).levelInfo.closedcaption}onInlineStylesParsed(e){}hasDiscontinuityOffset(e){return this.vttCCs[e]}_processUnparsedVttFrags(e){let t=e.frag,i=e.payload;i.byteLength?this._parseVTTs(t,i):this.hls.trigger(s.b.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:t})}processSubtitleFrag(e){let t=e.frag,i=e.payload;i.byteLength?"initSegment"===t.sn?this.hls.trigger(s.b.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:t}):isNaN(this.initPTS[t.cc])?(this.unparsedVttFrags.push(e),this.initPTS.length&&this.hls.trigger(s.b.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:t})):this._parseVTTs(t,i):this.hls.trigger(s.b.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:t})}onFragLoaded(e){let t=e.frag;if("main"===t.type&&"initSegment"!==t.sn){var i=t.sn;if(i!==this.lastSn+1){const e=this.cea608Parser;e&&e.reset()}this.lastSn=i}}_parseVTTs(e,t){let i=this.vttCCs;i[e.cc]||(i[e.cc]={start:e.start,prevCC:this.prevCC,new:!0},this.prevCC=e.cc);let r=this.textTracks,a=this.hls;Kr.parse(t,this.initPTS[e.cc],i,e.cc,t=>{const i=r[e.trackId];(t=t.filter(e=>!i.cues.getCueById(e.id))).map(t=>{try{i.addCue(t)}catch(e){this.logger.warn(`retry addCue. Previous addCue failed: ${e.message}`)();const s=new VTTCue(t.startTime,t.endTime,t.text);s.id=t.id,i.addCue(s),t=s}return t.fragSN=e.sn,t.webVTTCue=!0,t}),a.trigger(s.b.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e,cues:t})},t=>{a.trigger(s.b.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e})},e=>{a.trigger(s.b.INLINE_STYLES_PARSED,{styles:e})})}_ensureParser(){if(!this.cea608Parser){var e=new Br(this,1),t=new Br(this,2);this.cea608Parser=new Fr(0,e,t)}}onFragParsingCaptiondata(e){if(this.enabled&&this.config.enableCEA708Captions){this._ensureParser();for(let t=0;t<e.samples.length;t++){let i=e.samples[t].pts,s=e.samples[t].bytes;for(let e=0;e<s.length;e+=2){let r=[];r.push(s[e]),e+1<s.length?r.push(s[e+1]):(this.logger.warn(`CEA608 sample ${t} not even length (index ${e+1} >= length ${s.length})`)(),r.push(80)),this.cea608Parser.addData(i,r),i+=qr}}}}onFragParsingUserdata(e){if(this.enabled&&this.config.enableCEA708Captions){this._ensureParser();for(let t=0;t<e.samples.length;t++){let i=zr.extractCea608Data(e.samples[t].bytes);this.cea608Parser.addData(e.samples[t].pts,i)}}}static extractCea608Data(e){for(var t,i,s,r=31&e[0],a=2,n=[],o=0;o<r;o++)t=e[a++],i=127&e[a++],s=127&e[a++],0===i&&0===s||0!=(4&t)&&0==(3&t)&&(n.push(i),n.push(s));return n}}let Qr={maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},Xr={maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3};const Jr={autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,defaultVideoCodec:void 0,debug:!1,debugLevel:void 0,buildType:void 0,minFramesBeforeSwitchingLevel:11,minTargetDurations:3,initialLiveManifestSize:1,maxBufferLength:30,maxBufferHole:.5,maxSeekHole:2,discontinuitySeekTolerance:2,almostDryBufferSec:.5,maxTotalDurationTolerance:.1,lowBufferWatchdogPeriod:.5,highBufferWatchdogPeriod:3,seekWatchdogPeriod:5,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.2,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,liveFlushExpiredFrags:!0,allowFastSwitchUp:!1,desiredIframeFPS:8,initialIframeFPS:6,minRemainingTimeInMediaPipeline:3,leftMediaTimeToAutoPause:10,startTargetDurationFactor:.9,enableWorker:!0,enableSoftwareAES:!0,keySystemPreference:void 0,clearMediaKeysOnPromise:!0,useMultipleKeySessions:!1,enablePlayReadyKeySystem:!1,useMediaKeySystemAccessFilter:!1,startLevel:void 0,livePlaylistRefreshDelay:2500,liveMinPlayingBufferLen:5,enableIFramePreloading:!0,useMediaCapabilities:!1,enableID3Cues:!0,manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}},customURL:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:1e4,autoRetry:!1,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}},customURL:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:1e4,autoRetry:!1,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:5e3,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:Qr,errorRetry:Xr,forceContentLenCheckIfNoHeader:!1},customURL:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:Qr,errorRetry:Xr}},maxNumAddLevelToPenaltyBox:4,fragLoadingLoopThreshold:3,firstAudioMustOverlapVideoStart:!1,keyLoadingDefaultTimeout:2e4,keyLoadingMinTimeout:3e3,keyLoadingRetryDelay:1e3,keyRetryCountOnError:3,keyHoldTimeAfterExpiry:15e3,startFragPrefetch:!1,appendErrorMaxRetry:3,alwaysResetOnNewCC:!1,loader:f,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,abrController:class extends P{constructor(e){super(e,s.b.LEVELS_CHANGED,s.b.LEVEL_SWITCHING,s.b.FRAG_LOADING,s.b.FRAG_LOAD_PROGRESS,s.b.FRAG_LOADED,s.b.FRAG_BUFFERED,s.b.BUFFER_CHANGED,s.b.DESIRED_RATE_CHANGED,s.b.INTERNAL_ERROR),this._fragDownloadSlow=!1,this._fragDownloadTooSlow=!1,this._levelDownloadSlow=!1,this._highBWTrigger=Number.POSITIVE_INFINITY,this._shouldSwitchLevel=!1,this.maxBufferSize=Number.POSITIVE_INFINITY,this._nextAutoLevel=-1,this.shortTermBandwidthFactor=1.8,this.hls=e,this.onCheck=this._abandonRulesCheck.bind(this),this.flowMeasurementPeriodMS=2e3,this.underflowAllowanceMS=1e3,this.numBandwidthSamples=0,this.minItemsInBandwidthAverage=4,this.minTargetDurations=e.config&&e.config.minTargetDurations||1,"bandwidth-history-controller"===e.config.abrBandwidthEstimator&&this._ensureBwEstimator()}destroy(){this.clearTimer(),P.prototype.destroy.call(this)}_ensureBwEstimator(e=!1){if(!this._bwEstimator)if("bandwidth-history-controller"===this.hls.config.abrBandwidthEstimator)this._bwEstimator=this.hls.bandwidthHistoryController;else if("ewma"===this.hls.config.abrBandwidthEstimator){const{config:t}=this.hls;let i,s;e?(i=t.abrEwmaFastLive,s=t.abrEwmaSlowLive):(i=t.abrEwmaFastVoD,s=t.abrEwmaSlowVoD),this._bwEstimator=new class{constructor(e,t,i){this.hls=e,this.logger=e.logger,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new yr(t),this.fast_=new yr(i)}sample({tparsed:e,tload:t,trequest:i,loaded:s}){this.getEstimate();const r=Math.max((e||t)-i,this.minDelayMs_);var a=8e3*s/r,n=r/1e3;this.fast_.sample(n,a),this.slow_.sample(n,a)}canEstimate(){let e=this.fast_;return e&&e.getTotalWeight()>=this.minWeight_}getEstimate(){if(this.canEstimate())return{avgLatencyMs:0,avgBandwidth:Math.min(this.fast_.getEstimate(),this.slow_.getEstimate())}}destroy(){}}(this.hls,s,i);const r=this.hls.bandwidthHistoryController.getEstimate();r&&r.avgBandwidth&&(this.minItemsInBandwidthAverage=1,this._bwEstimator.sample({trequest:0,tparsed:0,tfirst:0,tload:1e3*this.hls.config.defaultTargetDuration,loaded:r.avgBandwidth*this.hls.config.defaultTargetDuration/8}),++this.numBandwidthSamples)}}onFragLoading(e){let t=e.frag;"main"===t.type&&(this.timer||(this.timer=setInterval(this.onCheck,100)),t&&!isNaN(t.level)&&this.hls.levelWithPersistentId(t.level).levelInfo?this._ensureBwEstimator(this.hls.levelWithPersistentId(t.level).levelInfo.details.live):this.logger.warn(`Invalid level id ${t.level} or level info, unable to process ensure bw estimator`)(),this.fragCurrent=t)}_abandonRulesCheck(){var e;let t=this.hls,i=t.media,r=this.fragCurrent,a=r.loader,n=t.minAutoLevel,o=t.iframeMode;if(!a||a.stats&&a.stats.aborted||o)return!0!==r.loadSuccess&&this.logger.warn(`[${r.type}] loader of frag ${r.sn} level ${r.level} destroy or aborted, disarm abandonRules`)(),void this.clearTimer();let l=a.stats,d=t.levelWithPersistentId(r.level),c=d.levelInfo,u=d.levelListPosition;if(!i||(i.paused||0===i.playbackRate)&&i.readyState||!r.autoLevel||0===u)return;const f=performance.now();let g=f-l.trequest,m=Math.abs(i.playbackRate);if(g<Math.min(this.flowMeasurementPeriodMS,500*r.duration/m))return;let y=t.levels,v=Math.max(1,l.bw?l.bw/8:1e3*l.loaded/g),b=c.realBitrate?Math.max(c.realBitrate,c.bitrate):c.bitrate,T=l.total?l.total:Math.max(l.loaded,Math.round(r.duration*b/8)),S=i.currentTime,I=(T-l.loaded)/v,E=(Os.bufferInfo(i,S,t.config.maxBufferHole).end-S)/m,_=2*((null===(e=c.details)||void 0===e?void 0:e.targetduration)||r.duration);if(!(E>0&&E<=_&&(I>=E||this.fragDownloadSlow)))return;this.fragDownloadSlow=!0;let R=!1,D=NaN;for(let e=u-1;e>=n&&!R;e--){let i=y[e];if(i.iframes!==o)continue;if(i.url&&!p.isCustomUrl(i.url)&&h.getHostName(i.url)!==this.hls.preferredHostName)continue;let s=i.realBitrate?Math.max(i.realBitrate,i.bitrate):i.bitrate;t.iframeMode&&(s*=t.config.desiredIframeFPS);let a=r.duration*s/(8*v);(a<E||isNaN(D))&&(D=i.persistentId),R=a<E}Object(Oi.c)(D)||(this.logger.info(`[abr] capping level to ${D} because likelyToStall`)(),t.nextAutoLevel=D),R&&(this.logger.warn(`loading too slow, abort fragment loading and switch to level ${D}`)(),this._sampleBandwidth(Object.assign({},l,{tfirst:l.tfirst||f,tload:l.tload||f})),a.abort(),this.clearTimer(),this.fragDownloadTooSlow=!0,t.trigger(s.b.FRAG_LOAD_EMERGENCY_ABORTED,{frag:r,stats:l}))}_fragResponseIsValid(e){let t=this.hls,i=!0;if(!t.levelWithPersistentId(e).levelInfo){let a=new r.h(r.g.OTHER_ERROR,r.d.INTERNAL_EXCEPTION,!1,"empty level info for level "+e);a.response=r.f.InternalError,a.url=t.url,t.trigger(s.b.INTERNAL_ERROR,a),i=!1}return i}onFragLoadProgress(e){let t=e.frag,i=e.stats;if("main"===t.type&&"initSegment"!==t.sn&&0!==i.loaded){if(!this._fragResponseIsValid(t.level))return;let e=this.hls.levelWithPersistentId(t.level).levelInfo,s=e.realBitrate?Math.max(e.realBitrate,e.bitrate):e.bitrate,r=i.total?i.total:Math.max(i.loaded,Math.round(t.duration*s/8)),a=performance.now()-i.tfirst,n=i.loaded*t.duration*1e3/r;a>=this.flowMeasurementPeriodMS&&a-n>=this.underflowAllowanceMS&&(this.fragDownloadSlow=!0),a>=1e3*t.duration&&(this.logger.warn(`[abr][${t.type}] too much time spent downloading fragment, likely to switch down ${a} > ${1e3*t.duration}`)(),this.fragDownloadTooSlow=!0)}}onFragLoaded(e){let t=e.frag;if("main"===t.type&&"initSegment"!==t.sn){if(this.clearTimer(),!this._fragResponseIsValid(t.level))return;if(this._nextAutoLevel=-1,this.hls.config.abrMaxWithRealBitrate){const i=this.hls.levelWithPersistentId(t.level).levelInfo;let s=(i.loaded?i.loaded.bytes:0)+e.stats.loaded,r=(i.loaded?i.loaded.duration:0)+e.frag.duration;i.loaded={bytes:s,duration:r},i.realBitrate=Math.round(8*s/r)}if(e.frag.bitrateTest){let t=e.stats;t.tparsed=t.tbuffered=t.tload,this.onFragBuffered(e)}}}onFragBuffered(e){var t=e.stats,i=e.frag;if(!0!==t.aborted&&1===i.loadCounter&&"initSegment"!==i.sn&&(!i.bitrateTest||t.tload===t.tbuffered)){let e=t.tparsed-t.trequest,s=t.tload-t.tfirst,r=t.tdataack-t.tload;if(this.logger.info(`[QE Critical] [${i.type}]latency/loading/dataack/parsing/append:${Math.round(t.tfirst-t.trequest)}/${Math.round(t.tload-t.tfirst)}/${Math.round(r)}/${Math.round(t.tparsed-t.tdataack)}/${Math.round(t.tbuffered-t.tparsed)}`)(),this.logger.info(`[QE Critical] [${i.type}]fragLoadingProcessingMs/stats.loaded/viddur/fragLoadMs: ${e}/${t.loaded}/${i.duration}/${s}`)(),"main"===i.type&&(this.fragDownloadSlow=!1),!("main"!==i.type&&"audio"!==i.type||i.iframe||isNaN(e))){this._sampleBandwidth(t),t.bwEstimate=this.getBandwidthEstimate(),this.logger.info(`[abr][${i.type}]fragNetworkDownloadKbps/fragDownloadKbps/bwEstimateKbps: ${Math.round(8*t.loaded/s)}/${Math.round(8*t.loaded/e)}/${Math.round(t.bwEstimate/1e3)}`)(),i.bitrateTest?this.bitrateTestDelay=e/1e3:this.bitrateTestDelay=0;let r=this.hls.config.abrBandWidthUpFactor,a=this.getAdjustedBW(this.getBandwidthEstimate(),r,this.hls.config.abrBandWidthFactor);"main"===i.type&&a.bwUp>this.highBWTrigger&&this.onBandwidthChanged(gr.HighBandwidth)}}}set fragDownloadSlow(e){this._fragDownloadSlow!==e&&(this._fragDownloadSlow=e,e&&this.onBandwidthChanged(gr.LowBandwidth))}get fragDownloadSlow(){return this._fragDownloadSlow}set fragDownloadTooSlow(e){this._fragDownloadTooSlow!==e&&(this._fragDownloadTooSlow=e,e&&this.onBandwidthChanged(gr.LowBandwidth))}get fragDownloadTooSlow(){return this._fragDownloadTooSlow}set levelDownloadSlow(e){this._levelDownloadSlow!==e&&(this._levelDownloadSlow=e,e&&this.onBandwidthChanged(gr.LowBandwidth))}get levelDownloadSlow(){return this._levelDownloadSlow}get _gotSlowMedia(){return this.levelDownloadSlow||this.fragDownloadTooSlow}onBandwidthChanged(e){this.logger.info(`bandwidth note ${e} ${Math.round(this.getBandwidthEstimate())/1e3}kbps`)(),this._gotSlowMedia||!this.hls.seeking&&!this.hls.waitingForIncompatibleCCFragLoad?this.setShouldSwitchLevel(!0,e):this.logger.warn(`[abr] Could be ignoring bandwidth change seeking=${this.hls.seeking} incompatibleCC ${this.hls.waitingForIncompatibleCCFragLoad}`)(),this.hls.trigger(s.b.BANDWIDTH_CHANGED,{reason:e})}onLevelsChanged(){this.hls.streamController&&(this.hls.levelWithPersistentId(this.hls.streamController.levelId).levelInfo||this.setShouldSwitchLevel(!0,"Current level in penalty box"),this.highBWTrigger=this._getLowestSuperiorBW(this.hls.streamController.levelId))}onLevelSwitching(e){this.setShouldSwitchLevel(!1,"Level switching"),this.fragDownloadTooSlow=!1,this.fragDownloadSlow=!1,this.levelDownloadSlow=!1,this.highBWTrigger=this._getLowestSuperiorBW(e.persistentId)}onInternalError(e){switch(e.details){case r.d.FRAG_LOAD_TIMEOUT:this.fragDownloadTooSlow=!0,this.clearTimer();break;case r.d.FRAG_LOAD_ERROR:this.clearTimer();break;case r.d.LEVEL_LOAD_TIMEOUT:this.levelDownloadSlow=!0;break;case r.d.BUFFER_FULL_ERROR:if(e instanceof r.b){let{parent:t,maxTotalBytes:i}=e;"main"===t&&(this.logger.info(`QuotaExceeded buffer ${this.maxBufferSize} -> ${i}`)(),this.maxBufferSize=i)}}}clearTimer(){this.timer&&(clearInterval(this.timer),this.timer=null)}isSafeToFlushExcessBuffer(){if(-1!==this._nextAutoLevel&&!this.getBandwidthEstimate(0))return!1;let e=this._bufferedDuration;return this._holdOffDuration&&e>this._holdOffDuration}getSafeBufferFlushPosition(){return this._holdOffDuration}get nextAutoLevel(){const e=this._nextAutoLevel;if(-1!==e&&!this.getBandwidthEstimate(0))return e;let t=this._nextABRAutoLevel;return-1!==e&&(t=Math.min(e,t)),t}get _bufferedDuration(){var e=this.hls;const t=e.media,i=t?t.currentTime:0,s=t&&0!==t.playbackRate?Math.abs(t.playbackRate):1;return(Os.bufferInfo(t,i,e.config.maxBufferHole).end-i)/s}findNextABRAutoLevelInMode(e){var t=this.hls,i=t.maxAutoLevel,s=t.levels,r=t.config,a=t.minAutoLevel;const n=this.hls.streamController.levelId,o=this.hls.levelController.variantManager.getVariantInfo(n),l=o?o.details:void 0,d=this.getBandwidthEstimate(),h=this._bufferedDuration;let c,u,f;if(e){const s=this.hls.config.desiredIframeFPS;f=this.fragCurrent&&void 0!==this.fragCurrent.iframeMediaDuration?this.fragCurrent.iframeMediaDuration:l?l.targetduration/s:0,f=Math.max(1/s,f),t.iframeMode!==e&&(i=t.maxLevelIframeMode,a=t.minLevelIframeMode)}else f=this.fragCurrent&&void 0!==this.fragCurrent.duration?this.fragCurrent.duration:l?l.targetduration:0;if((u=(c=this._findBestLevel(o,f,d,a,i,h,r.abrBandWidthFactor,r.abrBandWidthUpFactor,s,e)).levelId)<0){let t=f?Math.min(f,r.maxStarvationDelay):r.maxStarvationDelay,n=r.abrBandWidthFactor,l=r.abrBandWidthUpFactor;if(0===h){let e=this.bitrateTestDelay;e&&(t=(f?Math.min(f,r.maxLoadingDelay):r.maxLoadingDelay)-e,n=l=1)}u=-1===(c=this._findBestLevel(o,f,d,a,i,h+t,n,l,s,e)).levelId&&a>=0?s[a].persistentId:c.levelId}return this._holdOffDuration=c.holdOffDuration,u}_getLowestSuperiorBW(e){let t=1/0,i=this.hls.levelWithPersistentId(e),s=i.levelInfo;if(!s)return;let r=i.levelListPosition,a=s.frameRate,n=s.realBitrate?Math.max(s.realBitrate,s.bitrate):s.bitrate,o=this.hls.levels,l=Math.min(this.hls.maxAutoLevel,o.length-1);for(let e=this.hls.config.abrMaxWithRealBitrate?this.hls.minAutoLevel:Math.max(this.hls.minAutoLevel,r+1);e<=l;++e){let i=o[e];if(i.iframes!==s.iframes||void 0!==a&&i.frameRate<a)continue;let r=i.realBitrate?Math.max(i.realBitrate,i.bitrate):i.bitrate;if(r>n&&(t=Math.min(r,t),!this.hls.config.abrMaxWithRealBitrate))break}return t}set highBWTrigger(e){this._highBWTrigger!==e&&(this._highBWTrigger=e)}get highBWTrigger(){return this._highBWTrigger}get avgBW(){return this.logger.warn("abrController.getBandwidthEstimate() is deprecated and will be removed in a future release.")(),this.getBandwidthEstimate()}getBandwidthEstimate(e=this.hls.config.abrEwmaDefaultEstimate){const t=this._bwEstimator?this._bwEstimator.getEstimate():void 0;return t?t.avgBandwidth:e}_sampleBandwidth(e){++this.numBandwidthSamples,this._bwEstimator.sample(e),this._bwEstimator!==this.hls.bandwidthHistoryController&&this.hls.bandwidthHistoryController.sample(e)}getAdjustedBW(e,t,i){let s,r;return this.numBandwidthSamples>=this.minItemsInBandwidthAverage?(s=e*t,r=e*i):s=r=e/this.shortTermBandwidthFactor,{bwUp:s,bwDown:r}}onDesiredRateChanged(e){let{oldRate:t,newRate:i}=e;(0!==t&&1!==t)!=(0!==i&&1!==i)&&this.setShouldSwitchLevel(!0,"mode change")}onBufferChanged(e){this.hls.waitingForIncompatibleCCFragLoad||e.reason!==Ps.LowWaterLevel||this.setShouldSwitchLevel(!0,e.reason)}setShouldSwitchLevel(e,t){e!==this._shouldSwitchLevel&&(this.logger.info(`[abr] shouldSwitchLevel: ${this._shouldSwitchLevel}->${e} reason:${t}`)(),this._shouldSwitchLevel=e)}get shouldSwitchLevel(){return this._shouldSwitchLevel}get _nextABRAutoLevel(){let e,t=this.hls,i=t.iframeMode,s=t.config.minFramesBeforeSwitchingLevel;if(i){let r=t.countIframesInCurrentLevel();e=!t.levelWithPersistentId(r.level).levelInfo||r.loading+r.buffered===0||r.buffered>=s?this.findNextABRAutoLevelInMode(i):r.level}else e=this.shouldSwitchLevel?this.findNextABRAutoLevelInMode(i):this.hls.streamController.levelId;return e}_findBestLevel(e,t,i,s,r,a,n,o,l,d){const c=e&&e.persistentId,u=this.hls.preferredHostName,f=this.getAdjustedBW(i,o,n),g=this.maxBufferSize,m=e?e.frameRate:void 0;r=Math.max(0,Math.min(l.length-1,r)),s=Math.max(0,Math.min(l.length-1,s));for(let i=r;i>=s;i--){let s=l[i],r=s.persistentId,n=s.details,o=n?n.totalduration/n.fragments.length:t,y=null!=n&&n.live,v=null!=e&&s.bitrate>e.bitrate,b=null!=e&&s.bitrate<e.bitrate,T=s.url,S=!T||p.isCustomUrl(T)||h.getHostName(T)===u;if(isNaN(o)||s.iframes!==d||!S)continue;if(void 0!==m&&(v&&s.frameRate<m||b&&s.frameRate>m))continue;if(v&&e&&e.height>s.height)continue;let I=v?f.bwUp:f.bwDown,E=Math.max(s.realBitrate||0,s.bitrate),_=s.bandwidth,R=E*o/I;!y||s.details&&s.details.PTSKnown&&!this.hls.levelController.levelIsExpired(s.details)||(R*=2);let D=I>E&&I<_&&this._bufferedDuration<=2*o,A=(_||E||0)*(n&&n.targetduration||o),L=this.minTargetDurations*A/8<=g;if(I>E&&L&&!D&&(d||!R||R<a))return(this.fragDownloadSlow||this.fragDownloadTooSlow)&&this._bufferedDuration<=2*o&&v&&(this.logger.info("[abr] Last fragment too slow, not switching up")(),r=c),(!this.gotFirst||r!==c&&d===this.hls.iframeMode)&&(this.gotFirst=!0,this.logger.info(`[abr] level/adjustedbw/bitrate/avgDuration/maxFetchDuration/fetchDuration: ${r}/${Math.round(I)}/${E}/${o}/${a}/${R}`)()),{levelId:r,holdOffDuration:R}}return{levelId:-1,holdOffDuration:-1}}set nextAutoLevel(e){if(isNaN(e))try{throw Error("nextAutoLevel set with NaN")}catch(e){this.logger.warn(`${e.message} ${e.stack}`)()}this._nextAutoLevel=e}},bufferController:br,audioStreamController:class extends or{constructor(e,t){super(e,"audio",s.b.MEDIA_ATTACHING,s.b.MEDIA_DETACHING,s.b.AUDIO_TRACK_SWITCHING,s.b.AUDIO_TRACK_LOADED,s.b.FRAG_PARSING_INIT_SEGMENT,s.b.INTERNAL_ERROR,s.b.BUFFER_CREATED,s.b.BUFFER_APPENDED,s.b.BUFFER_FLUSHED,s.b.BUFFER_SOURCE_RESET,s.b.INIT_PTS_FOUND),this.initPTSs=new Map,this.tickFn=t,this.state=Ws.STOPPED}get hasInitialSeekToPos(){return this._hasInitialSeekToPos}hasInitPTS(e){return this.initPTSs.has(e)}tick(){this.tickFn()}destroy(){this.stopLoad(),this.state=Ws.STOPPED,super.destroy()}resetLoadSource(){this.initPTSs=new Map,this.stopLoad()}stopLoad(){this.state!==Ws.STOPPED&&(this.cancelCurrentLoad(),this.startFragRequested=!1,this.fragPrevious=null,this.pendingSeekToPosInfo=null,this._hasInitialSeekToPos=!1,this._destroyDemuxer(),this.state=Ws.STOPPED)}get waitingToStart(){return this.haveAltAudio&&!this.hasInitialSeekToPos}get pendingDataInfo(){const e=this.pendingParsedData;return e?{startPTS:e.startPTS,cc:e.frag.cc,level:e.frag.level}:void 0}startLoadAtTargetTime(e){var t,i;this.haveAltAudio?(null===(t=this.pendingSeekToPosInfo)||void 0===t?void 0:t.cc)===e.cc&&(null===(i=this.pendingSeekToPosInfo)||void 0===i?void 0:i.seekToPos)===e.seekToPos||(this.logger.info(`[audio] startLoadAtTargetTime setting pending seek, cc: ${e.cc} offset: ${e.seekToPos}`)(),this.pendingSeekToPosInfo=Object.assign({},e),this._hasInitialSeekToPos=!0,this.fragLoadError=0,this.checkPendingSeek()):this.logger.warn("[audio] startLoadAtTargetTime ignoring call, no alternate audio")()}checkPendingSeek(){var e;if(!this.pendingSeekToPosInfo)return;if(!this.haveAltAudio)return void this.logger.warn("[audio] checkPendingSeek ignoring call, no alternate audio")();if(!this.tracks||!this.tracks.length)return;const t=this.trackId>=0?null===(e=this.hls.audioTrackController.resolveTrackId(this.trackId).trackInfo)||void 0===e?void 0:e.details:void 0;if(!t)return void this.logger.info("[audio] waiting for track details")();const i=$s.snapToCCTimeRange(this.pendingSeekToPosInfo.seekToPos,t.fragments,this.pendingSeekToPosInfo.cc),s=!!this.mediaBuffer&&Cs.isBuffered(this.mediaBuffer,i);switch(this.logger.info(`[audio] have pending seek, cc: ${this.pendingSeekToPosInfo.cc}, actual start position seekToPos: ${i}, isBuffered: ${s}`)(),this.pendingSeekToPosInfo=null,void 0!==this.fragLoadIdx&&(this.fragLoadIdx+=2*this.config.fragLoadingLoopThreshold),this.state){case Ws.FRAG_LOADING:{const e=this.fragCurrent;e&&(e.loader&&!s&&(e.start>=i||e.start+e.duration<=i)?(this.logger.info(`[audio] currently loading ${e.fragTag}, audio range: ${e.rangeString}, outside of seekToPos: ${i}, cancel it`)(),e.loader.abort(),this.fragCurrent=null,this.fragPrevious=null,this.state=Ws.IDLE):this.logger.info(`[audio] currently loading ${e.fragTag}, audio range: ${e.rangeString}, within of seekToPos: ${i}, continue loading`)());break}case Ws.WAITING_DISCONTINUITY:this.ensurePendingDataForSeek(i);break;case Ws.WAITING_INIT_PTS:this.waitingForCC=null,this.state=Ws.IDLE;break;case Ws.ENDED:case Ws.STOPPED:this.state=Ws.IDLE}this.nextLoadPosition=i}get targetDuration(){return this.hls.streamController.targetDuration}get highWaterLevel(){return this.hls.streamController.highWaterLevel}flushAudioBuffer(e,t){this.state=Ws.BUFFER_FLUSHING,this.hls.bufferController.flushBufferRange(e,t,"audio")}resetNextLoadPositionState(){this.loadedmetadata||(this.stopLoad(),this.state=Ws.IDLE)}getAudioTimeRangeForCC(e){if(!this.tracks||isNaN(this.trackId))return[];let t=this.hls.audioTrackController.resolveTrackId(this.trackId).trackInfo;return t&&t.details?$s.getTimeRangeForCC(t.details.fragments,e):[]}doTickIdle(){var e;const t=this.hls,i=t.config,a=this.tracks;let n;if(!a||0===a.length||!this.hasInitialSeekToPos)return;if(this.pushPendingData())return;if(!this.media&&(this.startFragRequested||!i.startFragPrefetch))return;if(this.hls.isLive&&0===this.hls.desiredRate)return;n=this.media&&this.loadedmetadata?this.media.currentTime:this.nextLoadPosition;let o=this.getSourceBufferInfo(n),l=o.len,d=o.end,h=this.fragPrevious,c=this.maxBufferAheadSec,u=this.audioSwitch,f=this.trackId;if(l<c||u){let a=this.hls.audioTrackController.resolveTrackId(f).trackInfo;if(!a)return;if(this.hls.audioTrackController.updateTrack(f),this.hls.playlistLoader.isLoadingAudioTrack(f))return void(this.state=Ws.PLAYLIST_LOADING);const l=a.details;if(!l)return void this.logger.error("[audio] no track details")();if(!u&&!l.live&&h&&h.sn===l.endSN&&!this.hls.iframeMode&&(!this.media.seeking||this.media.duration-d<h.duration/2))return this.hls.bufferController.endBuffer("audio"),void(this.state=Ws.ENDED);let c=l.fragments,g=c.length,p=c[0].start,m=c[g-1].start+c[g-1].duration,y=null;if(u)if(this.startFragRequested&&l.live&&!l.PTSKnown)d=0;else if(d=n,l.PTSKnown&&n<p){if(!(o.end>p||o.nextStart))return;this.logger.info("[audio] adjust currentTime to alt audio track start")(),this.media.currentTime=p+.05}if(d<=p){if(y=c[0],l.live&&y.loadIdx&&y.loadIdx===this.fragLoadIdx){const e=o.nextStart?o.nextStart:p;return this.logger.info(`[audio] no alt audio available @currentTime:${this.media.currentTime}, seeking @${e+.05}`)(),void(this.media.currentTime=e+.05)}}else{let e=null,t=this.hls.config.firstAudioMustOverlapVideoStart?0:this.hls.config.maxFragLookUpTolerance;if(e=$s.findFragmentBySNAndBuffer(h,c,d,m,t),this.hls.isLive&&null===h&&e&&"number"==typeof e.sn&&(d>=m||m-d<=t)&&c.length>0&&e.sn===c[c.length-1].sn&&e.level===c[c.length-1].level&&(this.logger.info(`Dropping ${e.sn} as a repeat download`)(),e=null),e){if(y=e,p=e.start,this.hls.streamController&&!this.loadedmetadata){let e=this.hls.streamController.fragCurrent;"initSegment"!==y.sn&&e&&e.cc!==y.cc&&y.sn<l.endSN&&(this.logger.warn(`mismatching cc @pos:${n.toFixed(3)} main:${e.cc} audio:${y.cc} bumping one ahead`)(),y=c[y.sn+1-l.startSN],e.cc!==y.cc&&(this.logger.error(`still mismatching cc main:${e.cc} audio:${y.cc}`)(),y=null))}h&&y&&y.level===h.level&&y.sn===h.sn&&(y="initSegment"!==y.sn&&y.sn<l.endSN?c[y.sn+1-l.startSN]:null)}}if(y){y.decryptdata&&y.decryptdata.isEncrypted&&this.fetchKey(y).subscribe(),l.initSegments[y.cc]&&!l.initSegments[y.cc].data&&(y=l.initSegments[y.cc]);const a=this.hls.bufferController.isCompatibleTransition(y.cc),o=this.initPTSs.has(y.cc),c=o&&"no"!==a,u=o&&!c&&!this.pendingParsedData;let g="initSegment"===y.sn||c||u;if(h&&h.cc!==y.cc&&("no"===a&&this.pendingParsedData?this.logger.error(`[${this.sbid}} why are we back in idle you crazy controller? not compatible, already have cached frag ${y.fragTag}`)():g&&this.logger.info(`[${this.sbid}] loading into discontuity, frag ${y.fragTag}, isCompatible: ${a}, need to cache: ${u}, loadedmetadata: ${this.loadedmetadata}`)()),g||o||(g=!1,this.state=Ws.WAITING_INIT_PTS,this.waitingForCC=y.cc,this.logger.info(`[${this.sbid}] waiting to load frag ${y.fragTag}, state: ${this.state} range: ${y.rangeString}, currentTime: ${null===(e=this.media)||void 0===e?void 0:e.currentTime}, pos: ${n?n.toFixed(3):"undefined"}, bufferEnd: ${d?d.toFixed(3):"undefined"} URL ${this.hls.redactUrl(y.relurl)}`)()),g){if(void 0!==this.fragLoadIdx?this.fragLoadIdx++:this.fragLoadIdx=0,y.loadCounter){y.loadCounter++;let e=i.fragLoadingLoopThreshold;if(y.loadCounter>e&&Math.abs(this.fragLoadIdx-y.loadIdx)<e){let e=new r.j(r.g.MEDIA_ERROR,r.d.FRAG_LOOP_LOADING_ERROR,!1,"Frag has already been loaded more than 3 times",r.f.CorruptStream,y);return t.trigger(s.b.ERROR,e),void(e.iframe=y.iframe)}}else y.loadCounter=1;y.loadIdx=this.fragLoadIdx,this.fragCurrent=y,this.startFragRequested=!0,"initSegment"!==y.sn&&(this.nextLoadPosition=y.start+y.duration),this.logFragmentTiming(y,"loading"),this.logger.info(`${y.type} loading ${y.sn} of [${l.startSN},${l.endSN}], trackId: ${f}, cc: ${y.cc}, range: ${y.rangeString}, currentTime: ${this.media.currentTime}, pos:${n?n.toFixed(3):"undefined"}, bufferEnd:${d?d.toFixed(3):"undefined"} URL ${this.hls.redactUrl(y.relurl)} `)(),t.fragmentLoader.loadFragment(y).then(e=>{this.logFragmentTiming(y,"loaded"),this._processLoadedFrag(e)}).catch(e=>{this._handleFragmentError(e)}),this.demuxImmediate=Object(Ys.setImmediate)(this._ensureDemuxer.bind(this)),this.state=Ws.FRAG_LOADING}}}}doTick(){switch(this.state){case Ws.ERROR:case Ws.BUFFER_FLUSHING:break;case Ws.IDLE:this.doTickIdle();break;case Ws.PLAYLIST_LOADING:if(!this.hls.playlistLoader.isLoadingAudioTrack(this.trackId)){let e=this.hls.audioTrackController.resolveTrackId(this.trackId).trackInfo;e&&e.details&&(this.state=Ws.IDLE)}break;case Ws.FRAG_LOADING_WAITING_RETRY:{let e=performance.now(),t=this.retryDate,i=this.media,s=i&&i.seeking;(!t||e>=t||s)&&(this.state=Ws.IDLE);break}case Ws.WAITING_INIT_PTS:case Ws.STOPPED:break;case Ws.FRAG_LOADING:case Ws.KEY_LOADING:case Ws.PARSING:case Ws.PARSED:case Ws.ENDED:}}get loadedmetadata(){return this.hls.streamController.loadedmetadata}get tracks(){return this.hls.audioTracks}getSourceBufferInfo(e,t=this.config.maxBufferHole){return Cs.bufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,e,t)}onMediaAttaching(e){this._attachMedia(e.media)}_attachMedia(e){this.media=this.mediaBuffer=e,this.onvended=this.onMediaEnded.bind(this),e.addEventListener("ended",this.onvended)}onMediaDetaching(){var e=this.media;e&&e.ended&&(this.pendingSeekToPosInfo=null);var t=this.tracks;t&&t.length>0&&t.forEach(e=>{e.details&&e.details.fragments.forEach(e=>{e.loadCounter=void 0})}),e&&e.removeEventListener("ended",this.onvended),this.media=this.mediaBuffer=null,this.stopLoad(),this.hls.config.firstAudioMustOverlapVideoStart&&(this.initPTSs=new Map)}onMediaEnded(){this.pendingSeekToPosInfo=null}onAudioTrackSwitching(e){this.haveAltAudio=!!e.url,this.trackId=e.id,this.fragCurrent=null,this.haveAltAudio||this._destroyDemuxer(),this.haveAltAudio?(this.audioSwitch=!0,this.state=Ws.IDLE,void 0!==this.fragLoadIdx&&(this.fragLoadIdx+=2*this.config.fragLoadingLoopThreshold),this.tick()):this.stopLoad()}onAudioTrackLoaded(e){var t=e.details,i=e.id,s=this.hls.audioTrackController.resolveTrackId(i).trackInfo;if(t.totalduration,t.live){var r=s.details;r&&t.endSN===r.endSN&&(t.unchangedLivePlaylist=!0),r&&t.fragments.length>0?(js.mergeDetails(r,t),t.fragments[0].start,t.PTSKnown):t.PTSKnown=!1}else t.PTSKnown=!1;s.details=t,this.state===Ws.PLAYLIST_LOADING&&(this.checkPendingSeek(),this.state=Ws.IDLE)}_ensureDemuxer(){this.demuxer||(this.demuxer=new Ks(this.hls,"audio"))}_destroyDemuxer(){Object(Ys.clearImmediate)(this.demuxImmediate),this.demuxer&&(this.demuxer.destroy(),this.demuxer=null)}_processLoadedFrag(e){var t=this.fragCurrent,i=e.frag;if(this.state===Ws.FRAG_LOADING&&t&&"audio"===i.type&&i.level===t.level&&i.sn===t.sn){const i=t.level,r=this.hls.audioTrackController.resolveTrackId(i).trackInfo.details;if(!r)return this.logger.error("[audio] no track details")(),t=null,void(this.state=Ws.IDLE);const a=r.totalduration,{sn:n,cc:o}=t;let l=this.stats=e.stats;if("initSegment"===n)this.state=Ws.IDLE,l.tparsed=l.tbuffered=performance.now(),r.initSegments[o].data=e.payload,this.hls.trigger(s.b.FRAG_BUFFERED,{stats:l,frag:t,id:"audio"}),this.tick();else{this.state=Ws.PARSING,this.appended=!1,this._ensureDemuxer();let i=this.initPTSs.get(o),s=r.initSegments[o]?r.initSegments[o].data:void 0;if(void 0===i)this.state=Ws.WAITING_INIT_PTS;else{this.pendingBuffering=!0;let r=!1;this.logFragmentTiming({level:t.level,sn:"initSegment",cc:o},"parsing"),this.logFragmentTiming(t,"parsing"),this.demuxer.push(e.payload,s,t,a,r,i)}}}this.fragLoadError=0,this.hls.trigger(s.b.FRAG_LOADED,e)}onInitPtsFound(e){let t=e.id,i=e.frag.cc,s=e.initPTS90k;"main"===t&&(this.initPTSs.set(i,s),this.state===Ws.WAITING_INIT_PTS&&(this.state=Ws.IDLE,i===this.waitingForCC&&(this.waitingForCC=null)))}onFragParsingInitSegment(e){const t=this.fragCurrent,i=e.frag;if(t&&"audio"===e.id&&i.sn===t.sn&&i.level===t.level&&this.state===Ws.PARSING){const t=e.track;if("audio"===t.type){const{codec:s,type:r}=t,a=this.bufferController.updateKnownCodecs(r,i.cc,s,void 0),n=this.bufferController.getCurrentInitInfoForParent(this.sbid);this.logger.info(`[${i.type}] onFragParsingInitSegment, trackType: ${e.track.type}, frag: ${i.fragTag}, currentSbInitInfo: ${n?JSON.stringify(n):"N/A"}`)(),a||i.cc!==(null==n?void 0:n.cc)?this.doCreateSbAndAppendInitSegment(i,t,void 0):(this.logger.warn(`[${this.sbid}] incompatible codecs[parsed]=[${t.codec}] on track switch, will wait for a source buffer reset`)(),this.hls.streamController.setNeedsResetForCC(i.cc)),this.tick()}else this.logger.warn(`${e.id}: missing audio track @ level ${i.level} cc ${i.cc}`)(),this.hls.bufferController.ignoreSourceBuffer(1),this.stopLoad()}}handleFragParsingData(e,t){var i;const r=e.frag;t&&this.logger.info(`[${this.sbid}] handleFragParsingData parsing cached data for frag ${r.fragTag}`)();let a=this.hls.bufferController.isCompatibleTransition(r.cc);if("yes"!==a)this.logger.info(`[${this.sbid}] caching frag ${r.fragTag}, compatible: ${a}, seeking: ${null===(i=this.media)||void 0===i?void 0:i.seeking}`)(),this.setWaitingDiscontinuity(e);else if(this.audioSwitch&&this.mediaBuffer.buffered.length)this.pendingParsedData=e,this.flushAudioBuffer(0,Number.POSITIVE_INFINITY);else if(this.state===Ws.PARSING)if(null!=this.waitingForKey.value)this.pendingParsedData=e,this.state=Ws.KEY_LOADING;else{let t=this.trackId,i=this.hls.audioTrackController.resolveTrackId(t).trackInfo,a=this.hls;isNaN(e.endPTS)&&(e.endPTS=e.startPTS+r.duration,e.endDTS=e.startDTS+r.duration),this.ensureInitSegmentForFragInfo(r,e.track,void 0),this.logger.info(`parsed ${e.type},PTS:[${e.startPTS.toFixed(3)},${e.endPTS.toFixed(3)}],DTS:[${e.startDTS.toFixed(3)}/${e.endDTS.toFixed(3)}]`)(),js.updateFragPTSDTS(i.details,r,e.startPTS,e.endPTS);let n=this.audioSwitch,o=this.media;n&&o&&(this.audioSwitch=!1,a.trigger(s.b.AUDIO_TRACK_SWITCHED,{id:t})),[e.data1,e.data2].forEach(t=>{t&&t.length&&this.state===Ws.PARSING&&(this.appended=!0,this.pendingBuffering=!0,this.logFragmentTiming(r,"appending"),this.hls.bufferController.appendBuffer("audio",t,e.startPTS,e.endPTS,"audio","data",r))})}}onBufferCreated(e){let t=e.tracks.audio;t&&(this.mediaBuffer=t.buffer)}onBufferAppended(e){if("audio"===e.parent){this.logFragmentTiming(e.frag,"appended");const t=this.state;t!==Ws.PARSING&&t!==Ws.PARSED||(this.pendingBuffering=e.pending>0,this.checkAppendedParsed())}}checkAppendedParsed(){if(!(this.state!==Ws.PARSED||this.appended&&this.pendingBuffering)){let e=this.fragCurrent,t=this.stats,i=this.hls;if(e){this.fragPrevious=e,t.tbuffered=performance.now();let r=this.mediaBuffer?this.mediaBuffer:this.media;i.trigger(s.b.FRAG_BUFFERED,{stats:t,frag:e,id:"audio"}),this.logger.info(`audio buffered: ${qs(r.buffered)}`)(),this.audioSwitch&&this.appended&&(this.audioSwitch=!1,i.trigger(s.b.AUDIO_TRACK_SWITCHED,{id:this.trackId})),this.state=Ws.IDLE}this.tick()}}onBufferFlushed(){this.state!==Ws.FRAG_LOADING&&(this.state=Ws.IDLE,this.fragPrevious=null)}onBufferSourceReset(e){this._attachMedia(e.media)}_handleFragmentError(e){e instanceof r.l&&(this._handleFragmentNetworkError(e,!1),this.resetNextLoadPositionState(),e.fatal&&this.escalateInternalError(e))}onInternalError(e){if(super.handleInternalError(e))return;let t;if(!(e instanceof r.l||e instanceof r.k||e instanceof r.j||e instanceof r.o)||!(t=e.frag)||"audio"===t.type)if(e instanceof r.k)this.resetNextLoadPositionState(),this.state=e.fatal?Ws.ERROR:Ws.IDLE,this.logger.warn(`audioStreamController: ${e.details} while parsing frag,switch to ${this.state} state`)();else if(e instanceof r.j)e.fatal||e.retrying||this.state!==Ws.PLAYLIST_LOADING||(this.state=Ws.IDLE);else if(e instanceof r.b){let t=this.media.currentTime,i=Cs.bufferInfo(this.media,t,this.config.maxBufferHole),s=Cs.isBuffered(this.mediaBuffer,t)&&Cs.isBuffered(this.mediaBuffer,t+.5);this.handleBufferFullError(e,"audio",this.trackId,i,s,()=>{this.fragCurrent=null,this.flushAudioBuffer(0,Number.POSITIVE_INFINITY)})}}get canContinuePlaybackWithoutGap(){let e=this.trackId,t=this.hls.audioTrackController.resolveTrackId(e).trackInfo,i=t?t.details:void 0;return Cs.canContinuePlaybackWithoutGap(this.mediaBuffer||this.media,this.media.currentTime,this.config.maxBufferHole,this.hls.playlistType,i)}get variantController(){return this.hls.audioTrackController}},audioTrackController:class extends Ts{constructor(e){super(e,s.b.AUDIO_TRACK_LOADED,s.b.PREFERRED_HOST_CHANGED)}destroy(){this.stopLoad(),this.levelLoader&&this.levelLoader.destroy(),this.variantManager&&this.variantManager.destroy(),P.prototype.destroy.call(this)}stopLoad(){this.levelLoader&&this.levelLoader.stop()}resetTracks(){this.trackId=void 0,this._selectedMediaOption=void 0}setTracks(e,t){let i=e.validVariantList;this.resetTracks(),this.setVariantManager(e),this._mediaSelectionGroup=t||{MediaSelectionGroupAllowEmptySelection:1,MediaSelectionGroupMediaCharacteristics:["public.audible"],MediaSelectionGroupMediaType:pi.AUDIO,MediaSelectionGroupOptions:[]};let r={audioTracks:i};if(this.hls.trigger(s.b.AUDIO_TRACKS_UPDATED,r),void 0===this.queuedPersistentID||this.selectedMediaOption){if(this.mediaSelectionOptions.length>0){let e=this.mediaSelectionOptions.find((function(e){return e.MediaSelectionOptionsIsDefault}));this.selectedMediaOption=e||this.mediaSelectionOptions[0]}}else{let e=this.sanitizePersistentID(i,this.queuedPersistentID);e===this.queuedPersistentID||(this.queuedPersistentID=e),this.selectedPersistentID=this.queuedPersistentID,this.queuedPersistentID=void 0}}onPreferredHostChanged(e){if(e.mediaType===pi.AUDIO||isNaN(this.trackId)||this.trackId<0||0===this.variantManager.variantList.length)return;let t,i=this.variantManager&&this.variantManager.getVariantInfoIfValid(this.trackId),s=this.validTracks,r=i.groupCodecList;(t=s.find(e=>{let t=e.groupCodecList,s=!1;if(t.length===r.length&&1===t.length){let a=r[0],n=t[0];s=e.persistentID===i.persistentID&&Oi.b.isCompatibleAudioCodec(a,n)&&e.url&&h.getHostName(e.url)===this.hls.preferredHostName}return s}))&&(this.logger.warn(`preemptively switching audio host to ${this.hls.preferredHostName}`)(),this.updateTrack(t.id))}onAudioTrackLoaded(e){if(this.variantManager&&this.variantManager.getVariantInfoIfValid(e.id)){let t=e.details,i=this.levelLoader.handleLevelLoad(e.id,t,e.stats);i.success||this.logger.error(`Got error ${i.error}`)(),this.resolveTrackId(e.id).trackInfo.details=t}else this.logger.warn(`invalid audioTrack ${e.id} loaded`)()}_findValidGroupId(e){return this.validTracks.find((function(t){return t.groupId&&t.groupId!==e.groupId})).groupId}getNextBestAutoVariant(e){let t=this.resolveTrackId(e).trackInfo,i=this._findValidGroupId(t),s=this.hls.preferredHostName,r=this.validTracks.find((function(e){return e.groupId===i&&e.persistentID===t.persistentID&&h.getHostName(e.url)===s}));return r?r.id:-1}resolveTrackId(e){let t,i;return!e&&0!==e||e<0?this.logger.warn(`invalid trackID ${e}`)():this.variantManager&&(t=this.variantManager.getVariantInfoIfValid(e),i=this.variantManager.getVariantListPosition(e)),{trackInfo:t,trackListPosition:i}}containsFallbackVariant(){let e=this.audioTrack,t=this.resolveTrackId(e).trackInfo;return!!t&&this.validTracks.filter((function(e){return e.groupId&&e.persistentID===t.persistentID&&e.groupId!==t.groupId})).length>0}setNextAutoVariant(e){this.audioTrack=e}get validTracks(){return this.variantManager&&this.variantManager.validVariantList||[]}get currentVariantId(){return this.audioTrack}setVariantManager(e){this.levelLoader&&this.levelLoader.destroy(),this.variantManagerInternal=e,this.levelLoader=new bs(e,e=>{this._loadTrackInternal(e)},()=>{this.hls.playlistLoader.abort("audioTrack")})}get variantManager(){return this.variantManagerInternal}get audioTrack(){return this.trackId}set audioTrack(e){if(!this.validTracks)return;let t=this.resolveTrackId(e).trackInfo;t&&(this.trackId===e&&void 0!==t.details||this.setAudioTrackInternal(e))}get mediaSelectionGroup(){return this._mediaSelectionGroup}get mediaSelectionOptions(){return this.mediaSelectionGroup?this.mediaSelectionGroup.MediaSelectionGroupOptions:[]}get selectedPersistentID(){return this.selectedMediaOption?this.selectedMediaOption.MediaSelectionOptionsPersistentID:-1}set selectedPersistentID(e){if(e>=0&&!this._mediaSelectionGroup)return void(this.queuedPersistentID=e);let t=this.mediaSelectionOptions.find((function(t){return t.MediaSelectionOptionsPersistentID===e}));this.selectedMediaOption=t}get selectedMediaOption(){return this._selectedMediaOption}set selectedMediaOption(e){this._selectedMediaOption=e,this.updateTrackSelection()}updateTrackSelection(){if(!this._selectedMediaOption)return;let e=this._selectedMediaOption.MediaSelectionOptionsPersistentID,t=this.validTracks.find(t=>e===t.persistentID&&t.url&&h.getHostName(t.url)===this.hls.preferredHostName);t?this.audioTrack=t.id:this.logger.warn("could not find audio track for selected media group: "+this._selectedMediaOption.MediaSelectionOptionsName+" with ID: ("+e+")")()}setAudioTrackInternal(e){if(this.trackId!==e){this.trackId=e;let t=this.resolveTrackId(e).trackInfo,i=this.hls,r={id:e,type:t.type,url:t.url};this.logger.info(`[QE Critical] switching to audioTrack ${e} - ${t.name}`)(),i.trigger(s.b.AUDIO_TRACK_SWITCH,r),i.trigger(s.b.AUDIO_TRACK_SWITCHING,r)}this.levelLoader.loadLevel(e)}updateTrack(e){this.setAudioTrackInternal(e)}_loadTrackInternal(e){let t=e.url,i=e.id;t&&(this.logger.info(`[QE Critical] (re)loading playlist for audioTrack ${i}`)(),this.hls.playlistLoader.loadAudioTrack(t,i).then(function(e){this.hls.trigger(s.b.AUDIO_TRACK_LOADED,e)}.bind(this)).catch(e=>{this._handleMediaPlaylistNetworkError(e,!1)}))}_attemptRetry(e,t){let i=this.hls.playlistLoader.retryPlaylistRequest(e);return i?i.then(()=>{this.hls.trigger(s.b.AUDIO_TRACK_LOADED,e)}).catch(e=>{this._handleMediaPlaylistNetworkError(e,t)}):void 0}sanitizePersistentID(e,t){if(!e||!e.length)return t;let i;for(let s=0;s<e.length;s++){let r=e[s];if(r.persistentID===t){i=t;break}r.default&&(i=r.persistentID),i||"en-US"!==r.lang||(i=r.persistentID)}return i>=0?i:e[0].persistentID}},iframeMaxExitSeekDuration:2e3,iframeStallMaxRetry:5,audioPrimingDelay:0,subtitleStreamController:class extends zs{constructor(e,t){super(e,"subtitle",s.b.MEDIA_ATTACHING,s.b.MEDIA_DETACHING,s.b.INTERNAL_ERROR,s.b.SUBTITLE_TRACKS_UPDATED,s.b.SUBTITLE_TRACK_SWITCH,s.b.SUBTITLE_TRACK_LOADED,s.b.SUBTITLE_FRAG_PROCESSED),this.media=null,this.fragCurrent=null,this.fragPrevious=null,this.fragQueue=[],this.fragNumCues={},this.latestCueStart=0,this.tracks=null,this.enabledTrack=null,this.onMediaSeeking=()=>{this.state===Ws.ENDED&&(this.state=Ws.IDLE),this.tick()},this.onMediaSeeked=()=>{this.logger.info(`[subtitle] seeked. state ${this.state}`)();let e=this.hls.timelineController.forgetFragsWaitingForInitPTS();this.state===Ws.FRAG_LOADING&&e.length&&(this.state=Ws.IDLE)},this.fragLoadError=0,this.tickFn=t}destroy(){this.stopLoad(),this.bufferMonitor&&(this.bufferMonitor.destroy(),this.bufferMonitor=null),this.state=Ws.STOPPED,this._pendingDiscontinuityOffsets=void 0,super.destroy()}tick(){this.tickFn()}startLoad(){this.tracks?(this.stopLoad(),this.fragLoadError=0,this.state=Ws.IDLE,this.tick()):this.state=Ws.STOPPED}stopLoad(){if(this.state!==Ws.STOPPED){var e=this.fragCurrent;e&&(e.loader&&e.loader.abort(),this.fragCurrent=null),this.fragPrevious=null,this.state=Ws.STOPPED}}isSubtitleTrackEnabled(){return this.findEnabledTrack()&&(this.findEnabledTrack().mediaType===pi.SUBTITLE||this.enabledTrack.sideTrackId)}estimateCurrentWaterLevel(){if(!this.hls.media)return 0;const e=this.hls.media.currentTime;if(this.hls.isLive)return this.latestCueStart-e;{const{bufferedFrags:t}=this._checkFragBufferedState();return Os.fragmentsBufferedInfo(t,e,this.hls.config.maxBufferHole).end-e}}processSubtitleFrag(e){let t=e.frag,i=this.enabledTrack.details;this.logger.info(`${t.type} Loaded  ${t.sn} of [${i.startSN},${i.endSN}], `+`level: ${t.level}, cc: ${t.cc}, start: ${t.start} URL ${this.hls.redactUrl(t.relurl)}`)(),this.hls.timelineController.processSubtitleFrag(e)}doTick(){if(this.state===Ws.FRAG_LOADING_WAITING_RETRY){let e=performance.now(),t=this.retryDate;t&&e>=t&&(this.state=Ws.IDLE)}if(this.state!==Ws.IDLE||!this.enabledTrack||this.enabledTrack.mediaType!==pi.SUBTITLE&&void 0===this.enabledTrack.sideTrackId||!this.media)return;let e=!1;this.enabledTrack.details?this.enabledTrack.details.live&&Date.now()-this.enabledTrack.details.lastLoadTimeMillis>=1e3*this.enabledTrack.details.targetduration&&this.hls.isLive&&0!==this.hls.desiredRate&&(e=!0):e=!0,this.enabledTrack.details&&0===this.fragQueue.length&&this._addAllFragmentsToQueue(),e&&(this.state=Ws.PLAYLIST_LOADING,this.hls.subtitleTrackController.loadTrackInternal(this.enabledTrack)),this.enabledTrack.details&&this.bufferMonitor&&(this.bufferMonitor.targetDuration=this.enabledTrack.details.targetduration);let t=this.enabledTrack.details;const{fragQueue:i}=this;let s=this._findFragment();if(null==s)return;this.fragLoadError>0&&this.fragPrevious&&s.sn!==this.fragPrevious.sn+1&&(s=i[this.fragPrevious.sn-i[0].sn+1]),this._pendingDiscontinuityOffsets||(this._pendingDiscontinuityOffsets=this._findAllDiscontinuityFragmentsBefore(s));let r=this.enabledTrack.details.initSegments[s.cc];r&&!r.data?(r.trackId=this.enabledTrack.id,s=r):this._pendingDiscontinuityOffsets&&this._pendingDiscontinuityOffsets.length>0&&(s=this._pendingDiscontinuityOffsets.shift()),this.fragPrevious&&s.sn===this.fragPrevious.sn&&s.level===this.fragPrevious.level||(this.logger.info(`${s.type} loading ${s.sn} of level ${s.level} trackId ${s.trackId} `+`[${t.startSN},${t.endSN}], cc: ${s.cc}, range: ${s.rangeString}, `+`currentTime: ${this.media.currentTime} URL ${this.hls.redactUrl(s.relurl)} `)(),this.state=Ws.FRAG_LOADING,this.fragCurrent=s,this.hls.fragmentLoader.loadFragment(s).then(e=>{this.processSubtitleFrag(e),this.fragLoadError=0}).catch(e=>{this._handleFragmentError(e)}))}_findFragment(){const{hls:e}=this,t=this.media.currentTime,i=t+e.config.maxBufferLength;return e.isLive&&"EVENT"!==e.playlistType?this._findFragmentLive(i):this._findFragmentVod(t,i)}_findFragmentLive(e){return e>this.latestCueStart?this.fragQueue.shift():null}_findFragmentVod(e,t){const{loadableFrags:i}=this._checkFragBufferedState();for(const s of i){const i=s.start,r=i+s.duration;if(i<=e&&r>e||i<=t&&r>t||i>=e&&r<=t)return s}return null}_checkFragBufferedState(){if(!this.enabledTrack)return{bufferedFrags:[],loadableFrags:[]};let e=[],t=[];const{fragQueue:i,fragNumCues:s}=this,r=this.hls.timelineController.getCuesOfEnabledTrack(this.enabledTrack.id,void 0!==this.enabledTrack.sideTrackId);if(null!=r&&r.length>0&&i.length>0){const a={};for(let e=0;e<r.length;e++){const t=r[e];null==a[t.fragSN]?a[t.fragSN]=1:a[t.fragSN]++}for(const r of i){const i=r.sn,n=s[i],o=a[i];null==o||null==n||n>o?t.push(r):e.push(r)}}else t=[...i];return{bufferedFrags:e,loadableFrags:t}}_addAllFragmentsToQueue(){const{fragQueue:e,enabledTrack:t}=this,{details:i,id:s}=t;let r=e.length;i.fragments.forEach(t=>{t.trackId=s,"number"==typeof t.sn&&(null==this.fragPrevious||t.sn>this.fragPrevious.sn)&&(0===e.length||t.sn>e[e.length-1].sn)&&e.push(t)}),i.live&&(r<e.length||"number"!=typeof i.lastLoadTimeMillis)&&(i.lastLoadTimeMillis=Date.now())}_findAllDiscontinuityFragmentsBefore(e){let t,i=[];return this.enabledTrack.details.fragments.forEach(s=>{if(e.sn>s.sn){let e=this.hls.timelineController.hasDiscontinuityOffset(s.cc);void 0!==t&&s.cc===t||e||(i.push(s),t=s.cc)}}),i}onMediaAttaching(e){this.media=e.media;let t=this.tracks&&this.hls.config.autoStartLoad?this.hls.config.startPosition:-1;this._attachMedia(e.media,t)}_attachMedia(e,t){this.media=e,e.addEventListener("seeking",this.onMediaSeeking),e.addEventListener("seeked",this.onMediaSeeked),t>=0&&this.startLoad()}onMediaDetaching(){var e=this.media;e&&(e.removeEventListener("seeking",this.onMediaSeeking),e.removeEventListener("seeked",this.onMediaSeeked)),this.media=null,this.stopLoad(),this.bufferMonitor&&(this.bufferMonitor.destroy(),this.bufferMonitor=null)}onSubtitleTracksUpdated(e){this.tracks=e.subtitleTracks,this.fragQueue=[],this.fragNumCues=[],this.latestCueStart=0,this.state=Ws.IDLE}onSubtitleTrackSwitch(e){if(e.hidden&&e.track){let t=this.hls.subtitleTrackController.redirectTextTrack(e.track.id);this.enabledTrack=this.hls.subtitleTrackController.resolveTrackId(t).trackInfo,this.enabledTrack.sideTrackId=e.track.id,this.enabledTrack.url=this.hls.subtitleTrackController.resolveTrackId(e.track.id).trackInfo.url}else this.enabledTrack=e.track;if(this.fragPrevious&&this.enabledTrack&&this.fragPrevious.trackId!==this.enabledTrack.id&&(this.logger.info(`[subtitle] clear fragPrevious from trackId ${this.fragPrevious.trackId}`)(),this.fragPrevious=null),this.logger.info(`[subtitle] enable track id: ${this.enabledTrack?this.enabledTrack.id:"undefined"} `+`side track id ${this.enabledTrack?this.enabledTrack.sideTrackId:"undefined"}`)(),this.enabledTrack){this.bufferMonitor&&this.bufferMonitor.destroy();let e=()=>this.estimateCurrentWaterLevel();this.bufferMonitor=new Ns(this.hls,this.hls.media,e,Ms.Subtitle,this.config.maxBufferHole,this.config.maxBufferLength,this.config.defaultTargetDuration,this.config.almostDryBufferSec)}else this.bufferMonitor&&(this.bufferMonitor.destroy(),this.bufferMonitor=null);this.fragQueue=[],this.fragNumCues=[],this.latestCueStart=0,this.fragCurrent&&(this.fragCurrent.loader&&this.fragCurrent.loader.abort(),this.fragCurrent=null),this.state=Ws.IDLE,this.tick()}onSubtitleTrackLoaded(e){this.enabledTrack.details=e.details,this.enabledTrack&&this.enabledTrack.id===e.id&&this._addAllFragmentsToQueue(),this.state=Ws.IDLE,this.tick()}onSubtitleFragProcessed({frag:e,cues:t}){this.fragPrevious=e,this.fragCurrent=null,this.state=Ws.IDLE,"number"==typeof e.sn&&(t=t||[],this.updateLatestCueStart(t),this.fragNumCues[e.sn]=t.length,this.bufferMonitor.notifyWaterLevelChanged()),this.tick()}updateLatestCueStart(e){this.latestCueStart=Math.max(this.latestCueStart,...e.map(e=>e.startTime))}findEnabledTrack(){return this.enabledTrack}_handleFragmentError(e){e instanceof r.l&&(super._handleFragmentNetworkError(e,!1),e.fatal&&this.escalateInternalError(e))}onInternalError(e){if(this.state!==Ws.ERROR)return e.fatal?(this.state=Ws.ERROR,void this.escalateInternalError(e)):void 0}get variantController(){return this.hls.subtitleTrackController}},subtitleTrackController:class extends Ts{constructor(e){super(e,s.a.MEDIA_ATTACHED,s.a.MEDIA_DETACHING,s.a.SUBTITLE_TRACKS_CREATED,s.a.PREFERRED_HOST_CHANGED),this.media=void 0,this.subtitleDisplay=!1,this.allTracksCreated=!1,this.trackRetryCount=0,this.variantManager=new ys(e,pi.SUBTITLE)}destroy(){this.variantManager&&this.variantManager.destroy(),super.destroy()}get validTracks(){return this.variantManager&&this.variantManager.validVariantList||[]}get mediaSelectionGroup(){return this._mediaSelectionGroup}get mediaSelectionOptions(){return this.mediaSelectionGroup?this.mediaSelectionGroup.MediaSelectionGroupOptions:[]}get selectedPersistentID(){return this.selectedMediaOption?this.selectedMediaOption.MediaSelectionOptionsPersistentID:-1}set selectedPersistentID(e){if(e>=0&&!this.allTracksCreated)return void(this.queuedPersistentID=e);let t=this.mediaSelectionOptions.find((function(t){return t.MediaSelectionOptionsPersistentID===e}));this.selectedMediaOption=t}get selectedMediaOption(){return this._selectedMediaOption}set selectedMediaOption(e){if(e&&!this.allTracksCreated)return void(this.queuedPersistentID=e.MediaSelectionOptionsPersistentID);let t;if(this._selectedMediaOption=e,e){let i=e.MediaSelectionOptionsPersistentID;(t=this.validTracks.find((function(e){return e.persistentID===i})))||this.logger.warn("could not find subtitle track for selected media group: "+e.MediaSelectionOptionsName+" with ID: ("+i+")")()}this.selectedTrack=t;let i=this.selectedTrack?this.selectSideTrack(this._selectedMediaOption):void 0;i&&(this.selectedSideTrack=i)}get selectedTrack(){return this._selectedTrack}set selectedTrack(e){jr(this._selectedTrack,e)||(this.selectedSideTrack&&(this._selectedSideTrack=void 0),this.logger.info("[QE Critical] switching to subtitle/caption track "+(e?e.id+" - "+e.name:"(NONE)"))(),this._selectedTrack=e,this.hls.trigger(s.a.SUBTITLE_TRACK_SWITCH,{track:e}),this.updateTextTrackState())}get currentVariantId(){return this._selectedTrack.id}selectSideTrack(e){let t;if(this.hls.config.enableDualTrackSelection&&e&&e.MediaSelectionOptionsMediaType===pi.CLOSEDCAPTION){e.MediaSelectionOptionsPersistentID;let i=this.selectedTrack,s=this.logger;t=this.validTracks.find((function(t){let r=t.mediaType===pi.SUBTITLE&&t.lang===e.MediaSelectionOptionsExtendedLanguageTag&&t.forced&&t.autoselect&&t.groupId!==i.groupId;return r&&s.info(`[subtitle] pick side track persistent id ${t.persistentID} track id ${t.id} group id ${t.groupId}`)(),r}))}return t}get selectedSideTrack(){return this._selectedSideTrack}set selectedSideTrack(e){jr(this._selectedSideTrack,e)||(this.logger.info("[QE Critical] switching to side subtitle/caption track "+(e?e.id+" - "+e.name:"(NONE)"))(),this._selectedSideTrack=e,this.hls.trigger(s.a.SUBTITLE_TRACK_SWITCH,{track:e,hidden:!0}),this.updateTextTrackState())}redirectTextTrack(e){let t=e;return this.selectedSideTrack&&e===this.selectedSideTrack.id&&(t=this.selectedTrack.id,this.logger.info(`[subtitle] promote side track id from ${e} to ${t}`)()),t}updateTextTrackState(){if(!this.media||!this.media.textTracks)return;let e=this.selectedTrack?this.selectedTrack.id:void 0,t=Wr(this.media.textTracks);for(let i=0;i<t.length;i++)i===e&&"showing"!==t[i].mode?t[i].mode="showing":i!==e&&"hidden"!==t[i].mode&&(t[i].mode="hidden")}onMediaAttached(e){this.media=e.media,this.media&&(this.updateTextTrackState(),this.trackChangeListener=this._onTextTracksChanged.bind(this),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.subtitlePollingInterval=setInterval(()=>{this.trackChangeListener()},500):this.media.textTracks.addEventListener("change",this.trackChangeListener))}onMediaDetaching(){this.media&&(this.useTextTrackPolling?clearInterval(this.subtitlePollingInterval):this.media.textTracks.removeEventListener("change",this.trackChangeListener),this.media=void 0)}resetTracks(){this.selectedTrack=void 0,this._selectedMediaOption=void 0,this.trackRetryCount=0}setVariantManager(e){this.logger.info(`${this.constructor.name} setVariantManager ${e&&e.validVariantList.length}`)(),this.variantManager=e}setTracks(e,t){this.resetTracks(),this.setVariantManager(e),this._mediaSelectionGroup=t||{MediaSelectionGroupAllowEmptySelection:1,MediaSelectionGroupMediaCharacteristics:["public.legible"],MediaSelectionGroupMediaType:pi.SUBTITLE,MediaSelectionGroupOptions:[]};let i={subtitleTracks:this.validTracks};this.hls.trigger(s.a.SUBTITLE_TRACKS_UPDATED,i)}onSubtitleTracksCreated(){this.allTracksCreated=!0,void 0===this.queuedPersistentID||this.selectedMediaOption||(this.selectedPersistentID=this.queuedPersistentID,this.queuedPersistentID=void 0)}onPreferredHostChanged(e){if(e.mediaType===pi.SUBTITLE||!this.selectedTrack||0===this.variantManager.variantList.length)return;let t,i=this.selectedTrack;i.url,(t=this.validTracks.find(e=>e.persistentID===i.persistentID&&e.forced===i.forced&&d.getHostName(e.url)===this.hls.preferredHostName))&&(this.selectedSideTrack?(this.logger.warn(`preemptively switching subtitle host for side track id ${this.selectedSideTrack.id} to id ${t.id}, host=${this.hls.preferredHostName}`)(),this.selectedSideTrack=t):(this.logger.warn(`preemptively switching subtitle host to ${this.hls.preferredHostName}`)(),this.selectedTrack=t))}_onTextTracksChanged(){if(!this.media)return;let e,t=!1,i=Wr(this.media.textTracks);for(let s=0;s<i.length;s++)i[s].seen?"showing"===i[s].mode&&this.resolveTrackId(s).trackInfo&&(e=this.resolveTrackId(s).trackInfo):(i[s].seen=!0,t=!0);if(!t){let t=e?e.persistentID:void 0,i=this._selectedMediaOption;if(!i||i.MediaSelectionOptionsPersistentID!==t){let e=this.mediaSelectionOptions.find((function(e){return e.MediaSelectionOptionsPersistentID===t}));this.selectedMediaOption=e}}}loadTrackInternal(e){let t=e.url;e.id,t&&this.hls.playlistLoader.loadSubtitleTrack(e.url,e.id).then(function(e){this.hls.trigger(s.a.SUBTITLE_TRACK_LOADED,e)}.bind(this)).catch(function(e){this._handleMediaPlaylistNetworkError(e,!1)}.bind(this))}_attemptRetry(e,t){let i=this.hls.playlistLoader.retryPlaylistRequest(e);return i?i.then(()=>{this.hls.trigger(s.a.SUBTITLE_TRACK_LOADED,e)}).catch(e=>{this._handleMediaPlaylistNetworkError(e,t)}):void 0}containsFallbackVariant(){return this.validTracks.filter(e=>e.persistentID===this.selectedTrack.persistentID&&e.forced===this.selectedTrack.forced).length>1}_findValidGroupId(e){let t=this.validTracks.find((function(t){return t.groupId&&t.groupId!==e.groupId}));return t?t.groupId:void 0}resolveTrackId(e){let t,i;return!e&&0!==e||e<0?this.logger.warn(`invalid trackID ${e}`)():this.variantManager&&(t=this.variantManager.getVariantInfoIfValid(e),i=this.variantManager.getVariantListPosition(e)),{trackInfo:t,trackListPosition:i}}getNextBestAutoVariant(e){let t,i=this.resolveTrackId(e).trackInfo,s=i?this._findValidGroupId(i):void 0,r=this.hls.preferredHostName;return i&&s?t=this.validTracks.find((function(e){return e.groupId===s&&e.persistentID===i.persistentID&&d.getHostName(e.url)===r})):this.logger.warn("can't find substitute track in a different group id")(),t?t.id:-1}setNextAutoVariant(e){let t=this.resolveTrackId(e).trackInfo;if(t){let e=this.mediaSelectionOptions.find((function(e){return e.MediaSelectionOptionsPersistentID===t.persistentID}));this.selectedSideTrack?(this.logger.info(`[subtitle] use next side track ${t.id}`)(),this.selectedSideTrack=t):(this.logger.info(`[subtitle] use next track ${t.id}`)(),this._selectedMediaOption=e,this.selectedTrack=t)}}},timelineController:zr,cueHandler:{newCue:function(e,t,i,s,r){let a,n,o,l,d;const h={foreground:!1,background:!1,italics:!1,underline:!1,flash:!1,styleStack:[]};for(const[c,u]of s.rows.entries())if(n=!0,o=0,l="",!u.isEmpty()){for(let e=0;e<u.chars.length;e++)u.chars[e].uchar.match(/\s/)&&n?o++:(l+=this.getFormattedChar(u.chars[e],h),n=!1);u.cueStartTime=t,t===i&&(i+=1e-4),l=l.trim().replace(/<br(?: \/)?>/gi,"\n"),l+=this.closeStyles(h),a=new Tr.VTTCue(t,i,l),o>=16?o--:o++,d=navigator.userAgent.match(/Firefox\//)?c+1:c>7?c:c+1,a.snapToLines=!1,a.line=10+5.33*d,a.align="left",a.position=this.getPosition(o,r),e.addCue(a)}},getPosition:function(e,t){let i=4/3;t&&t.offsetWidth&&t.offsetHeight&&t.offsetWidth/t.offsetHeight>=1.6&&(i=16/9);let s=10+e/32*80,r=10,a=90;return i===16/9&&(s=12.5+.75*s,r=20,a=80),Math.max(r,Math.min(a,s+(navigator.userAgent.match(/Firefox\//)?50:0)))},getRootStyleTag:function(e){let t=e[0];return"c"===t?t:e},closeStyles:function(e){let t="";for(let i=e.styleStack.length-1;i>=0;--i)t+="</"+this.getRootStyleTag(e.styleStack[i])+">",e.styleStack.pop();return t},beginStyleAndBalance:function(e,t){let i="";return"c"===t[0]&&(i+=this.closeStyleAndBalance(e,"c")),i+="<"+t+">",e.styleStack.push(t),i},closeStyleAndBalance:function(e,t){let i=e.styleStack.length,s=0,r="",a=!1;for(let n=i-1;n>=0;--n){let o=e.styleStack[n],l=this.getRootStyleTag(o);if(t[0]===o[0]){r+="</"+l+">",e.styleStack.splice(i-1-s);break}a=!0,"c"===l[0]?(e.background="",e.foreground="",e.flash=!1,r+="</c>"):"u"===l[0]?(e.underline=!1,r+="</u>"):"i"===l[0]&&(e.italics=!1,r+="</i>"),s++}return r},getFormattedChar:function(e,t){let i="",s=e.uchar,r="",a=e.penState.foreground!==t.foreground,n=e.penState.background!==t.background,o=e.penState.flash!==t.flash;return(a||n||o)&&(r="."+e.penState.foreground,r+=".bg_"+e.penState.background,e.penState.flash&&o&&(r+=".blink"),e.penState.foreground||e.penState.background||e.penState.blink?i+=this.beginStyleAndBalance(t,"c"+r):i+=this.closeStyleAndBalance(t,"c"),a&&(t.foreground=e.penState.foreground),n&&(t.background=e.penState.background),o&&(t.flash=e.penState.flash)),e.penState.underline!==t.underline&&(i+=e.penState.underline?this.beginStyleAndBalance(t,"u"):this.closeStyleAndBalance(t,"u"),t.underline=e.penState.underline),e.penState.italics!==t.italics&&(i+=e.penState.italics?this.beginStyleAndBalance(t,"i"):this.closeStyleAndBalance(t,"i"),t.italics=e.penState.italics),i+s}},enableCEA708Captions:!0,customTextTrackCueRenderer:!1,enableWebVTT:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",enableDualTrackSelection:!1,stretchShortVideoTrack:!1,forceKeyFrameOnDiscontinuity:!0,useFirstLevelAtIncompatDiscontinuity:!0,abrBandwidthEstimator:"bandwidth-history-controller",abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrBandWidthFactor:.95,abrBandWidthUpFactor:.9,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,enableRtcReporting:!1,rtcIntervalTimeout:3e5,rtcSender:"HLSJS",rtcSessionTag:"none",useHTTPPlaybackSessionId:!1,warmupCdms:!1,enablePerformanceLogging:!1,overridePlaybackRate:!1,enableAdaptiveStartup:!0,bandwidthHistoryWindowSize:12e4,bandwidthHistoryTTL:6e5,bandwidthHistoryAggregationMethod:"quadratic-time-weighted",bandwidthHistoryGetEstimateThrottleMs:1e3,defaultTargetDuration:10,targetStartupMs:3e3,adaptiveStartupMetricsOverride:{maxValidHeight:1080,maxValidBitrate:1/0,maxPreferredBitrate:1/0},bandwidthHistoryStorageKey:"AppleHLS-bandwidth-estimation",storage:{get:"undefined"==typeof localStorage?void 0:localStorage.getItem.bind(localStorage),set:"undefined"==typeof localStorage?void 0:localStorage.setItem.bind(localStorage)},enableCDNFallback:!0,enableQueryParamsForITunes:!1,gapless:!1};var Zr=(function(){function e(e,t){this.predicate=e,this.thisArg=t}return e.prototype.call=function(e,t){return t.subscribe(new ea(e,this.predicate,this.thisArg))},e})(),ea=(function(e){function t(t,i,s){var r=e.call(this,t)||this;return r.predicate=i,r.thisArg=s,r.count=0,r}return fe(t,e),t.prototype._next=function(e){var t;try{t=this.predicate.call(this.thisArg,e,this.count++)}catch(e){return void this.destination.error(e)}t&&this.destination.next(e)},t})(Ae),ta=(function(){function e(){return Error.call(this),this.message="argument out of range",this.name="ArgumentOutOfRangeError",this}return e.prototype=Object.create(Error.prototype),e})(),ia=(new He(function(e){return e.complete()}),(function(){function e(e){if(this.total=e,this.total<0)throw new ta}return e.prototype.call=function(e,t){return t.subscribe(new sa(e,this.total))},e})()),sa=(function(e){function t(t,i){var s=e.call(this,t)||this;return s.total=i,s.count=0,s}return fe(t,e),t.prototype._next=function(e){var t=this.total,i=++this.count;i<=t&&(this.destination.next(e),i===t&&(this.destination.complete(),this.unsubscribe()))},t})(Ae),ra=(function(){function e(e){this.value=e}return e.prototype.call=function(e,t){return t.subscribe(new aa(e,this.value))},e})(),aa=(function(e){function t(t,i){var s=e.call(this,t)||this;return s.value=i,s}return fe(t,e),t.prototype._next=function(e){this.destination.next(this.value)},t})(Ae);class na extends He{constructor(){var e;super(t=>this._count$.pipe((e=e=>0===e,function(t){return t.lift(new Zr(e,void 0))}),(1,function(e){return e.lift(new ia(1))}),(void 0,function(e){return e.lift(new ra(void 0))})).subscribe(t)),this._count$=new Js(0)}do(e){this.add(),yt(e).pipe(ke({complete:()=>this.done()})).subscribe()}add(e=1){this._count$.next(this._count$.value+e)}done(e=1){this._count$.next(this._count$.value-e)}}const oa=[".*.itunes.apple.com"],la={deviceName:"&xapdn=",deviceModel:"&xapdm=",language:"&xapdl=",dsid:"&xapdsid=",subs:"&xapsub="};class da extends Vs{constructor(e={}){super(),this.firstItem=!0,this.media=null,this.destroyWG=new na,this.destroy$=new it;let t=da.DefaultConfig;if((e.liveSyncDurationCount||e.liveMaxLatencyDurationCount)&&(e.liveSyncDuration||e.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");this.config=Object.assign(Object.assign({},t),e);const{config:i}=this;if(void 0!==i.liveMaxLatencyDurationCount&&i.liveMaxLatencyDurationCount<=i.liveSyncDurationCount)throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be gt "liveSyncDurationCount"');if(void 0!==i.liveMaxLatencyDuration&&(i.liveMaxLatencyDuration<=i.liveSyncDuration||void 0===i.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be gt "liveSyncDuration"');this.logger=new c.a,this.logger.enable(i.debug,i.debugLevel),this.config=i,this._autoLevelCapping=-1,this.trigger=function(e,...t){if(t&&t.length&&"object"!=typeof t[0])return void this.logger.warn(`[QE Critical] [EventTrigger] ${e.toString()} data[0]: ${t[0]} is not an object`)();let i={loadItemId:this.loadingItem?this.loadingItem.options.itemId:void 0,playItemId:this.playingItem?this.playingItem.options.itemId:void 0};if(t.length?t[0].itemData=i:t[0]={itemData:i},"hlsFragLoadProgress"!==e.toString()){let i="";"hlsInternalError"!==e&&"hlsError"!==e||!t.length||(i=JSON.stringify(t[0],["fatal","details","reason"])),this.logger.info(`[QE Critical] [EventTrigger] ${e.toString()} ${i}`)()}this.emit(e,e,...t)}.bind(this),void 0===this.off&&(this.off=function(e,...t){this.removeListener(e,...t)}),this.bufferChangedFn=this.onBufferChanged.bind(this),this.on(s.a.BUFFER_CHANGED,this.bufferChangedFn);const r=this.bandwidthHistoryController=new fr(this),a=this.abrController=new i.abrController(this),n=this.bufferController=new i.bufferController(this),o=this.playlistLoader=new ds(this),l=this.fragmentLoader=new us(this),d=this.keyLoader=new Ut(this),h=this.networkErrorHandler=new ws(this),u=new x(this),f=new dr(this);let g=[this.levelController=new Ls(this,o),this.streamController=new lr(this)];this.networkControllers=g;const p=[o,l,d,u,a,n,f,h,r];if(i.audioTrackController){let e=new i.audioTrackController(this);this.audioTrackController=e,p.push(e)}if(i.subtitleTrackController){let e=new i.subtitleTrackController(this);this.subtitleTrackController=e,p.push(e)}if(i.timelineController){let e=new i.timelineController(this);this.timelineController=e,p.push(e)}const m=this.eventReporter=new mr(this);p.push(m),this.coreComponents=p,this.isValid=!0,this.cdnReferenceBaseURL=void 0,this.cdnWhiteList=new Set}get audioStreamController(){return this.streamController.audioStreamController}get subtitleStreamController(){return this.streamController.subtitleStreamController}static initialize(e){let t=da.DefaultConfig,i=Object.assign(Object.assign({},t),e);da.DefaultConfig=i,c.b.enable(i.debug,i.debugLevel),!0===i.warmupCdms&&lt.warmupCDM()}static get version(){return"1.530.2"}static isSupported(){return (function(){try{const e=window.MediaSource||window.WebKitMediaSource,t=window.SourceBuffer||window.WebKitSourceBuffer,i=e&&"function"==typeof e.isTypeSupported&&e.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"'),s=!t||t.prototype&&"function"==typeof t.prototype.appendBuffer&&"function"==typeof t.prototype.remove;return!!i&&!!s}catch(e){return!1}})()}static get Events(){return s.a}static get ErrorTypes(){return r.g}static get ErrorDetails(){return r.d}static get ErrorResponses(){return r.f}static get GaplessEvictReason(){return r.m}static get DefaultConfig(){return da.defaultConfig?da.defaultConfig:Jr}static set DefaultConfig(e){da.defaultConfig=e}destroy(){if(this._isObjectValid())return this.logger.info("destroy")(),this.destroy$.next(),this.clearFatalError(),this.trigger(s.a.DESTROYING),this.detachMedia(),this.coreComponents.concat(this.networkControllers).forEach(e=>{e.destroy()}),this.setPlayingItem(null),this.setLoadingItem(null),this.removeAllListeners(),this._autoLevelCapping=-1,this.cdnReferenceBaseURL=void 0,this.cdnWhiteList.clear(),this.isValid=!1,this.bufferEndPromiseWrapper=void 0,this.destroyWG.toPromise()}scheduleFatalError(e){this.fatalImmediate||(this.fatalImmediate=setImmediate(this.triggerFatalError.bind(this,e)))}clearFatalError(){clearImmediate(this.fatalImmediate),this.fatalImmediate=null}triggerFatalError(e){this.clearFatalError(),this.trigger(s.a.ERROR,e)}get isFirstItem(){return this.firstItem}evictItemOnFatalError(e){let t=this.isPreloadingItem&&this.playingItem.itemId!==this.loadingItem.itemId;return t&&(e.escalated=r.e.Downgraded,this.streamController.evictLoadingItem(this.loadingItem.startTime,da.GaplessEvictReason.FatalErrorWhileLoading)),t}fatalErrorRequiresAction(e){return!e.escalated&&!this.evictItemOnFatalError(e)}upgradeInternalErrorIfNecessary(e){return e.escalated?e.escalated===r.e.Upgraded:(this.evictItemOnFatalError(e)||(e.escalated=r.e.Upgraded,this.scheduleFatalError(e)),e.escalated===r.e.Upgraded)}attachMedia(e){this._isObjectValid()&&(this.logger.info("attachMedia")(),this.media=e,this.streamController.installMediaFunctions(e),this.trigger(s.a.MEDIA_ATTACHING,{media:e}))}detachMedia(){this._isObjectValid()&&this.media&&(this.logger.info("detachMedia")(),this.streamController.uninstallMediaFunctions(),this.trigger(s.a.MEDIA_DETACHING),this.media=null)}get isPreloadingItem(){return this.config.gapless&&this.loadingItem&&!isNaN(this.loadingItem.startTime)&&this.media&&this.media.buffered&&this.media.buffered.length>0}get inGaplessMode(){return this.config.gapless&&this.streamController.gaplessAllowed}cleanupItem(e){if(e&&e.cachedManifestCtx){let t=e.cachedManifestCtx;[t.levels,t.audioTracks,t.subtitleTracks].forEach(e=>{e&&e.destroy()}),e.cachedManifestCtx=void 0}}setLoadingItem(e){if(this.loadingItemInternal!==e)if(this.loadingItemInternal&&this.loadingItemInternal===this.playingItem){let e=this.loadingItemInternal.cachedManifestCtx;e&&[e.levels,e.audioTracks,e.subtitleTracks].forEach(e=>e.stopTimers())}else this.cleanupItem(this.loadingItemInternal);let t=e&&e.cachedManifestCtx;t&&[t.levels,t.audioTracks,t.subtitleTracks].forEach(e=>e.startTimers()),this.loadingItemInternal=e}get loadingItem(){return this.loadingItemInternal}setPlayingItem(e){this.playingItemInternal!==e&&this.cleanupItem(this.playingItemInternal),this.playingItemInternal=e}get playingItem(){return this.playingItemInternal}get playingItemDuration(){return this.media.duration-(isNaN(this.playingItem.startTime)?0:this.playingItem.startTime)}queueSource(e,t={}){if(!this._isObjectValid()||!this.media||!this.config.gapless)return;if(t===this.playingItem.options)return void this.logger.error("[gapless] queueSource must not reuse the options object from loadSource")();if(this.loadingItem.itemId!==this.playingItem.itemId)return void c.b.error(`[gapless] already enqueued. loading item ${this.loadingItem.itemId}, playing item ${this.playingItem.itemId}`)();let i=this.bufferController.totalItemDuration;this.resetLoadSource(),this.firstItem=!1,this.logger.info(`[gapless] start loading next item @ ${i}`)(),this.loadSource(e,t,i)}dequeueSource(e=r.m.ApplicationInitiated){this._isObjectValid()&&this.media&&this.config.gapless&&(this.loadingItem.itemId!==this.playingItem.itemId?this.streamController.dequeueSource(e):c.b.error(`[gapless] nothing to dequeue. loading item ${this.loadingItem.itemId}, playing item ${this.playingItem.itemId}`)())}endSource(){this._isObjectValid()&&this.media&&this.config.gapless&&this.streamController.endSource()}get accessLog(){if(!this._isObjectValid())return;let e=this.eventReporter;return e?e.accessLog:[]}get errorLog(){if(!this._isObjectValid())return;let e=this.eventReporter;return e?e.errorLog:[]}get url(){if(this._isObjectValid())return this.playingItem?this.playingItem.url:this.loadingItem?this.loadingItem.url:void 0}_isObjectValid(){return this.isValid||this.logger.error("Hls object already destroyed")(),this.isValid}_getHostName(e){return d.getHostName(e)}_urlNeedsUpdate(e){if(!0===this.config.enableQueryParamsForITunes)return!0;let t=this._getHostName(e);return void 0!==oa.find(e=>new RegExp(e).exec(t))}_shouldUpdateUrlWithDeviceNameAndModel(e){let t=e.model,i=e.manufacturer;return t&&i||this.logger.warn(`Missing model/manufacturer in platformInfo model ${t} manufacturer ${i}`)(),!!t&&!!i}_updateUrlWithDeviceNameAndModel(e,t){let i,s,r=t.model,a=t.manufacturer,n=-1!==e.indexOf("?");return i=encodeURIComponent(r),s=encodeURIComponent(a),(e=n?e:e+"?")+la.deviceName+s+la.deviceModel+i}_updateUrlWithOptionsQuery(e,t){let i,s=-1!==e.indexOf("?");for(i in e=s?e:e+"?",t)t[i]?e+=la[i]+("subs"===i?encodeURIComponent(t[i]):t[i]):this.logger.warn(`Missing ${i} info`)();return e}_updateUrlWithQueryStrings(e,t,i){return this._shouldUpdateUrlWithDeviceNameAndModel(t)&&(e=this._updateUrlWithDeviceNameAndModel(e,t)),this._updateUrlWithOptionsQuery(e,i)}_createSessionID(){var e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,i=4294967295*Math.random()|0,s=4294967295*Math.random()|0,r=[];for(let e=0;e<256;++e)r[e]=(e<16?"0":"")+e.toString(16);return r[255&e]+r[e>>8&255]+r[e>>16&255]+r[e>>24&255]+"-"+r[255&t]+r[t>>8&255]+"-"+r[t>>8&15|64]+r[t>>16&255]+"-"+r[63&i|128]+r[i>>8&255]+"-"+r[i>>8&255]+r[i>>16&255]+r[255&s]+r[s>>8&255]+r[s>>16&255]+r[s>>24&255]}resetLoadSource(){var e;this.logger.info("[gapless] clean up current source")(),this.streamController.resetLoadSource(),null===(e=this.streamController.audioStreamController)||void 0===e||e.resetLoadSource(),this.levelController.resetLoadSource(),this.bufferController.resetLoadSource()}loadSource(e,t={},i){if(!this._isObjectValid())return;let a;if(t.appData&&(a=t.appData.reportingAgent),this.sessionID=a?a.SessionID:this._createSessionID(),this.streamID=t.streamID,this.logger.setStreamAndSessionIDs(this.sessionID,this.streamID),this.logger.info(`[QE Critical] hls player version ${da.version}`)(),"playready"===this.config.keySystemPreference&&!this.config.enablePlayReadyKeySystem){let t=new r.h(r.g.OTHER_ERROR,r.d.INTERNAL_EXCEPTION,!0,"Playready key system is not supported now");return t.url=e,void this.trigger(s.a.ERROR,t)}if(!e||!e.trim().length){let t=new r.h(r.g.OTHER_ERROR,r.d.INTERNAL_EXCEPTION,!0,"Empty loadSource url");return t.url=e,void this.trigger(s.a.ERROR,t)}if(this.config.gapless&&void 0===t.itemId){let e=new r.h(r.g.OTHER_ERROR,r.d.INTERNAL_EXCEPTION,!0,"Undefined itemId");this.trigger(s.a.ERROR,e)}else{if(e=d.buildAbsoluteURL(window.location.href,e,{alwaysNormalize:!0}),this.platformInfo=t.platformInfo,this._userInfo=t.userInfo,this._urlNeedsUpdate(e)){let i={language:t.language,dsid:t.dsid,subs:t.subs};e=this._updateUrlWithQueryStrings(e,this.platformInfo,i),t.inheritQuery=!1}this.loadSourceInternal(e,t,i)}}reloadSource(e){this.resetLoadSource(),this.logger.info(`[gapless] reload item ${this.playingItem.itemId} @ ${this.playingItem.startTime}, seek to ${e}; stale loading item ${this.loadingItem.itemId}`)(),this.loadSourceInternal(this.playingItem.url,this.playingItem.options,isNaN(this.playingItem.startTime)?0:this.playingItem.startTime,e)}loadSourceInternal(e,t={},i,s){let a=t&&t.itemId;this.playingItem&&a===this.playingItem.itemId?this.setLoadingItem(this.playingItem):(this.setLoadingItem({url:e,itemId:t.itemId,inheritQuery:Boolean(t.inheritQuery),secureStop:Boolean(t.generateSecureStop),appData:t.appData,startTime:i,options:t}),(isNaN(i)||i<0)&&(this.logger.info("[gapless] loadSource: setting playingItem as current loadingItem")(),this.setPlayingItem(this.loadingItem),void 0===this.playingItem.startTime&&(this.playingItem.startTime=0))),this.logger.info(`[QE Critical] loadSource:${this.redactUrl(e)}, itemId:${t.itemId}`)(),this.tloadsource=performance.now(),this.loadingItem.cachedManifestCtx?this.handleParsedManifestData(this.loadingItem.cachedManifestCtx,s):this.playlistLoader.loadManifest(e,t).then(e=>{this.handleManifestLoadedData(e,a)}).catch(e=>{e instanceof r.p?this._handleManifestNetworkError(e):e instanceof r.q&&this.logger.warn(`encountered playlist parsing error because ${e.reason} and may expect to hanle manifest parsing error here`)()})}handleManifestLoadedData(e,t){return this.trigger(s.a.MANIFEST_LOADED,e),this.levelController.parseManifestLoadedData(e).then(i=>{if(this.loadingItem.itemId!==t)return void this.logger.warn(`[gapless] item switched before manifest parsed for ${t}`)();let r=e.stats;r.tparsed=performance.now(),this.loadingItem.cachedManifestCtx=i,this.handleParsedManifestData(i);let a={levels:this.levels,firstLevel:this.firstLevel,audio:i.audioCodecFound,video:i.videoCodecFound,altAudio:i.altAudio,audioTracks:this.audioTracks,audioMediaSelectionGroup:i.audioMediaSelectionGroup,subtitleMediaSelectionGroup:i.subtitleMediaSelectionGroup,stats:r};if(this.trigger(s.a.MANIFEST_PARSED,a),e.isMediaPlaylist){let e=this.levels[0].details,t=this.playlistType,i={level:this.levels[0].persistentId,details:e,playlistType:t,id:this.levels[0].persistentId,stats:{trequest:r.trequest,tload:r.tload,contentType:r.contentType},livePlaylistUpdateError:!1};this.trigger(s.a.LEVEL_LOADED,i)}}).catch(e=>{let t;this.logger.error(`manifest parse error:${e.message}`)(),e instanceof r.q?t=Object.assign(Object.assign({},e),{url:this.url}):((t=new r.h(r.g.OTHER_ERROR,r.d.INTERNAL_EXCEPTION,void 0,e.message)).response=r.f.InternalError,t.url=this.url),t.fatal=!0,this.trigger(s.a.ERROR,t)})}handleParsedManifestData(e,t){let{levels:i,audioTracks:s,subtitleTracks:r,isMediaPlaylist:a,audioCodecFound:n,videoCodecFound:o,altAudio:l,audioMediaSelectionGroup:h,subtitleMediaSelectionGroup:c}=e;this.logger.info(`handleParsedManifestData ${i.validVariantList.length}/${s.validVariantList.length}/${r.validVariantList.length}`)();let u=i.variantList;this.cdnWhiteList=new Set(u.map(e=>d.getHostName(e.url))),this.levelController.setVariantManager(i),this.audioTrackController&&this.audioTrackController.setTracks(s,h),this.subtitleTrackController&&this.subtitleTrackController.setTracks(r,c);let f=o||i.variantList.length&&l;this.bufferController.setExpectedSB(f,n,l),this.streamController.startItemLoad(u,a,l,t)}_handleManifestNetworkError(e){let t,i,s,a=e.response,n=a?a.code:a;i=this.networkErrorHandler.getActionForManifestError(e),this.logger.warn(`manifest encountered error ${n} errorAction ${i.errorAction}`)(),s=()=>this.playlistLoader.retryPlaylistRequest(e),(t=this.networkErrorHandler.handleNetworkError(i.errorAction,i.errorActionFlags,e,void 0,s)).retryPromise instanceof Promise?t.retryPromise.then(e=>{this.handleManifestLoadedData(e,this.loadingItem.itemId)}).catch(e=>{e instanceof r.p&&this._handleManifestNetworkError(e)}):i.errorAction===Ds.RetryRequest&&(e.fatal=!0),e.fatal&&this.upgradeInternalErrorIfNecessary(e)}handleItemTransitioned(){let e=this.playingItem?this.playingItem.itemId:void 0,t=this.loadingItem;this.logger.info(`[QE Critical] [gapless] transitioning from ${e} to ${t.itemId}`)(),this.setPlayingItem(t),this.trigger(s.a.ITEM_TRANSITIONED,{prevItemId:e,nextItemId:t.itemId,nextStartTime:this.playingItem.startTime,nextDuration:this.playingItem.totalduration})}get bufferDryPromise(){if(this.streamController.combinedBufferEmpty())return Promise.resolve();if(!this.bufferEndPromiseWrapper){this.bufferEndPromiseWrapper={};let e=new Promise((e,t)=>{this.bufferEndPromiseWrapper.resolve=e,this.bufferEndPromiseWrapper.reject=t});this.bufferEndPromiseWrapper.promise=e.then(()=>{this.bufferEndPromiseWrapper=void 0}).catch(e=>{throw this.bufferEndPromiseWrapper=void 0,e})}return this.bufferEndPromiseWrapper.promise}onBufferChanged(e,t){switch(t.reason){case Ps.AlmostDryWaterLevel:this.bufferEndPromiseWrapper&&this.bufferEndPromiseWrapper.resolve()}}get realCurrentTime(){if(this._isObjectValid())return this.streamController.realCurrentTime}set realCurrentTime(e){this._isObjectValid()&&(this.streamController.realCurrentTime=e)}get iframeMode(){if(this._isObjectValid())return this.streamController.iframeMode}get effectiveRate(){return this.streamController.effectiveRate}set desiredRate(e){this.setRate(e)}get desiredRate(){return this._isObjectValid()?this.streamController.desiredRate:0}addCDNToWhiteList(e){this.cdnWhiteList.add(e)}removeCDNFromWhiteList(e){this.cdnWhiteList.delete(e)}isValidCDN(e){return this.cdnWhiteList.has(e)}hasFallBack(){return this.cdnWhiteList.size>1&&this.config.enableCDNFallback}get preferredHostName(){return this.cdnReferenceBaseURL}set preferredHostName(e){this.cdnReferenceBaseURL=e}setRate(e){if(!this._isObjectValid()||!this.media)return;this.logger.info(`setRate ${e}`)();const t=Math.abs(e);if(![0,1,8,24,48,96].some(e=>e===t))return this.logger.warn(`unsupported rate(${e})`)(),-3;const i=0!==e&&1!==e;if(i&&!this.levelController.hasIframeLevels)return this.logger.warn("can't switch to iframe mode")(),-1;if(this.config.overridePlaybackRate){let e=i?2:1;this.media.playbackRate=e,this.logger.info(`[iframes] setting playbackRate to ${e}`)()}return this.streamController.desiredRate=e,this.eventReporter.setRate(e),0}startLoad(e=-1){this._isObjectValid()&&this.media&&(this.logger.info(`Hls startLoad(${e})`)(),this.networkControllers.forEach(t=>{t.startLoad(e)}))}stopLoad(){this._isObjectValid()&&(this.logger.info("stopLoad")(),this.networkControllers.forEach(e=>{e.stopLoad()}))}setAppData(e){this._isObjectValid()&&e&&this.eventReporter&&this.eventReporter.setAppData(e)}set userInfo(e){this._isObjectValid()&&e&&(this._userInfo=e)}get userInfo(){if(this._isObjectValid())return this._userInfo}get keysystems(){if(this._isObjectValid())return this.keyLoader.keySystemController.availableKeySystems}setProtectionData(e){this._isObjectValid()&&this.keyLoader.keySystemController.initialize(e)}generateKeyRequest(e,t){this._isObjectValid()&&(this.keyLoader.keySystemController.generateRequest(e,t),this.eventReporter.notifyKeySessionEvent(F.spcreceived,{keyuri:e}))}setLicenseResponse(e,t){this._isObjectValid()&&this.keyLoader.keySystemController.setLicenseResponse(e,t)}registerProgramDateTime(e,t){if(!this._isObjectValid())return;this.availableProgramDateTime||(this.availableProgramDateTime=new Map);let i=new Date(e);this.availableProgramDateTime.set(i.getTime(),t)}resolvePendingSeekToDate(){if(!this._isObjectValid())return;let e=-1;return this.availableProgramDateTime&&this.availableProgramDateTime.size>0&&this.pendingSeekToDate&&(e=this.resolveProgramDateTimeToPTS(this.pendingSeekToDate)),e}resolveProgramDateTimeToPTS(e){if(!this._isObjectValid())return;let t=Array.from(this.availableProgramDateTime.keys());t.sort((function(e,t){return e-t}));let i,s=new Date("1970-01-01 00:00:00").getTime(),r=0,a=0,n=0;if(t.length){for(i=0;i<t.length;++i){let r=t[i];if(e.getTime()<r)break;s=r}if(0===i){let i=t[0],s=this.availableProgramDateTime.get(i);s>0&&(n=s-(a=(i-e.getTime())/1e3))}else n=(r=this.availableProgramDateTime.get(s))+(a=(e.getTime()-s)/1e3)}return n}seekToDate(e){if(this._isObjectValid()&&e instanceof Date&&!isNaN(e.getTime()))if(this.availableProgramDateTime&&0!==this.availableProgramDateTime.size){let t=this.resolveProgramDateTimeToPTS(e);null!=t&&isFinite(t)&&(this.logger.info(`adjust currentTime to date ${t}`)(),this.media.currentTime=t)}else this.pendingSeekToDate=e}handleResolvedUri(e,t){this._isObjectValid()&&this.trigger(s.a.UNRESOLVED_URI_LOADED,{uri:e,response:t})}redactUrl(e){return"production"===this.config.buildType?"<redacted>":e}recoverMediaError(){if(this._isObjectValid()){var e=this.media;this.detachMedia(),this.attachMedia(e)}}get levels(){if(this._isObjectValid())return this.levelController.validLevels}get currentLevel(){if(this._isObjectValid())return this.streamController.currentLevel}levelWithPersistentId(e){if(this._isObjectValid())return this.levelController.getLevelWithPersistentId(e)}set currentLevel(e){this._isObjectValid()&&(this.loadLevel=e,this.streamController.immediateLevelSwitch())}get nextLevel(){if(this._isObjectValid())return this.streamController.nextLevel}set nextLevel(e){this._isObjectValid()&&(this.levelController.manualLevel=e,this.streamController.nextLevelSwitch())}get loadLevel(){if(this._isObjectValid())return this.levelController.level}set loadLevel(e){this._isObjectValid()&&(this.levelController.manualLevel=e)}get nextLoadLevel(){if(this._isObjectValid())return this.levelController.nextLoadLevel}set nextLoadLevel(e){this._isObjectValid()&&(this.levelController.nextLoadLevel=e)}get firstLevel(){if(this._isObjectValid())return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(e){this._isObjectValid()&&(this.levelController.firstLevel=e)}get startLevel(){if(this._isObjectValid())return this.levelController.startLevel}set startLevel(e){this._isObjectValid()&&(-1!==e&&(e=Math.max(e,this.minAutoLevel)),this.levelController.startLevel=e)}get autoLevelCapping(){if(this._isObjectValid())return this._autoLevelCapping}set autoLevelCapping(e){this._isObjectValid()&&(this._autoLevelCapping=e)}get autoLevelEnabled(){if(this._isObjectValid())return-1===this.levelController.manualLevel}get manualLevel(){if(this._isObjectValid())return this.levelController.manualLevel}get seeking(){return!!this._isObjectValid()&&this.streamController.seeking}get playbackLikelyToKeepUp(){return!!this._isObjectValid()&&this.streamController.playbackLikelyToKeepUp}get waitingForIncompatibleCCFragLoad(){return!!this._isObjectValid()&&!!this.streamController.waitingForIncompatibleCC}get minAutoLevel(){if(!this._isObjectValid())return;let e=this,t=e.levels,i=e.config.minAutoBitrate,s=t?t.length:0;for(let r=0;r<s;r++)if((t[r].realBitrate?Math.max(t[r].realBitrate,t[r].bitrate):t[r].bitrate)>i&&t[r].iframes===e.iframeMode)return r;return 0}get minLevelIframeMode(){if(!this._isObjectValid())return;let e=this.levels,t=this.config.minAutoBitrate,i=e?e.length:0;for(let s=0;s<i;s++)if((e[s].realBitrate?Math.max(e[s].realBitrate,e[s].bitrate):e[s].bitrate)>t&&!0===e[s].iframes)return s;return-1}get maxAutoLevel(){if(!this._isObjectValid())return;const e=this.levels,t=this.iframeMode?-1:this.autoLevelCapping;return-1===t&&e&&e.length?e.length-1:t}get maxLevelIframeMode(){if(!this._isObjectValid())return;const e=this.levels;return e&&e.length?e.length-1:-1}getLowestBitrateLevel(e){if(this._isObjectValid())return this.levelController.lowestBitrateLevel(e)}countIframesInCurrentLevel(){return this.streamController.countIframesInCurrentLevel(this.levelController.level)}get nextAutoLevel(){if(this._isObjectValid())return 0!==this.levels.length?Math.min(Math.max(this.abrController.nextAutoLevel,this.minAutoLevel),this.levels[this.maxAutoLevel].persistentId):void 0}set nextAutoLevel(e){this._isObjectValid()&&(this.abrController.nextAutoLevel=Math.max(this.minAutoLevel,e))}get sessionData(){if(this._isObjectValid())return this.playlistLoader.parsedSessionData}get liveSyncPosition(){if(this._isObjectValid())return this.streamController.liveSyncPosition}get audioTracks(){if(!this._isObjectValid())return;const e=this.audioTrackController;return e?e.validTracks:[]}get audioTrack(){if(!this._isObjectValid())return;const e=this.audioTrackController;return e?e.audioTrack:-1}get audioMediaOptions(){if(!this._isObjectValid())return;const e=this.audioTrackController;return e&&e.mediaSelectionGroup?e.mediaSelectionGroup.MediaSelectionGroupOptions:void 0}get audioSelectedPersistentID(){if(!this._isObjectValid())return;const e=this.audioTrackController;return e&&e.selectedMediaOption?e.selectedPersistentID:void 0}set audioSelectedPersistentID(e){if(!this._isObjectValid())return;const t=this.audioTrackController;t&&(t.selectedPersistentID=e)}get subtitleTracks(){if(!this._isObjectValid())return;const e=this.subtitleTrackController;return e?e.validTracks:[]}get subtitleMediaOptions(){if(!this._isObjectValid())return;const e=this.subtitleTrackController;return e&&e.mediaSelectionGroup?e.mediaSelectionGroup.MediaSelectionGroupOptions:void 0}get subtitleSelectedPersistentID(){if(!this._isObjectValid())return;const e=this.subtitleTrackController;return e&&e.selectedMediaOption?e.selectedPersistentID:void 0}set subtitleSelectedPersistentID(e){if(!this._isObjectValid())return;const t=this.subtitleTrackController;t&&(t.selectedPersistentID=e)}get selectedMediaArray(){if(!this._isObjectValid())return;let e=[],t=this.audioTrackController?this.audioTrackController.selectedMediaOption:void 0,i=this.subtitleTrackController?this.subtitleTrackController.selectedMediaOption:void 0;if(t){let i={MediaSelectionGroupMediaType:pi.AUDIO,MediaSelectionOptionsPersistentID:t.MediaSelectionOptionsPersistentID};e.push(i)}if(i){let t=i.MediaSelectionOptionsDisplaysNonForcedSubtitles?i.MediaSelectionOptionsDisplaysNonForcedSubtitles:mi.NO,s={MediaSelectionGroupMediaType:pi.SUBTITLE,MediaSelectionOptionsDisplaysNonForcedSubtitles:t,MediaSelectionOptionsPersistentID:i.MediaSelectionOptionsPersistentID};e.push(s)}return e}set selectedMediaArray(e){this._isObjectValid()&&e.forEach(e=>{e.MediaSelectionGroupMediaType===pi.AUDIO||e.MediaSelectionOptionsMediaType===pi.AUDIO?this.audioSelectedPersistentID=e.MediaSelectionOptionsPersistentID:e.MediaSelectionGroupMediaType!==pi.SUBTITLE&&e.MediaSelectionOptionsMediaType!==pi.SUBTITLE&&e.MediaSelectionOptionsMediaType!==pi.CLOSEDCAPTION||(this.subtitleSelectedPersistentID=e.MediaSelectionOptionsPersistentID)})}get mediaSelectionArray(){if(!this._isObjectValid())return;let e=new Array;const t=this.subtitleTrackController,i=this.audioTrackController;return i&&i.mediaSelectionGroup&&e.push(i.mediaSelectionGroup),t&&t.mediaSelectionGroup&&e.push(t.mediaSelectionGroup),e}get subtitleDisplay(){if(!this._isObjectValid())return;const e=this.subtitleTrackController;return!!e&&e.subtitleDisplay}set subtitleDisplay(e){if(!this._isObjectValid())return;const t=this.subtitleTrackController;t&&(t.subtitleDisplay=e)}get hasPlaybackEverStarted(){if(this._isObjectValid())return this.streamController.playbackEverStarted}updatePlaylistAttributes(e){let t=e.type,i="VOD",s=e.live;return"EVENT"===t&&s?i="EVENT":t&&"LIVE"!==t||!s||(i="LIVE"),this.isLive=s,this.playlistType=i,{playlistType:i,isLive:s}}}t.default=da}),(function(e,t,i){"use strict";i.r(t),i.d(t,"createDemuxerWorker",(function(){return n})),i.d(t,"createDecryptorWorker",(function(){return o}));var s=i(14);i.d(t,"DemuxerInline",(function(){return s.a}));var r=i(15);i.d(t,"SegmentDecryptorInline",(function(){return r.a}));const a=(e,t)=>i(24)(e,t),n=()=>a(25),o=()=>a(26)})]).default}));